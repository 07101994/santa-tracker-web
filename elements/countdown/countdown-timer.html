<link rel="import" href="../../components/polymer/polymer.html">

<script src="audiocontroller.js"></script>

<!--
Countdown timer.

@element countdown-timer
-->
<polymer-element name="countdown-timer" attributes="santaService endDate playSounds finished">
  <template>
    <link rel="stylesheet" href="countdown-timer.css" no-shim>
    <style>
      :host {
        display: block;
      }
    </style>

    <div hidden>
      <content id="content" select="*"></content>
    </div>

    <div id="counter" layout horizontal>
      <template repeat="{{title, i in titles}}">
        <div class="counter-box" layout vertical center hidden?="{{i == 0 && displayDigits < 8}}">
          <h2>{{title.textContent}}</h2>
          <div class="digits" layout horizontal>
            <template repeat="{{digits in [0, 1]}}">
              <div class="digit digit-ani">
                <div class="digit-top digit-top-front"><span></span></div>
                <div class="digit-top digit-top-behind"><span></span></div>
                <div class="digit-bottom digit-bottom-front"><span></span></div>
                <div class="digit-bottom digit-bottom-behind"><span></span></div>
                <div class="digit-bg"></div>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>

  </template>
  <script>
  (function() {

    // TODO(ericbidelman): use end date in santatracker.js
    var END_DATE = 1419415200000;
    var TRANSITION_TIME_ = 300;

    Polymer({

      /**
       * Optional container element to render the countdown into. If `render`
       * is `true`, the container defaults to this element's light dom.
       *
       * @attribute container
       * @type Element
       * @default HTMLElement|null
       */
      container: null,

      /**
       * True if the countdown should be active.
       *
       * @property active
       * @type bool
       * @default false
       */
      active: false,

      /**
       * True if the countdown should render a UI.
       *
       * @property render
       * @type bool
       * @default true
       */
      render: true,

      /**
       * The end time for this countdown, in milliseconds.
       *
       * @property endDate
       * @type number
       * @default 1387879200000
       */
      endDate: END_DATE,

      /**
       * The current time as dictated by the `santaService`.
       *
       * @attribute santaService
       * @type SantaService
       */
       santaService: null,

      /**
       * The number of digits to display.
       *
       * @property displayDigits
       * @type number
       * @default 8
       */
       displayDigits: 8,

      /**
       * True if the countdown should tick when the numbers flip.
       *
       * @attribute playSounds
       * @type bool
       * @default false
       */
       playSounds: false,

       publish: {
        /**
         * True when the countdown has reached `endDate`.
         *
         * @attribute finished
         * @type bool
         * @default false
         */
        finished: {value: false, reflect: true}
       },

      /**
       * The current time as dictated by the `santaService`.
       *
       * @property currentTime
       * @type number
       */

      created: function() {
        this.titles = [];
        this.digits = [];
      },

      ready: function() {
        this.currentTime = this.getCurrentTime_();

        if (this.playSounds) {
          this.audio = new AudioController();
        }

        if (this.render) {
          this.container = this.container || this;
        }
      },

      attached: function() {
        if (this.render) {
          this.titles = Array.prototype.slice.call(
              this.$.content.getDistributedNodes());
        }
      },

      domReady: function() {
        // Needs to wait one rAF so titles has populated the template repeat.
        if (this.render) {
          this.digits = Array.prototype.slice.call(
              this.$.counter.querySelectorAll('.digit'));
        }

        this.fire('countdown-timer-ready', this);

        // Set the initial time but don't start
        this.tickTock();
      },

      /**
       * Pads a number with leading zeros.
       *
       * TODO: This is also in util.js
       *
       * @param {number} digit
       * @return {string|number}
       * @private
       */
      pad: function(digit) {
        return digit < 10 ? '0' + digit : digit;
      },

      /**
       * @private
       * @return {Object.<string>}
       */
      getCurrentTime_: function() {
        var diff = Math.max(0, this.endDate - this.santaService.now());
        var msPerDay = 24 * 60 * 60 * 1000;

        var daysX = diff / msPerDay;
        var days = Math.floor(daysX);

        var hoursX = (daysX - days) * 24;
        var hours = Math.floor(hoursX);

        var minsX = (hoursX - hours) * 60;
        var mins = Math.floor(minsX);

        var secondsX = (minsX - mins) * 60;
        var seconds = Math.floor(secondsX);

        return {diff: diff, days: days, hours: hours, mins: mins, seconds: seconds};
      },

      tickTock: function() {
        this.currentTime = this.getCurrentTime_();

        var days = this.currentTime.days;
        var hours = this.currentTime.hours;
        var mins = this.currentTime.mins;
        var seconds = this.currentTime.seconds;

        if (this.render) {
          var bits = [this.pad(days), this.pad(hours), this.pad(mins),
                      this.pad(seconds)].join('').split('');
          this.displayDigits = (days == 0) ? 6 : 8

          for (var i = 0, digit; digit = this.digits[i]; ++i) {
            this.setDigit(digit, bits[i]);
          }
        }

        if (this.currentTime.diff == 0) {
          this.fire('countdown-timer-finish', this);
          this.finished = true;
          this.stop();
        }
      },

      /**
       * Sets a value for the digit node.
       *
       * @method setDigit
       * @param {Element} digit
       * @param {string} val
       */
      setDigit: function(digit, val) {
        var oldDigit = digit.getAttribute('data-digit');
        digit.setAttribute('data-digit', val);

        if (oldDigit == val) {
          return;
        }

        var digitTopFront = digit.querySelector('.digit-top-front');
        var digitTopBehind = digit.querySelector('.digit-top-behind');
        var digitBottomFront = digit.querySelector('.digit-bottom-front');
        var digitBottomBehind = digit.querySelector('.digit-bottom-behind');

        if (oldDigit != undefined) {
          digitTopBehind.firstElementChild.textContent = val;
          digitBottomFront.firstElementChild.textContent = val;

          digitTopFront.classList.add('digit-flip');

          window.setTimeout(function() {
            digitBottomFront.classList.add('digit-flip');

            window.setTimeout(function() {
              digitTopFront.classList.remove('digit-flip');
              digitBottomFront.classList.remove('digit-flip');

              digitTopFront.firstElementChild.textContent = val;
              digitBottomBehind.firstElementChild.textContent = val;

              // used by Chrome extension to play sound
              this.fire('countdown-timer-digitflip', this.currentTime);
            }.bind(this), TRANSITION_TIME_);
          }.bind(this), TRANSITION_TIME_);

        } else {
          digitTopFront.firstElementChild.textContent = val;
          digitBottomBehind.firstElementChild.textContent = val;
        }
      },

      /**
       * Stop the countdown
       */
      stop: function() {
        window.clearInterval(this.tickInterval_);
        this.active = false;
      },

      /**
       * Start the countdown
       */
      start: function() {
        if (this.active) {
          return;
        }
        this.active = true;
        this.tickTock();

        this.tickInterval_ = window.setInterval(function() {
          this.tickTock();
        }.bind(this), 1000);
      },

      /**
       * @param {string} url Sound file to load and play.
       * @param {Function=} opt_callback Optional callback when file is fully loaded.
       */
      setAudio: function(url, opt_callback) {
        if (this.audio && this.audio.isSupported) {
          this.audio.load(url, opt_callback);
        }
      },

      /**
       * Plays tick sound if audio has been loaded and the Web Audio API is supported.
       */
      playTick: function() {
        this.audio && this.audio.play(0.1);
      },

      /**
       * @return boolean
       */
      isFinished: function() {
        return this.currentTime.diff <= 0;
      }

    });

  })();
  </script>
</polymer-element>
