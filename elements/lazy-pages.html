<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/core-pages/core-pages.html">

<!--
Lazy loads children "pages".

@element lazy-pages
@extends core-pages
-->
<polymer-element name="lazy-pages" extends="core-pages" attributes="santaApp">
<template>
  <style>
    :host {
      position: initial;
    }
  </style>
  <shadow></shadow>
</template>
<script>
  Polymer({

    /**
     * A `<santa-app>` controller element.
     *
     * @attribute santaApp
     * @type HTMLElement
     * @default null
     */
    santaApp: null,

    /**
     * A `<preload-overlay>` element.
     *
     * @attribute preloader
     * @type HTMLElement
     * @default null
     */
    preloader: null,

    selectedItemChanged: function() {

      this.super();

      var scene = this.selectedItem;

      // Can't use scene.path because element definition may not be loaded yet
      // and .path property won't exist.
      var path = scene.getAttribute('path');

      if (!path || !scene || !this.selected || scene.loaded) {
        return;
      }

      // This is here (instead of attached()) to prevent timing errors under
      // the polyfill.
      // TODO(ericbidelman): this reaches outside. The auto-binding template
      // doesn't setup  automatic node finding until after
      // selectedItemChanged() gets called.
      if (!this.preloader) {
        this.preloader = this.parentElement.querySelector('preload-overlay');
      }

      // (Re)set the preload bg color and loading image before scene is loaded.
      this.preloader.color = scene.getAttribute('loadingBgColor');
      this.preloader.src = scene.getAttribute('loadingSrc');

      Polymer.import([path], function(e) {
        scene.santaApp = this.santaApp;
      }.bind(this));
    }
  });
</script>
</polymer-element>
