<link rel="import" href="../../scenes/base-scene.html">
<link rel="import" href="../../components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../components/core-animated-pages/transitions/cross-fade.html">
<link rel="import" href="../../components/paper-fab/paper-fab.html">

<!--
Village calendar navigation.

@element calendar-nav
@extends base-scene
-->
<polymer-element name="calendar-nav" extends="base-scene" attributes="houses">
  <template>
    <link rel="stylesheet" href="calendar-nav.css" no-shim>
    <style>
      paper-tabs::shadow #selectionBar {
        background-color: #fcdb32;
        height: 4px;
      }
      paper-tab::shadow #ink {
        color: rgba(254, 222, 50, 0.5);
      }
      paper-tab::shadow .tab-content {
        opacity: 1;
      }
    </style>

    <div id="module-nav">
      <div id="global-nav" class="{{ {opened: opened, opening: opening, closing: closing, closed: closed, scrollable: scrollable} | tokenList}}">
        <a id="global-nav-btn" href="{{pageUrl}}#{{active ? santaApp.prevSelectedScene.route : 'calendar'}}" on-click="{{fabClick}}">
          <paper-fab icon="today" on-core-transitionend="{{rippleDone}}"></paper-fab>
        </a>
        <div id="global-nav-body">
          <div id="global-nav-header" layout horizontal center-center>
            <a id="global-back-to-village" href="{{pageUrl}}#village" title="Go to the Village" class="back"><i18n-msg msgid="gotovillage">PLACEHOLDER_i18n</i18n-msg></a>
            <paper-tabs id="tabs" valueattr="filterOn" selected="{{filterOn}}"
                        on-core-activate="{{onNavSelect}}">
              <paper-tab filterOn="calendar"><i18n-msg msgid="calendar">PLACEHOLDER_i18n</i18n-msg></paper-tab>
              <paper-tab filterOn="watch"><i18n-msg msgid="watch">PLACEHOLDER_i18n</i18n-msg></paper-tab>
              <paper-tab filterOn="play"><i18n-msg msgid="play">PLACEHOLDER_i18n</i18n-msg></paper-tab>
              <paper-tab filterOn="learn"><i18n-msg msgid="learn">PLACEHOLDER_i18n</i18n-msg></paper-tab>
              <paper-tab on-tap="{{onTheGo}}"><i18n-msg msgid="onthego">PLACEHOLDER_i18n</i18n-msg></paper-tab>
            </paper-tabs>
          </div>

          <div id="global-nav-content">

            <core-animated-pages transitions="cross-fade" selected="{{route}}" valueattr="route">
              <section route="calendar">
                <div id="nav-calendar" cross-fade class="{{filterOn}}">
                  <div layout horizontal center-center wrap>
                    <div class="card"></div>

                    <div layout vertical center-center data-index="1"
                         class="card calendar scene video play learn">
                      <template repeat="{{house, i in firstFour}}">
                        <a href="{{pageUrl}}#[[house.module]]" on-click="{{onCalendarClick}}">
                          <div class="menu-marker marker1 calendar [[house.category]]" style="background-image:url({{componentBaseDir}}img/menu-[[house.module]].svg);"></div>
                        </a>
                      </template>
                    </div>

                    <template repeat="{{house, i in regularSchedule}}">
                      <div layout vertical center-center data-index="{{i + 2}}" data-category="[[house.category]]" class="card calendar [[house.category]] {{house.iced ? 'iced' : 'melt'}}">
                        <a href="{{pageUrl}}#[[house.module]]" on-click="{{onCalendarClick}}">
                          <div class="menu-marker marker{{i + 2}} calendar [[house.category]]" style="background-image:url({{componentBaseDir}}img/menu-[[house.module]].svg);"></div>
                        </a>
                      </div>
                    </template>
                    <div class="card"></div>
                    <div class="card"></div>
                    <div class="card"></div>
                    <div class="card"></div>
                  </div>
                </div>
              </section>
              <section route="onthego">
                <div id="nav-onthego" cross-fade>
                  <div class="onthego-item onthego-android">
                    <a href="//play.google.com/store/apps/details?id=com.google.android.apps.santatracker" on-click="{{trackOutboundLink}}">
                      <div class="logo"></div>
                      <h2><i18n-msg msgid="play">PLACEHOLDER_i18n</i18n-msg></h2>
                      <p><i18n-msg msgid="playdescription">PLACEHOLDER_i18n</i18n-msg></p>
                    </a>
                  </div>
                  <div class="onthego-item onthego-chrome">
                    <a href="//www.google.com/chrome/santatracker/" on-click="{{trackOutboundLink}}">
                      <div class="logo"></div>
                      <h2><i18n-msg msgid="deck">PLACEHOLDER_i18n</i18n-msg></h2>
                      <p><i18n-msg msgid="deckdescription">PLACEHOLDER_i18n</i18n-msg></p>
                    </a>
                  </div>
                  <div class="onthego-item onthego-cast">
                    <a href="//play.google.com/store/apps/details?id=com.google.android.apps.santatracker" on-click="{{trackOutboundLink}}">
                      <div class="logo"></div>
                      <h2><i18n-msg msgid="light">PLACEHOLDER_i18n</i18n-msg></h2>
                      <p><i18n-msg msgid="lightdescription">PLACEHOLDER_i18n</i18n-msg></p>
                    </a>
                  </div>
                </div>
              </section>
            </core-animated-pages>
          </div>
        </div>

        <div id="language-choose" layout vertical center-center hidden>
          <div>
            <a href="#" id="close-lang" on-click="{{toggleLanguageSelect}}"></a>
            <h2><i18n-msg msgid="select-language">PLACEHOLDER_i18n</i18n-msg></h2>
            <select id="language" value="{{santaApp.language}}" on-change="{{onLanguageChanged}}">
              <option value="af">Afrikaans</option>
              <option value="ca">Català</option>
              <option value="zh-HK">中文（香港）</option>
              <option value="zh-TW">中文</option>
              <option value="da">Dansk</option>
              <option value="de">Deutsch</option>
              <option value="et">Eesti</option>
              <option value="en">English</option>
              <option value="es">Español</option>
              <option value="fr">Français</option>
              <option value="fr-CA">Français (Canada)</option>
              <option value="hr">Hrvatski</option>
              <option value="id">Indonesia</option>
              <option value="it">Italiano</option>
              <option value="ja">日本語</option>
              <option value="lv">Latvijas</option>
              <option value="lt">Lietuvos</option>
              <option value="no">Norsk</option>
              <option value="pl">Polski</option>
              <option value="pt-BR">Português (Brasil)</option>
              <option value="pt-PR">Português (Portugal)</option>
              <option value="ro">Român</option>
              <option value="sl">Slovenija</option>
              <option value="sv">Svenska</option>
              <option value="tl">Tagalog</option>
              <option value="fi">Viimeistely</option>
              <option value="bg">Български</option>
              <option value="uk">Український</option>
              <option value="ta-IN">தமிழ்</option>
              <option value="ms">മലയാളം </option>
              <option value="th">ภาษาไทย</option>
            </select>
          </div>
        </div>

        <div id="global-nav-footer">
          <a href="#" id="select-lang" on-click="{{toggleLanguageSelect}}"><i18n-msg msgid="language">PLACEHOLDER_i18n</i18n-msg></a>
          &bull;
          <!-- TODO(cbro): This should go to the right locale about page -->
          <a href="http://www.google.com/santatracker/about.html"><i18n-msg msgid="about-santa">PLACEHOLDER_i18n</i18n-msg></a>
          &bull;
          <a href="http://www.google.com/policies/"><i18n-msg msgid="terms-and-privacy">PLACEHOLDER_i18n</i18n-msg></a>
          &bull;
          <a href="http://maps.google.com/help/maps/helloworld/index.html"><i18n-msg msgid="getgooglemaps">PLACEHOLDER_i18n</i18n-msg></a>
        </div>
      </div>

      <div id="site-nav">
        <h2><i18n-msg msgid="santatracker">PLACEHOLDER_i18n</i18n-msg></h2>
        <div class="share">
          <ul>
            <li><a href="#" class="gplus" on-click="{{shareGplus}}"><i><i18n-msg msgid="gplus">PLACEHOLDER_i18n</i18n-msg></i></a></li>
            <li><a href="#" class="fb" on-click="{{shareFB}}"><i>Facebook</i></a></li>
            <li><a href="#" class="twitter" on-click="{{shareTwitter}}"><i><i18n-msg msgid="twitter">PLACEHOLDER_i18n</i18n-msg></i></a></li>
          </ul>
        </div>
      </div>

      <div id="sound">
        <a href="#" class="on" on-click="{{toggleSounds}}"><i></i></a>
      </div>

    </div>

  </template>
  <script>
  (function() {
    Polymer({
      opened: false,
      opening: false,
      closed: true,
      closing: false,

      TIMEOUT_DELAY: 300 + (25 * 42),

      componentDir: 'elements/calendar/',

      /**
       * Fired when a general tracking event should be recorded in analytics.
       *
       * @event analytics-track-event
       * @param {Object} detail
       *   @param {string} detail.category
       *   @param {string} detail.action
       *   @param {string} detail.label
       */

      /**
       * Fired when a social/share should be recorded in analytics.
       *
       * @event analytics-track-social
       * @param {Object} detail
       *   @param {string} detail.network
       *   @param {string} detail.action
       *   @param {string} detail.target
       */

      rippleDone: function(e, detail, sender) {
        location.href = this.$['global-nav-btn'].href;
      },

      fabClick: function(e, detail, sender) {
        e.preventDefault();
      },

      housesChanged: function() {
        this.firstFour = this.houses.slice(0, 4);
        this.regularSchedule = this.houses.slice(4);
      },

      onNavSelect: function(e, detail, sender) {
        // Ensure the calendar comes back up when a filter nav item is clicked.
        if (detail.item.hasAttribute('filterOn')) {
          this.route = 'calendar';
        }
      },

      onCalendarClick: function(e, detail, sender) {
        var iced = sender.templateInstance.model.house.iced;
        if (iced) {
          e.preventDefault();
        }
      },

      onTheGo: function(e, detail, sender) {
        e.preventDefault();
        this.route = 'onthego';
      },

      trackOutboundLink: function(e, detail, sender) {
        e.preventDefault();

        this.fire('analytics-track-event', {category: 'outbound', action: 'click',
                                            label: sender.href});

        this.async(function() {
          document.location.href = sender.href;
        }, null, 100);
      },

      onLanguageChanged: function(e, detail, sender) {
        var lang = sender.value;

        this.fire('analytics-track-event', {category: 'language', action: 'click',
                                            label: 'change', 'value': lang});

        // TODO(lukem): Wire this up to redirect to the right url.
        // This is done as a RAF because we want to make sure the analytics event is triggered.
        this.async(function() {
          window.location = '/intl/' + lang + '/' + window.location.hash;
        }, null, 100);
      },

      onShow: function() {
        this.cancelAsync(this.closeTimeout_);

        this.$['global-nav-content'].scrollTop = 0;
        this.$['language-choose'].hidden = true;

        this.$.tabs.selected = 'calendar';

        this.closed = this.closing = false;
        this.opening = true;

        this.async(function() {
          this.opened = true;
        });

        this.fire('sound-trigger', 'menu_open');

        this.santaApp && this.santaApp.visibilityService.pause();
      },

      onHide: function() {
        this.opening = this.opened = false;
        this.closing = true;

        this.$['language-choose'].hidden = true;

        this.closeTimeout_ = this.async(function() {
          this.route = 'calendar';
          this.closed = true;
        }, null, this.TIMEOUT_DELAY);

        this.fire('sound-trigger', 'menu_close');

        this.santaApp && this.santaApp.visibilityService.resume();
      },

      toggleLanguageSelect: function(e) {
        e.preventDefault();
        this.$['language-choose'].hidden = !this.$['language-choose'].hidden;
      },

      getNicePageUrl: function() {
        // We don't want to share urls with #village in them.
        return location.href.replace('#village', '');
      },

      shareGplus: function(e) {
        e.preventDefault();

        var target = this.getNicePageUrl();

        this.fire('analytics-track-social', {
          network: 'googleplus', action: 'share',
          target: target
        });

        this.openPage_('https://plus.google.com/share?url=' +
                       encodeURIComponent(target) +
                       '&hl=' + encodeURIComponent(document.documentElement.lang));
      },

      shareFB: function(e) {
        e.preventDefault();

        var target = this.getNicePageUrl();

        this.fire('analytics-track-social', {
          network: 'facebook', action: 'share',
          target: target
        });

        this.openPage_('http://www.facebook.com/sharer.php?u=' +
                       encodeURIComponent(target) +
                       '&t=' + encodeURIComponent(document.title));

      },

      shareTwitter: function(e) {
        e.preventDefault();

        var target = this.getNicePageUrl();

        this.fire('analytics-track-social', {
          network: 'twitter', action: 'share',
          target: target
        });

        this.openPage_('http://twitter.com/share?text=' +
                       encodeURIComponent('Google Santa Tracker - ' +
                       'Follow Santa on his journey around the ' +
                       'world -') + '&url=' +
                       encodeURIComponent(target));
      },

      /**
       * Open a fixed size window to a url
       * @param {string} url
       */
      openPage_: function(url) {
        window.open(url, 'Share', 'toolbar=0,status=0,width=626,height=480');
      },

      toggleSounds: function(e, detail, sender) {
        e.preventDefault();

        if (sender.classList.contains('off')) {
          this.fire('sound-ambient', 'global_sound_on');
          sender.classList.switch('off', 'on');
        } else {
          this.fire('sound-ambient', 'global_sound_off');
          sender.classList.switch('on', 'off');
        }
      }

    });

  })();
  </script>
</polymer-element>
