<link rel="import" href="../../scenes/base-scene.html">
<link rel="import" href="../../components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../components/core-animated-pages/transitions/cross-fade.html">

<!--
Village calendar navigation.

@element calendar-nav
@extends base-scene
-->
<polymer-element name="calendar-nav" extends="base-scene" attributes="houses">
  <template>
    <link rel="stylesheet" href="calendar-nav.css" no-shim>
    <style>
      paper-tabs::shadow #selectionBar {
        background-color: #fede32;
      }
      paper-tab::shadow #ink {
        color: rgba(254, 222, 50, 0.5);
      }
    </style>

    <div id="module-nav">

      <div id="global-nav" class="{{ {opened: opened, opening: opening, closing: closing, closed: closed, scrollable: scrollable} | tokenList}}">
        <a id="global-nav-btn" href="#{{active ? 'village' : 'calendar'}}" layout horizontal>
          <div class="nav-santa-icon"></div>
          <div class="nav-santa-bar"></div>
        </a>
        <div id="sound">
          <a href="#" class="on" on-click="{{toggleSounds}}"><i></i></a>
        </div>
        <div id="global-nav-body">
          <div id="global-nav-header" layout horizontal center-center>
            <a id="global-back-to-village" href="{{baseURI}}#village" title="Go to the Village" class="back">Go to the Village</a>
            <paper-tabs id="tabs" valueattr="filterOn" selected="{{filterOn}}"
                        on-core-activate="{{onNavSelect}}">
              <paper-tab filterOn="watch">Videos</paper-tab>
              <paper-tab filterOn="play">Games</paper-tab>
              <paper-tab filterOn="calendar">The Calendar</paper-tab>
              <paper-tab filterOn="learn">Education</paper-tab>
              <paper-tab filterOn="scene">Scenes</paper-tab>
              <paper-tab on-tap="{{onTheGo}}">Santa on the go</paper-tab>
            </paper-tabs>
          </div>

          <div id="global-nav-content">

            <core-animated-pages transitions="cross-fade" selected="{{route}}" valueattr="route">
              <section route="calendar">
                <div id="nav-calendar" cross-fade class="{{filterOn}}">
                  <div layout horizontal wrap>
                    <div class="card"></div>

                    <div layout vertical center-center data-index="1"
                         class="card calendar scene video play learn">
                      <template repeat="{{house, i in firstFour}}">
                        <a href="{{baseURI}}#{{house.module}}" on-click="{{onCalendarClick}}">
                          <div class="menu-marker calendar {{house.category}}" style="background-image:url({{componentBaseDir}}img/menu-{{house.module}}.svg);"></div>
                        </a>
                      </template>
                    </div>

                    <template repeat="{{house, i in regularSchedule}}">
                      <div layout vertical center-center data-index="{{i + 2}}" data-category="{{house.category}}" class="card calendar {{house.category}} {{ {iced: house.iced, melt: !house.iced} | tokenList }}">
                        <a href="{{baseURI}}#{{house.module}}" on-click="{{onCalendarClick}}">
                          <div class="menu-marker marker{{i + 2}} calendar {{house.category}}" style="background-image:url({{componentBaseDir}}img/menu-{{house.module}}.svg);"></div>
                        </a>
                      </div>
                    </template>
                    <div class="card"></div>
                    <div class="card"></div>
                    <div class="card"></div>
                  </div>
                </div>
              </section>
              <section route="onthego">
                <div id="nav-onthego" cross-fade>
                  <div class="onthego-item onthego-android">
                    <a href="//play.google.com/store/apps/details?id=com.google.android.apps.santatracker" on-click="{{trackOutboundLink}}">
                      <div class="logo"></div>
                      <h2>Play</h2>
                      <p>Play with friends in the Santa Tracker Android App.</p>
                    </a>
                  </div>
                  <div class="onthego-item onthego-chrome">
                    <a href="//www.google.com/chrome/santatracker/" on-click="{{trackOutboundLink}}">
                      <div class="logo"></div>
                      <h2>Deck out</h2>
                      <p>Deck out your browser with a Santa Chrome extension.</p>
                    </a>
                  </div>
                  <div class="onthego-item onthego-cast">
                    <a href="//play.google.com/store/apps/details?id=com.google.android.apps.santatracker" on-click="{{trackOutboundLink}}">
                      <div class="logo"></div>
                      <h2>Light up</h2>
                      <p>Light up your TV with the Santa Tracker Android app and Chromecast.</p>
                    </a>
                  </div>
                </div>
              </section>
            </core-animated-pages>
          </div>

        </div>
        <div id="global-nav-footer">
          <!-- TODO(lukem): put back goro stuff -->
          <!-- <div style="display:inline"><a href="#" id="select-lang">{% msg %}Language{% endmsg %}</a> &bull;</div>
          <a href="{{'www.google.com/santatracker/about.html'|localizedpath:goro.page.locale}}">About</a>
          &bull;
          <a href="http://www.google.com/policies/">Terms &amp; Privacy</a>
          &bull; -->
          <a href="http://maps.google.com/help/maps/helloworld/index.html">Get Google Maps</a>
        </div>
      </div>

      <div id="site-nav">
        <h2>Santa Tracker</h2>
        <div class="share">
          <ul>
            <li><a href="#" class="gplus" on-click="{{shareGplus}}"><i>Google+</i></a></li>
            <li><a href="#" class="fb" on-click="{{shareFB}}"><i>Facebook</i></a></li>
            <li><a href="#" class="twitter" on-click="{{shareTwitter}}"><i>Twitter</i></a></li>
          </ul>
        </div>
      </div>

    </div>

  </template>
  <script>
  (function() {
    Polymer({
      opened: false,
      opening: false,
      closed: true,
      closing: false,

      TIMEOUT_DELAY: 300 + (24 * 42),

      componentDir: 'elements/calendar/',

      housesChanged: function() {
        this.firstFour = this.houses.slice(0, 4);
        this.regularSchedule = this.houses.slice(4);

      },

      onNavSelect: function(e, detail, sender) {
        // Ensure the calendar comes back up when a filter nav item is clicked.
        if (detail.item.hasAttribute('filterOn')) {
          this.route = 'calendar';
        }
      },

      onCalendarClick: function(e, detail, sender) {
        var iced = sender.templateInstance.model.house.iced;
        if (iced) {
          e.preventDefault();
        }
      },

      onTheGo: function(e, detail, sender) {
        e.preventDefault();
        this.route = 'onthego';
      },

      trackOutboundLink: function(e, detail, sender) {
        e.preventDefault();

        this.analyticsService.trackEvent('outbound', 'click', sender.href);

        this.async(function() {
          document.location.href = sender.href;
        }, null, 100);
      },

      onShow: function() {
        this.cancelAsync(this.closeTimeout_);

        this.$['global-nav-content'].scrollTop = 0;
        this.$.tabs.selected = 'calendar';

        this.closed = this.closing = this.scrollable = false;
        this.opening = true;

        this.async(function() {
          this.opened = true;

          this.async(function() {
            this.scrollable = true;
          }, null, this.TIMEOUT);
        });

        this.playSound('menu_open');

        this.visibilityService && this.visibilityService.pause();
      },

      onHide: function() {
        this.opening = this.opened = this.scrollable = false;
        this.closing = true;

        this.closeTimeout_ = this.async(function() {
          this.route = 'calendar';
          this.closed = true;
        }, null, this.TIMEOUT_DELAY);

        this.playSound('menu_close');

        this.visibilityService && this.visibilityService.resume();
      },

      /**
       * @private
       */
      addLanguageSelectEvents_: function() {
        /*
        $('#select-lang').on('click', function(e) {
          $('#page-language').show();
          e.preventDefault(); // necessary for standalone village, but not web.
        });

        // Prevent a click on the language select from closing the form.
        $('#language-content').on('click', function(e) {
          return false;
        });

        var hidePopup = function() {
          $('#page-language').hide();
          return false;
        };

        $('#page-language').on('click', hidePopup);
        $('#close-lang').on('click', hidePopup);

        $('#language').val(window.santatracker.lang);

        $('#language').on('change', function() {
          var lang = $(this).val();
          window.santatracker.analytics.trackEvent('language', 'click', 'change',
              lang);
          window.setTimeout(function() {
            window.location = '/intl/' + lang + '/santatracker/' +
                window.location.hash;
          }, 100);
        });
        */
      },


      shareGplus: function(e) {
        e.preventDefault();

        this.analyticsService.trackSocial('googleplus', 'share',
            'http://www.google.com/santatracker');
        this.openPage_('https://plus.google.com/share?url=' +
                       encodeURIComponent('http://www.google.com/santatracker'));
      },

      shareFB: function(e) {
        e.preventDefault();

        this.analyticsService.trackSocial('facebook', 'share',
            'http://www.google.com/santatracker');

        this.openPage_('http://www.facebook.com/sharer.php?u=' +
                       encodeURIComponent('http://www.google.com/santatracker') +
                       '&t=' + encodeURIComponent('Google Santa Tracker'));

      },

      shareTwitter: function(e) {
        e.preventDefault();

        this.analyticsService.trackSocial('twitter', 'share',
            'http://www.google.com/santatracker');

        this.openPage_('http://twitter.com/share?text=' +
                       encodeURIComponent('Google Santa Tracker - ' +
                       'Follow Santa on his journey around the ' +
                       'world -') + '&url=' +
                       encodeURIComponent('http://www.google.com/santatracker'));
      },

      /**
       * Open a fixed size window to a url
       * @param {string} url
       */
      openPage_: function(url) {
        window.open(url, 'Share', 'toolbar=0,status=0,width=626,height=480');
      },

      toggleSounds: function(e, detail, sender) {
        e.preventDefault();

        if (sender.classList.contains('off')) {
          this.playAmbientSounds('global_sound_on');
          sender.classList.switch('off', 'on');
        } else {
          this.playAmbientSounds('global_sound_off');
          sender.classList.switch('on', 'off');
        }
      }

    });

  })();
  </script>
</polymer-element>
