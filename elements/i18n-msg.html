<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../components/polymer/polymer.html">
<script src="../components/promise-polyfill/Promise.min.js"></script>

<!--
Custom element to do localization (i18n) messages. Only used for dev, and is
compiled out to raw strings in production.
-->
<dom-module id="i18n-msg">
<script>
(function() {

  // TODO(samthor): Restore listener-style behavior for I18nMsg, so that e.g.,
  // lang can be quickly changed for testing.
  window.I18nMsg = window.I18nMsg || {
    lang: 'en',
    messagesPath: '_messages/'
  };

  /**
   * Maps from lang to Promise objects for message JSON.
   * @type {!Object<!Promise<!Object<{message: string}>>>}
   */
  var locales = {};


  /**
   * @param {string} language to fetch, typcially 'en', 'de' etc
   * @return {!Promise<!Object<{message: string}>>} containing mesasge data
   */
  function fetchLanguage(language) {
    if (!language) {
      return Promise.reject('invalid language');
    }
    var p = locales[language];
    if (!p) {
      p = locales[language] = new Promise(function(resolve, reject) {
        var url = I18nMsg.messagesPath + language + '.json';

        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);
        xhr.onload = function(e) {
          if (e.target.status != 200) {
            reject('message JSON not found: ' + e.target.status);
            return;
          }
          var resp = JSON.parse(e.target.response);
          if (resp) {
            resolve(resp);
          } else {
            reject('empty message JSON for: ' + language);
          }
        };
        xhr.send();
      });
    }
    return p;
  }


  Polymer({
    is: 'i18n-msg',

    properties: {
      language: {
        observer: '_change',
        value: function() {
          return I18nMsg.lang;
        }
      },

      /**
       * The message id (key) for this message.
       */
      msgid: {
        observer: '_change',
        value: null,
        reflectToAttribute: true
      }
    },

    ready: function() {
      if (!window.DEV) {
        throw new Error('i18n-msg not used outside dev');
      }
    },

    _change: function() {
      // TODO(samthor): language and msgid change simultaneously on start, so
      // we get two pending Promise objects. This is probably fine.
      var language = this.language;
      fetchLanguage(this.language).then(function(resp) {
        if (this.language != language) {
          return;  // language changed while resolving
        }
        var msg = resp[this.msgid];
        if (msg && msg.message) {
          Polymer.dom(this).innerHTML = msg.message;
        } else {
          console.warn('"' + this.msgid + '" message id was not found');
        }
      }.bind(this));
    }

  });

}());
</script>
</dom-module>
