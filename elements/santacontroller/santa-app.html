<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../../components/core-a11y-keys/core-a11y-keys.html">
<link rel="import" href="../santa-tracker-router.html">
<link rel="import" href="../preloader/preload-overlay.html">
<link rel="import" href="../calendar/calendar-nav.html">
<link rel="import" href="../lazy-pages.html">

<link rel="import" href="dependencies.html">

<!--
Santa Track app.

@element santa-app
-->
<polymer-element name="santa-app" tabindex="0">
<template>
  <!-- keyboard handler -->
  <core-a11y-keys target="{{}}" keys="esc" on-keys-pressed="{{keyHandler}}"></core-a11y-keys>

  <!-- Route controller -->
  <santa-tracker-router route="{{route}}" sceneParams="{{sceneParams}}" autoHash></santa-tracker-router>

  <!-- Preloading scene overlay -->
  <preload-overlay id="preloader" value="{{selectedScene.preloadProgress || 0}}"
                   active?="{{selectedScene && !selectedScene.loaded}}"></preload-overlay>

  <lazy-pages id="lazypages" selected="{{route}}" selectedItem="{{selectedScene}}" valueattr="route"
              santaApp="{{}}" preloader="{{$.preloader}}">

    <template if="{{mode != 'cast'}}">
      <calendar-nav route="calendar" alwaysActive
          houses="{{houses}}" santaApp="{{}}" mode="{{mode}}"></calendar-nav>
    </template>

    <village-scene route="village"
        path="scenes/village/village-scene_[[language]].html"
        mode="{{mode}}" hidden></village-scene>

    <airport-scene route="airport"
        path="scenes/airport/airport-scene_[[language]].html"
        hidden></airport-scene>

    <boatload-scene route="boatload"
        path="scenes/boatload/boatload-scene_[[language]].html"
        loadingBgColor="#8fd7f7"
        loadingSrc="scenes/boatload/img/loading.svg" hidden></boatload-scene>

    <briefing-scene route="briefing"
        path="scenes/briefing/briefing-scene_[[language]].html"
        hidden></briefing-scene>

    <codelab-scene route="codelab"
        path="scenes/codelab/codelab-scene_[[language]].html"
        loadingBgColor="#3F4EA1"
        loadingSrc="scenes/codelab/img/loading.svg" hidden></codelab-scene>

    <commandcentre-scene route="commandcentre"
        path="scenes/commandcentre/commandcentre-scene_en.html"
        loadingBgColor="rgb(129,208,0)" hidden></commandcentre-scene>

    <gumball-scene route="gumball"
        path="scenes/gumball/gumball-scene_[[language]].html"
        loadingBgColor="#8d23a9"
        loadingSrc="scenes/gumball/img/loading.svg" hidden></gumball-scene>

    <jamband-scene route="jamband"
        path="scenes/jamband/jamband-scene_[[language]].html"
        loadingBgColor="#fdbe27"
        loadingSrc="scenes/jamband/img/loading.svg" hidden></jamband-scene>

    <jetpack-scene route="jetpack"
        path="scenes/jetpack/jetpack-scene_[[language]].html"
        loadingBgColor="#8fd7f7"
        loadingSrc="scenes/jetpack/img/loading.svg" hidden></jetpack-scene>

    <matching-scene route="matching"
        path="scenes/matching/matching-scene_[[language]].html"
        loadingBgColor="#b27644"
        loadingSrc="scenes/matching/img/loading.svg" hidden></matching-scene>

    <mercator-scene route="mercator"
        path="scenes/mercator/mercator-scene_[[language]].html"
        loadingBgColor="#fbbf2c"
        loadingSrc="scenes/mercator/img/loading.svg" hidden></mercator-scene>

    <presentdrop-scene route="presentdrop"
        path="scenes/presentdrop/presentdrop-scene_[[language]].html"
        loadingBgColor="#8fd7f7"
        loadingSrc="scenes/presentdrop/img/loading.svg" hidden></presentdrop-scene>

    <racer-scene route="racer"
        path="scenes/racer/racer-scene_[[language]].html"
        loadingBgColor="#8fd7f7"
        loadingSrc="scenes/racer/img/loading.svg" hidden></racer-scene>

    <santaselfie-scene route="santaselfie"
        path="scenes/santaselfie/santaselfie-scene_[[language]].html"
        loadingBgColor="#83D7F5"
        loadingSrc="scenes/santaselfie/img/loading.svg" hidden></santaselfie-scene>

    <workshop-scene route="workshop"
        path="scenes/workshop/workshop-scene.html"
        hidden></workshop-scene>

    <windtunnel-scene route="windtunnel"
        path="scenes/windtunnel/windtunnel-scene.html"
        hidden></windtunnel-scene>

    <rollercoaster-scene route="rollercoaster"
        path="scenes/rollercoaster/rollercoaster-scene.html" hidden></rollercoaster-scene>

    <undersea-scene route="undersea"
        path="scenes/undersea/undersea-scene.html" hidden></undersea-scene>

    <traditions-scene route="traditions"
        path="scenes/traditions/traditions-scene_[[language]].html"
        loadingBgColor="rgb(255,224,0)"
        loadingSrc="scenes/traditions/img/loading{{hdpi ? '_2x' : ''}}.gif"
        mode="{{mode}}" hidden></traditions-scene>

    <tracker-scene route="tracker"
        path="scenes/tracker/tracker-scene_[[language]].html"
        hidden></tracker-scene>

    <trailer-scene route="trailer"
        path="scenes/trailer/trailer-scene_[[language]].html"
        hidden></trailer-scene>

    <about-scene route="about"
        path="scenes/about/about-scene_[[language]].html"
        hidden></about-scene>

  </lazy-pages>
</template>
<script>
(function() {

var DEFAULT_ROUTE_ = 'village';
var TRACKER_ROUTE_ = 'tracker';
var VALID_ROUTES_ = [];

// Routes/scenes which should always be accessible, no matter what the day.
// These scenes are also not removed from the lazy-page switching.
var PERMANENT_ROUTES_ = ['village', 'calendar', 'about'];

// Check if date1 is the same date as date2.
function isSameDay_(date1, date2) {
  return date1.getMonth() == date2.getMonth() &&
         date1.getDate() == date2.getDate() &&
         date1.getYear() == date2.getYear();
}

Polymer(Polymer.mixin({

  /**
   * When Santa's flight is finished.
   *
   * @property countDownEndDate
   * @type number
   * @default null
   */
  countDownEndDate: null,

  /**
   * When Santa's flight is finished.
   *
   * @property FLIGHT_FINISHED
   * @type number
   * @default null
   * @const
   */
  FLIGHT_FINISHED: null,

  /**
   * The house meta data shared across scenes.
   *
   * @property houses
   * @type array
   * @default []
   */
  houses: [],

  /**
   * If the browser is hdpi.
   * @property
   * @type boolean
   * @default false
   */
  hdpi: 'devicePixelRatio' in window && devicePixelRatio > 1.5 || false,

  /**
   * The current language locale.
   *
   * @property language
   * @type string
   * @default 'en'
   */
  language: document.documentElement.lang || 'en',

  /**
   * The currently open scene.
   *
   * @property selectedScene
   * @type Element
   * @default null
   */
  selectedScene: null,

  /**
   * The previously selected scene route.
   *
   * @attribute prevSelectedRoute
   * @type string
   * @default null
   */
  prevSelectedRoute: null,

  /**
   * Current URL route.
   *
   * @attribute route
   * @type string
   * @default null
   */
  route: null,

  /**
   * Analytics service.
   *
   * @property analyticsService
   * @type Analytics
   * @default null
   */
  analyticsService: null,

  /**
   * Page/Scene visibility manager.
   *
   * @property visibilityService
   * @type VisiblityManager
   * @default null
   */
  visibilityService: null,

  /**
   * The mode of the scene. Possible values are: 'cast' or 'embed'.
   *
   * @property mode
   * @type string
   * @default ''
   */
  mode: '',

  /**
   * True when Santa's schedule has been checked for the first time.
   *
   * @property scheduleChecked
   * @type bool
   * @default false
   */
  scheduleChecked: false,

  publish: {
    /**
     * True when the countdown is complete.
     *
     * @attribute postCountdown
     * @type bool
     * @default false
     */
    postCountdown: {value: false, reflect: true},

    /**
     * True when Santa's flight has is complete.
     *
     * @attribute postFlight
     * @type bool
     * @default false
     */
    postFlight: {value: false, reflect: true},
  },

  eventDelegates: {
    'iframe-focus-change': 'onIframeFocusChange',
    'analytics-track-event': 'trackEvent',
    'analytics-track-perf': 'trackPerf',
    'analytics-time-start': 'timeStart',
    'analytics-time-end': 'timeEnd',
    'analytics-track-social': 'trackSocial',
    'analytics-track-game-start': 'trackGameStart',
    'analytics-track-game-quit': 'trackGameQuit',
    'analytics-track-game-over': 'trackGameOver'
  },

  ready: function() {
    // silence the noisy things
    if (!window.DEV) {
      console.log = function(){};
    }

    this.analyticsService = new Analytics();
    this.visibilityService = new VisibilityManager(this);
    this.visibilityService.addOnPauseListener(this.onPause.bind(this));
    this.visibilityService.addOnResumeListener(this.onResume.bind(this));

    this.houses = window.HOUSES;
    this.config = window.SANTA_CONFIG;
    delete window.HOUSES; // cleanup
    delete window.SANTA_CONFIG; // cleanup

    this.countDownEndDate = this.config.COUNTDOWN_END_DATE;
    this.FLIGHT_FINISHED = this.config.FLIGHT_FINISHED;

    var apiClient = getUrlParameter('api_client') || 'web';
    if (!apiClient.match(/^[a-zA-Z_]*$/)) {
      apiClient = 'web';
    }

    var loadSound = true;

    switch (apiClient) {
      case 'web_chromecast':
        this.mode = 'cast';
        this.initChromecast();
        loadSound = false;

        // disable any houses not suitable for cast
        for (var i = 0; i < this.houses.length; i++) {
          this.houses[i].disabled =
              this.houses[i].disabled || !this.houses[i].cast;
        }
        break;
      case 'web_embed':
        this.mode = 'embed';
        loadSound = false;
        break;
      default:
        break;
    }

    if (loadSound) {
      var sc = new SoundController(this.soundsLoaded.bind(this));
      this.addEventListener('sound-preload', sc.loadSounds.bind(sc));
      this.addEventListener('sound-ambient', sc.playAmbientSounds.bind(sc));
      this.addEventListener('sound-trigger', sc.playSound.bind(sc));
    }

    // Initialize routes.
    VALID_ROUTES_ = this.$.lazypages.items.map(function(el) {
      // Note: can't use .route b/c some scene elements won't be upgraded yet.
      return el.getAttribute('route');
    });

    this.santaService = new SantaService(apiClient, this.language);
    this.santaService.sync(this.checkSchedule_.bind(this));
    this.santaService.addListener('kill', function() {
      window.location = 'https://santatracker.google.com' +
          location.pathname.replace(/[^\/]*$/, '') + 'error.html';
    });

    // Disable Google Play house on iOS devices
    if (navigator.userAgent.match(/iPhone|iPod|iPad/i)) {
      if (this.houses[3].module === 'app') {
        this.houses[3].disabled = true;
      }
    }

    if (!this.route) {
      this.checkSchedule_();
      this.route = this.postCountdown ? TRACKER_ROUTE_ : DEFAULT_ROUTE_;
    }
  },

  languageChanged: function() {
    this.santaService.lang_ = this.language;
  },

  selectedSceneChanged: function(oldVal, newVal) {
    if (oldVal) {
      this.prevSelectedRoute = oldVal.route;
    }
    // If there are scene params in the URL, let the selected scene know.
    if (Object.keys(this.sceneParams).length) {
      this.selectedScene.sceneParams = this.sceneParams;
    }
  },

  prevSelectedRouteChanged: function() {
    // Only remove certain elements from the DOM.
    var dontRemoveEl = PERMANENT_ROUTES_.indexOf(this.prevSelectedRoute) != -1;
    if (dontRemoveEl) {
      return;
    }

    var prevSelectedScene = null;
    for (var i = 0, scene; scene = this.$.lazypages.items[i]; ++i) {
      if (scene.route == this.prevSelectedRoute) {
        prevSelectedScene = scene;
        break;
      }
    }

    // Remove previous scene if it shouldn't always be active.
    if (!prevSelectedScene.alwaysActive) {
      prevSelectedScene.parentNode.removeChild(prevSelectedScene);

      // Re-construct removed scene and add it back to lazy-pages.
      var el = document.createElement(prevSelectedScene.localName);
      el.route = prevSelectedScene.route;
      el.path = prevSelectedScene.path;
      el.mode = this.mode;
      el.hidden = true;
      el.santaApp = this;
      el.loaded = true;

      this.$.lazypages.appendChild(el);
    }
  },

  routeChanged: function() {
    // Check if the new route needs a special-case redirect or if it is valid.
    // If this changes the route, routeChanged() will be called again, repeating
    // until this.route passes through validateRoute() successfully.
    var requestedRoute = this.route;
    switch (requestedRoute) {
      case 'tourist':
        // tourist and trailer are synonymous
        this.route = 'trailer';
        break;
      case 'gumballs':
        this.route = 'gumball';
        break;
      default:
        this.validateRoute();
    }

    if (requestedRoute === this.route) {
      // Route is valid. Send to analytics and load the scene.
      this.trackPageview('/' + this.route);
    } else if (requestedRoute !== '') {
      // The requested route was changed.
      this.fire('analytics-track-event', { category: 'Routing',
          action: 'Invalid Route', label: '/' + requestedRoute});
    }
  },

  validateRoute: function() {
    if (this.scheduleChecked) {
      var valid = (VALID_ROUTES_.indexOf(this.route) != -1 &&
                   this.sceneIsUnlocked(this.route)) ||
                   (this.postCountdown && this.route == TRACKER_ROUTE_);
      if (!valid) {
        this.route = this.postCountdown ? TRACKER_ROUTE_ : DEFAULT_ROUTE_;
      }
    }
  },

  onPause: function() {
    this.fire('sound-ambient', 'global_blur');
    this.fire('sound-ambient', 'global_pause');
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('scene-pause', true);
    }
  },

  onResume: function() {
    this.fire('sound-ambient', 'global_focus');
    this.fire('sound-ambient', 'global_unpause');
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('scene-pause', false);
    }
  },

  soundsLoaded: function(soundsName) {
    // TODO(bckenny): selectedScene.fire check may be unecessary as it's not
    // clear if it's possible for selectedScene to not be upgraded by this point
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('sounds-loaded', soundsName);
    }
  },

  trackPageview: function(path) {
    this.analyticsService.trackPageView(path);
  },

  trackEvent: function(e, detail, sender) {
    this.analyticsService.trackEvent(
        detail.category, detail.action, detail.label);
  },

  trackPerf: function(e, detail, sender) {
    this.analyticsService.trackPerf(
        detail.category, detail.variable, detail.time, detail.label, detail.maxTime);
  },

  timeStart: function(e, detail, sender) {
    this.analyticsService.timeStart(
        detail.category, detail.variable, detail.time);
  },

  timeEnd: function(e, detail, sender) {
    this.analyticsService.timeEnd(
        detail.category, detail.variable, detail.time, detail.label, detail.maxTime);
  },

  trackSocial: function(e, detail, sender) {
    this.analyticsService.trackSocial(
        detail.network, detail.action, detail.target);
  },

  trackGameStart: function(e, detail, sender) {
    this.analyticsService.trackGameStart(detail.gameid);
  },

  trackGameQuit: function(e, detail, sender) {
    this.analyticsService.trackGameQuit(detail.gameId, detail.timePlayed);
  },

  trackGameOver: function(e, detail, sender) {
    this.analyticsService.trackGameOver(
        detail.gameId, detail.score, detail.level, detail.timePlayed);
  },

  onIframeFocusChange: function(e, detail, sender) {
    if (detail === 'blur') {
      this.visibilityService.pauseIframe();
    } else if (detail === 'focus') {
      this.visibilityService.resumeIframe();
    }
  },

  /**
   * When the flight finishes, redirect the user to the village.
   */
  postFlightChanged: function() {
    // TODO(lukem): lock houses that need locking.
  },

  /**
   * When the countdown finishes, redirect the user to the tracker.
   */
  postCountdownChanged: function() {
    if (this.santaService.now() > this.FLIGHT_FINISHED) {
      this.postFlight = true;
      return;
    }

    if (document.body.classList.contains('posttakeoff')) {
      return;
    }

    document.body.classList.add('posttakeoff');
  },

  /**
   * @param number index
   */
  unlockHouse: function(idx) {
    var house = this.houses[idx];
    if (!house) {
      return;
    }

    // house is melted unless it's disabled
    house.iced = house.disabled;
  },

  unlockAllHouses: function() {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      this.unlockHouse(i);
      house.today = false;
      house.tomorrow = false;
    }
  },

  lockAllHouses: function() {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      house.iced = true;
      house.today = false;
      house.tomorrow = false;
    }
  },

  sceneIsUnlocked: function(moduleName) {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      if (house.module === moduleName) {
        return !house.disabled && (this.santaService.now() > house.launchDate);
      }
    }

    // Certain scenes don't have associated houses. Whitelist them.
    if (PERMANENT_ROUTES_.indexOf(moduleName) != -1) {
      return true;
    }

    return false;
  },

  /**
   * Unlocks the correct houses based on the day (index).
   * @private
   */
  checkSchedule_: function() {
    var todayDate = this.santaService.dateNow();
    var tomorrowDate = new Date(todayDate);
    tomorrowDate.setDate(todayDate.getDate() + 1);

    // Set post countdown/post flight flags based on current time.
    if (todayDate > this.countDownEndDate) {
      if (todayDate < this.FLIGHT_FINISHED) {
        this.postCountdown = true;
      } else {
        this.postFlight = true;
      }
    }

    switch(todayDate.getMonth()) {
      case 11: // DECEMBER
        // Update house status based on today's date.
        for (var i = 0; i < this.houses.length; i++) {
          var house = this.houses[i];

          if (house.launchDate <= todayDate) {
            this.unlockHouse(i);
            house.today = isSameDay_(house.launchDate, todayDate);
            house.tomorrow = false;
          } else {
            house.iced = true;
            house.today = false;
            house.tomorrow = isSameDay_(house.launchDate, tomorrowDate);
          }
        }
        break;
      case 0: // JAN
        // All houses in Jan are unlocked. Full experience baby!
        this.unlockAllHouses();
        break;
      default:
        // noop
        this.lockAllHouses();
    }

    this.scheduleChecked = true;
    this.validateRoute();

    // Check again at the next hour tick.
    var timeTillHour = (60 - todayDate.getMinutes()) * 60 * 1000;
    this.scheduleTimeout_ = this.async(this.checkSchedule_, null, timeTillHour);
  },

  keyHandler: function(e, detail, sender) {
    switch(e.detail.key) {
      case 'esc':
        this.route = 'village';
        break;
    }
  }

}, chromecastMixin));

})();
</script>
</polymer-element>
