<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../../components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../santa-chrome/santa-chrome.html">
<link rel="import" href="../santa-tracker-router.html">
<link rel="import" href="../preloader/preload-overlay.html">
<link rel="import" href="../lazy-pages.html">
<link rel="import" href="../santa-strings.html">

<script src="../../js/config/houses.js"></script>
<script src="../../js/config/videos.js"></script>

<!--
Santa Tracker app.
-->
<dom-module id="santa-app">
<template>
  <!-- Shared i18n strings -->
  <santa-strings id="strings"></santa-strings>

  <!-- Global singleton state -->
  <santa-state during-tracker="{{duringTracker}}" current-time="{{currentTime}}"></santa-state>

  <!-- Keyboard handler -->
  <iron-a11y-keys keys="esc" on-keys-pressed="_escHandler"></iron-a11y-keys>

  <!-- Preloading scene overlay -->
  <preload-overlay id="preloader"></preload-overlay>

  <!-- Route controller -->
  <santa-tracker-router id="router" route="{{route}}" scene-params="{{sceneParams}}" auto-hash></santa-tracker-router>

  <!-- Chrome, including toolbar and sidebar -->
  <santa-chrome id="chrome"
      mode$="[[mode]]"
      disabled="[[omitSantaChrome(mode)]]"
      tracker-unlocked="[[duringTracker]]"
      today-house="[[todayHouse]]"
      mute="{{userMute}}"
      pause="{{userPause}}">

    <!-- Scenes -->
    <lazy-pages id="lazypages"
        selected="{{route}}"
        selected-item="{{selectedScene}}"
        selectable=":not([disabled])"
        attr-for-selected="route"
        selected-attribute="active">

      <dorf-scene id="village" route="village" icon="1f384" permament
          during-tracker="[[duringTracker]]"
          today-house="[[todayHouse]]"
          houses="[[_houses]]"
          mode$="[[mode]]"
          path$="scenes/dorf/dorf-scene_[[language]].html"
          class="santa-scene" allow-page-scrolling></dorf-scene>

      <!-- Keep scenes (non-village) ordered alphabetically -->

      <about-scene route="about" icon="2753" permament
          path$="scenes/about/about-scene_[[language]].html"
          header-color="rgb(39, 186, 131)"
          class="santa-scene" allow-page-scrolling></about-scene>

      <airport-scene route="airport" icon="1f6c4"
          path$="scenes/airport/airport-scene_[[language]].html"
          header-color="#fdbe27"
          class="santa-scene"></airport-scene>

      <blimp-scene route="blimp" icon="1f6a1"
          path$="scenes/blimp/blimp-scene_[[language]].html"
          header-color="#575769"
          class="santa-scene"></blimp-scene>

      <boatload-scene route="boatload" icon="26f5"
          path$="scenes/boatload/boatload-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/boatload/img/loading.svg"
          class="santa-scene"></boatload-scene>

      <briefing-scene route="briefing" icon="1f3eb"
          path$="scenes/briefing/briefing-scene_[[language]].html"
          header-color="#007ab6"
          class="santa-scene"></briefing-scene>

      <callfromsanta-scene route="callfromsanta" icon="1f4de" disabled
          path$="scenes/callfromsanta/callfromsanta-scene.html"
          mute="[[userMute]]"
          loading-bg-color="rgb(129,208,0)"
          class="santa-scene"></callfromsanta-scene>

      <citylights-scene route="citylights" icon="1f306"
          path$="scenes/citylights/citylights-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#575769"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/citylights/img/loading.svg"
          class="santa-scene"></citylights-scene>

      <codeboogie-scene route="codeboogie" icon="1f4dd"
          path$="scenes/codeboogie/codeboogie-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#9a519f"
          loading-bg-color="#3f4ea1"
          loading-src="scenes/codeboogie/img/loading.svg"
          class="santa-scene"></codeboogie-scene>

      <codelab-scene route="codelab" icon="1f4dd"
          path$="scenes/codelab/codelab-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#9a519f"
          loading-bg-color="#3f4ea1"
          loading-src="scenes/codelab/img/loading.svg"
          class="santa-scene"></codelab-scene>

      <commandcentre-scene route="commandcentre" icon="1f5fc"
          path$="scenes/commandcentre/commandcentre-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#575769"
          loading-bg-color="rgb(129,208,0)"
          class="santa-scene"></commandcentre-scene>

      <factory-scene route="factory" icon="1f3ed"
          path$="scenes/factory/factory-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"
          class="santa-scene"></factory-scene>

      <glider-scene route="glider" icon="1f343"
          path$="scenes/glider/glider-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#675ab9"
          loading-bg-color="#8d23a9"
          loading-src="scenes/glider/img/loading.svg"
          class="santa-scene"></glider-scene>

      <gumball-scene route="gumball" icon="1f36d"
          path$="scenes/gumball/gumball-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#fdbe27"
          loading-bg-color="#8d23a9"
          loading-src="scenes/gumball/img/loading.svg"
          class="santa-scene"></gumball-scene>

      <icecave-scene route="icecave" icon="2744"
          path$="scenes/icecave/icecave-scene_[[language]].html"
          class="santa-scene"></icecave-scene>

      <island-scene route="island" icon="1f334"
          path$="scenes/island/island-scene_[[language]].html"
          header-color="#1da1a1"
          class="santa-scene"></island-scene>

      <jamband-scene route="jamband" icon="1f3b6"
          path$="scenes/jamband/jamband-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#fdbe27"
          loading-bg-color="#fdbe27"
          loading-src="scenes/jamband/img/loading.svg"
          class="santa-scene"></jamband-scene>

      <jetpack-scene route="jetpack" icon="1f680"
          path$="scenes/jetpack/jetpack-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#9a519f"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/jetpack/img/loading.svg"
          class="santa-scene"></jetpack-scene>

      <latlong-scene route="latlong" icon="1f3af"
          path$="scenes/latlong/latlong-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#76b1cc"
          loading-bg-color="#ffcc00"
          loading-src="scenes/latlong/img/loading.svg"
          class="santa-scene"></latlong-scene>

      <matching-scene route="matching" icon="1f6aa"
          path$="scenes/matching/matching-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#76b1cc"
          loading-bg-color="#b27644"
          loading-src="scenes/matching/img/loading.svg"
          class="santa-scene"></matching-scene>

      <mercator-scene route="mercator" icon="1f30e"
          path$="scenes/mercator/mercator-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#fbbf2c"
          loading-src="scenes/mercator/img/loading.svg"
          class="santa-scene"></mercator-scene>

      <playground-scene route="playground" icon="1f3aa"
          path$="scenes/playground/playground-scene_[[language]].html"
          header-color="#575769"
          loading-bg-color="rgb(251, 191, 44)"
          class="santa-scene"></playground-scene>

      <postcard-scene route="postcard" icon="1f4ec"
          path$="scenes/postcard/postcard-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="rgb(244, 123, 32)"
          loading-bg-color="rgb(244, 123, 32)"
          loading-src="scenes/postcard/img/loading.gif"
          class="santa-scene"></postcard-scene>

      <postcardly-scene route="postcardly"
          path$="scenes/postcardly/postcardly-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"
          class="santa-scene"></postcardly-scene>

      <presentdrop-scene route="presentdrop" icon="1f381"
          path$="scenes/presentdrop/presentdrop-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#b4b6b9"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/presentdrop/img/loading.svg"
          class="santa-scene"></presentdrop-scene>

      <presentbounce-scene route="presentbounce" icon="1f381"
          path$="scenes/presentbounce/presentbounce-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#e53935"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/presentbounce/img/loading.svg"
          class="santa-scene"></presentbounce-scene>

      <racer-scene route="racer" icon="1f3c1"
          path$="scenes/racer/racer-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/racer/img/loading.svg"
          class="santa-scene"></racer-scene>

      <runner-scene route="runner" icon="1f3c7"
          path$="scenes/runner/runner-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#575769"
          class="santa-scene"></runner-scene>

      <rollercoaster-scene route="rollercoaster" icon="1f3a2"
          path$="scenes/rollercoaster/rollercoaster-scene.html"
          class="santa-scene"></rollercoaster-scene>

      <santasearch-scene route="santasearch" icon=""
          path$="scenes/santasearch/santasearch-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#00904a"
          loading-bg-color="#29B6F6"
          loading-src="scenes/santasearch/img/loading.svg"
          class="santa-scene"></santasearch-scene>

      <santaselfie-scene route="santaselfie" icon="1f488"
          path$="scenes/santaselfie/santaselfie-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#4172e8"
          loading-bg-color="#83D7F5"
          loading-src="scenes/santaselfie/img/loading.svg"
          class="santa-scene"></santaselfie-scene>

      <seasonofgiving-scene route="seasonofgiving" icon="1f3ee"
          path$="scenes/seasonofgiving/seasonofgiving-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#09904a"
          loading-src="scenes/seasonofgiving/img/loading.svg"
          class="santa-scene"></seasonofgiving-scene>

      <smatch-scene route="smatch"
          path$="scenes/smatch/smatch-scene_[[language]].html"
          header-color="#09904a"
          loading-bg-color="rgb(129,208,0)"
          class="santa-scene"></smatch-scene>

      <streetview-scene route="streetview" icon="1f3a5"
          path$="scenes/streetview/streetview-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"
          class="santa-scene"></streetview-scene>

      <tracker-scene id="tracker" route="tracker" icon="1f30d"
          path$="scenes/tracker/tracker-scene_[[language]].html"
          class="santa-scene"
          allow-page-scrolling></tracker-scene>

      <traditions-scene route="traditions" icon="1f4cc"
          path$="scenes/traditions/traditions-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#fdbe27"
          loading-bg-color="rgb(255,224,0)"
          loading-src="scenes/traditions/img/loading.gif"
          class="santa-scene"></traditions-scene>

      <translations-scene route="translations" icon="1f4e2"
          path$="scenes/translations/translations-scene_[[language]].html"
          header-color="#558b2f"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/translations/img/loading.png"
          class="santa-scene"></translations-scene>

      <trivia-scene route="trivia"
          path$="scenes/trivia/trivia-scene_[[language]].html"
          class="santa-scene"></trivia-scene>

      <undersea-scene route="undersea" icon="1f30a"
          path$="scenes/undersea/undersea-scene_[[language]].html"
          header-color="#ba594e"
          class="santa-scene"></undersea-scene>

      <template is="dom-repeat" items="[[_computeVideoRoutes(videos)]]">
        <video-scene route$="[[item]]" icon="1f4fd"
            youtube-id$="[[_computeVideoId(videos, item)]]"
            mode$="[[mode]]"
            mute="[[userMute]]"
            pause="[[userPause]]"
            header-color="#ec4582"
            path="scenes/videoscene/video-scene.html"
            class="santa-scene"></video-scene>
      </template>

      <windtunnel-scene route="windtunnel" icon="1f38f"
          path$="scenes/windtunnel/windtunnel-scene_[[language]].html"
          header-color="#575769"
          loading-bg-color="rgb(129,208,0)"
          class="santa-scene"></windtunnel-scene>

      <press-scene route="press" icon="1f4f0" permament
          path$="scenes/press/press-scene.html"
          class="santa-scene"
          allow-page-scrolling></press-scene>

    </lazy-pages>

  </santa-chrome>

</template>
<script>
(function() {

// Default title of Santa Tracker. Note that this is currently not localized.
var WINDOW_TITLE = 'Google Santa Tracker';

var TOOLBAR_DEFAULT_COLOR = '#00c6ed';  // also in css

var DEFAULT_ROUTE = 'village';
var TRACKER_ROUTE = 'tracker';

Polymer({
  is: 'santa-app',
  hostAttributes: {'tabindex': '0'},

  properties: {

    /**
     * The size of the header, if any. Used by games to adjust their size.
     */
    headerSize: {
      type: Number,
      readOnly: true,
      value: 44
    },

    /**
     * The house metadata, including unlock information.
     */
    _houses: {
      type: Array,
      value: function() {
        return [];
      }
    },

    /**
     * The house open today.
     */
    todayHouse: {
      type: String,
      value: '',
      notify: true
    },

    /**
     * Whether sounds are muted by the user.
     */
    userMute: {
      type: Boolean,
      observer: '_userMuteChanged',
    },

    /**
     * Whether the game is paused by the user. Only effects games that can actually be paused!
     */
    userPause: {
      type: Boolean,
      value: false,
    },

    /**
     * Whether the page is currently in the background.
     */
    pageInBackground: {
      type: Boolean,
      readOnly: true,
    },

    /**
     * Whether the current game should be paused (if it can be paused), based on (userPause ||
     * pageInBackground).
     */
    pause: {
      type: Boolean,
      computed: '_computePause(userPause, pageInBackground)',
      observer: '_pauseChanged',
    },

    /**
     * The current language locale. This is not modifable after launch; reload the site.
     */
    language: {
      type: String,
      readOnly: true,
      value: document.documentElement.lang || 'en'
    },

    /**
     * The currently open scene.
     */
    selectedScene: {
      type: Element,
      observer: '_selectedSceneChanged',
      value: null
    },

    /**
     * The previously selected scene route.
     */
    prevSelectedRoute: {
      type: String,
      observer: '_prevSelectedRouteChanged',
      value: null
    },

    /**
     * Current URL route.
     */
    route: {
      type: String,
      observer: '_routeChanged'
    },

    /** Whether the schedule is checked. If false, houses will remain unlocked. */
    scheduleChecked: {
      type: Boolean,
      value: !window.DEV,
      observer: '_scheduleCheckedChanged',
    },

    /**
     * Analytics service.
     */
    analyticsService: {
      type: Object
    },

    /**
     * The mode of Santa Tracker. Possible values are blank, 'cast', 'portal',
     * or 'embed'.
     *
     * 'portal': Portal mode indicates that Santa Tracker is being run in a web
     * kiosk or similar device.
     *
     * 'cast': Cast mode indicates that Santa Tracker is being run on a casted
     * device.
     *
     * 'embed': embed mode indicates that a Santa Tracker scene is being called
     * from within one of the native Santa Tracker frontends (e.g. Android/iOS
     * app).
     */
    mode: {
      type: String,
      value: ""
    },

    /**
     * True when the tracker intro scene was shown. Used by `tracker-scene`.
     */
    hasTrackerIntroShown: {
      type: Boolean,
      value: false
    },

    /**
     * List of video routes. Used for template binding.
     */
    videos: {
      type: Object,
      readOnly: true
    },

    /**
     * sceneParams from `santa-tracker-router`. Can't be changed; router
     * provides this as frozen and readOnly.
     */
    sceneParams: {
      type: Object,
      observer: 'sceneParamsChanged'
    },

    /**
     * True when the countdown is complete, and the tracker is active. Bound from `santa-state`.
     */
    duringTracker: {
      type: Boolean,
      observer: '_duringTrackerChanged',
    },

    /**
     * Current time as per the Santa API. Bound from `santa-state`. This is updated only every 15
     * minutes or when a shift is specified by the server.
     */
    currentTime: {
      type: Number,
      observer: '_currentTimeChanged',
    },

  },

  listeners: {
    'title-click': 'onDefaultAction',
    'scene-progress': 'onSceneProgress',
    'scene-ready': 'onSceneReady',
    'analytics-track-event': 'trackEvent',
    'analytics-time-start': 'timeStart',
    'analytics-time-end': 'timeEnd',
    'analytics-track-share': 'trackShare',
    'analytics-track-game-start': 'trackGameStart',
    'analytics-track-game-quit': 'trackGameQuit',
    'analytics-track-game-over': 'trackGameOver',
    'game-start': 'onStartGame',
    'game-stop': 'onStopGame',
    'share': 'onShare',
  },

  created: function() {
    // silence the noisy things
    if (!window.DEV) {
      console.log = function(){};
    }

    this.analyticsService = new Analytics();
  },

  ready: function() {
    this._houses = window.HOUSES;
    this._setVideos(Object.freeze(window.VIDEOS));
    delete window.HOUSES; // cleanup
    delete window.VIDEOS; // cleanup

    var apiClient = getUrlParameter('api_client') || 'web';
    if (!apiClient.match(/^[a-zA-Z_]*$/)) {
      apiClient = defaultApiClient;
    }
    switch (apiClient) {
      case 'web_portal':
        apiClient = 'web';
        this.mode = 'portal';
        break;
      case 'web_embed':
        apiClient = 'web';
        this.mode = 'embed'
        break;
    }

    var sc = new SoundController(this._soundsLoaded.bind(this));
    this.addEventListener('sound-preload', sc.loadSounds.bind(sc));
    this.addEventListener('sound-ambient', sc.playAmbientSounds.bind(sc));
    this.addEventListener('sound-trigger', sc.playSound.bind(sc));

    var handler = function() {
      this._setPageInBackground(document.hidden || false);
    }.bind(this);
    document.addEventListener('visibilitychange', handler);
    handler();

    this._prepareHouses();

    if (!this.route) {
      this.route = this.defaultRoute;
    }
  },

  detached: function() {
    throw new Error('santa-app was detached');
  },

  /**
   * Handles the title being clicked, or ESC being hit. Closes the drawer, or redirects to the
   * default route.
   */
  onDefaultAction: function() {
    var wasOpen = this.$.chrome.closeDrawer();
    if (!wasOpen) {
      this.$.router.go(this.defaultRoute);
    }
  },

  /**
   * Handles a loading progress hint, hiding or displaying the preloader.
   */
  onSceneProgress: function() {
    var scene = this.selectedScene;
    if (scene) {
      this.$.preloader.color = scene.getAttribute('loading-bg-color');
      this.$.preloader.src = scene.getAttribute('loading-src');
      this.$.preloader.active = !scene.loaded;
      this.$.preloader.value = scene.preloadProgress || 0;  // prevent undefined
    } else {
      this.$.preloader.active = false;
    }
  },

  /**
   * Called when a scene is initially ready (and not when it's made active a 2nd time).
   */
  onSceneReady: function(event, scene) {
    this.sceneParamsChanged(this.$.router.sceneParams);

    this._prepareScene(scene);
  },

  sceneParamsChanged: function(newValue) {
    // sceneParamsChanged might happen while a scene isn't ready yet, so wait
    // until it's upgraded. onSceneReady will be called then.
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.sceneParams = newValue;
    }
  },

  /**
   * Initializes all houses, setting their initial state of locked and disabled.
   */
  _prepareHouses: function() {
    var portalMode = this.mode === 'portal';
    var ios = navigator.userAgent.match(/iPhone|iPod|iPad/i);

    for (var i = 0, house; house = this._houses[i]; ++i) {
      house.disabled = false;
      house.locked = this.scheduleChecked;
      switch (house.module) {
        case 'app':
          // Disable Google Play house on iOS devices
          house.disabled |= (ios || portalMode);
          break;
      }
    }
  },

  get defaultRoute() {
    return this.duringTracker ? TRACKER_ROUTE : DEFAULT_ROUTE;
  },

  /**
   * Reset and update various bits of global state when a new scene is made visible.
   */
  _selectedSceneChanged: function(newValue, oldValue) {
    this.$.chrome.hasGameButtons = false;
    this.$.chrome.closeDrawer();
    this.userPause = false;

    if (oldValue && oldValue.route) {
      this.prevSelectedRoute = oldValue.route;
    }

    var scene = this.selectedScene;
    var allowPageScrolling = scene && scene.hasAttribute('allow-page-scrolling')

    // Allow scrolling body if scene requests it. Update `santa-chrome` to match.
    if (allowPageScrolling) {
      document.body.classList.remove('scrollock');
      this.$.chrome.classList.remove('fixed');
    } else {
      document.body.classList.add('scrollock');
      this.$.chrome.classList.add('fixed');
    }

    // Update custom colors.
    var color = this.colorForRoute(this.route);
    this.customStyle['--santa-toolbar-color'] = color;
    this.updateStyles();
    var meta = document.head.querySelector('meta[name="theme-color"]');
    if (meta) {
      meta.content = color || TOOLBAR_DEFAULT_COLOR;
    }

    // Optionally update the document title (with emoji/scene name).
    var raw = scene && scene.getAttribute('icon');
    var icon = '';
    if (raw && String.fromCodePoint) {  // no emoji on IE11
      icon = String.fromCodePoint(parseInt(raw, 16));
    }
    document.title = icon + WINDOW_TITLE;

    if (this.selectedScene && this.selectedScene.is) {
      this._prepareScene(this.selectedScene);
    }
  },

  /**
   * Called when a scene is brought to the foreground and is an upgraded Polymer element.
   */
  _prepareScene: function(scene) {
    // Intentionally empty.
  },

  _prevSelectedRouteChanged: function() {
    // Find and remove the previous scene, if it exists and isn't a permanent scene.
    var prevSelectedScene = this.$.lazypages.getRoute(this.prevSelectedRoute);
    if (!prevSelectedScene || prevSelectedScene.hasAttribute('permament')) {
      return;
    }
    var dom = Polymer.dom(this.$.lazypages);
    dom.removeChild(prevSelectedScene);

    // Re-construct removed scene and add it back to lazy-pages. Note that
    // loading-* isn't copied, since the element is already loaded.
    var el = document.createElement(prevSelectedScene.localName);
    el.route = prevSelectedScene.route;
    el.className = prevSelectedScene.className;
    el.santaApp = this;
    el.loaded = true;

    var retainAttr = [
      'route', 'mode', 'allow-page-scrolling', 'header-color', 'youtube-id'
    ];
    retainAttr.forEach(function(attr) {
      if (prevSelectedScene.hasAttribute(attr)) {
        el.setAttribute(attr, prevSelectedScene.getAttribute(attr));
      }
    });

    dom.appendChild(el);
  },

  _routeChanged: function(newValue) {
    if (this.validateRoute()) {
      // Route is valid. Send to analytics and load the scene.
      this.analyticsService.trackPageView('/' + newValue);
      return;
    }

    // The requested route was changed.
    var currentRoute = this.selectedScene ? this.selectedScene.route : '';
    this.fire('analytics-track-event', { category: 'Routing',
        action: 'Invalid Route Source', label: '/' + currentRoute});
    this.fire('analytics-track-event', { category: 'Routing',
        action: 'Invalid Route', label: '/' + newValue});
    this.route = this.defaultRoute;
  },

  /**
   * Returns whether the current route is valid.
   */
  validateRoute: function() {
    var sceneIsOpen = this.sceneIsOpen(this.route);
    if (typeof sceneIsOpen === 'boolean') {
      if (!sceneIsOpen && window.DEV) {
        console.debug('prod would redirect from', this.route, '=>', this.defaultRoute);
        return true;
      }
      return sceneIsOpen;
    }
    return this.$.lazypages.isValidRoute(this.route);
  },

  /** Handler for 'game-start' event. Shows the pause/restart buttons and starts the game. */
  onStartGame: function() {
    var scene = this.selectedScene;
    if (scene && 'pause' in scene) {
      this.$.chrome.hasGameButtons = true;
      scene.start();
    }
  },

  /** Handler for 'game-stop' event. Fired by the gameover shared JS component. */
  onStopGame: function() {
    this.$.chrome.hasGameButtons = false;
  },

  _computePause: function(userPause, pageInBackground) {
    return userPause || pageInBackground;
  },

  _pauseChanged: function(pause) {
    var scene = this.selectedScene;
    if (scene && 'pause' in scene) {  // nb. does it implement SantaSceneGameButtonsBehavior
      scene.pause = pause;
    }
  },

  _userMuteChanged: function(userMute) {
    // It's possible to confuse Klang, so dedup this with a very short delay.
    this.debounce('_userMute', function() {
      this.fire('sound-ambient', this.userMute ? 'global_sound_off' : 'global_sound_on');
    }, 50);
  },

  _soundsLoaded: function(soundsName) {
    // _soundsLoaded is typically invoked after a scene preloads audio, but the
    // scene may have changed in that time, so check upgraded state again.
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('sounds-loaded', soundsName);
    }
  },

  trackEvent: function(e, detail) {
    this.analyticsService.trackEvent(
        detail.category, detail.action, detail.label, detail.value);
  },

  timeStart: function(e, detail) {
    this.analyticsService.timeStart(
        detail.category, detail.variable, detail.time);
  },

  timeEnd: function(e, detail) {
    this.analyticsService.timeEnd(
        detail.category, detail.variable, detail.time, detail.label, detail.maxTime);
  },

  trackShare: function(e, detail) {
    this.analyticsService.trackSocial('share', detail || '', '/' + this.route);
  },

  trackGameStart: function(e, detail) {
    this.analyticsService.trackGameStart(detail.gameId || detail.gameid);
  },

  trackGameQuit: function(e, detail) {
    this.analyticsService.trackGameQuit(detail.gameId || detail.gameid,
        detail.level, detail.timePlayed);
  },

  trackGameOver: function(e, detail) {
    this.analyticsService.trackGameOver(
        detail.gameId || detail.gameid, detail.score, detail.level,
        detail.timePlayed);
  },

  unlockAllHouses: function() {
    this.scheduleChecked = false;
    for (var i = 0, house; house = this._houses[i]; ++i) {
      house.locked = false;
    }
    this._notifyHouses();
  },

  /**
   * Determines whether a given scene is open. This is a superset of unlocked, which is whether
   * the scene is visibily unlocked in the village. Scenes are open as soon as any place on Earth
   * matches the launch date (e.g., a scene is open for everyone as soon as someone in New Zealand
   * has access to it).
   *
   * @return {boolean=} true if open, false if not, or undefined if unknown
   */
  sceneIsOpen: function(moduleName) {
    if (this.currentTime === undefined) {
      return true;  // fail open before time ready
    } else if (moduleName === TRACKER_ROUTE && !this.duringTracker) {
      return false;  // special-case tracker, as it's open only when Santa is in flight
    }

    var targetOffset = -14 * (60 * 60000);  // UTC+14 is pretty far east
    var dateNow = new Date(this.currentTime);
    var userOffset = dateNow.getTimezoneOffset() * 60000;
    var eastDateNow = new Date(+dateNow + (userOffset - targetOffset));

    for (var i = 0, house; house = this._houses[i]; ++i) {
      if (house.module === moduleName) {
        if (house.disabled) {
          return false;
        } else if (!house.locked) {
          return true;
        }
        var launchDate = house.launchDate;
        if (santaApp.mode == 'portal' && house.portalLaunchDate) {
          launchDate = house.portalLaunchDate;
        }
        return eastDateNow > launchDate;
      }
    }

    return undefined;  // couldn't find this scene/house, defer to caller
  },

  _scheduleCheckedChanged: function() {
    if (this.scheduleChecked) {
      this._currentTimeChanged();
    } else {
      // nb. This doesn't immediately unlock any houses, instead it leaves the existing state.
    }
  },

  /**
   * Unlocks the correct houses based on the day (index).
   * @private
   */
  _currentTimeChanged: function() {
    var todayDate = new Date(this.currentTime);

    var todayHouse = '';

    switch (todayDate.getMonth()) {
      case 0:  // January
        // fall-through to December logic
      case 11: // December
        for (var i = 0, house; house = this._houses[i]; ++i) {
          var launchDate = house.launchDate;
          if (santaApp.mode == 'portal' && house.portalLaunchDate) {
            launchDate = house.portalLaunchDate;
          }
          if (isSameDay(launchDate, todayDate)) {
            todayHouse = house.module;
          }
          if (this.scheduleChecked) {
            house.locked = (launchDate > todayDate);
          }
        }
        break;
      default:
        if (this.scheduleChecked) {
          for (var i = 0, house; house = this._houses[i]; ++i) {
            house.locked = true;
          }
        }
        break;
    }
    this.todayHouse = todayHouse;
    this._notifyHouses();

    if (!this.validateRoute()) {
      this.route = this.defaultRoute;
    }
  },

  _escHandler: function(e, detail) {
    switch (e.detail.key) {
      case 'esc':
        this.onDefaultAction();
        break;
    }
  },

  _duringTrackerChanged: function(newValue, oldValue) {
    if (typeof oldValue === 'boolean' && typeof newValue === 'boolean') {
      this.$.router.go(this.defaultRoute);
    }
  },

  /**
   * Triggered on a request to share. Creates sharing popup for the specified service (passed as
   * detail of event).
   */
  onShare: function(e, service) {
    this.fire('analytics-track-share', service);

    // TODO(samthor): Use a URL shortener if something large is in the URL (e.g., encoded beard).
    var url = window.location.href;
    var title = this.$.strings.s('scene-' + this.route) ||
        this.$.strings.s('santatracker') || document.title;

    if (service == 'webshare' && navigator.share) {
      navigator.share({title: title, url: url});
      return;
    }

    var shareUrl = (function(url) {
      var enc = window.encodeURIComponent(url);
      switch (service) {
      case 'facebook':
        return 'https://facebook.com/sharer.php?p[url]=' + enc;
      case 'gplus':
        return 'https://plus.google.com/share?hl=' + this.language + '&url=' + enc;
      case 'twitter':
        return 'https://twitter.com/intent/tweet?lang=' + this.language +
            '&hashtags=santatracker&text=' + window.encodeURIComponent(title) + '&url=' + enc;
      }
    }.call(this, url));

    if (shareUrl) {
      var opts = 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width=800,height=600';
      window.open(shareUrl, '', opts);
    }
  },

  /**
   * Notifies bound properties that the houses have changed (useful for the
   * village). Dedups with a microtask.
   * @param {number=} opt_idx
   * @private
   */
  _notifyHouses: function(opt_idx) {
    this.debounce('_notifyHouses', function() {
      if (!this.$.village.is) {
        return;  // the village isn't yet a Polymer element, so ignore.
      }

      // TODO(samthor): Notify all properties that might change. Polymer 1.x+ cannot use O.o, and
      // there's no way to notify a whole house.
      var propertiesToNotify = ['locked', 'disabled', 'module', 'category'];

      this._houses.forEach(function(house, i) {
        var path = ['houses', i, ''];
        propertiesToNotify.forEach(function(property) {
          path[2] = property;
          this.$.village.notifyPath(path, house[property]);
        }, this);
      }, this);
    });
  },

  /**
   * Returns the (static) color for the given route. Returns the blank string if there is no color.
   */
  colorForRoute: function(route) {
    var el = this.$.lazypages.getRoute(route);
    return (el ? el.getAttribute('header-color') : '') || '';
  },

  omitSantaChrome: function(mode) {
    return mode == 'cast' || mode == 'embed';
  },

  /**
   * Converts the map of routes -> YouTube IDs to an array of routes.
   */
  _computeVideoRoutes: function(videos) {
    return Object.keys(videos);
  },

  /**
   * Converts the route to a YouTube ID.
   */
  _computeVideoId: function(videos, route) {
    return videos[route];
  },

});

})();
</script>
</dom-module>
