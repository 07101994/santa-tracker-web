<link rel="import" href="../../components/polymer/polymer.html">

<!-- Analytics -->
<script src="//www.google.com/js/gweb/analytics/autotrack.js"></script>

<!-- TODO; get rid of this. Really only need for getUrlParameter() -->
<script src="../../js/consts.js"></script>

<script src="../../js/analytics.js"></script>
<script src="../../js/visibilitymanager.js"></script>
<script src="../../js/soundcontroller.js"></script>
<script src="chromecast.js"></script>

<script src="../../js/statuses/picker.js"></script>

<!-- Santa API -->
<script src="../../js/service/events.js"></script>
<script src="../../js/service/lat_lng.js"></script>
<script src="../../js/service/spherical.js"></script>
<script src="../../js/service/details.js"></script>
<script src="../../js/service/location.js"></script>
<script src="../../js/service/state.js"></script>
<script src="../../js/service/transport.js"></script>
<script src="../../js/service/santa_client.js"></script>

<!-- Houses/pin metadata -->
<script src="../../js/houses.js"></script>

<!--
Santa Track app.

@element santa-app
-->
<polymer-element name="santa-app" attributes="language selectedScene"
                 on-analytics-track-event="{{trackEvent}}"
                 on-analytics-track-social="{{trackSocial}}"
                 on-analytics-track-game-start="{{trackGameStart}}"
                 on-analytics-track-game-quit="{{trackGameQuit}}"
                 on-analytics-track-game-over="{{trackGameOver}}">
<script>
(function() {

var COUNTDOWN_END_DATE_ = 1419415200000; // Dec 24, 2014

var FLIGHT_FINISHED_ = COUNTDOWN_END_DATE_ + 25 * 60 * 60 * 1000;

// Check if date1 is the same date as date2.
function isSameDay_(date1, date2) {
  return date1.getMonth() == date2.getMonth() &&
         date1.getDate() == date2.getDate() &&
         date1.getYear() == date2.getYear();
}

Polymer(Polymer.mixin({

  /**
   * When Santa's flight is finished.
   *
   * @property FLIGHT_FINISHED
   * @type number
   * @default COUNTDOWN_END_DATE + 25 * 60 * 60 * 1000
   * @const
   */
  FLIGHT_FINISHED: FLIGHT_FINISHED_,

  /**
   * The house meta data shared across scenes.
   *
   * @property houses
   * @type array
   * @default []
   */
   houses: [],

  /**
   * The current language locale.
   *
   * @attribute language
   * @type string
   * @default 'en'
   */
  language: document.documentElement.lang || 'en',

  /**
   * When Santa's flight is finished.
   *
   * @property countDownEndDate
   * @type number
   * @default 1419415200000
   */
   countDownEndDate: COUNTDOWN_END_DATE_,

  /**
   * The currently open scene.
   *
   * @attribute selectedScene
   * @type Element
   * @default null
   */
   selectedScene: null,

  /**
   * Analytics service.
   *
   * @property analyticsService
   * @type Analytics
   * @default null
   */
  analyticsService: null,

  /**
   * Page/Scene visibility manager.
   *
   * @property visibilityService
   * @type VisiblityManager
   * @default null
   */
  visibilityService: null,

  /**
   * The mode of the scene. Possible values are: 'cast'.
   *
   * @property mode
   * @type string
   * @default ''
   */
  mode: '',

  publish: {
    /**
     * True when the countdown is complete.
     *
     * @attribute postCountdown
     * @type bool
     * @default false
     */
    postCountdown: {value: false, reflect: true},

    /**
     * True when Santa's flight has is complete.
     *
     * @attribute postFlight
     * @type bool
     * @default false
     */
    postFlight: {value: false, reflect: true},
  },

  ready: function() {
    this.analyticsService = new Analytics();
    this.visibilityService = new VisibilityManager();

    this.houses = window.HOUSES;
    delete window.HOUSES; // cleanup

    this.language = getUrlParameter('hl') || this.language;

    var apiClient = getUrlParameter('api_client') || 'web';

    this.santaService = new SantaService(apiClient, this.language);
    this.santaService.addListener('kill', function() {
      window.location = 'error.html';
    });

    if (apiClient === 'web_chromecast') {
      this.mode = 'cast';
      this.initChromecast();
    } else {
      var sc = new SoundController();
      this.addEventListener('sound-preload', sc.loadSounds.bind(sc));
      this.addEventListener('sound-ambient', sc.playAmbientSounds.bind(sc));
      this.addEventListener('sound-trigger', sc.playSound.bind(sc));
    }

    if (this.santaService.now() > this.countDownEndDate) {
      if (this.santaService.now() < this.FLIGHT_FINISHED) {
        this.postCountdown = true;
      } else {
        this.postFlight = true;
      }
    }
  },

  languageChanged: function() {
    this.santaService.lang_ = this.language;
  },

  trackEvent: function(e, detail, sender) {
    this.analyticsService.trackEvent(
        detail.category, detail.action, detail.label);
  },

  trackSocial: function(e, detail, sender) {
    this.analyticsService.trackSocial(
        detail.network, detail.action, detail.target);
  },

  trackGameStart: function(e, detail, sender) {
    this.analyticsService.trackGameStart(detail.gameid);
  },

  trackGameQuit: function(e, detail, sender) {
    this.analyticsService.trackGameQuit(detail.gameId, detail.timePlayed);
  },

  trackGameOver: function(e, detail, sender) {
    this.analyticsService.trackGameOver(
        detail.gameId, detail.score, detail.level, detail.timePlayed);
  },

  /**
   * When the flight finishes, redirect the user to the village.
   */
  postFlightChanged: function() {
    // TODO(lukem): lock houses that need locking.
  },

  /**
   * When the countdown finishes, redirect the user to the tracker.
   */
  postCountdownChanged: function() {
    if (this.santaService.now() > this.FLIGHT_FINISHED) {
      this.postFlight = true;
      return;
    }

    if (document.body.classList.contains('posttakeoff')) {
      return;
    }

    document.body.classList.add('posttakeoff');
  },

  /**
   * @param number index
   */
  unlockHouse: function(idx) {
    var house = this.houses[idx];

    if (!house || house.disabled) {
      return;
    }

    house.iced = false;
  },

  unlockAllHouses: function() {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      this.unlockHouse(i);
      house.today = false;
      house.tomorrow = false;
    }
  },

  lockAllHouses: function() {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      house.iced = true;
      house.today = false;
      house.tomorrow = false;
    }
  },

  /**
   * Unlocks the correct houses based on the day (index).
   * @param {boolean=} opt_once check only once.
   * @private
   */
  checkSchedule_: function(opt_once) {
    var now = this.santaService ? this.santaService.now() : Date.now();

    var todayDate = new Date(now);
    var day = todayDate.getDate();

    // // Houses unlock at 6AM.
    // if (todayDate.getHours() < 6) {
    //   day--;
    // }

    switch(todayDate.getMonth()) {
      case 11: // DECEMBER
        // Unlock all houses up to and including today's.
        for (var i = 0; i <= day + 2; ++i) {
          var house = this.houses[i];

          if (house) {
            house.today = false; // reset previous houses.
            house.tomorrow = false;

            this.unlockHouse(i);

            // Check if house's unlocking date it today!
            if (isSameDay_(house.launchDate, todayDate)) {

              house.today = true;

              var nextHouse = this.houses[i + 1];
              if (nextHouse) {
                nextHouse.tomorrow = true;
              }
            }
          }
        }
        break;
      case 0: // JAN
        // All houses in Jan are unlocked. Full experience baby!
        this.unlockAllHouses();
        break;
      default:
        // noop
        this.lockAllHouses();
    }

    if (opt_once) {
      return;
    }

    // Check again at the next hour tick.
    var timeTillHour = (60 - todayDate.getMinutes()) * 60 * 1000;
    this.scheduleTimeout_ = this.async(this.checkSchedule_, null, timeTillHour);
  }

}, chromecastMixin));

})();
</script>
</polymer-element>
