<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../../components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../santa-chrome/santa-chrome.html">
<link rel="import" href="../santa-tracker-router.html">
<link rel="import" href="../preloader/preload-overlay.html">
<link rel="import" href="../lazy-pages.html">

<link rel="import" href="dependencies.html">

<!--
Santa Tracker app.
-->
<dom-module id="santa-app">
<template>
  <!-- Keyboard handler -->
  <iron-a11y-keys keys="esc" on-keys-pressed="_escHandler"></iron-a11y-keys>

  <!-- Preloading scene overlay -->
  <preload-overlay id="preloader"></preload-overlay>

  <!-- Route controller -->
  <santa-tracker-router id="router" route="{{route}}" scene-params="{{sceneParams}}" auto-hash></santa-tracker-router>

  <!-- Chrome, including toolbar and sidebar -->
  <santa-chrome id="chrome"
      mode$="{{mode}}"
      disabled="{{isCastMode(mode)}}"
      color="{{_colorForRoute(route, _houses)}}"
      tracker-unlocked="{{postCountdown}}"
      press-ready="{{pressReady}}"
      today-house="{{todayHouse}}"
      mute="{{userMute}}">

    <!-- Scenes -->
    <lazy-pages id="lazypages"
        preloader="[[preloader]]"
        selected="{{route}}"
        selected-item="{{selectedScene}}"
        selectable=":not([disabled])"
        attr-for-selected="route"
        selected-attribute="active">

      <dorf-scene route="village" always-active icon="1f384"
          id="village"
          mode$="{{mode}}"
          path$="scenes/dorf/dorf-scene_[[language]].html"></dorf-scene>

      <!-- Keep scenes (non-village) ordered alphabetically -->

      <about-scene route="about" icon="2753"
          path$="scenes/about/about-scene_[[language]].html"></about-scene>

      <airport-scene route="airport" icon="1f6c4"
          path$="scenes/airport/airport-scene_[[language]].html"></airport-scene>

      <blimp-scene route="blimp" icon="1f6a1"
          path$="scenes/blimp/blimp-scene_[[language]].html"></blimp-scene>

      <boatload-scene route="boatload" icon="26f5"
          path$="scenes/boatload/boatload-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/boatload/img/loading.svg"></boatload-scene>

      <briefing-scene route="briefing" icon="1f3eb"
          path$="scenes/briefing/briefing-scene_[[language]].html"></briefing-scene>

      <callfromsanta-scene route="callfromsanta" icon="1f4de"
          path$="scenes/callfromsanta/callfromsanta-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"></callfromsanta-scene>

      <citylights-scene route="citylights" icon="1f306"
          path$="scenes/citylights/citylights-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/citylights/img/loading.svg"></citylights-scene>

      <codelab-scene route="codelab" icon="1f4dd"
          path$="scenes/codelab/codelab-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#3f4ea1"
          loading-src="scenes/codelab/img/loading.svg"></codelab-scene>

      <commandcentre-scene route="commandcentre" icon="1f5fc"
          path$="scenes/commandcentre/commandcentre-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="rgb(129,208,0)"></commandcentre-scene>

      <factory-scene route="factory" icon="1f3ed"
          path$="scenes/factory/factory-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"></factory-scene>

      <glider-scene route="glider" icon="1f343"
          path$="scenes/glider/glider-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#8d23a9"
          loading-src="scenes/glider/img/loading.svg"></glider-scene>

      <gumball-scene route="gumball" icon="1f36d"
          path$="scenes/gumball/gumball-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#8d23a9"
          loading-src="scenes/gumball/img/loading.svg"></gumball-scene>

      <icecave-scene route="icecave" icon="2744"
          path$="scenes/icecave/icecave-scene_[[language]].html"></icecave-scene>

      <island-scene route="island" icon="1f334"
          path$="scenes/island/island-scene_[[language]].html"></island-scene>

      <jamband-scene route="jamband" icon="1f3b6"
          path$="scenes/jamband/jamband-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#fdbe27"
          loading-src="scenes/jamband/img/loading.svg"></jamband-scene>

      <jetpack-scene route="jetpack" icon="1f680"
          path$="scenes/jetpack/jetpack-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/jetpack/img/loading.svg"></jetpack-scene>

      <latlong-scene route="latlong" icon="1f3af"
          path$="scenes/latlong/latlong-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#ffcc00"
          loading-src="scenes/latlong/img/loading.svg"></latlong-scene>

      <matching-scene route="matching" icon="1f6aa"
          path$="scenes/matching/matching-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#b27644"
          loading-src="scenes/matching/img/loading.svg"></matching-scene>

      <mercator-scene route="mercator" icon="1f30e"
          path$="scenes/mercator/mercator-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#fbbf2c"
          loading-src="scenes/mercator/img/loading.svg"></mercator-scene>

      <playground-scene route="playground" icon="1f3aa"
          path$="scenes/playground/playground-scene_[[language]].html"
          loading-bg-color="rgb(251, 191, 44)"></playground-scene>

      <postcard-scene route="postcard" icon="1f4ec"
          path$="scenes/postcard/postcard-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="rgb(244, 123, 32)"
          loading-src="scenes/postcard/img/loading.gif"></postcard-scene>

      <presentdrop-scene route="presentdrop" icon="1f381"
          path$="scenes/presentdrop/presentdrop-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/presentdrop/img/loading.svg"></presentdrop-scene>

      <racer-scene route="racer" icon="1f3c1"
          path$="scenes/racer/racer-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/racer/img/loading.svg"></racer-scene>

      <runner-scene route="runner" icon="1f3c7"
          mode$="{{mode}}"
          path$="scenes/runner/runner-scene_[[language]].html"></runner-scene>

      <rollercoaster-scene route="rollercoaster" icon="1f3a2"
          path$="scenes/rollercoaster/rollercoaster-scene.html"></rollercoaster-scene>

      <santasearch-scene route="santasearch" icon=""
          path$="scenes/santasearch/santasearch-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#29B6F6"
          loading-src="scenes/santasearch/img/loading.svg"></santasearch-scene>

      <santaselfie-scene route="santaselfie" icon="1f488"
          path$="scenes/santaselfie/santaselfie-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="#83D7F5"
          loading-src="scenes/santaselfie/img/loading.svg"></santaselfie-scene>

      <seasonofgiving-scene route="seasonofgiving" icon="1f3ee"
          path$="scenes/seasonofgiving/seasonofgiving-scene_[[language]].html"
          mode$="{{mode}}"
          loading-src="scenes/seasonofgiving/img/loading.svg"></seasonofgiving-scene>

      <streetview-scene route="streetview" icon="1f3a5"
          path$="scenes/streetview/streetview-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"></streetview-scene>

      <!-- TODO(samthor): The Polymer upgrade path mucks with binding this value
        and it may not be updated after the first time -->
      <tracker-scene id="tracker" route="tracker" icon="1f385"
          destinations="{{destinations}}"
          path$="scenes/tracker/tracker-scene_[[language]].html"></tracker-scene>

      <traditions-scene route="traditions" icon="1f4cc"
          path$="scenes/traditions/traditions-scene_[[language]].html"
          mode$="{{mode}}"
          loading-bg-color="rgb(255,224,0)"
          loading-src="scenes/traditions/img/loading.gif"></traditions-scene>

      <translations-scene route="translations" icon="1f4e2"
          path$="scenes/translations/translations-scene_[[language]].html"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/translations/img/loading.png"></translations-scene>

      <trivia-scene route="trivia"
          path$="scenes/trivia/trivia-scene_[[language]].html"></trivia-scene>

      <undersea-scene route="undersea" icon="1f30a"
          path$="scenes/undersea/undersea-scene_[[language]].html"></undersea-scene>

      <template is="dom-repeat" items="{{videoRoutes}}">
        <video-scene route$="{{item}}"
            mode$="{{mode}}"
            path$="scenes/videoscene/video-scene_[[language]].html"></video-scene>
      </template>

      <windtunnel-scene route="windtunnel" icon="1f38f"
          path$="scenes/windtunnel/windtunnel-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"></windtunnel-scene>

      <press-scene route="press" icon="1f4f0"
          path$="scenes/press/press-scene.html"></press-scene>

    </lazy-pages>

  </santa-chrome>

  <!-- Messages that must be selected dynamically -->
  <div id="msg" hidden>
    <div msgid="category-learn"><i18n-msg msgid="learn">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="category-play"><i18n-msg msgid="play">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="category-watch"><i18n-msg msgid="watch">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-airport"><i18n-msg msgid="scene_airport">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-traditions"><i18n-msg msgid="scene_traditions">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-codelab"><i18n-msg msgid="scene_codelab">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-app"><i18n-msg msgid="scene_app">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-briefing"><i18n-msg msgid="scene_briefing">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-seasonofcaring"><i18n-msg msgid="scene_seasonofgiving">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-santasback"><i18n-msg msgid="scene_videoscene_santasback">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-santaselfie"><i18n-msg msgid="scene_santaselfie">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-translations"><i18n-msg msgid="scene_translations">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-callfromsanta"><i18n-msg msgid="scene_callfromsanta">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-presentdrop"><i18n-msg msgid="scene_presentdrop">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-santasearch"><i18n-msg msgid="scene_santasearch">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-windtunnel"><i18n-msg msgid="scene_windtunnel">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-racer"><i18n-msg msgid="scene_racer">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-jamband"><i18n-msg msgid="scene_jamband">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-gumball"><i18n-msg msgid="scene_gumball">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-postcard"><i18n-msg msgid="scene_postcard">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-jetpack"><i18n-msg msgid="scene_jetpack">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-boatload"><i18n-msg msgid="scene_boatload">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-mercator"><i18n-msg msgid="scene_mercator">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-presentbounce"><i18n-msg msgid="scene_presentbounce">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-codeboogie"><i18n-msg msgid="scene_codeboogie">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-carpool"><i18n-msg msgid="scene_videoscene_carpool">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-citylights"><i18n-msg msgid="scene_citylights">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-commandcentre"><i18n-msg msgid="scene_commandcentre">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-seasonofgiving"><i18n-msg msgid="scene_seasonofgiving">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-matching"><i18n-msg msgid="scene_matching">PLACEHOLDER_i18n</i18n-msg></div>
    <div msgid="scene-liftoff"><i18n-msg msgid="scene_videoscene_liftoff">PLACEHOLDER_i18n</i18n-msg></div>
  </div>

</template>
<script>
(function() {

// Default title of Santa Tracker. Note that this is currently not localized.
var WINDOW_TITLE = 'Google Santa Tracker';

var DEFAULT_ROUTE = 'village';
var TRACKER_ROUTE = 'tracker';

// Routes/scenes which should always be accessible, no matter what the day.
// These scenes are also not removed from the lazy-page switching.
var PERMANENT_ROUTES = ['village', 'about', 'press'];

var VIDEO_ROUTES = [
  'trailer', 'carpool', 'liftoff', 'jingle', 'satellite', 'temptation',
  'office', 'tired', 'com-room', 'reload', 'slacking-off', 'wheressanta',
  'santasback'
];

// Timing for playing random videos in Cast mode, in ms.
var VIDEO_RANDOM_MIN = 5 * (60 * 1000);
var VIDEO_RANDOM_MAX = 12 * (60 * 1000);
var VIDEO_RANDOM_SAFE = 60 * (60 * 1000);  // don't show videos before countdown ends

// Routes/scenes unlocked with the tracker (including all video routes)
var TRACKER_ROUTES = ['blimp', 'island', 'undersea', 'icecave', 'runner',
    'latlong', 'glider', 'trivia'].concat(VIDEO_ROUTES);

// TODO(bckenny): Restore Cast mixin
Polymer({
  is: 'santa-app',
  hostAttributes: {'tabindex': '0'},

  properties: {

    /**
     * The size of the header, if any. Used by games to adjust their size.
     */
    headerSize: {
      type: Number,
      readOnly: true,
      value: 56
    },

    /**
     * The preloader used inside this element. This is provided as a binding
     * helper.
     */
    preloader: {
      type: Element,
      readOnly: true,
      value: function() {
        return this.$.preloader;
      }
    },

    /**
     * The time at which Santa takes off, in ms.
     */
    countdownEndAt: {
      type: Number,
      readOnly: true
    },

    /**
     * When Santa's flight is finished, in ms.
     */
    flightFinishedAt: {
      type: Number,
      readOnly: true
    },

    /**
     * The house metadata, including unlock information.
     */
    _houses: {
      type: Array,
      value: function() {
        return [];
      }
    },

    /**
     * The house open today.
     */
    todayHouse: {
      type: String,
      value: '',
      notify: true,
      observer: '_notifyHouses'
    },

    /**
     * Whether the sounds are globally muted by the user.
     */
    userMute: Boolean,

    /**
     * Whether the page is in the background.
     */
    pageInBackground: {
      type: Boolean,
      readOnly: true
    },

    /**
     * Computes the global mute state.
     */
    _globalMute: {
      type: Boolean,
      observer: '_globalMuteChanged',
      computed: '_computeGlobalMute(userMute, pageInBackground)'
    },

    /**
     * If the browser is hdpi.
     */
    hdpi: {
      type: Boolean,
      value: function() {
        return 'devicePixelRatio' in window && devicePixelRatio > 1.5 || false;
      }
    },

    /**
     * The current language locale. This is not modifable after launch; reload the site.
     */
    language: {
      type: String,
      readOnly: true,
      value: document.documentElement.lang || 'en'
    },

    /**
     * The currently open scene.
     */
    selectedScene: {
      type: Element,
      observer: '_selectedSceneChanged',
      value: null
    },

    /**
     * The previously selected scene route.
     */
    prevSelectedRoute: {
      type: String,
      observer: '_prevSelectedRouteChanged',
      value: null
    },

    /**
     * Current URL route.
     */
    route: {
      type: String,
      observer: '_routeChanged'
    },

    /**
     * Analytics service.
     */
    analyticsService: {
      type: Object
    },

    /**
     * Page/Scene visibility manager.
     */
    visibilityService: {
      type: Object
    },

    /**
     * The mode of Santa Tracker. Possible values are blank, 'cast', 'portal',
     * or 'embed'.
     */
    mode: {
      type: String,
      value: ""
    },

    /**
     * If true, whenever the village is loaded, load some random visual experience after a time.
     */
    triggerRandom: {
      type: Boolean,
      value: false
    },

    /**
     * True when Santa's schedule has been checked for the first time.
     */
    scheduleChecked: {
      type: Boolean,
      value: false
    },

    /**
     * True when the tracker intro scene was shown. Used by `tracker-scene`.
     */
    hasTrackerIntroShown: {
      type: Boolean,
      value: false
    },

    /**
     * Full list of tracker destinations as they've come in.
     */
    destinations: {
      type: Array
    },

    /**
     * Full list of timeline feed items.
     */
    timeline: {
      type: Array,
      value: function() {
        return [];
      }
    },

    /**
     * List of video routes. Used for template binding.
     */
    videoRoutes: {
      type: Array,
      readOnly: true,
      value: Object.freeze(VIDEO_ROUTES)
    },

    /**
     * A reference to the fallback house used instead of 'callfromsanta'.
     */
    _fallbackHouse: {
      type: Object,
      value: null
    },

    /**
     * True when the countdown is complete.
     */
    postCountdown: {
      type: Boolean,
      value: false,
      reflectToAttribute: true,
      observer: '_postCountdownChanged'
    },

    /**
     * True when Santa's flight is complete.
     */
    postFlight: {
      type: Boolean,
      value: false,
      reflectToAttribute: true,
      observer: '_postFlightChanged'
    },

    /**
     * True if the Press page is unlocked.
     */
    pressReady: {
      type: Boolean,
      notify: true
    },

    /**
     * Fixed string map stored on `santa-app`. Used for elements with strings
     * that cannot be inferred at compile-time (e.g., i18n-msg with custom
     * msgids, used in village and sidebar).
     */
    strings: {
      type: Object,
      notify: true
    },

  },

  listeners: {
    'scene-progress': 'onSceneProgress',
    'scene-loaded': 'onSceneLoaded',
    'video-scene-done': 'onVideoSceneDone',
    'iframe-focus-change': 'onIframeFocusChange',
    'analytics-track-event': 'trackEvent',
    'analytics-track-perf': 'trackPerf',
    'analytics-time-start': 'timeStart',
    'analytics-time-end': 'timeEnd',
    'analytics-track-social': 'trackSocial',
    'analytics-track-game-start': 'trackGameStart',
    'analytics-track-game-quit': 'trackGameQuit',
    'analytics-track-game-over': 'trackGameOver',
    'tracker-action': 'onTrackerAction',
    'countdown-timer-finish': 'onCountdownFinish',
    'tracker-end': 'onTrackerEnd',

    // For prod, <i18n-msg> is removed and textContent will already be
    // correct. For dev, listen for i18n updates and update the string map.
    'i18n-language-ready': '_updateStrings',
  },

  created: function() {
    // silence the noisy things
    if (!window.DEV) {
      console.log = function(){};
    }

    this.analyticsService = new Analytics();
    this.visibilityService = new VisibilityManager();
  },

  attached: function() {
    // If we're in production mode, then update the string map immediately, as
    // the translations have been included in source directly.
    if (!window.DEV) {
      this._updateStrings();
    }
  },

  _updateStrings: function() {
    if (this.strings) {
      return;  // don't try again
    }
    var strings = {};
    var all = this.$.msg.children;
    for (var x, i = 0; x = all[i]; ++i) {
      var msgid = x.getAttribute('msgid');
      strings[msgid] = x.textContent;
    }

    // NOTE: Since santaApp isn't actually bound onto this.$.chrome (just )
    this.$.chrome.set('santaApp.strings', strings);
    this.strings = Object.freeze(strings);
  },

  ready: function() {
    this._houses = window.HOUSES;
    this.config = window.SANTA_CONFIG;
    delete window.HOUSES; // cleanup
    delete window.SANTA_CONFIG; // cleanup

    this._setCountdownEndAt(this.config.COUNTDOWN_END_DATE);
    this._setFlightFinishedAt(this.config.FLIGHT_FINISHED);

    var defaultApiClient = 'cast' in window ? 'web_chromecast' : 'web';
    var apiClient = getUrlParameter('api_client') || defaultApiClient;
    if (!apiClient.match(/^[a-zA-Z_]*$/)) {
      apiClient = defaultApiClient;
    }

    var loadSound = true;

    switch (apiClient) {
      case 'web_chromecast':
        this.mode = 'cast';
        this.triggerRandom = true;
        break;
      case 'web_embed':
        this.mode = 'embed';
        loadSound = false;
        break;
      case 'web_portal':
        apiClient = 'web';
        this.mode = 'portal';
        break;
      default:
        break;
    }

    if (loadSound) {
      var sc = new SoundController(this.soundsLoaded.bind(this));
      this.addEventListener('sound-preload', sc.loadSounds.bind(sc));
      this.addEventListener('sound-ambient', sc.playAmbientSounds.bind(sc));
      this.addEventListener('sound-trigger', sc.playSound.bind(sc));
    }

    // NOTE: There's a race here: 'sound-ambient' is registered above, but setting the initial
    // background state here still causes audio to start on unfocused tabs. This is probably fine,
    // and Santa will just make noise before its tab is first focused.
    this.visibilityService.addOnPauseListener(this._setPageInBackground.bind(this, true));
    this.visibilityService.addOnResumeListener(this._setPageInBackground.bind(this, false));
    this._setPageInBackground(this.visibilityService.isPaused());

    var version = document.body.getAttribute('data-version');
    this.santaService = new SantaService(apiClient, this.language, version);
    this.santaService.sync(this._checkSchedule.bind(this));

    this.santaService.addListener('destinations_changed', function(destinations) {
      this.destinations = destinations || [];
    }.bind(this));

    this.santaService.addListener('timeline_changed', function(timeline) {
      this.timeline = timeline || [];
    }.bind(this));

    this.santaService.addListener('kill', function justKillMe() {
      this.analyticsService.trackEvent('API', 'killed');
      // redirect after analytics has been processed
      this.analyticsService.executeFunction(function errorRedirect() {
        window.location = 'https://santatracker.google.com' +
            location.pathname.replace(/[^\/]*$/, '') + 'error.html';
      });
    }.bind(this));

    var reloadTimeout;
    this.santaService.addListener('reload', function() {
      this.analyticsService.trackEvent('API', 'reload');

      if (window.DEV) {
        console.warn('prod would trigger reload, out of date', document.body.getAttribute('data-version'));
        return;
      }
      if (reloadTimeout) {
        return;  // already trying to reload
      }

      // Schedule a reload in the next ~2 hours, but only after the last user
      // click.
      var reloader = function(ev) {
        if (ev && !isRealEvent(ev)) {
          return;  // ignore fake events, such as simulated clicks
        }
        var when = Math.random() * 1000 * 60 * 60 * 2;  // next two hours
        window.clearTimeout(reloadTimeout);
        reloadTimeout = window.setTimeout(function() {
          window.location.reload();
        }, when);
      }
      document.addEventListener('click', reloader);
      reloader();
    }.bind(this));

    this._prepareHouses();

    this._checkSchedule();
    if (!this.route) {
      this.route = this.defaultRoute;
    }
  },

  /**
   * Handles a loading progress hint, hiding or displaying the preloader.
   */
  onSceneProgress: function() {
    var scene = this.selectedScene;
    if (scene) {
      this.$.preloader.active = !scene.loaded;
      this.$.preloader.value = scene.preloadProgress;
    } else {
      this.$.preloader.active = false;
    }
  },

  onSceneLoaded: function(event, scene) {
    if (scene == this.$.village) {
      this._notifyHouses();
    }
  },

  onVideoSceneDone: function(event) {
    if (this.mode == 'cast') {
      this.route = this.defaultRoute;
    }
  },

  /**
   * Catch-all place to do some kind of initialization of houses.
   */
  _prepareHouses: function() {
    var castMode = this.mode === 'cast';
    var portalMode = this.mode === 'portal';
    var ios = navigator.userAgent.match(/iPhone|iPod|iPad/i);
    var spanglish = /^e(n|s)/.test(this.language);

    for (var i = this._houses.length - 1; i >= 0; i--) {
      var house = this._houses[i];

      house.disabled = house.disabled || castMode;  // by default, all houses are disabled on cast

      switch (house.module) {
        case 'app':
          // Disable Google Play house on iOS devices
          house.disabled = (ios || portalMode || house.disabled);
          break;
        case 'callfromsanta':
          // remove callfromsanta where not supported (leaving fallback house) or
          // after Santa's flight has concluded.
          if (!spanglish || this.postFlight) {
            this._houses.splice(i, 1);
          }
          break;
        default:
          if (house.fallback) {
            // remove fallback where callfromsanta supported (en|en-GB|es|es-419)
            // Save the object for postFlight (when callfromsanta will be disabled)
            if (spanglish && !this.postFlight) {
              this._fallbackHouse = this._houses.splice(i, 1)[0];
            }
          }
          break;
      }
    }

    this._notifyHouses();
  },

  get defaultRoute() {
    return this.postCountdown ? TRACKER_ROUTE : DEFAULT_ROUTE;
  },

  /**
   * Async holder for _triggerRandom.
   */
  _triggerRandomAsync: null,

  /**
   * Requests that a random visual scene be loaded. Only runs if `triggerRandom` is true.
   */
  _triggerRandom: function() {
    if (!this.triggerRandom) {
      return;
    }

    var when = randomRange(VIDEO_RANDOM_MIN, VIDEO_RANDOM_MAX);
    var remaining = this.countdownEndAt - this.santaService.now();
    if (remaining < VIDEO_RANDOM_SAFE) {
      return;  // give up, no more videos this close to launch
    }
    console.debug('triggering random video in', when);

    this.cancelAsync(this._triggerRandomAsync);
    this._triggerRandomAsync = this.async(function() {
      var opts = VIDEO_ROUTES.filter(function(scene) {
        return this.sceneIsUnlocked(scene);
      }, this);
      var choice = randomChoice(opts);
      console.debug('chose random video', choice, 'from', opts);
      this.route = choice;
    }, when);
  },

  _selectedSceneChanged: function(newValue, oldValue) {
    this.$.chrome.isFixedToolbar = (newValue != this.$.village);

    if (oldValue && oldValue.route) {
      this.prevSelectedRoute = oldValue.route;
    }
    if (newValue == this.$.village) {
      this._triggerRandom();
    }

    // Let the selected scene know about params.
    // TODO(samthor): How does this interact with two-way binding?
    if (this.selectedScene) {
      this.selectedScene.sceneParams = this.sceneParams;
    }
    this._updateWindowTitle();
  },

  _prevSelectedRouteChanged: function() {
    if (!this.prevSelectedRoute) {
      return;
    }

    // Only remove certain elements from the DOM.
    var dontRemoveEl = PERMANENT_ROUTES.indexOf(this.prevSelectedRoute) != -1;
    if (dontRemoveEl) {
      return;
    }

    var prevSelectedScene = null;
    for (var i = 0, scene; scene = this.$.lazypages.items[i]; ++i) {
      if (scene.route == this.prevSelectedRoute) {
        prevSelectedScene = scene;
        break;
      }
    }

    // Remove previous scene if it shouldn't always be active.
    if (prevSelectedScene && !prevSelectedScene.alwaysActive) {
      var dom = Polymer.dom(this.$.lazypages);
      dom.removeChild(prevSelectedScene);

      // Re-construct removed scene and add it back to lazy-pages. Note that
      // loading-* isn't copied, since the element is already loaded.
      var el = document.createElement(prevSelectedScene.localName);
      el.route = prevSelectedScene.route;
      el.santaApp = this;
      el.loaded = true;
      el.setAttribute('route', el.route);
      el.setAttribute('mode', this.mode);

      dom.appendChild(el);
    }
  },

  _routeChanged: function() {
    // Check if the new route needs a special-case redirect or if it is valid.
    // If this changes the route, routeChanged() will be called again, repeating
    // until this.route passes through validateRoute() successfully.
    var requestedRoute = this.route;
    switch (requestedRoute) {
      case 'tourist':
        // tourist and trailer are synonymous
        this.route = 'trailer';
        break;
      case 'gumballs':
        this.route = 'gumball';
        break;
    }
    this.validateRoute();

    if (requestedRoute === this.route) {
      // Route is valid. Send to analytics and load the scene.
      this.trackPageview('/' + this.route);
    } else if (requestedRoute !== '') {
      // The requested route was changed.
      var currentRoute = null;
      var pageUrl = window.location.href.substr(0, location.href.length - location.hash.length);
      if (pageUrl) {
        if (this.selectedScene == null) {
          console.warn('routeChanged but scene is null, route', requestedRoute, new Error());
        } else {
          currentRoute = pageUrl + '#' + this.selectedScene.route;
        }
      }
      this.fire('analytics-track-event', { category: 'Routing',
          action: 'Invalid Route Source', label: currentRoute});
      this.fire('analytics-track-event', { category: 'Routing',
          action: 'Invalid Route', label: '/' + requestedRoute});
    }
  },

  _updateWindowTitle: function() {
    var scene = this.selectedScene;
    var raw = scene && scene.getAttribute('icon');
    var icon = '';
    if (raw && String.fromCodePoint) {  // no emoji on IE11
      icon = String.fromCodePoint(parseInt(raw, 16));
    }
    document.title = icon + WINDOW_TITLE;
  },

  validateRoute: function() {
    if (this.scheduleChecked) {
      var valid = (this.$.lazypages.isValidRoute(this.route) &&
                   this.sceneIsUnlocked(this.route)) ||
                   (this.postCountdown && this.route == TRACKER_ROUTE) ||
                   (this.mode == 'cast' && VIDEO_ROUTES.indexOf(this.route) != -1);
      if (!valid) {
        if (window.DEV) {
          console.warn('prod would redirect from', this.route, 'to', this.defaultRoute);
        } else {
          this.route = this.defaultRoute;
        }
      }
    }
  },

  _computeGlobalMute: function(userMute, pageInBackground) {
    return userMute || pageInBackground;
  },

  _globalMuteChanged: function(newValue) {
    if (newValue)  {
      this.fire('sound-ambient', 'global_blur');
      this.fire('sound-ambient', 'global_pause');
      if (this.selectedScene && this.selectedScene.fire) {
        this.selectedScene.fire('scene-pause', true);
      }
    } else {
      this.fire('sound-ambient', 'global_focus');
      this.fire('sound-ambient', 'global_unpause');
      if (this.selectedScene && this.selectedScene.fire) {
        this.selectedScene.fire('scene-pause', false);
      }
    }
  },

  soundsLoaded: function(soundsName) {
    // TODO(bckenny): selectedScene.fire check may be unecessary as it's not
    // clear if it's possible for selectedScene to not be upgraded by this point
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('sounds-loaded', soundsName);
    }
  },

  trackPageview: function(path) {
    this.analyticsService.trackPageView(path);
  },

  trackEvent: function(e, detail) {
    this.analyticsService.trackEvent(
        detail.category, detail.action, detail.label, detail.value);
  },

  trackPerf: function(e, detail) {
    this.analyticsService.trackPerf(
        detail.category, detail.variable, detail.time, detail.label, detail.maxTime);
  },

  timeStart: function(e, detail) {
    this.analyticsService.timeStart(
        detail.category, detail.variable, detail.time);
  },

  timeEnd: function(e, detail) {
    this.analyticsService.timeEnd(
        detail.category, detail.variable, detail.time, detail.label, detail.maxTime);
  },

  trackSocial: function(e, detail) {
    this.analyticsService.trackSocial(
        detail.network, detail.action, detail.target);
  },

  trackGameStart: function(e, detail) {
    this.analyticsService.trackGameStart(detail.gameId || detail.gameid);
  },

  trackGameQuit: function(e, detail) {
    this.analyticsService.trackGameQuit(detail.gameId || detail.gameid,
        detail.level, detail.timePlayed);
  },

  trackGameOver: function(e, detail) {
    this.analyticsService.trackGameOver(
        detail.gameId || detail.gameid, detail.score, detail.level,
        detail.timePlayed);
  },

  onIframeFocusChange: function(e, detail) {
    if (detail === 'blur') {
      this.visibilityService.pauseIframe();
    } else if (detail === 'focus') {
      this.visibilityService.resumeIframe();
    }
  },

  /**
   * When the flight finishes, check if any houses in the village need to be
   * shutoff, kicking out of invalid routes if necessary.
   */
  _postFlightChanged: function() {
    for (var i = 0; i < this._houses.length; i++) {
      // In regions where callfromsanta was supported, replace it with the
      // fallbackHouse used in other regions
      if (this._houses[i].module === 'callfromsanta') {
        if (this._fallbackHouse) {
          this._houses[i] = this._fallbackHouse;
        }
      }

      // lock more houses here, if needed
    }

    // allowed routes may have changed, so check again
    this._checkSchedule();
  },

  _postCountdownChanged: function() {
    if (this.postCountdown) {
      document.body.classList.add('posttakeoff');
    } else {
      document.body.classList.remove('posttakeoff');
    }
  },

  /**
   * @param number index
   */
  unlockHouse: function(idx) {
    var house = this._houses[idx];
    if (!house) {
      return;
    }

    // house is melted unless it's disabled
    house.iced = !!house.disabled;
    this._notifyHouses();
  },

  unlockAllHouses: function() {
    for (var i = 0, house; house = this._houses[i]; ++i) {
      this.unlockHouse(i);
    }
  },

  lockAllHouses: function() {
    for (var i = 0, house; house = this._houses[i]; ++i) {
      this.set('_houses.i.')
      house.iced = true;
    }
    this._notifyHouses();
  },

  sceneIsUnlocked: function(moduleName) {
    for (var i = 0, house; house = this._houses[i]; ++i) {
      if (house.module === moduleName) {
        return !house.disabled && (this.santaService.now() > house.launchDate);
      }
    }

    // Certain scenes don't have associated houses. Whitelist them.
    if (PERMANENT_ROUTES.indexOf(moduleName) != -1) {
      return true;
    }

    if (this.postCountdown && TRACKER_ROUTES.indexOf(moduleName) != -1) {
      return true;
    }

    if (this.mode == 'cast' && VIDEO_ROUTES.indexOf(moduleName) != -1) {
      return true;  // allows non-house (i.e., not part of the scchedule) video scenes on cast
    }

    return false;
  },

  /**
   * Timeout for _checkSchedule.
   */
  _scheduleTimeout: null,

  /**
   * Unlocks the correct houses based on the day (index).
   * @private
   */
  _checkSchedule: function() {
    if (!this.santaService) {
      return;  // ignore, will be called via ready:
    }

    var todayDate = this.santaService.dateNow();
    var tomorrowDate = new Date(todayDate);
    tomorrowDate.setDate(todayDate.getDate() + 1);

    // Set post countdown/post flight flags based on current time.
    this.postFlight = todayDate >= this.flightFinishedAt;
    this.postCountdown = todayDate > this.countdownEndAt && !this.postFlight;

    // TODO(samthor): Remove after press approval.
    this.pressReady = (+new Date('Dec 3, 2015') <= +todayDate);

    switch(todayDate.getMonth()) {
      case 11: // DECEMBER
        var todayHouse = '';

        // Update house status based on today's date.
        for (var i = 0; i < this._houses.length; i++) {
          var house = this._houses[i];

          if (house.launchDate > todayDate) {
            house.iced = true;
            continue;
          }
          this.unlockHouse(i);
          if (isSameDay(house.launchDate, todayDate)) {
            todayHouse = house.module;
          }
        }

        this.todayHouse = todayHouse;
        break;
      case 0: // JAN
        // All houses in Jan are unlocked. Full experience baby!
        this.unlockAllHouses();
        break;
      default:
        if (window.DEV) {
          this.unlockAllHouses();
        } else {
          this.lockAllHouses();
        }
    }
    this._notifyHouses();

    this.scheduleChecked = true;
    this.validateRoute();

    // Check again at the next hour tick.
    var timeTillHour = (60 - todayDate.getMinutes()) * 60 * 1000;
    this._scheduleTimeout = this.async(this._checkSchedule, timeTillHour);
  },

  _escHandler: function(e, detail) {
    switch (e.detail.key) {
      case 'esc':
        this.route = this.defaultRoute;
        break;
    }
  },

  onTrackerAction: function(e, detail) {
    // Note: needs to go qS() because DOM is not guaranteed to exist if on cast.
    var calendar = this.$.lazypages.querySelector('calendar-nav');
    if (!calendar) {
      return; // cast mode
    }
    if (detail.type == 'tracker-toggle') {
      calendar.trackerActive = detail.active;
    } else if (detail.type == 'city-toggle') {
      calendar.cityFeedActive = detail.active;
    }
  },

  onCountdownFinish: function(e, detail) {
    // Redirect village -> tracker when the countdown finishes. This allows
    // users to go back to the village.
    if (!this.postCountdown) {
      this._checkSchedule();
      if (this.postCountdown && this.route === DEFAULT_ROUTE) {
        // Act as if the user has clicked a link, and update the hash manually.
        this.$.router.go(TRACKER_ROUTE);
      }
    }
  },

  /**
   * Notifies bound properties that the houses have changed (useful for the
   * village). Dedups with a microtask.
   * @private
   */
  _notifyHouses: function() {
    this.debounce('_notifyHouses', function() {
      if (!this.$.village.fire) {
        // We're not a Polymer element yet, ignore. This will be later called
        // by onSceneLoaded.
        return;
      }

      var houses = this._houses.slice();
      this.$.village.houses = houses;
      this.$.village.todayHouse = this.todayHouse;

      // TODO(samthor): This works around Polymer aggressively comparing the
      // inner objects of the array. It decides that since the inner objects
      // are the same (and they are by equality) that the template should not
      // re-run. We don't use .set on _this_ element, because there's no
      // rendering here and this isn't actually bound to village, since late-
      // binding isn't supported in Polymer 1+.
      for (var i = 0; i < houses.length; ++i) {
        this.$.village.set(['houses', i, 'iced'], houses[i].iced);
      }
    });
  },

  _colorForRoute: function(route, houses) {
    if (!route || route == 'village') {
      return '';
    }

    for (var i = 0, house; house = houses[i]; ++i) {
      if (house.module == route) {
        return house.color || '';
      }
    }

    return '';
  },

  isCastMode: function(mode) {
    return mode == 'cast';
  },

  onTrackerEnd: function(e, detail) {
    this._checkSchedule();
  }

});

})();
</script>
</dom-module>
