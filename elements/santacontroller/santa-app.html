<link rel="import" href="../../components/polymer/polymer.html">

<!-- Analytics -->
<script src="//www.google.com/js/gweb/analytics/autotrack.js"></script>

<!-- TODO; get rid of this. Really only need for getUrlParameter() -->
<script src="../../js/consts.js"></script>

<script src="../../js/analytics.js"></script>
<script src="../../js/visibilitymanager.js"></script>
<script src="../../js/soundcontroller.js"></script>

<script src="../../js/statuses/picker.js"></script>

<!-- Santa API -->
<script src="../../js/service/events.js"></script>
<script src="../../js/service/lat_lng.js"></script>
<script src="../../js/service/spherical.js"></script>
<script src="../../js/service/details.js"></script>
<script src="../../js/service/location.js"></script>
<script src="../../js/service/state.js"></script>
<script src="../../js/service/transport.js"></script>
<script src="../../js/service/santa_client.js"></script>

<!-- Houses/pin metadata -->
<link rel="import" href="../../js/houses.html">

<!--
Santa Track app.

@element santa-app
-->
<polymer-element name="santa-app" attributes="language houses countDownEndDate selectedScene"
                 on-analytics-track-event="{{trackEvent}}"
                 on-analytics-track-social="{{trackSocial}}">
<script>
(function() {

var COUNTDOWN_END_DATE_ = 1419415200000; // Dec 24, 2014

var FLIGHT_FINISHED_ = COUNTDOWN_END_DATE_ + 25 * 60 * 60 * 1000;

Polymer({

  /**
   * When Santa's flight is finished.
   *
   * @property FLIGHT_FINISHED
   * @type number
   * @default COUNTDOWN_END_DATE + 25 * 60 * 60 * 1000
   * @const
   */
  FLIGHT_FINISHED: FLIGHT_FINISHED_,

  // TODO(bckenny): right now, event.data values are "left", "right",
  // "up", "down", "return", "space". Finalize these.
  CAST_KEY_MAPPING_: {
    left: {
      keyIdentifier: 'Left',
      key: 'ArrowLeft'
    },
    right: {
      keyIdentifier: 'Right',
      key: 'ArrowRight'
    },
    up: {
      keyIdentifier: 'Up',
      key: 'ArrowUp'
    },
    down: {
      keyIdentifier: 'Down',
      key: 'ArrowDown'
    },
    return: {
      keyIdentifier: 'Enter',
      key: 'Enter'
    },
    space: {
      keyIdentifier: ' ',
      key: 'U+0020'
    }
  },

  /**
   * The house meta data shared across scenes.
   *
   * @attribute houses
   * @type array
   * @default []
   */
   houses: [],

  /**
   * The current language locale.
   *
   * @attribute language
   * @type string
   * @default 'en'
   */
  language: document.documentElement.lang || 'en',

  /**
   * When Santa's flight is finished.
   *
   * @attribute countDownEndDate
   * @type number
   * @default 1419415200000
   */
   countDownEndDate: COUNTDOWN_END_DATE_,

  /**
   * Analytics service.
   *
   * @property analyticsService
   * @type Analytics
   * @default null
   */
  analyticsService: null,

  ready: function() {
    this.analyticsService = new Analytics();

    this.houses = window.HOUSES;
    delete window.HOUSES; // cleanup

    var sc = new SoundController();
    this.addEventListener('sound-preload', sc.loadSounds.bind(sc));
    this.addEventListener('sound-ambient', sc.playAmbientSounds.bind(sc));
    this.addEventListener('sound-trigger', sc.playSound.bind(sc));

    var apiClient = getUrlParameter('api_client') || 'web';

    this.santaService = new SantaService(apiClient, this.language);
    this.santaService.addListener('kill', function() {
      window.location = 'error.html';
    });

    if (apiClient === 'web_chromecast') {
      this.initChromecast();
    }

    if (this.santaService.now() > this.countDownEndDate) {
      if (this.santaService.now() < this.FLIGHT_FINISHED) {
        this.postCountdown();
      } else {
        this.postFlight();
      }
    }
  },

  languageChanged: function() {
    this.santaService.lang_ = this.language;
  },

  initChromecast: function() {
    // TODO(bckenny): remove noisy chromecast debugging logging
    // dynamically import the Cast Reciever SDK if in chromecast mode
    Polymer.import(['../../js/chromecast.html'], function(e) {
      // `cast` is added to global scope by SDK
      var castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
      console.log('Starting Cast Receiver Manager');
      castReceiverManager.onReady = function(event) {
        console.log('Received Cast Ready event: ' + JSON.stringify(event.data));
        castReceiverManager.setApplicationState('Santa Tracker');
      };
      castReceiverManager.onSenderConnected = function(event) {
        console.log('Received Cast Sender Connected event: ' + event.data);
        console.log(castReceiverManager.getSender(event.data).userAgent);
      };
      castReceiverManager.onSenderDisconnected = function(event) {
        console.log('Received Cast Sender Disconnected event: ' + event.data);
        if (castReceiverManager.getSenders().length === 0 &&
          event.reason ===
              cast.receiver.system.DisconnectReason.REQUESTED_BY_SENDER) {
            window.close();
        }
      };
      castReceiverManager.onSystemVolumeChanged = function(event) {
        console.log('Received Cast System Volume Changed event: ' +
            event.data.level + ' ' + event.data.muted);
      };

      var messageBus = castReceiverManager
          .getCastMessageBus('urn:x-cast:com.google.cast.santatracker');
      messageBus.onMessage = function(event) {
        console.log('Message [' + event.senderId + ']: ' + event.data);

        // fire KeyboardEvent on current scene
        // since this is Chromecast only, we can assume it supports the modern
        // KeyboardEvent constructor and skip the initKeyboardEvent silliness
        var keyDetails = this.CAST_KEY_MAPPING_[event.data];
        if (keyDetails) {
          var e = new KeyboardEvent('keydown', {
            bubbles: true,
            cancelable: true,
            keyIdentifier: keyDetails.keyIdentifier,
            key: keyDetails.key
          });
          this.selectedScene.dispatchEvent(e);
        }
      };

      castReceiverManager.start({statusText: 'Santa Tracker is starting'});
      console.log('Cast Receiver Manager started');
    }.bind(this));
  },

  trackEvent: function(e, detail, sender) {
    this.analyticsService.trackEvent(
        detail.category, detail.action, detail.label);
  },

  trackSocial: function(e, detail, sender) {
    this.analyticsService.trackSocial(
        detail.network, detail.action, detail.target);
  },

  /**
   * When the flight finishes, redirect the user to the village.
   * @private
   */
  postFlight: function() {
    if (document.body.classList.contains('postflight')) {
      return;
    }

    document.body.classList.switch('posttakeoff', 'postflight');

    // TODO(lukem): lock houses that need locking.
  },

  /**
   * When the countdown finishes, redirect the user to the tracker.
   * @private
   */
  postCountdown: function() {
    if (this.santaService.now() > this.FLIGHT_FINISHED) {
      this.postFlight();
      return;
    }

    if (document.body.classList.contains('posttakeoff')) {
      return;
    }

    document.body.classList.add('posttakeoff');
  }

});

})();
</script>
</polymer-element>
