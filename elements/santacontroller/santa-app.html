<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../../components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../santa-chrome/santa-chrome.html">
<link rel="import" href="../santa-tracker-router.html">
<link rel="import" href="../preloader/preload-overlay.html">
<link rel="import" href="../lazy-pages.html">
<link rel="import" href="../santa-strings.html">
<link rel="import" href="../../js/utils.html">

<link rel="import" href="dependencies.html">

<!--
Santa Tracker app.
-->
<dom-module id="santa-app">
<template>
  <!-- Shared i18n strings -->
  <santa-strings id="strings"></santa-strings>

  <!-- Keyboard handler -->
  <iron-a11y-keys keys="esc" on-keys-pressed="_escHandler"></iron-a11y-keys>

  <!-- Preloading scene overlay -->
  <preload-overlay id="preloader"></preload-overlay>

  <!-- Route controller -->
  <santa-tracker-router id="router" route="{{route}}" scene-params="{{sceneParams}}" auto-hash></santa-tracker-router>

  <!-- Chrome, including toolbar and sidebar -->
  <santa-chrome id="chrome"
      mode$="[[mode]]"
      disabled="[[isCastMode(mode)]]"
      color="[[colorForRoute(route, validRoutes)]]"
      tracker-unlocked="[[duringTracker]]"
      today-house="[[todayHouse]]"
      mute="{{userMute}}">

    <!-- Scenes -->
    <lazy-pages id="lazypages"
        preloader="[[preloader]]"
        valid-routes="{{validRoutes}}"
        selected="{{route}}"
        selected-item="{{selectedScene}}"
        selectable=":not([disabled])"
        attr-for-selected="route"
        selected-attribute="active">

      <dorf-scene id="village" route="village" freeform icon="1f384"
          during-tracker="[[duringTracker]]"
          today-house="[[todayHouse]]"
          houses="[[_houses]]"
          mode$="[[mode]]"
          path$="scenes/dorf/dorf-scene_[[language]].html"></dorf-scene>

      <!-- Keep scenes (non-village) ordered alphabetically -->

      <about-scene route="about" freeform icon="2753"
          header-color="rgb(39, 186, 131)"
          path$="scenes/about/about-scene_[[language]].html"></about-scene>

      <airport-scene route="airport" icon="1f6c4"
          header-color="#fdbe27"
          path$="scenes/airport/airport-scene_[[language]].html"></airport-scene>

      <blimp-scene route="blimp" icon="1f6a1"
          path$="scenes/blimp/blimp-scene_[[language]].html"></blimp-scene>

      <boatload-scene route="boatload" icon="26f5"
          path$="scenes/boatload/boatload-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/boatload/img/loading.svg"></boatload-scene>

      <briefing-scene route="briefing" icon="1f3eb"
          path$="scenes/briefing/briefing-scene_[[language]].html"></briefing-scene>

      <callfromsanta-scene route="callfromsanta" icon="1f4de"
          path$="scenes/callfromsanta/callfromsanta-scene.html"
          mute="[[userMute]]"
          loading-bg-color="rgb(129,208,0)"></callfromsanta-scene>

      <citylights-scene route="citylights" icon="1f306"
          path$="scenes/citylights/citylights-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#182a4a"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/citylights/img/loading.svg"></citylights-scene>

      <codeboogie-scene route="codeboogie" icon="1f4dd"
          path$="scenes/codeboogie/codeboogie-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#9a519f"
          loading-bg-color="#3f4ea1"
          loading-src="scenes/codeboogie/img/loading.svg"></codeboogie-scene>

      <codelab-scene route="codelab" icon="1f4dd"
          path$="scenes/codelab/codelab-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#9a519f"
          loading-bg-color="#3f4ea1"
          loading-src="scenes/codelab/img/loading.svg"></codelab-scene>

      <commandcentre-scene route="commandcentre" icon="1f5fc"
          path$="scenes/commandcentre/commandcentre-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="rgb(129,208,0)"></commandcentre-scene>

      <factory-scene route="factory" icon="1f3ed"
          path$="scenes/factory/factory-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"></factory-scene>

      <glider-scene route="glider" icon="1f343"
          path$="scenes/glider/glider-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#8d23a9"
          loading-src="scenes/glider/img/loading.svg"></glider-scene>

      <gumball-scene route="gumball" icon="1f36d"
          path$="scenes/gumball/gumball-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#fdbe27"
          loading-bg-color="#8d23a9"
          loading-src="scenes/gumball/img/loading.svg"></gumball-scene>

      <icecave-scene route="icecave" icon="2744"
          path$="scenes/icecave/icecave-scene_[[language]].html"></icecave-scene>

      <island-scene route="island" icon="1f334"
          path$="scenes/island/island-scene_[[language]].html"></island-scene>

      <jamband-scene route="jamband" icon="1f3b6"
          path$="scenes/jamband/jamband-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#fdbe27"
          loading-bg-color="#fdbe27"
          loading-src="scenes/jamband/img/loading.svg"></jamband-scene>

      <jetpack-scene route="jetpack" icon="1f680"
          path$="scenes/jetpack/jetpack-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#9a519f"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/jetpack/img/loading.svg"></jetpack-scene>

      <latlong-scene route="latlong" icon="1f3af"
          path$="scenes/latlong/latlong-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#ffcc00"
          loading-src="scenes/latlong/img/loading.svg"></latlong-scene>

      <matching-scene route="matching" icon="1f6aa"
          path$="scenes/matching/matching-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#b27644"
          loading-src="scenes/matching/img/loading.svg"></matching-scene>

      <mercator-scene route="mercator" icon="1f30e"
          path$="scenes/mercator/mercator-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#fbbf2c"
          loading-src="scenes/mercator/img/loading.svg"></mercator-scene>

      <playground-scene route="playground" icon="1f3aa"
          path$="scenes/playground/playground-scene_[[language]].html"
          loading-bg-color="rgb(251, 191, 44)"></playground-scene>

      <postcard-scene route="postcard" icon="1f4ec"
          path$="scenes/postcard/postcard-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="rgb(244, 123, 32)"
          loading-src="scenes/postcard/img/loading.gif"></postcard-scene>

      <postcardly-scene route="postcardly"
          path$="scenes/postcardly/postcardly-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"></postcardly-scene>

      <presentdrop-scene route="presentdrop" icon="1f381"
          path$="scenes/presentdrop/presentdrop-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/presentdrop/img/loading.svg"></presentdrop-scene>

      <presentbounce-scene route="presentbounce" icon="1f381"
          path$="scenes/presentbounce/presentbounce-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/presentbounce/img/loading.svg"></presentbounce-scene>

      <racer-scene route="racer" icon="1f3c1"
          path$="scenes/racer/racer-scene_[[language]].html"
          mode$="[[mode]]"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/racer/img/loading.svg"></racer-scene>

      <runner-scene route="runner" icon="1f3c7"
          mode$="[[mode]]"
          path$="scenes/runner/runner-scene_[[language]].html"></runner-scene>

      <rollercoaster-scene route="rollercoaster" icon="1f3a2"
          path$="scenes/rollercoaster/rollercoaster-scene.html"></rollercoaster-scene>

      <santasearch-scene route="santasearch" icon=""
          path$="scenes/santasearch/santasearch-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#00904a"
          loading-bg-color="#29B6F6"
          loading-src="scenes/santasearch/img/loading.svg"></santasearch-scene>

      <santaselfie-scene route="santaselfie" icon="1f488"
          path$="scenes/santaselfie/santaselfie-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#4172e8"
          loading-bg-color="#83D7F5"
          loading-src="scenes/santaselfie/img/loading.svg"></santaselfie-scene>

      <seasonofcaring-scene route="seasonofcaring" icon="1f3ee"
          path$="scenes/seasonofcaring/seasonofcaring-scene_[[language]].html"
          mode$="[[mode]]"
          loading-src="scenes/seasonofcaring/img/loading.svg"></seasonofcaring-scene>

      <seasonofgiving-scene route="seasonofgiving" icon="1f3ee"
          path$="scenes/seasonofgiving/seasonofgiving-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#9dca3b"
          loading-src="scenes/seasonofgiving/img/loading.svg"></seasonofgiving-scene>

      <smatch-scene route="smatch"
          path$="scenes/smatch/smatch-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"></smatch-scene>

      <streetview-scene route="streetview" icon="1f3a5"
          path$="scenes/streetview/streetview-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"></streetview-scene>

      <tracker-scene id="tracker" route="tracker" freeform icon="1f30d"
          path$="scenes/tracker/tracker-scene_[[language]].html"></tracker-scene>

      <traditions-scene route="traditions" icon="1f4cc"
          path$="scenes/traditions/traditions-scene_[[language]].html"
          mode$="[[mode]]"
          header-color="#fdbe27"
          loading-bg-color="rgb(255,224,0)"
          loading-src="scenes/traditions/img/loading.gif"></traditions-scene>

      <translations-scene route="translations" icon="1f4e2"
          path$="scenes/translations/translations-scene_[[language]].html"
          header-color="#558b2f"
          loading-bg-color="#8fd7f7"
          loading-src="scenes/translations/img/loading.png"></translations-scene>

      <trivia-scene route="trivia"
          path$="scenes/trivia/trivia-scene_[[language]].html"></trivia-scene>

      <undersea-scene route="undersea" icon="1f30a"
          path$="scenes/undersea/undersea-scene_[[language]].html"></undersea-scene>

      <template is="dom-repeat" items="[[_computeVideoRoutes(videos)]]">
        <video-scene route$="[[item]]" icon="1f4fd"
            youtube-id$="[[_computeVideoId(videos, item)]]"
            mode$="[[mode]]"
            mute="[[userMute]]"
            header-color="#ec4582"
            path="scenes/videoscene/video-scene.html"></video-scene>
      </template>

      <windtunnel-scene route="windtunnel" icon="1f38f"
          path$="scenes/windtunnel/windtunnel-scene_[[language]].html"
          loading-bg-color="rgb(129,208,0)"></windtunnel-scene>

      <press-scene route="press" freeform icon="1f4f0"
          path$="scenes/press/press-scene.html"></press-scene>

    </lazy-pages>

  </santa-chrome>

</template>
<script>
(function() {

// Default title of Santa Tracker. Note that this is currently not localized.
var WINDOW_TITLE = 'Google Santa Tracker';

var DEFAULT_ROUTE = 'village';
var TRACKER_ROUTE = 'tracker';

// Routes/scenes which should always be accessible, no matter what the day.
// These scenes are also not removed from the lazy-page switching.
var PERMANENT_ROUTES = ['village', 'about', 'press'];

// Timing for playing random videos in Cast mode, in ms.
var VIDEO_RANDOM_MIN = 5 * (60 * 1000);
var VIDEO_RANDOM_MAX = 12 * (60 * 1000);
var VIDEO_RANDOM_SAFE = 60 * (60 * 1000);  // don't show videos before countdown ends

Polymer({
  is: 'santa-app',
  hostAttributes: {'tabindex': '0'},

  properties: {

    /**
     * The size of the header, if any. Used by games to adjust their size.
     */
    headerSize: {
      type: Number,
      readOnly: true,
      value: 44
    },

    /**
     * The preloader used inside this element. This is provided as a binding
     * helper.
     */
    preloader: {
      type: Element,
      readOnly: true,
      value: function() {
        return this.$.preloader;
      }
    },

    /**
     * The time at which Santa takes off, in ms.
     */
    countdownEndAt: {
      type: Number,
      readOnly: true
    },

    /**
     * When Santa's flight is finished, in ms.
     */
    flightFinishedAt: {
      type: Number,
      readOnly: true
    },

    /**
     * The house metadata, including unlock information.
     */
    _houses: {
      type: Array,
      value: function() {
        return [];
      }
    },

    /**
     * The house open today.
     */
    todayHouse: {
      type: String,
      value: '',
      notify: true
    },

    /**
     * Whether the sounds are globally muted by the user.
     */
    userMute: {
      type: Boolean,
      notify: true,
      observer: '_userMuteChanged'
    },

    /**
     * Whether the page is in the background.
     */
    pageInBackground: {
      type: Boolean,
      readOnly: true
    },

    /**
     * If the browser is hdpi.
     */
    hdpi: {
      type: Boolean,
      value: function() {
        return 'devicePixelRatio' in window && devicePixelRatio > 1.5 || false;
      }
    },

    /**
     * The current language locale. This is not modifable after launch; reload the site.
     */
    language: {
      type: String,
      readOnly: true,
      value: document.documentElement.lang || 'en'
    },

    /**
     * The currently open scene.
     */
    selectedScene: {
      type: Element,
      observer: '_selectedSceneChanged',
      value: null
    },

    /**
     * The previously selected scene route.
     */
    prevSelectedRoute: {
      type: String,
      observer: '_prevSelectedRouteChanged',
      value: null
    },

    /**
     * Current URL route.
     */
    route: {
      type: String,
      observer: '_routeChanged'
    },

    /**
     * Mirrored from lazy-pages valid-routes.
     */
    validRoutes: Object,

    /**
     * Analytics service.
     */
    analyticsService: {
      type: Object
    },

    /**
     * Page/Scene visibility manager.
     */
    visibilityService: {
      type: Object
    },

    /**
     * The mode of Santa Tracker. Possible values are blank, 'cast', or 'portal'.
     */
    mode: {
      type: String,
      value: ""
    },

    /**
     * If true, whenever the village is loaded, load some random visual experience after a time.
     */
    triggerRandom: {
      type: Boolean,
      value: false
    },

    /**
     * True when the tracker intro scene was shown. Used by `tracker-scene`.
     */
    hasTrackerIntroShown: {
      type: Boolean,
      value: false
    },

    /**
     * List of video routes. Used for template binding.
     */
    videos: {
      type: Object,
      readOnly: true
    },

    /**
     * A reference to the fallback house used instead of 'callfromsanta'.
     */
    _fallbackHouse: {
      type: Object,
      value: null
    },

    /**
     * True when the countdown is complete, and the tracker is active.
     */
    duringTracker: {
      type: Boolean,
      value: false,
    },

    /**
     * True when Santa's flight is complete.
     */
    postFlight: {
      type: Boolean,
      value: false,
      observer: '_postFlightChanged'
    },

    /**
     * sceneParams from `santa-tracker-router`. Can't be changed; router
     * provides this as frozen and readOnly.
     */
    sceneParams: {
      type: Object,
      observer: 'sceneParamsChanged'
    },

  },

  listeners: {
    'title-click': 'onDefaultAction',
    'scene-progress': 'onSceneProgress',
    'scene-ready': 'onSceneReady',
    'video-scene-done': 'onVideoSceneDone',
    'iframe-focus-change': 'onIframeFocusChange',
    'analytics-track-event': 'trackEvent',
    'analytics-time-start': 'timeStart',
    'analytics-time-end': 'timeEnd',
    'analytics-track-share': 'trackShare',
    'analytics-track-game-start': 'trackGameStart',
    'analytics-track-game-quit': 'trackGameQuit',
    'analytics-track-game-over': 'trackGameOver',
    'countdown-timer-finish': 'onCountdownFinish',
    'tracker-end': 'onTrackerEnd',
    'share': 'onShare',
  },

  created: function() {
    // silence the noisy things
    if (!window.DEV) {
      console.log = function(){};
    }

    this.analyticsService = new Analytics();
    this.visibilityService = new VisibilityManager();
  },

  ready: function() {
    this._houses = window.HOUSES;
    this._setVideos(Object.freeze(window.VIDEOS));
    this.config = window.SANTA_CONFIG;
    delete window.HOUSES; // cleanup
    delete window.VIDEOS; // cleanup
    delete window.SANTA_CONFIG; // cleanup

    this._setCountdownEndAt(this.config.COUNTDOWN_END_DATE);
    this._setFlightFinishedAt(this.config.FLIGHT_FINISHED);

    var defaultApiClient = 'cast' in window ? 'web_chromecast' : 'web';
    var apiClient = getUrlParameter('api_client') || defaultApiClient;
    if (!apiClient.match(/^[a-zA-Z_]*$/)) {
      apiClient = defaultApiClient;
    }
    switch (apiClient) {
      case 'web_chromecast':
        this.mode = 'cast';
        this.triggerRandom = true;
        break;
      case 'web_portal':
        apiClient = 'web';
        this.mode = 'portal';
        break;
      default:
        break;
    }

    var sc = new SoundController(this._soundsLoaded.bind(this));
    this.addEventListener('sound-preload', sc.loadSounds.bind(sc));
    this.addEventListener('sound-ambient', sc.playAmbientSounds.bind(sc));
    this.addEventListener('sound-trigger', sc.playSound.bind(sc));

    // NOTE: There's a race here: 'sound-ambient' is registered above, but setting the initial
    // background state here still causes audio to start on unfocused tabs. This is probably fine,
    // and Santa will just make noise before its tab is first focused.
    this.visibilityService.addOnPauseListener(this._setPageInBackground.bind(this, true));
    this.visibilityService.addOnResumeListener(this._setPageInBackground.bind(this, false));
    this._setPageInBackground(this.visibilityService.isPaused());

    var version = document.body.getAttribute('data-version');
    this.santaService = new SantaService(apiClient, this.language, version);
    this.santaService.sync(this._checkSchedule.bind(this));

    this.santaService.addListener('kill', function justKillMe() {
      window.ga('send', 'event', 'API', 'killed');
      window.setTimeout(function() {
        window.location = 'https://santatracker.google.com' +
            location.pathname.replace(/[^\/]*$/, '') + 'error.html';
      }, 1000);
    }.bind(this));

    var reloadTimeout;
    this.santaService.addListener('reload', function() {
      this.analyticsService.trackEvent('API', 'reload');

      if (window.DEV) {
        console.warn('prod would trigger reload, out of date', document.body.getAttribute('data-version'));
        return;
      }
      if (reloadTimeout) {
        return;  // already trying to reload
      }

      // Schedule a reload in the next ~2 hours, but only after the last user
      // click.
      var reloader = function(ev) {
        var when = Math.random() * 1000 * 60 * 60 * 2;  // next two hours
        window.clearTimeout(reloadTimeout);
        reloadTimeout = window.setTimeout(function() {
          window.location.reload();
        }, when);
      };
      document.addEventListener('click', reloader);
      reloader();
    }.bind(this));

    this._prepareHouses();

    this._checkSchedule();
    if (!this.route) {
      this.route = this.defaultRoute;
    }
  },

  /**
   * Handles the title being clicked, or ESC being hit. Closes the drawer, or redirects to the
   * default route.
   */
  onDefaultAction: function() {
    var wasOpen = this.$.chrome.closeDrawer();
    if (!wasOpen) {
      this.$.router.go(this.defaultRoute);
    }
  },

  /**
   * Handles a loading progress hint, hiding or displaying the preloader.
   */
  onSceneProgress: function() {
    var scene = this.selectedScene;
    if (scene) {
      this.$.preloader.active = !scene.loaded;
      this.$.preloader.value = scene.preloadProgress || 0;  // prevent undefined
    } else {
      this.$.preloader.active = false;
    }
  },

  onSceneReady: function(event, scene) {
    this.sceneParamsChanged(this.$.router.sceneParams);
  },

  sceneParamsChanged: function(newValue) {
    // sceneParamsChanged might happen while a scene isn't ready yet, so wait
    // until it's upgraded. onSceneReady will be called then.
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.sceneParams = newValue;
    }
  },

  onVideoSceneDone: function(event) {
    if (this.mode == 'cast') {
      this.route = this.defaultRoute;
    }
  },

  /**
   * Catch-all place to do some kind of initialization of houses.
   */
  _prepareHouses: function() {
    var castMode = this.mode === 'cast';
    var portalMode = this.mode === 'portal';
    var ios = navigator.userAgent.match(/iPhone|iPod|iPad/i);
    var isSpanglish = /^e(n|s)/.test(this.language);
    var isEnglish = /^en/.test(this.language);

    for (var i = this._houses.length - 1; i >= 0; i--) {
      var house = this._houses[i];

      // If this house is an array, it's a choice of houses based on language
      // or other conditions.
      if (house.length) {
        var choice = house[0];
        switch (choice.module) {
        case 'callfromsanta':
          // remove callfromsanta where not supported (leaving fallback house)
          // or after Santa's flight has concluded.
          if (!isSpanglish || this.postFlight) {
            choice = house[1];
          } else {
            // Save the object for postFlight (when callfromsanta will be 
            // disabled)
            this._fallbackHouse = house[1];
          }
          break;
        case 'seasonofcaring':
          // not translated, choose backup house instead
          if (!isEnglish) {
            choice = house[1];
          }
          break;
        }

        this._houses[i] = house = choice;
      }

      house.disabled = house.disabled || castMode;  // by default, all houses are disabled on cast

      switch (house.module) {
        case 'app':
          // Disable Google Play house on iOS devices
          house.disabled = (ios || portalMode || house.disabled);
          break;
      }
    }
  },

  get defaultRoute() {
    return this.duringTracker ? TRACKER_ROUTE : DEFAULT_ROUTE;
  },

  /**
   * Async holder for _triggerRandom.
   */
  _triggerRandomAsync: null,

  /**
   * Requests that a random visual scene be loaded. Only runs if `triggerRandom` is true.
   */
  _triggerRandom: function() {
    if (!this.triggerRandom) {
      return;
    }

    var when = randomRange(VIDEO_RANDOM_MIN, VIDEO_RANDOM_MAX);
    var remaining = this.countdownEndAt - this.santaService.now();
    if (remaining < VIDEO_RANDOM_SAFE) {
      return;  // give up, no more videos this close to launch
    }
    console.debug('triggering random video in', when);

    this.cancelAsync(this._triggerRandomAsync);
    this._triggerRandomAsync = this.async(function() {
      var opts = Object.keys(this.videos).filter(function(scene) {
        return this.sceneIsUnlocked(scene);
      }, this);
      var choice = randomChoice(opts);
      console.debug('chose random video', choice, 'from', opts);
      this.route = choice;
    }, when);
  },

  _selectedSceneChanged: function(newValue, oldValue) {
    this.$.chrome.isFixedToolbar = newValue && !newValue.hasAttribute('freeform');
    this.$.chrome.closeDrawer();

    if (oldValue && oldValue.route) {
      this.prevSelectedRoute = oldValue.route;
    }
    if (newValue == this.$.village) {
      this._triggerRandom();
    }

    this._updateWindowTitle();
  },

  _prevSelectedRouteChanged: function() {
    if (!this.prevSelectedRoute) {
      return;
    }

    // Only remove certain elements from the DOM.
    var isPermanentScene = PERMANENT_ROUTES.indexOf(this.prevSelectedRoute) != -1;
    if (isPermanentScene) {
      return;
    }

    // Find and remove the previous scene, if any.
    var prevSelectedScene = null;
    for (var i = 0, scene; scene = this.$.lazypages.items[i]; ++i) {
      if (scene.route == this.prevSelectedRoute) {
        prevSelectedScene = scene;
        break;
      }
    }
    if (!prevSelectedScene) {
      return;
    }

    var dom = Polymer.dom(this.$.lazypages);
    dom.removeChild(prevSelectedScene);

    // Re-construct removed scene and add it back to lazy-pages. Note that
    // loading-* isn't copied, since the element is already loaded.
    var el = document.createElement(prevSelectedScene.localName);
    el.route = prevSelectedScene.route;
    el.santaApp = this;
    el.loaded = true;

    var retainAttr = ['route', 'mode', 'freeform', 'header-color', 'youtube-id'];
    retainAttr.forEach(function(attr) {
      if (prevSelectedScene.hasAttribute(attr)) {
        el.setAttribute(attr, prevSelectedScene.getAttribute(attr));
      }
    });

    dom.appendChild(el);
  },

  _routeChanged: function(newValue) {
    if (this.validateRoute()) {
      // Route is valid. Send to analytics and load the scene.
      this.trackPageview('/' + newValue);
      return;
    }

    // The requested route was changed.
    var currentRoute = this.selectedScene ? this.selectedScene.route : '';
    this.fire('analytics-track-event', { category: 'Routing',
        action: 'Invalid Route Source', label: '/' + currentRoute});
    this.fire('analytics-track-event', { category: 'Routing',
        action: 'Invalid Route', label: '/' + newValue});
    this.route = this.defaultRoute;
  },

  _updateWindowTitle: function() {
    var scene = this.selectedScene;
    var raw = scene && scene.getAttribute('icon');
    var icon = '';
    if (raw && String.fromCodePoint) {  // no emoji on IE11
      icon = String.fromCodePoint(parseInt(raw, 16));
    }
    document.title = icon + WINDOW_TITLE;
  },

  /**
   * Returns whether the current route is valid.
   */
  validateRoute: function() {
    if (!this.$.lazypages.isValidRoute(this.route)) {
      return false;
    }
    if (!this.sceneIsUnlocked(this.route)) {
      if (!window.DEV) {
        return false;
      }
      console.debug('prod would redirect from', this.route, '=>', this.defaultRoute);
    }
    return true;
  },

  _userMuteChanged: function(userMute) {
    this.fire('sound-ambient', userMute ? 'global_sound_off' : 'global_sound_on');
  },

  _soundsLoaded: function(soundsName) {
    // _soundsLoaded is typically invoked after a scene preloads audio, but the
    // scene may have changed in that time, so check upgraded state again.
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('sounds-loaded', soundsName);
    }
  },

  trackPageview: function(path) {
    this.analyticsService.trackPageView(path);
  },

  trackEvent: function(e, detail) {
    this.analyticsService.trackEvent(
        detail.category, detail.action, detail.label, detail.value);
  },

  timeStart: function(e, detail) {
    this.analyticsService.timeStart(
        detail.category, detail.variable, detail.time);
  },

  timeEnd: function(e, detail) {
    this.analyticsService.timeEnd(
        detail.category, detail.variable, detail.time, detail.label, detail.maxTime);
  },

  trackShare: function(e, detail) {
    this.analyticsService.trackSocial('share', detail || '', '/' + this.route);
  },

  trackGameStart: function(e, detail) {
    this.analyticsService.trackGameStart(detail.gameId || detail.gameid);
  },

  trackGameQuit: function(e, detail) {
    this.analyticsService.trackGameQuit(detail.gameId || detail.gameid,
        detail.level, detail.timePlayed);
  },

  trackGameOver: function(e, detail) {
    this.analyticsService.trackGameOver(
        detail.gameId || detail.gameid, detail.score, detail.level,
        detail.timePlayed);
  },

  onIframeFocusChange: function(e, detail) {
    if (detail === 'blur') {
      this.visibilityService.pauseIframe();
    } else if (detail === 'focus') {
      this.visibilityService.resumeIframe();
    }
  },

  /**
   * When the flight finishes, check if any houses in the village need to be
   * shutoff, kicking out of invalid routes if necessary.
   */
  _postFlightChanged: function() {
    for (var i = 0; i < this._houses.length; i++) {
      // In regions where callfromsanta was supported, replace it with the
      // fallbackHouse used in other regions
      if (this._houses[i].module === 'callfromsanta') {
        if (this._fallbackHouse) {
          // Use Polymer's splice method to cause notifications.
          this.splice('_houses', i, 1, this._fallbackHouse);
        }
      }

      // lock more houses here, if needed
    }

    // allowed routes may have changed, so check again
    this._checkSchedule();
  },

  /**
   * @param {number} idx of house to unlock
   */
  unlockHouse: function(idx) {
    var house = this._houses[idx];
    if (!house) {
      return;
    }

    // house is melted unless it's disabled
    house.iced = !!house.disabled;
    this._notifyHouses(idx);
  },

  unlockAllHouses: function() {
    for (var i = 0, house; house = this._houses[i]; ++i) {
      this.unlockHouse(i);
    }
  },

  lockAllHouses: function() {
    for (var i = 0, house; house = this._houses[i]; ++i) {
      house.iced = true;
    }
    this._notifyHouses();
  },

  sceneIsUnlocked: function(moduleName) {
    if (!this.santaService) {
      return true;  // fail open before santaService is ready
    }
    var dateNow = this.santaService.dateNow();

    // Unlock scenes as soon as anywhere on the Earth has it unlocked: assume
    // UTC+14 is pretty much as far east as it goes. This doesn't effect houses
    // being iced, but it means users can share links.
    var targetOffset = -14 * (60 * 60000);  // as far east as possible
    var userOffset = dateNow.getTimezoneOffset() * 60000;
    var eastDateNow = new Date(+dateNow + (userOffset - targetOffset));

    for (var i = 0, house; house = this._houses[i]; ++i) {
      if (house.module === moduleName) {
        var launchDate = house.launchDate;
        if (santaApp.mode == 'portal' && house.portalLaunchDate) {
          launchDate = house.portalLaunchDate;
        }
        return !house.disabled && (eastDateNow > launchDate);
      }
    }

    if (moduleName === TRACKER_ROUTE && !this.duringTracker) {
      return false;
    }
    return true;
  },

  /**
   * Timeout for _checkSchedule.
   */
  _scheduleTimeout: null,

  /**
   * Unlocks the correct houses based on the day (index).
   * @private
   */
  _checkSchedule: function() {
    if (!this.santaService) {
      return;  // ignore, will be called via ready:
    }

    var todayDate = this.santaService.dateNow();
    var tomorrowDate = new Date(todayDate);
    tomorrowDate.setDate(todayDate.getDate() + 1);

    // Set post countdown/post flight flags based on current time.
    this.postFlight = todayDate >= this.flightFinishedAt;
    this.duringTracker = todayDate > this.countdownEndAt && !this.postFlight;

    switch(todayDate.getMonth()) {
      case 11: // DECEMBER
        var todayHouse = '';

        // Update house status based on today's date.
        for (var i = 0; i < this._houses.length; i++) {
          var house = this._houses[i];

          var launchDate = house.launchDate;;
          if (santaApp.mode == 'portal' && house.portalLaunchDate) {
            launchDate = house.portalLaunchDate;
          }
          if (launchDate > todayDate) {
            house.iced = true;
            continue;
          }
          this.unlockHouse(i);
          if (isSameDay(launchDate, todayDate)) {
            todayHouse = house.module;
          }
        }

        this.todayHouse = todayHouse;
        break;
      case 0: // JAN
        // All houses in Jan are unlocked. Full experience baby!
        this.unlockAllHouses();
        break;
      default:
        if (window.DEV) {
          this.unlockAllHouses();
        } else {
          this.lockAllHouses();
        }
    }
    this._notifyHouses();

    if (!this.validateRoute()) {
      this.route = this.defaultRoute;
    }

    // Check again at the next hour tick.
    var timeTillHour = (60 - todayDate.getMinutes()) * 60 * 1000;
    this._scheduleTimeout = this.async(this._checkSchedule, timeTillHour);
  },

  _escHandler: function(e, detail) {
    switch (e.detail.key) {
      case 'esc':
        this.onDefaultAction();
        break;
    }
  },

  onCountdownFinish: function(e, detail) {
    // Redirect village -> tracker when the countdown finishes. This allows
    // users to go back to the village.
    if (!this.duringTracker) {
      this._checkSchedule();
      if (this.duringTracker && this.route === DEFAULT_ROUTE) {
        // Act as if the user has clicked a link, and update the hash manually.
        this.$.router.go(TRACKER_ROUTE);
      }
    }
  },

  /**
   * Triggered on a request to share. Creates sharing popup for the specified service (passed as
   * detail of event).
   */
  onShare: function(e, service) {
    var url = (function(url) {
      // TODO(samthor): Optionally use a URL shortener, if something's obviously hiding in the URL-
      // like an encoded beard.
      var enc = window.encodeURIComponent(url);

      switch (service) {
      case 'facebook':
        return 'https://facebook.com/sharer.php?p[url]=' + enc;
      case 'gplus':
        return 'https://plus.google.com/share?hl=' + this.language + '&url=' + enc;
      case 'twitter':
        // For Twitter, include the name of the current scene (or fallback to 'Santa Tracker').
        var cand = this.$.strings.s('scene-' + this.route);
        var text = cand || this.$.strings.s('santatracker') || 'Santa Tracker';
        return 'https://twitter.com/intent/tweet?lang=' + this.language +
            '&hashtags=santatracker&text=' + window.encodeURIComponent(text) + '&url=' + enc;
      }

      return null;
    }.call(this, window.location.href));
    if (!url) { return; }

    this.fire('analytics-track-share', service);
    window.open(url, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,width=800,height=600');
  },

  /**
   * Notifies bound properties that the houses have changed (useful for the
   * village). Dedups with a microtask.
   * @param {number=} opt_idx
   * @private
   */
  _notifyHouses: function(opt_idx) {
    this.debounce('_notifyHouses', function() {
      if (!this.$.village.is) {
        // the village isn't yet a Polymer element, so ignore.
        return;
      }

      // TODO(samthor): Notify all properties that might change. Polymer 1.x+ cannot use O.o, and
      // there's no way to notify a whole house. Also, `this.splice` is used in _postFlightChanged.
      var propertiesToNotify = ['iced', 'disabled', 'module', 'category'];

      this._houses.forEach(function(house, i) {
        var path = ['houses', i, ''];
        propertiesToNotify.forEach(function(property) {
          path[2] = property;
          this.$.village.notifyPath(path, house[property]);
        }, this);
      }, this);
    });
  },

  /**
   * Returns the (static) color for the given route. Returns the blank string if there is no color.
   * This accepts both route and validRoutes from lazy-pages, in order to retrigger when the routes
   * are fully computed: any template dom-repeat routes are hidden.
   */
  colorForRoute: function(route, validRoutes) {
    var el = this.$.lazypages.getRoute(route);
    return (el ? el.getAttribute('header-color') : '') || '';
  },

  isCastMode: function(mode) {
    return mode == 'cast';
  },

  onTrackerEnd: function(e, detail) {
    this._checkSchedule();
  },

  /**
   * Converts the map of routes -> YouTube IDs to an array of routes.
   */
  _computeVideoRoutes: function(videos) {
    return Object.keys(videos);
  },

  /**
   * Converts the route to a YouTube ID.
   */
  _computeVideoId: function(videos, route) {
    return videos[route];
  },

});

})();
</script>
</dom-module>
