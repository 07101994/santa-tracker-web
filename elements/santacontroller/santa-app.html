<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../../components/flatiron-director/flatiron-director.html">
<link rel="import" href="../preloader/preload-overlay.html">
<link rel="import" href="../calendar/calendar-nav.html">
<link rel="import" href="../lazy-pages.html">

<link rel="import" href="dependencies.html">

<!--
Santa Track app.

@element santa-app
-->
<polymer-element name="santa-app"
                 on-analytics-track-event="{{trackEvent}}"
                 on-analytics-track-perf="{{trackPerf}}"
                 on-analytics-time-start="{{timeStart}}"
                 on-analytics-time-end="{{timeEnd}}"
                 on-analytics-track-social="{{trackSocial}}"
                 on-analytics-track-game-start="{{trackGameStart}}"
                 on-analytics-track-game-quit="{{trackGameQuit}}"
                 on-analytics-track-game-over="{{trackGameOver}}" tabindex="0">
<template>
  <!-- Route controller -->
  <flatiron-director route="{{route}}" autoHash></flatiron-director>

  <!-- Preloading scene overlay -->
  <preload-overlay id="preloader" value="{{selectedScene.preloadProgress || 0}}"
                   active?="{{selectedScene && !selectedScene.loaded}}"></preload-overlay>

  <lazy-pages id="lazypages" selected="{{route}}" selectedItem="{{selectedScene}}" valueattr="route"
              santaApp="{{}}" preloader="{{$.preloader}}">

    <calendar-nav route="calendar" alwaysActive
        houses="{{houses}}" santaApp="{{}}"
        loadingBgColor="#7847b2"
        hidden?="{{mode == 'cast'}}"></calendar-nav>

    <village-scene route="village"
        path="scenes/village/village-scene_[[language]].html"
        mode="{{mode}}" hidden></village-scene>

    <airport-scene route="airport"
        path="scenes/airport/airport-scene_[[language]].html"
        loadingBgColor="rgb(129,208,0)" hidden></airport-scene>

    <boatload-scene route="boatload"
        path="scenes/boatload/boatload-scene_[[language]].html"
        loadingBgColor="#28b5f5"
        loadingSrc="scenes/boatload/img/loading.gif" hidden></boatload-scene>

    <briefing-scene route="briefing"
        path="scenes/briefing/briefing-scene_[[language]].html"
        loadingBgColor="'rgb(129,208,0)" hidden></briefing-scene>

    <gumball-scene route="gumball"
        path="scenes/gumball/gumball-scene_[[language]].html"
        loadingBgColor="#914295"
        loadingSrc="scenes/gumball/img/loading.gif" hidden></gumball-scene>

    <matching-scene route="matching"
        path="scenes/matching/matching-scene_[[language]].html"
        loadingBgColor="#b27644"
        loadingSrc="scenes/matching/img/loading.gif" hidden></matching-scene>

    <mercator-scene route="mercator"
        path="scenes/mercator/mercator-scene_[[language]].html"
        loadingBgColor="rgb(251,191,44)"
        loadingSrc="scenes/mercator/img/loading.svg" hidden></mercator-scene>

    <presentdrop-scene route="presentdrop"
        path="scenes/presentdrop/presentdrop-scene_[[language]].html"
        loadingBgColor="rgb(251, 191, 44)"
        loadingSrc="scenes/presentdrop/img/loading{{hdpi ? '_2x' : ''}}.gif" hidden></presentdrop-scene>

    <racer-scene route="racer"
        path="scenes/racer/racer-scene_[[language]].html"
        loadingBgColor="#8fd7f7"
        loadingSrc="scenes/racer/img/loading{{hdpi ? '_2x' : ''}}.gif" hidden></racer-scene>

    <workshop-scene route="workshop"
        path="scenes/workshop/workshop-scene.html"
        loadingBgColor="rgb(129,208,0)" hidden></workshop-scene>

    <windtunnel-scene route="windtunnel"
        path="scenes/windtunnel/windtunnel-scene.html" hidden
        loadingBgColor="rgb(129,208,0)"></windtunnel-scene>

    <rollercoaster-scene route="rollercoaster"
        path="scenes/rollercoaster/rollercoaster-scene.html" hidden></rollercoaster-scene>

    <undersea-scene route="undersea"
        path="scenes/undersea/undersea-scene.html" hidden></undersea-scene>

    <traditions-scene route="traditions"
        path="scenes/traditions/traditions-scene_[[language]].html"
        loadingBgColor="rgb(255,224,0)"
        loadingSrc="scenes/traditions/img/loading{{hdpi ? '_2x' : ''}}.gif" hidden></traditions-scene>

    <trailer-scene route="trailer"
        path="scenes/trailer/trailer-scene_[[language]].html"
        loadingBgColor="rgb(129,208,0)" hidden></trailer-scene>

    <about-scene route="about"
        path="scenes/about/about-scene_[[language]].html"
        loadingBgColor="rgb(129,208,0)" hidden></about-scene>

  </lazy-pages>
</template>
<script>
(function() {

var DEFAULT_ROUTE_ = 'village';
var TRACKER_ROUTE_ = 'tracker';
var VALID_ROUTES_ = [];

// Routes/scenes which should always be accessible, no matter what the day.
// These scenes are also not removed from the lazy-page switching.
var PERMANENT_ROUTES_ = ['village', 'calendar', 'about'];

// Check if date1 is the same date as date2.
function isSameDay_(date1, date2) {
  return date1.getMonth() == date2.getMonth() &&
         date1.getDate() == date2.getDate() &&
         date1.getYear() == date2.getYear();
}

Polymer(Polymer.mixin({

  /**
   * When Santa's flight is finished.
   *
   * @property countDownEndDate
   * @type number
   * @default null
   */
  countDownEndDate: null,

  /**
   * When Santa's flight is finished.
   *
   * @property FLIGHT_FINISHED
   * @type number
   * @default null
   * @const
   */
  FLIGHT_FINISHED: null,

  /**
   * The house meta data shared across scenes.
   *
   * @property houses
   * @type array
   * @default []
   */
  houses: [],

  /**
   * If the browser is hdpi.
   * @property
   * @type boolean
   * @default false
   */
  hdpi: 'devicePixelRatio' in window && devicePixelRatio > 1.5 || false,

  /**
   * The current language locale.
   *
   * @property language
   * @type string
   * @default 'en'
   */
  language: document.documentElement.lang || 'en',

  /**
   * The currently open scene.
   *
   * @property selectedScene
   * @type Element
   * @default null
   */
  selectedScene: null,

  /**
   * The previously selected scene route.
   *
   * @attribute prevSelectedRoute
   * @type string
   * @default null
   */
  prevSelectedRoute: null,

  /**
   * Current URL route.
   *
   * @attribute route
   * @type string
   * @default null
   */
  route: null,

  /**
   * Analytics service.
   *
   * @property analyticsService
   * @type Analytics
   * @default null
   */
  analyticsService: null,

  /**
   * Page/Scene visibility manager.
   *
   * @property visibilityService
   * @type VisiblityManager
   * @default null
   */
  visibilityService: null,

  /**
   * The mode of the scene. Possible values are: 'cast'.
   *
   * @property mode
   * @type string
   * @default ''
   */
  mode: '',

  /**
   * True when Santa's schedule has been checked for the first time.
   *
   * @property scheduleChecked
   * @type bool
   * @default false
   */
  scheduleChecked: false,

  publish: {
    /**
     * True when the countdown is complete.
     *
     * @attribute postCountdown
     * @type bool
     * @default false
     */
    postCountdown: {value: false, reflect: true},

    /**
     * True when Santa's flight has is complete.
     *
     * @attribute postFlight
     * @type bool
     * @default false
     */
    postFlight: {value: false, reflect: true},
  },

  ready: function() {
    // silence the noisy things
    if (!window.DEV) {
      console.log = function(){};
    }

    this.analyticsService = new Analytics();
    this.visibilityService = new VisibilityManager(this);
    this.visibilityService.addOnPauseListener(this.onPause.bind(this));
    this.visibilityService.addOnResumeListener(this.onResume.bind(this));

    this.houses = window.HOUSES;
    this.config = window.SANTA_CONFIG;
    delete window.HOUSES; // cleanup
    delete window.SANTA_CONFIG; // cleanup

    this.countDownEndDate = this.config.COUNTDOWN_END_DATE;
    this.FLIGHT_FINISHED = this.config.FLIGHT_FINISHED;

    var apiClient = getUrlParameter('api_client') || 'web';
    if (!apiClient.match(/^[a-zA-Z_]*$/)) {
      apiClient = 'web';
    }

    this.santaService = new SantaService(apiClient, this.language);
    this.santaService.addListener('kill', function() {
      window.location = 'error.html';
    });

    if (apiClient === 'web_chromecast') {
      this.mode = 'cast';
      this.initChromecast();
    } else {
      var sc = new SoundController();
      this.addEventListener('sound-preload', sc.loadSounds.bind(sc));
      this.addEventListener('sound-ambient', sc.playAmbientSounds.bind(sc));
      this.addEventListener('sound-trigger', sc.playSound.bind(sc));

      window.addEventListener('blur', function() {
        this.fire('sound-ambient', 'global_blur');
      }.bind(this));

      window.addEventListener('focus', function() {
        this.fire('sound-ambient', 'global_focus');
      }.bind(this));
    }

    // Set post countdown/post flight flags based on current time.
    if (this.santaService.now() > this.countDownEndDate) {
      if (this.santaService.now() < this.FLIGHT_FINISHED) {
        this.postCountdown = true;
      } else {
        this.postFlight = true;
      }
    }

    // Initialize routes.
    VALID_ROUTES_ = this.$.lazypages.items.map(function(el) {
      // Note: can't use .route b/c some scene elements won't be upgraded yet.
      return el.getAttribute('route');
    });

    if (!this.route) {
      this.route = this.postCountdown ? TRACKER_ROUTE_ : DEFAULT_ROUTE_;
    }
  },

  languageChanged: function() {
    this.santaService.lang_ = this.language;
  },

  selectedSceneChanged: function(oldVal, newVal) {
    if (oldVal) {
      this.prevSelectedRoute = oldVal.route;
    }
  },

  prevSelectedRouteChanged: function() {
    // Only remove certain elements from the DOM.
    var dontRemoveEl = PERMANENT_ROUTES_.indexOf(this.prevSelectedRoute) != -1;
    if (dontRemoveEl) {
      return;
    }

    var prevSelectedScene = null;
    for (var i = 0, scene; scene = this.$.lazypages.items[i]; ++i) {
      if (scene.route == this.prevSelectedRoute) {
        prevSelectedScene = scene;
        break;
      }
    }

    prevSelectedScene.parentNode.removeChild(prevSelectedScene);

    // Re-construct removed scene and add it back to lazy-pages.
    var el = document.createElement(prevSelectedScene.localName);
    el.route = prevSelectedScene.route;
    el.path = prevSelectedScene.path;
    el.mode = this.mode;
    el.hidden = true;
    el.santaApp = this;
    el.loaded = true;

    this.$.lazypages.appendChild(el);
  },

  scheduleCheckedChanged: function() {
    if (this.scheduleChecked) {
      this.validateRoute();
    }
  },

  routeChanged: function() {
    // Special case certain routes. The rest are handled by lazy-pages.
    switch (this.route) {
      case 'now':
        this.route = 'village';
        break;
      default:
        this.validateRoute();
    }

    this.trackPageview('/' + this.route);
  },

  validateRoute: function() {
    if (this.scheduleChecked) {
      var valid = (VALID_ROUTES_.indexOf(this.route) != -1 &&
                   this.sceneIsUnlocked(this.route)) ||
                   (this.postCountdown && this.route == TRACKER_ROUTE_);
      if (!valid) {
        this.route = DEFAULT_ROUTE_;
      }
    }
  },

  // TODO(bckenny): can also add a paused attribute in case anything wants to
  // bind to it
  onPause: function() {
    this.fire('sound-ambient', 'global_pause');
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('scene-pause', true);
    }
  },

  onResume: function() {
    this.fire('sound-ambient', 'global_unpause');
    if (this.selectedScene && this.selectedScene.fire) {
      this.selectedScene.fire('scene-pause', false);
    }
  },

  trackPageview: function(path) {
    this.analyticsService.trackPageView(path);
  },

  trackEvent: function(e, detail, sender) {
    this.analyticsService.trackEvent(
        detail.category, detail.action, detail.label);
  },

  trackPerf: function(e, detail, sender) {
    this.analyticsService.trackPerf(
        detail.category, detail.variable, detail.time, detail.label);
  },

  timeStart: function(e, detail, sender) {
    this.analyticsService.timeStart(
        detail.category, detail.variable, detail.time);
  },

  timeEnd: function(e, detail, sender) {
    this.analyticsService.timeEnd(
        detail.category, detail.variable, detail.time, detail.label);
  },

  trackSocial: function(e, detail, sender) {
    this.analyticsService.trackSocial(
        detail.network, detail.action, detail.target);
  },

  trackGameStart: function(e, detail, sender) {
    this.analyticsService.trackGameStart(detail.gameid);
  },

  trackGameQuit: function(e, detail, sender) {
    this.analyticsService.trackGameQuit(detail.gameId, detail.timePlayed);
  },

  trackGameOver: function(e, detail, sender) {
    this.analyticsService.trackGameOver(
        detail.gameId, detail.score, detail.level, detail.timePlayed);
  },

  /**
   * When the flight finishes, redirect the user to the village.
   */
  postFlightChanged: function() {
    // TODO(lukem): lock houses that need locking.
  },

  /**
   * When the countdown finishes, redirect the user to the tracker.
   */
  postCountdownChanged: function() {
    if (this.santaService.now() > this.FLIGHT_FINISHED) {
      this.postFlight = true;
      return;
    }

    if (document.body.classList.contains('posttakeoff')) {
      return;
    }

    document.body.classList.add('posttakeoff');
  },

  /**
   * @param number index
   */
  unlockHouse: function(idx) {
    var house = this.houses[idx];

    if (!house || house.disabled) {
      return;
    }

    house.iced = false;
  },

  unlockAllHouses: function() {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      this.unlockHouse(i);
      house.today = false;
      house.tomorrow = false;
    }
  },

  lockAllHouses: function() {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      house.iced = true;
      house.today = false;
      house.tomorrow = false;
    }
  },

  sceneIsUnlocked: function(moduleName) {
    for (var i = 0, house; house = this.houses[i]; ++i) {
      if (house.module == moduleName) {
        return !house.iced;
      }
    }

    // Certain scenes don't have associated houses. Whitelist them.
    if (PERMANENT_ROUTES_.indexOf(moduleName) != -1) {
      return true;
    }

    return false;
  },

  /**
   * Unlocks the correct houses based on the day (index).
   * @param {boolean=} opt_once check only once.
   * @private
   */
  checkSchedule_: function(opt_once) {
    var now = this.santaService ? this.santaService.now() : Date.now();

    var todayDate = new Date(now);
    var day = todayDate.getDate();

    // // Houses unlock at 6AM.
    // if (todayDate.getHours() < 6) {
    //   day--;
    // }

    switch(todayDate.getMonth()) {
      case 11: // DECEMBER
        // Unlock all houses up to and including today's.
        for (var i = 0; i <= day + 2; ++i) {
          var house = this.houses[i];

          if (house) {
            house.today = false; // reset previous houses.
            house.tomorrow = false;

            this.unlockHouse(i);

            // Check if house's unlocking date it today!
            if (isSameDay_(house.launchDate, todayDate)) {

              house.today = true;

              var nextHouse = this.houses[i + 1];
              if (nextHouse) {
                nextHouse.tomorrow = true;
              }
            }
          }
        }
        break;
      case 0: // JAN
        // All houses in Jan are unlocked. Full experience baby!
        this.unlockAllHouses();
        break;
      default:
        // noop
        this.lockAllHouses();
    }

    if (opt_once) {
      this.scheduleChecked = true;
      return;
    }

    // Check again at the next hour tick.
    var timeTillHour = (60 - todayDate.getMinutes()) * 60 * 1000;
    this.scheduleTimeout_ = this.async(this.checkSchedule_, null, timeTillHour);
  }

}, chromecastMixin));

})();
</script>
</polymer-element>
