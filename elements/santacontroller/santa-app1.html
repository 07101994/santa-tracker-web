<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../../components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../santa-tracker-router.html">
<link rel="import" href="../preloader/preload-overlay.html">
<!-- <link rel="import" href="../calendar/calendar-nav.html"> -->
<link rel="import" href="../lazy-pages.html">

<link rel="import" href="dependencies.html">

<dom-module id="santa-app">
<template>
  <!-- Keyboard handler -->
  <iron-a11y-keys id="keys" keys="esc" on-keys-pressed="_escHandler"></iron-a11y-keys>

  <!-- Route controller -->
  <santa-tracker-router route="{{route}}" scene-params="{{sceneParams}}" auto-hash></santa-tracker-router>

  <!-- Preloading scene overlay -->
  <preload-overlay id="preloader"></preload-overlay>

  <!-- Scenes -->
  <lazy-pages id="lazypages" delay-load selected="{{route}}" selected-item="{{selectedScene}}" attr-for-selected="route" selected-attribute="active">
    <dummy-scene route="dummy" always-active path="scenes/dummy/dummy-scene.html"></dummy-scene>

    <boatload-scene route="boatload"
        path="scenes/boatload/boatload-scene_en.html"
        loading-bg-color="#8fd7f7"
        loading-src="scenes/boatload/img/loading.svg"></boatload-scene>

    <div route="first">First</div>
    <div route="second">Second</div>
    <div route="third">Third</div>
  </lazy-pages>

</template>
<script>
(function() {

var VALID_ROUTES = [];

// Routes/scenes which should always be accessible, no matter what the day.
// These scenes are also not removed from the lazy-page switching.
var PERMANENT_ROUTES = ['village', 'calendar', 'about'];

var VIDEO_ROUTES = [
  'trailer', 'carpool', 'liftoff', 'jingle', 'satellite', 'temptation',
  'office', 'tired', 'com-room', 'reload', 'slacking-off'
];

// Routes/scenes unlocked with the tracker (including all video routes)
var TRACKER_ROUTES = ['blimp', 'island', 'undersea', 'icecave', 'runner',
    'latlong', 'glider', 'trivia'].concat(VIDEO_ROUTES);

Polymer({
  is: 'santa-app',

  htmlAttributes: {'tabindex': '0'},

  properties: {
    selectedScene: {
      type: Element,
      observer: '_selectedSceneChanged',
      value: null
    },
    route: {
      type: String,
      observer: '_routeChanged'
    },
    prevSelectedRoute: {
      type: String,
      observer: '_prevSelectedRouteChanged',
      value: null
    },
  },

  listeners: {
    'scene-progress': 'onSceneProgress',
  },

  /**
   * Handles a loading progress hint, hiding or displaying the preloader.
   */
  onSceneProgress: function() {
    var scene = this.selectedScene;
    if (scene) {
      this.$.preloader.active = !scene.loaded;
      this.$.preloader.value = scene.preloadProgress;
    } else {
      this.$.preloader.active = false;
    }
  },

  ready: function() {
    this.$.lazypages.preloader = this.$.preloader;
    this.$.lazypages.santaApp = this;

    if (!this.route) {
      this.route = this.defaultRoute;
    }
  },

  get defaultRoute() {
    // TODO(samthor): Village or tracker based on time
    return 'dummy';
  },


  _selectedSceneChanged: function(newValue, oldValue) {
    if (oldValue === newValue) {
      return;
    }
    if (oldValue && oldValue.route) {
      this.prevSelectedRoute = oldValue.route;
    }
    // Let the selected scene know about params.
    // TODO(samthor): How does this interact with two-way binding?
    if (this.selectedScene) {
      this.selectedScene.sceneParams = this.sceneParams;
    }
  },

  _prevSelectedRouteChanged: function() {
    if (!this.prevSelectedRoute) {
      return;
    }

    // Only remove certain elements from the DOM.
    var dontRemoveEl = PERMANENT_ROUTES.indexOf(this.prevSelectedRoute) != -1;
    if (dontRemoveEl) {
      return;
    }

    var prevSelectedScene = null;
    for (var i = 0, scene; scene = this.$.lazypages.items[i]; ++i) {
      if (scene.route == this.prevSelectedRoute) {
        prevSelectedScene = scene;
        break;
      }
    }

    // // Remove previous scene if it shouldn't always be active.
    if (prevSelectedScene && !prevSelectedScene.alwaysActive) {
      var dom = Polymer.dom(this.$.lazypages);
      dom.removeChild(prevSelectedScene);

      // Re-construct removed scene and add it back to lazy-pages. Note that
      // loading-* isn't copied, since the element is already loaded.
      var el = document.createElement(prevSelectedScene.localName);
      el.route = prevSelectedScene.route;
      el.santaApp = this;
      el.loaded = true;

      dom.appendChild(el);
    }
  },

  _routeChanged: function() {
    // Check if the new route needs a special-case redirect or if it is valid.
    // If this changes the route, routeChanged() will be called again, repeating
    // until this.route passes through validateRoute() successfully.
    var requestedRoute = this.route;
    switch (requestedRoute) {
      case 'tourist':
        // tourist and trailer are synonymous
        this.route = 'trailer';
        break;
      case 'gumballs':
        this.route = 'gumball';
        break;
    }
    this.validateRoute();

    if (requestedRoute === this.route) {
      // Route is valid. Send to analytics and load the scene.
      // TODO(samthor): Restore this call
//          this.trackPageview('/' + this.route);
    } else if (requestedRoute !== '') {
      // The requested route was changed.
      var currentRoute = null;
      var pageUrl = location.href.substr(0, location.href.length - location.hash.length);
      if (pageUrl) {
        currentRoute = pageUrl + '#' + this.selectedScene.route;
      }
      this.fire('analytics-track-event', { category: 'Routing',
          action: 'Invalid Route Source', label: currentRoute});
      this.fire('analytics-track-event', { category: 'Routing',
          action: 'Invalid Route', label: '/' + requestedRoute});
    }
  },

  validateRoute: function() {
    var validRoutes = this.$.lazypages.items.map(function(el) {
      // Note: can't use .route b/c some scene elements won't be upgraded yet.
      return el.getAttribute('route');
    });
    var valid = (validRoutes.indexOf(this.route) != -1);

    // TODO(samthor): Restore this logic
    // if (this.scheduleChecked) {
    //   var valid = (VALID_ROUTES_.indexOf(this.route) != -1 &&
    //                this.sceneIsUnlocked(this.route)) ||
    //                (this.postCountdown && this.route == TRACKER_ROUTE_);
      if (!valid) {
        this.route = this.defaultRoute;
      }
    // }
  },

  _escHandler: function(e, detail, sender) {
    switch (e.detail.key) {
      case 'esc':
        this.route = this.defaultRoute;
        break;
    }
  },

});

})();
</script>
</dom-module>
