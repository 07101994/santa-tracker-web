<script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
<script>
(function() {
  var TIMEOUT_SECONDS = 50;  // default is 10s
  var session = null;
  var applicationID = location.hostname == 'santatracker.google.com' ? '76D471B7' : 'FA3B9AAD';
  var namespace = 'urn:x-cast:com.google.cast.santatracker';

  function sessionListener(e) {
    console.info('cast_sender sessionId', e.sessionId);
    window.santaApp.analyticsService.trackEvent('cast', 'connect');

    session = e;
    session.addUpdateListener(function() {
      if (session.status != chrome.cast.SessionStatus.CONNECTED) {
        window.santaApp.analyticsService.trackEvent('cast', 'disconnect');
        session = null;
      }
    });
    session.addMessageListener(namespace, function(namespace, message) {
      console.info('cast_sender recieved message', namespace, message);
    });
  }

  function receiverListener(e) {
    if (e === chrome.cast.ReceiverAvailability.AVAILABLE) {
      console.info('reciever found', e);
    } else {
      console.info('receiver list empty');
    }
  }

  window.__onGCastApiAvailable = function(loaded, errorInfo) {
    if (!loaded) {
      console.warn('cast_sender api error', errorInfo);
      return;
    }
    var sessionRequest = new chrome.cast.SessionRequest(applicationID,
      [chrome.cast.Capability.VIDEO_OUT],
      1000 * TIMEOUT_SECONDS);
    var apiConfig = new chrome.cast.ApiConfig(sessionRequest,
      sessionListener,
      receiverListener,
      chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED);
    chrome.cast.initialize(apiConfig, function() {
      // great success
    }, function(message) {
      console.warn('cast_sender failure', message);
    });
  }
}());
</script>
