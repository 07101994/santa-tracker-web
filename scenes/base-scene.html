<link rel="import" href="../components/polymer/polymer.html">

<!--
A base class element for Santa Tracker scenes. Should not be declared directly,
but extended by other elements.

### Scene methods

Subclass scene elements are expected to implement the following methods as needed.
These methods will be called at the appropriate times:

- `onPreload` - called to preload assets. Scenes should call `preloadImages` and/or `preloadSounds` inside this method.
- `onShow` - if applicable, preloading has completed. The scene is revealed.
- `onHide` - the scene is hidden.
- `onPause` - the scene has been paused due to page visibility hidden or window blur. Scenes should use this method to stop animations, sounds, etc.
- `onResume` - the scene has been resumed due to page visibility unhidden or window focus. Scenes should use this method to restart animations, sounds, etc.

### Scene properties

Subclass scene elements can define the following properties:

- `componentDir` - the relative path to the component's root folder from the main app folder (e.g 'scenes/village/').
- `loadingColor` - an optional loading screen background color.
- `loadingSrc` - an optional loading screen background image. The path should be relative to the
  component's folder (e.g 'img/loading.gif').

@element base-scene
-->

<!-- Outside base-scene so we don't have to create extra an Shadow DOM. -->
<style shim-shadowdom>
  body /deep/ [alwaysActive] {
    visibility: visible;
    z-index: initial;
  }
</style>

<polymer-element name="base-scene" tabindex="0" attributes="active alwaysActive path route visibilityService">
  <script>
    Polymer({
      publish: {
        /**
         * If `true`, the scene is selected.
         *
         * @attribute active
         * @type bool
         * @default false
         */
        active: {value: false, reflect: true},

        /**
         * If `true`, the scene is always visible and `hidden` won't be applied
         * when the page's `onHide()` is called.
         *
         * @attribute alwaysActive
         * @type bool
         * @default false
         */
        alwaysActive: {value: false, reflect: true}
      },


      /**
       * URL route for this scene.
       *
       * @attribute route
       * @type string
       * @default null
       */
      route: null,

      computed: {
        /**
         * Preloading progress (percentage) of the loaded scene.
         *
         * @property preloadProgress
         * @type number
         * @default 0
         */
        preloadProgress: 'loaded ? 100 : totalAssets ? (assetsLoaded / totalAssets * 100) : 0',
      },

      /**
       * Total number of assets that will need to be preloaded. Must be set
       * in `onPreload` or will be ignored.
       * @property totalAssets
       * @type number
       * @default 0
       */
      totalAssets: 0,

      /**
       * Assets loaded so far (out of `totalAssets`).
       * @property assetsLoaded
       * @type number
       * @default 0
       */
      assetsLoaded: 0,

      /**
       * The path of the scene file (html import) to load.
       *
       * @attribute path
       * @type string
       * @default null
       */
      path: null,

      /**
       * The relative path of the scene folder from the main app root folder.
       * (e.g 'scenes/village/').
       *
       * @property componentDir
       * @type string
       * @default null
       */
      componentDir: null,

      /**
       * True if the scene has previously been loaded.
       *
       * @property loaded
       * @type bool
       * @default false
       */
      loaded: false,

      /**
       * The house meta data shared across scenes.
       *
       * @property houses
       * @type array
       * @default []
       */
      houses: [],

      /**
       * Max number of milliseconds to wait before timing out and abandoning
       * preload.
       *
       * @property MAX_PRELOAD_TIME
       * @type number
       * @default 30000
       */
      MAX_PRELOAD_TIME: 30 * 1000,

      /**
       * Santa service.
       *
       * @property santaService
       * @type SantaService
       * @default null
       */
      santaService: null,

      /**
       * Page/Scene visibility manager.
       *
       * @attribute visibilityService
       * @type VisiblityManager
       * @default null
       */
      visibilityService: null,

      /**
       * The component's directory. Can be used to reference assets in HTML.
       *
       * @property componentBaseDir
       * @type string
       * @default
       */
      get componentBaseDir() {
        return this.baseURI + this.componentDir || '';
      },

      ready: function() {
        if (this.loadingSrc) {
          this.loadingSrc = this.componentBaseDir + this.loadingSrc;
        }
      },

      visibilityServiceChanged: function() {
        if (this.onPause) {
          this.visibilityService.addOnPauseListener(this.onPause.bind(this));
        }
        if (this.onResume) {
          this.visibilityService.addOnResumeListener(this.onResume.bind(this));
        }
      },

      /**
       * A helper method for preloading an array of image URLs.
       * @param {!Array.<string>} imageUrls
       */
      preloadImages: function(imageUrls) {
        this.totalAssets += imageUrls.length;

        var onload = function() {
          this.assetsLoaded++;
        }.bind(this);

        for (var i = 0; i < imageUrls.length; i++) {
          var img = new Image();
          img.onerror = img.onload = onload;
          img.src = this.resolvePath(imageUrls[i]);
        }
      },

      /**
       * Preload a set of sounds for this scene via Klang.
       * @method preloadSounds
       * @param string soundSetName
       */
      preloadSounds: function(soundSetName) {
        this.fire('sound-preload', soundSetName);
      },

      /**
       * Play an ambient sound script for the scene via Klang. This is typically
       * called in onShow and onHide.
       * @method playAmbientSounds
       * @param string soundName
       */
      playAmbientSounds: function(soundName) {
        this.fire('sound-ambient', soundName);
      },

      /**
       * Play a single sound via Klang.
       * @method playSound
       * @param string soundName
       */
      playSound: function(soundName) {
        this.fire('sound-trigger', soundName);
      },

      preloadProgressChanged: function() {
        if (this.preloadProgress === 100) {
          this.showScene();
        }
      },

      showScene: function() {
        this.loaded = true;

        if (this.active) {
          this.onShow && this.onShow();
          this.hidden = false;

          // focus in case element needs keyboard events
          this.focus();
        }
      },

      activeChanged: function() {
        if (!this.active) {
          this.onHide && this.onHide();
          if (!this.alwaysActive) {
            this.hidden = true;
          }
          return;
        }

        // If subclass defines preloading, call it. If not, or nothing needs to
        // be preloaded, signal ready.
        if (!this.loaded && this.onPreload) {
          this.onPreload();

          // If assets are queued to preload, schedule showScene on timeout in
          // case preloading fails.
          if (this.totalAssets > 0) {
            this.async(this.showScene, null, this.MAX_PRELOAD_TIME);
            return;
          }
        }

        this.showScene();
      }

    });
  </script>
</polymer-element>
