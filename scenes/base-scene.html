<link rel="import" href="../components/polymer/polymer.html">

<!--
A base class element for Santa Tracker scenes. Should not be declared directly,
but extended by other elements.

**Note** Subclass scene elements are expected to implement an
         `onPreload`/`onShow`/`onHide` method. Upon the scene becoming
         active/hidden, those methods will be called.

@element base-scene
-->
<polymer-element name="base-scene" attributes="active path">
  <script>
    Polymer({
      publish: {
        /**
         * If `true`, the scene is selected.
         *
         * @attribute active
         * @type bool
         * @default false
         */
        active: {value: false, reflect: true}
      },

      computed: {
        /**
         * Preloading progress (percentage) of the loaded scene.
         *
         * @property preloadProgress
         * @type number
         * @default 0
         */
        preloadProgress: 'loaded ? 100 : totalAssets ? (assetsLoaded / totalAssets * 100) : 0',
      },

      /**
       * Total number of assets that will need to be preloaded. Must be set
       * in `onPreload` or will be ignored.
       * @property totalAssets
       * @type number
       * @default 0
       */
      totalAssets: 0,

      /**
       * Assets loaded so far (out of `totalAssets`).
       * @property assetsLoaded
       * @type number
       * @default 0
       */
      assetsLoaded: 0,

      /**
       * The path of the scene file to load.
       *
       * @attribute path
       * @type string
       * @default null
       */
      path: null,

      /**
       * True if the scene has previously been loaded.
       *
       * @property loaded
       * @type bool
       * @default false
       */
      loaded: false,

      /**
       * Max number of milliseconds to wait before timing out and abandoning
       * preload.
       *
       * @property MAX_PRELOAD_TIME
       * @type number
       * @default 30000
       */
      MAX_PRELOAD_TIME: 30 * 1000,

      /**
       * Santa service.
       *
       * TODO(ericbidelman): Don't call global function.
       *
       * @property santaService
       * @type SantaService
       * @default {}
       */
      santaService: window.santatracker.controller.getService(),

      /**
       * A helper method for preloading an array of image URLs.
       * @param {!Array.<string>} imageUrls
       */
      preloadImages: function(imageUrls) {
        this.totalAssets += imageUrls.length;

        var onload = function() {
          this.assetsLoaded++;
        }.bind(this);

        for (var i = 0; i < imageUrls.length; i++) {
          var img = new Image();
          img.onerror = img.onload = onload;
          img.src = this.resolvePath(imageUrls[i]);
        }
      },

      preloadProgressChanged: function() {
        if (this.preloadProgress === 100) {
          this.showScene();
        }
      },

      showScene: function() {
        this.loaded = true;

        if (this.active) {
          this.onShow && this.onShow();
          this.hidden = false;
        }
      },

      activeChanged: function() {
        if (!this.active) {
          this.onHide && this.onHide();
          return;
        }

        // If subclass defines preloading, call it. If not, or nothing needs to
        // be preloaded, signal ready.
        if (!this.loaded && this.onPreload) {
          this.onPreload();

          // If assets are queued to preload, schedule showScene on timeout in
          // case preloading fails.
          if (this.totalAssets > 0) {
            this.async(this.showScene, null, this.MAX_PRELOAD_TIME);
            return;
          }
        }

        this.showScene();
      }
    });
  </script>
</polymer-element>