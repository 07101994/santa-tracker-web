<link rel="import" href="../base-scene.html">

<link rel="import" href="../../elements/countdown/countdown-timer.html">

<link rel="import" href="dependencies.html">

<!--
Village scene.

@element village-scene
@extends base-scene
-->
<polymer-element name="village-scene" extends="base-scene" attributes="countDownEndDate houses">
<template>
  <link rel="stylesheet" href="village-scene.css" no-shim>

  <div id="module-village" fit>
    <div id="village-wrapper" fit>

      <div id="countdown" layout vertical center relative
                          class="{{ {finished: finished} | tokenList}}">
        <h1 class="logo">Google</h1>
        <h1><i18n-msg msgid="santatracker_msg_id">Santa Tracker</i18n-msg></h1>
        <countdown-timer id="count" santaService="{{santaService}}"
                         finished="{{finished}}" countDownEndDate="[[countDownEndDate]]">
          <h3><i18n-msg msgid="days_msg_id">Days</i18n-msg></h3>
          <h3><i18n-msg msgid="hours_msg_id">Hours</i18n-msg></h3>
          <h3><i18n-msg msgid="minutes_msg_id">Minutes</i18n-msg></h3>
          <h3><i18n-msg msgid="seconds_msg_id">Seconds</i18n-msg></h3>
        </countdown-timer>
        <!-- <h2>Until Santa Departs &ndash; <a href="{{'www.google.com/santatracker/about.html'|localizedpath:goro.page.locale}}">Learn More</a></h2> -->
        <h2>Until Santa Departs &ndash; <a href="//www.google.com/santatracker/about.html">Learn More</a></h2>
        <div id="finished-tracker">
          <a href="#/tracker/dashboard"><!----></a>
        </div>
        <h2 style="display:none">Santa's finished his journey for the year! He and the elves are still having some fun in the North Pole before their annual vacation.</h2>
      </div>

      <div id="hit-area-left" on-mouseenter="{{onHitArea}}" on-mouseleave="{{cancelScrollAnimation}}"
                              on-down="{{onHitArea}}" on-up="{{cancelScrollAnimation}}"></div>
      <div id="hit-area-right" on-mouseenter="{{onHitArea}}" on-mouseleave="{{cancelScrollAnimation}}"
                               on-down="{{onHitArea}}" on-up="{{cancelScrollAnimation}}"></div>

      <div id="trees" class="parallax-layer">
        <template repeat="{{tree in trees}}">
          <div class="tree" _style="left:{{tree.left}}px"></div>
        </template>
      </div>
      <div id="snow" class="parallax-layer"></div>
      <div id="village-parallax" fit>
        <div id="village">
          <div id="trees-back">
            <template repeat="{{tree, i in treesBg}}">
              <div id="tree{{i + 1}}" class="tree"></div>
            </template>
          </div>
          <div id="houses">

            <template repeat="{{house, i in houses}}">
              <div id="house-{{house.module}}" class="house {{house.category}} {{ {iced: house.iced, melt: !house.iced} | tokenList }}">
                <div class="building"></div>

                <div class="house-snow"></div>
                <div class="house-elves">
                  <div class="snow-elves">
                    <template repeat="{{house.elves.snow}}">
                      <div class="elf {{}}"></div>
                    </template>
                  </div>
                  <div class="melt-elves">
                    <template repeat="{{house.elves.melt}}">
                      <div class="elf {{}}"></div>
                    </template>
                  </div>
                </div>
                <a href="{{baseURI}}#{{house.module}}" class="house-marker" tabindex="{{house.iced || house.disabled ? -1 : 0}}"
                   on-click="{{onHouseClick}}"></a>
                </a>
              </div>
            </template>

            <div id="garage">
              <div class="elf elf-red-girl-right"></div>
              <div class="elf elf-blue-left"></div>
              <div class="elf elf-green"></div>
            </div>

            <div id="balloon" class="interactive" on-tap="{{onBalloonClick}}"></div>
            <div id="balloon-ropes" hidden></div>
            <div id="balloon-elf1" class="elf elf-purple"></div>
            <div id="balloon-elf2" class="elf elf-green-girl-left"></div>

            <div id="xmastree">
              <div class="elf elf-red-sit-right elf1"></div>
              <div class="elf elf-blue elf2"></div>
              <div class="elf elf-purple elf3"></div>

              <div class="elf elf-orange elf4"></div>
              <div class="elf elf-blue elf5"></div>
              <div class="elf elf-green-girl-sit-left elf6"></div>
            </div>

            <div id="unicycle" class="elf"><div class="cycle"></div></div>
            <div id="snowman" class="elf interactive" on-tap="{{onSnowManClick}}"></div>
            <div id="bus" class="bus-unload">
              <div class="elf"></div>
              <div class="elf"></div>
              <div class="elf"></div>
              <div class="elf"></div>
              <div class="elf"></div>
              <div class="elf"></div>
              <div class="elf"></div>
            </div>
            <div id="busstop1" class="interactive busstop" on-tap="{{onSendBusToStop}}">
              <div class="busstop-sign"></div>
              <div class="bus-bench"></div>
              <div class="bus-chair"></div>
              <div class="elf elf-red-sit-right elf1"></div>
              <div class="elf elf-green elf2"></div>
              <div class="elf elf-orange elf3"></div>
            </div>
            <div id="busstop2" class="interactive busstop" on-tap="{{onSendBusToStop}}">
              <div class="busstop-sign"></div>
              <div class="bus-bench"></div>
              <div class="bus-chair"></div>
              <div class="elf elf-green-sit-right elf1"></div>
              <div class="elf elf-purple elf2"></div>
              <div class="elf elf-orange elf3"></div>
            </div>
            <div id="busstop3" class="interactive busstop" on-tap="{{onSendBusToStop}}">
              <div class="busstop-sign"></div>
              <div class="bus-bench"></div>
              <div class="bus-chair"></div>
              <div class="elf elf-blue-sit-right elf1"></div>
              <div class="elf elf-red elf2"></div>
              <div class="elf elf-purple elf3"></div>
            </div>
            <div id="snowmobile1" class="interactive" on-tap="{{onDriveSnowMobile}}"></div>
            <div id="snowmobile2" class="interactive" on-tap="{{onDriveSnowMobile}}"></div>
            <div id="snowmobile3" class="interactive" on-tap="{{onDriveSnowMobile}}"></div>
          </div>
        </div>
      </div>
      <div id="ground"></div>
      <div id="rail" class="parallax-layer {{timeOfDay}}">
        <div id="train"></div>
      </div>
      <div id="mountains" class="parallax-layer">
        <div id="mountains-day" class="{{ {visible: timeOfDay == 'day'} | tokenList }}"></div>
        <div id="mountains-night" class="{{ {visible: timeOfDay == 'night'} | tokenList }}"></div>
      </div>
      <div id="clouds"></div>
      <div id="plane"></div>
      <div id="spaceship"></div>
      <div id="fakesun" on-tap="{{onFakeElementClick}}"
                        hidden?="{{timeOfDay == 'night'}}"></div>
      <div id="fakemoon" on-tap="{{onFakeElementClick}}"
                         hidden?="{{timeOfDay == 'day'}}"></div>
      <div id="sun" class="{{timeOfDay == 'day' ? 'up go-up' : 'down go-down'}}"></div>
      <div id="moon" class="{{timeOfDay == 'night' ? 'up go-up' : 'down go-down'}}"></div>
      <div id="sky">
        <div id="sky-day" class="{{ {visible: timeOfDay == 'day'} | tokenList }}"></div>
        <div id="sky-night" class="{{ {visible: timeOfDay == 'night'} | tokenList }}"></div>
      </div>
    </div>
  </div>

</template>
<script>
(function() {

  function polynomialEasing_(t) {
    return t * t;
  }

  Polymer({
    componentDir: 'scenes/village/',

    updateScheduled_: false,
    villageWidth_: 12740, // Defined in _variables.scss, but also recalculated below.
    parallaxLayers_: null,
    scrollContainer_: null,

    animator_: null,

    /**
     * Time taken to scroll across entire village, in milliseconds.
     *
     * @property SCROLL_TIME_
     * @type number
     * @default 5000
     * @const
     * @private
     */
    SCROLL_TIME_: 5000,

    /**
     * The current scroll animation, if any.
     *
     * @property scrollAnimation_
     * @type {Animation}
     * @default null
     * @private
     */
    scrollAnimation_: null,

    randomBusTimeoutID_: -1,

    /**
     * The current day in the calendar schedule.
     *
     * @property scheduleDay_
     * @type {number}
     * @default 1
     * @private
     */
     scheduleDay_: 1,

    /**
     * The time of day to display. Values are 'day' or 'night'.
     *
     * @property timeOfDay
     * @type {string}
     * @default 'day'
     */
    timeOfDay: 'day',

    /**
     * The schedule of houses that open based on the day. Day - 1 is the index.
     * @private
     */
    SCHEDULE_: [
      'house1', // airport
      'house2', // racer
      'house3', // trailer
      'house4', // windtunnel
      'house5', // boatload
      'house7', // streets
      'house8', // factory
      'house9', // rollercoaster
      'house11', // commandcentre
      'house12', // callfromsanta
      'house13', // gumballs
      'house14', // sendamessage
      'house15', // mountain
      'house16', // playground
      'house18', // ferriswheel
      'house19', // briefing
      'house20', // matching
      'house21', // choir
      'house22', // jetpack
      'house23', // presentdrop
      'house24', // traditions
      'house25', // workshop
      'house26', // finalprep
      'house27' // tracker
    ],

    /**
     * End of Santa's flight (ms).
     *
     * @attribute countDownEndDate
     * @type number
     * @default null
     */

    /**
     * Fired when a general tracking event should be recorded in analytics.
     *
     * @event analytics-track-event
     * @param {Object} detail
     *   @param {string} detail.category
     *   @param {string} detail.action
     *   @param {string} detail.label
     */

    created: function() {
      this.trees = [];
      this.treesBg = new Array(28);
      this.animator_ = new Animator();
    },

    ready: function() {
      this.super();

      this.container_ = this.$['module-village'];
      this.scrollContainer_ = this.$['village-parallax'];

      this.villageWidth_ = parseFloat(getComputedStyle(this.$.village).width);

      this.addTrees_();

      // Use touch event support as a rough heuristic of when we shouldn't use
      // parallax.
      // TODO(bckenny): expand parallax support to touch devices like the Pixel
      if (!Modernizr.touch) {
        this.scrollContainer_.addEventListener('scroll',
            this.scheduleParallaxUpdate_.bind(this));
        window.addEventListener('resize',
            this.scheduleParallaxUpdate_.bind(this));
      }

      // Between 6am and 6pm it's day time.
      // Note: Not scientifically correct but it makes children happier.
      var hour = new Date().getHours();
      this.timeOfDay = (6 <= hour && hour <= 18) ? 'day' : 'night';

      this.parallaxLayers_ = Array.prototype.slice.call(
          this.container_.querySelectorAll('.parallax-layer'));
      this.scheduleParallaxUpdate_();

      this.villageSnow_ = new VillageSnow(this.container_);
      this.villageBus_ = new VillageBus(this.container_);
      this.villageSnowMobile_ = new VillageSnowMobile(this.container_);

      // No Android spaceship for iOS devices
      if (navigator.userAgent.match(/iPhone|iPod|iPad/i)) {
        this.$.spaceship.parentElement.removeChild(this.$.spaceship);
      }

      // Know when template house stamping is done to scroll to the last one.
      this.onMutation(this.$.houses, function(observer, records) {
        var melts = this.$.houses.querySelectorAll('.melt');
        this.panToHouse(melts[melts.length - 1], 0);
      });
    },

    domReady: function() {
      this.$.sun.classList.remove('go-down', 'go-up');
      this.$.moon.classList.remove('go-down', 'go-up');
    },

    santaServiceChanged: function() {
      this.super();
      if (this.santaService) {
        this.checkSchedule_(true);
      }
    },

    /**
     * @param {int} index
     */
    unlockHouse: function(idx) {
      this.houses[idx].iced = false;
    },

    /**
     * @param {Element} el
     * @param {number=} opt_time
     */
    panToHouse: function(el, opt_time) {
      var villageOffset = parseFloat(getComputedStyle(this.$.village).left);
      var left = parseFloat(getComputedStyle(el).left);
      var width = parseFloat(getComputedStyle(el.querySelector('.building')).width);
      this.panTo(left + width / 2 + villageOffset, opt_time || 0);
    },

    onHouseClick: function(e, detail, sender) {
      var iced = sender.templateInstance.model.house.iced;
      if (iced) {
        e.preventDefault();
      }
    },

    onSnowManClick: function(e, detail, sender) {
      this.$.snowman.classList.add('snowman-fall');
      this.playSound('village_snowman_click');

      this.fire('analytics-track-event', {category: 'village', action: 'click', label: 'snowman'});

      // Lets be nice and bring the snowman back.
      this.async(function() {
        this.$.snowman.classList.remove('snowman-fall');
      }, null, 20000);
    },

    onBalloonClick: function(e, detail, sender) {
      if (sender.classList.contains('flying')) {
        // If its already flying then do nothing.
        return;
      }

      this.fire('analytics-track-event', {category: 'village', action: 'click', label: 'balloon'});

      this.playSound('village_balloon_click');

      sender.classList.add('takeoff');

      this.$['balloon-ropes'].hidden = false;
      this.$['balloon-elf1'].hidden = true;
      this.$['balloon-elf2'].hidden = true;

      var WAIT = 500; // Seems nice enough.
      var timeout = 1000;

      this.async(function() {
        sender.classList.add('fly', 'flying', 'float');
      }, null, timeout);

      // The same amount of time we set in the CSS animation.
      var ANIMATION_TIME = 55000;

      timeout += ANIMATION_TIME;

      this.async(function() {
        sender.classList.remove('flying', 'float');
      }, null, timeout);

      timeout += WAIT;

      this.async(function() {
        sender.classList.remove('takeoff');
        this.$['balloon-ropes'].hidden = true;
        this.$['balloon-elf1'].hidden = false;
        this.$['balloon-elf2'].hidden = false;

        this.playSound('village_balloon_landing');
      }, null, timeout);
    },

    onSendBusToStop: function(e, detail, sender) {
      var stopId = parseInt(sender.id.split('busstop')[1]);

      this.fire('analytics-track-event', {category: 'village', action: 'click',
                                          label: 'busstop' + stopId});

      this.villageBus_.sendBusToStop(stopId);
    },

    onDriveSnowMobile: function(e, detail, sender) {
      var snowMobileId = parseInt(sender.id.split('snowmobile')[1]);

      this.fire('analytics-track-event', {category: 'village', action: 'click',
                                          label: 'snowmobile' + snowMobileId});

      this.villageSnowMobile_.driveSnowMobile(sender);
    },

    onFakeElementClick: function(e, detail, sender) {
      if (sender.id == 'fakesun') {
        this.fire('analytics-track-event', {category: 'village', action: 'click', label: 'sun'});
        this.timeOfDay = 'night';
      } else if (sender.id == 'fakemoon') {
        this.fire('analytics-track-event', {category: 'village', action: 'click', label: 'moon'});
        this.timeOfDay = 'day';
      }
    },

    onHitArea: function(e, detail, sender) {
      var left = sender == this.$['hit-area-right'] ? this.villageWidth_: 0;
      this.panTo(left, this.SCROLL_TIME_, polynomialEasing_);
    },

    /**
     * @private
     */
    addTrees_: function() {
      var numTrees = Math.max(3, Math.ceil(Math.random() * 10));
      var width = parseFloat(getComputedStyle(this.$.trees).width);
      var left = 0;
      var minDistanceBetweenTrees = 2000;
      var maxDistanceBetweenTrees = width / numTrees;

      var trees = [];

      for (var i = 0; i < numTrees; i++) {
        var pos = Math.max(minDistanceBetweenTrees,
                           Math.random() * maxDistanceBetweenTrees);
        left += pos;
        if (left > width) {
          return;
        }

        trees.push({left: left});
      }

      this.trees = trees;
    },

    /**
     * Centers the view on this position within the village (or as close as the
     * bounds of the view allow).
     * @param {number} value New center position, in pixels.
     */
    setPosition: function(value) {
      // put desired position at center of current view
      value -= this.scrollContainer_.offsetWidth / 2;
      this.scrollContainer_.scrollLeft = value;
    },

    /**
     * Animates the view to centers on this position within the village (or as
     * close as the bounds of the view allow).
     * @param {number} value New center position, in pixels.
     * @param {number=} opt_duration Duration of animation. Defaults to 600ms.
     * @param {Function=} opt_easing Animation easing function.
     */
    panTo: function(value, opt_duration, opt_easing) {
      this.cancelScrollAnimation();

      var scrollee = this.scrollContainer_;
      var currentScroll = scrollee.scrollLeft;
      var targetScroll = value - (scrollee.offsetWidth / 2);
      var duration = (opt_duration != null) ? opt_duration : 600;

      this.scrollAnimation_ = this.animator_.animate(function(t) {
        var scrollPos = currentScroll + t * (targetScroll - currentScroll);
        scrollee.scrollLeft = /** @type {number} */(scrollPos);
      }, duration, opt_easing);
    },

    cancelScrollAnimation: function(e, detail, sender) {
      if (this.scrollAnimation_) {
        this.scrollAnimation_.cancel();
        this.scrollAnimation_ = null;
      }
    },

    /**
     * Schedule a parallax update for next browser repaint.
     * @private
     */
    scheduleParallaxUpdate_: function() {
      if (!this.active) {
        return;
      }

      if (!this.updateScheduled_) {
        this.updateScheduled_ = true;
        window.requestAnimationFrame(this.updateParallax_.bind(this));
      }
    },

    /**
     * Update the village layers in relation to village scroll.
     * @private
     */
    updateParallax_: function() {
      this.updateScheduled_ = false;

      var scrollLeft = /** @type {number} */(this.scrollContainer_.scrollLeft);
      var viewWidth = /** @type {number} */(this.scrollContainer_.offsetWidth);
      var villageWidth = /** @type {number} */(this.villageWidth_);

      for (var i = 0, layer; layer = this.parallaxLayers_[i]; i++) {
        this.scrollLayer_(layer, scrollLeft, viewWidth, villageWidth);
      }
    },

    /**
     * Scroll an element in the view relative to a reference width.
     * @param {!Element} el The element to translate.
     * @param {number} scrollLeft The reference element's current scrollLeft.
     * @param {number} viewWidth The width of the view of the element.
     * @param {number} refrenceWidth
     * @private
     */
    scrollLayer_: function(el, scrollLeft, viewWidth, refrenceWidth) {
      var scrollScale = (el.offsetWidth - viewWidth) / (refrenceWidth - viewWidth);
      var translate = -scrollLeft * scrollScale;
      var translateStyle = 'translateX(' + translate + 'px)';
      el.style[VillageUtils.CSS_TRANSFORM] = translateStyle;
      el.style[VillageUtils.CSS_TRANSFORM] = 'translateZ(0) ' + translateStyle;
    },

    /**
     * Unlocks the correct houses based on the day (index).
     * @param {boolean=} opt_once check only once.
     * @private
     */
    checkSchedule_: function(opt_once) {
      var now = this.santaService ? this.santaService.now() : Date.now();

      var date = new Date(now);
      // TODO: Remove this hack before the 2014 release.
      // Hard coding the date to the 30th so houses don't refreeze in January.
      var day = 31;
      // var day = date.getDate();

      // Houses unlock at 6am
      if (date.getHours() < 6) {
        day--;
      }

      // We don't want users still in November seeing all the Houses unlocked.
      // The site will be shut down before November the following year.
      if (day >= this.scheduleDay_ && date.getMonth() != 10) {
        for (var i = this.scheduleDay_; i <= day; ++i) {
          // var houseIdx = this.SCHEDULE_[i - 1];
          // if (!houseIdx) {
            // Nothing more to unlock.
            // break;
          // }

          if (!this.houses[i - 1].disabled) {
            this.unlockHouse(i - 1);
          }
        }

        this.scheduleDay_ = day;
      }

      if (opt_once) {
        return;
      }

      // Check again at the next hour tick.
      var timeTillHour = (60 - date.getMinutes()) * 60 * 1000;
      this.scheduleTimeout_ = this.async(this.checkSchedule_, null, timeTillHour);
    },

    onPreload: function() {
      console.debug('village: onPreload');

      this.preloadSounds('village_load_sounds');

      var suffix = window.devicePixelRatio > 1.5 ? '_2x.png' : '.png';

      var images = [
        'img/assets_sprite' + suffix,
        'img/markers_sprite' + suffix,
        'img/elves_sprite' + suffix,
        'img/trees' + suffix,
        'img/monorail' + suffix,
        'img/mountain-day-tile' + suffix,
        'img/mountain-night-tile' + suffix,
        //'img/menuicons' + suffix
      ];

      for (var i = 1; i <= 26; ++i) {
        images.push('img/house_' + i + suffix);
      }

      this.preloadImages(images);
    },

    onShow: function() {
      console.debug('village: onShow');

      this.checkSchedule_();

      this.playAmbientSounds('village_start');

      this.villageSnow_.start();
      this.villageBus_.start();
      this.villageSnowMobile_.start();
      this.$.count.start();
    },

    onHide: function() {
      console.debug('village: onHide');

      window.clearTimeout(this.scheduleTimeout_);

      this.playAmbientSounds('village_end');
      this.villageSnow_.stop();
      this.villageBus_.stop();
      this.villageSnowMobile_.stop();
      this.$.count.stop();
    },

    onPause: function() {
      this.onHide();
    },

    onResume: function() {
      this.onShow();
    }
  });

})();
</script>
</polymer-element>
