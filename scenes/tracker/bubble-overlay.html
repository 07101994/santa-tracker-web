<!--
Canvas overlay to draw animated cut-out bubbles over the content.

@element bubble-overlay
-->
<script src="bubble.js"></script>

<polymer-element name="bubble-overlay" attributes="color opacity">
<template>
  <style>
    canvas {
    z-index: 3;
    position: absolute;
    left: 0;
    top: 0;
    display: block;
    opacity: {{opacity}};
  }
  </style>
  <canvas id="canvas"></canvas>
  <content></content>
</template>
<script>
  Polymer({
    /**
     * Color of the overlay.
     *
     * @property color
     * @type string
     * @default '#ff0000'
     */
    color: '#ff0000',
    /**
     * Opacity of the overlay.
     *
     * @property opacity
     * @type number
     * @default 0.6
     */
    opacity: 0.6,
    ready: function() {
      this.$.canvas.width = window.innerWidth;
      this.$.canvas.height = window.innerHeight;
      this.ctx = this.$.canvas.getContext('2d');
      this.ctx.fillStyle = this.color;
      this.ctx.fillRect(0, 0, this.$.canvas.width, this.$.canvas.height);
    },
    /**
     * Cuts out all bubbles on the overlay;
     *
     * @method refresh
     */
    refresh: function() {
      this.ctx.save();
      for (var i = 0; i < this.bubbles.length; i++) {
        this.bubbles[i].cutout();
      }
      this.ctx.restore();
    },
    /**
     * Registers a new bubble with the overlay.
     *
     * @method registerBubble
     * @param {Element} bubble An a-bubble element.
     */
    registerBubble: function(bubble) {
      if (!this.bubbles) {
        this.bubbles = [];
      }
      this.bubbles.push(bubble);
      bubble.addEventListener(Bubble.EventType.UPDATE, function() {
        this.refresh();
      }.bind(this));
    }
  });
</script>
</polymer-element>


<!--
A cut-out bubble in the canvas over the content.
Must be a child of bubble-overlay.

@element a-bubble
-->
<polymer-element name="a-bubble" attributes="x y">
<template>
  <style>
    :host {
      position: absolute;
      display: block;
      border-radius: 50%;
      width: {{2 * radius}}px;
      height: {{2 * radius}}px;
      top: {{y - radius}}px;
      left: {{x - radius}}px;
      z-index: 4;
    };
  </style>
</template>
<script>
  Polymer({
    /**
     * Bubble's radius.
     *
     * @property radius
     * @type number
     * @default 0 (bubble is closed)
     */
    radius: 0,
    /**
     * Bubble's location along x axis.
     *
     * @property x
     * @type number
     * @default 0
     */
    x: 0,
    /**
     * Bubble's location along y axis.
     *
     * @property y
     * @type number
     * @default 0
     */
    y: 0,
    ready: function() {
      this.setupBubble_();
    },
    setupBubble_: function() {
      this.bubble = new Bubble(this.x, this.y, this.parentNode);

      this.bubble.addEventListener('translate', function() {
        this.fire('translate');
      }.bind(this));

      this.bubble.addEventListener('resize', function() {
        this.fire('resize');
      }.bind(this));
    },
    /**
     * Changes bubble's radius.
     *
     * @method open
     * @param {number} radius A new radius.
     * @param {Function} callback To be called after opening is finished.
     */
    open: function(radius, callback) {
      this.bubble.open(radius, callback);
      this.radius = radius;
    },
    /**
     * Changes bubble's location and optionally radius.
     *
     * @method move
     * @param {number} x A new location along x axis.
     * @param {number} y A new location along y axis.
     * @param {number} radius A new radius.
     * @param {Function} callback To be called after opening is finished.
     */
    move: function(x, y, radius, callback) {
      this.bubble.translate(x, y, radius, callback);
    }
  });
</script>
</polymer-element>
