<link rel="import" href="../base-scene.html">
<link rel="import" href="../../elements/i18n-msg.html">
<link rel="import" href="tracker-intro.html">
<link rel="import" href="../../components/google-apis/google-maps-api.html">

<link rel="import" href="dependencies.html">

<script src="../shared/js/mapstyles.js"></script>


<!--
Tracker scene.

@element tracker-scene
@extends base-scene
-->
<polymer-element name="tracker-scene" extends="base-scene">
<template>
  <link rel="stylesheet" href="tracker-scene.css" no-shim>

  <div id="module-tracker">
    <div class="scene">
        <tracker-intro id="intro"
            userLocation="{{userLocation}}"></tracker-intro>
        <template if="{{santaApp}}">
          <google-maps-api version="3.exp" clientId="{{santaApp.config.CLIENT_ID}}"
            libraries="places,geometry" language="{{santaApp.language}}"
            on-api-load="{{mapsAPIReady}}"></google-maps-api>

        </template>
        <div id="trackermap" fit></div>

        <div id="status-bar" hidden>
          <div id="back-to-village">
            <a id="global-back-to-village" href="{{pageUrl}}#village" class="back">
              <i18n-msg msgid="gotovillage">PLACEHOLDER_i18n</i18n-msg>
            </a>
          </div>
          <div id="status-bar-location" hidden>
            <ul>
              <li>
                <h4>Your location</h4>
                <div class="ico ico-marker"></div>
                <div class="stat">{{ userLocation.name }}</div>
              </li>
              <li>
                <h4>Santa arrives in your area</h4>
                <div class="stat-large">TODO</div>
              </li>
              <li>
                <h4>Santa is approximately</h4>
                <div class="stat-large"> {{ santaDistance | formatDistance_ }}</div>
              </li>
              <li >
                <h4>Gifts delivered</h4>
                <div class="stat-large">{{ location.presentsDelivered | formatInt_ }}</div>
              </li>
              <li>
                <h4>Next stop</h4>
                <div class="ico ico-arrow"></div>
                <div class="stat">{{ location.next.city }}</div>
              </li>
            </ul>
          </div>

          <div id="status-bar-generic" hidden>
            <ul>
              <li hidden?="{{!location.stopover}}">
                <h4>Previous stop</h4>
                <div class="ico ico-marker"></div>
                <div class="stat">{{ location.prev.city }}</div>
              </li>
              <li hidden?="{{location.stopover}}">
                <h4>Current stop</h4>
                <div class="ico ico-marker"></div>
                <div class="stat">{{ location.stopover.city }}</div>
              </li>
              <li>
                <h4>Next stop</h4>
                <div class="ico ico-arrow"></div>
                <div class="stat">{{ location.next.city }}</div>
              </li>
              <li hidden?="{{!location.stopover}}">
                <h4>Arriving in</h4>
                <div class="ico ico-clock"></div>
                <div class="stat">{{ arrival_ }}</div>
              </li>
              <li hidden?="{{location.stopover}}">
                <h4>Departing in</h4>
                <div class="ico ico-clock"></div>
                <div class="stat">{{ departure_ }}</div>
              </li>
              <li >
                <h4>Gifts Delivered</h4>
                <div class="stat-large">{{ location.presentsDelivered | formatInt_ }}</div>
              </li>
            </ul>
          </div>
        </div>

    </div>
  </div>


</template>
<script>
(function() {

  Polymer({
    componentDir: 'scenes/tracker/',

    /**
     * Current Santa's location.
     * @type {SantaState}
     * @private
     */
    location: null,

    /**
     * Santas time of arrival.
     * @type {string}
     * @private
     */
    arrival_: null,

    /**
     * Santas time of arrival.
     * @type {string}
     * @private
     */
    departure_: null,

    /**
     * User's location.
     * @type {Position}
     * @private
     */
    userLocation: null,

    worldView_: false,
    dests_: null,

    onPreload: function() {
      // TOOD(lukem): Add images
      this.preloadImages([
        'img/smallglobe.svg'
      ]);
    },

    ready: function() {
      this.super();
    },

    mapsAPIReady: function() {
      this.setup_();
    },

    trackSanta: function() {
      if (this.trackingInterval_) return;

      this.$['status-bar'].hidden = false;
      this.updateSanta_();
    },

    updateSanta_: function() {
      this.santaApp.santaService.getCurrentLocation(function(location) {
        this.location = location;
      }.bind(this));

      if (!this.trackingInterval_) {
        this.trackingInterval_ = window.setInterval(this.updateSanta_.bind(this), 250);
      }
    },

    setup_: function() {
      this.worldView_ = new WorldView(this, this.componentDir);
      this.worldView_.setupMap();
      this.$.intro.showTitle();

      // TODO(lukem): this will need to move for the intro animation
      navigator.geolocation.getCurrentPosition(this.geoLocationSuccess_.bind(this),
        this.geoLocationError_.bind(this), {
          enableHighAccuracy: false,
          timeout: 2000,
          maximumAge: Infinity // We really don't care
        });

      this.santaApp.santaService.addListener('destinations_changed',
          this.destinationsChanged_.bind(this));

      this.trackSanta();
    },

    geoLocationSuccess_: function(position) {
      var latlng = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode({'latLng': latlng}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            var types = results[i].types;
            if (types.indexOf('locality') != -1) {
              this.userLocation = {
                location: {
                  lat: results[i].geometry.location.lat(),
                  lng: results[i].geometry.location.lng()
                },
                name: results[i].formatted_address
              };
              return;
            }
          }
        }
      }.bind(this));
    },

    geoLocationError_: function(error) {
      this.userLocation = null;
      this.$['status-bar-location'].hidden = true;
      this.$['status-bar-generic'].hidden = false;
      this.$.intro.destroy();
    },

    destinationsChanged_: function() {
      var dests = this.santaApp.santaService.getDestinations();
      this.setDestinations_(dests);
    },

    userLocationChanged: function() {
      this.$['status-bar-location'].hidden = this.userLocation == null;
      this.$['status-bar-generic'].hidden = this.userLocation != null;
    },

    locationChanged: function() {
      var location = this.location;

      this.arrival_ = this.formatCountdown_(location.next.arrival);

      if (location.stopover) {
        this.departure_ = this.formatCountdown_(location.stopover.departure);
      }

      if (this.userLocation) {
        var distance = Spherical.computeDistanceBetween(
          location.position, this.userLocation.location);

        this.santaDistance = distance;
      }

      if (this.worldView_) {
        this.worldView_.moveSanta(location);
      }
    },

    setDestinations_: function(dests) {
      this.dests_ = dests || [];

      this.worldView_.setDestinations(this.dests_);
    },

    onShow: function() {

      //TODO(lukem): figure out something nicer to do
      if (this.worldView_) {
        this.worldView_.fitBounds();
      }
    },

    onHide: function() {
      // TODO: implement
    },

    formatInt_: function(i) {
      if (!i) return '';
      return formatInt(i);
    },

    formatDistance_: function(dist) {
      return formatDistance(dist);
    },

    formatCountdown_: function(timestamp) {
      if (!this.santaApp || !this.santaApp.santaService || isNaN(timestamp)) return '';

      timestamp -= this.santaApp.santaService.now();
      timestamp /= 1000;

      // TODO: localise?
      var seconds = Math.floor(timestamp) % 60;
      timestamp /= 60;
      var mins = Math.floor(timestamp) % 60;
      timestamp /= 60;
      var hours = Math.floor(timestamp) % 24;
      var parts = [pad(hours), pad(mins), pad(seconds)];
      if (!hours) parts.shift();
      return parts.join(':');
    }
  });
})();
</script>
</polymer-element>
