<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../scene-behavior.html">
<link rel="import" href="../../components/i18n-msg/i18n-msg.html">
<link rel="import" href="tracker-intro.html">
<link rel="import" href="city-feed/city-feed.html">
<link rel="import" href="../../components/google-apis/google-maps-api.html">
<link rel="import" href="../../components/paper-fab/paper-fab.html">
<link rel="import" href="../../components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../components/iron-image/iron-image.html">
<link rel="import" href="../../components/iron-icons/iron-icons.html">

<link rel="import" href="dependencies.html">

<script src="../shared/js/mapstyles.js"></script>

<!-- TODO(samthor): Upgrade styling for Polymer 1+ (#1165) -->
<link rel="stylesheet" href="tracker-scene.css" />

<!--
Tracker scene.
-->
<dom-module id="tracker-scene">
<template>
  <style>
      #tracker-zoom-controls-zoomin::shadow iron-icon,
      #tracker-zoom-controls-zoomout::shadow iron-icon {
        -webkit-filter: drop-shadow(0px 2px 0 rgba(0,0,0,0.2));
        filter: drop-shadow(0 2px 0 rgba(0,0,0,0.2));
      }
    </style>

  <iron-a11y-keys keys="esc" on-keys-pressed="keyHandler"></iron-a11y-keys>

  <div id="module-tracker">
    <div class="scene">

      <template is="dom-if" if="{{santaApp}}">
        <!-- Conditional required to prevent double loading -->
        <google-maps-api version="3.exp"
                         client-id="{{santaApp.config.CLIENT_ID}}"
                         language="{{santaApp.language}}"
                         on-api-load="mapsAPIReady"></google-maps-api>
      </template>

      <city-feed id="feed" class="fit" timeline="{{santaApp.timeline}}"
                 santa-app="{{santaApp}}" video-map="{{ytMapping}}"></city-feed>

      <tracker-intro id="intro"
          user-location="{{userLocation}}"
          santa-distance="{{initialSantaDistance}}"
          santa-location="{{initialSantaLocation}}"></tracker-intro>

      <div id="cards">
        <template id="mini-cards-template">
          <div hidden$="{{!modelTypeIs_('city')}}" class="card-city">
            <a href="{{pageUrl}}#tracker" on-tap="onTrackerCardClicked">
              <div class="card-header">
                <div class="corner-image"></div>
                <h4><i18n-msg msgid="tracker_next_stop">PLACEHOLDER_i18n</i18n-msg></h4>
                <h3>{{model.stop.city}}</h3>
                <h5><span class="icon-clock"></span>{{formatCountdown_(model.stop.arrival)}}</h4>
              </div>
              <div class="card-body">
                <div class="cover fit"></div>
                <iron-image sizing="cover" class="fit" preload fade
                    src="{{model.stop.details.photos[0].url}}"></iron-image>
              </div>
            </a>
          </div>
          <div hidden$="{{!modelTypeIs_('facts')}}">
            <a href="{{pageUrl}}#tracker" on-tap="onTrackerCardClicked">
              <div class="card-header">
                <div class="corner-image"></div>
                <h4><i18n-msg msgid="tracker_world_facts">PLACEHOLDER_i18n</i18n-msg></h4>
              </div>
              <div class="card-body">
                <p>{{model.didyouknow}}</p>
              </div>
              <div class="card-footer">
                <p><i18n-msg msgid="trivia_ngb_promo">PLACEHOLDER_i18n</i18n-msg></p>
              </div>
            </a>
          </div>

          <div hidden$="{{!modelTypeIs_('photos')}}" style="height:100%">
            <div class="card-header">
              <div class="corner-image"></div>
            </div>
            <div class="card-body">
              <iron-image sizing="cover" preload fade src="{{model.imageUrl}}" fit></iron-image>
            </div>
          </div>

          <div hidden$="{{!modelTypeIs_('update')}}">
            <div class="card-header">
              <div class="corner-image"></div>
              <h4><i18n-msg msgid="tracker_santa_update">PLACEHOLDER_i18n</i18n-msg></h4>
            </div>
            <div class="card-body">
              <p>{{model.status}}</p>
            </div>
          </div>

          <div hidden$="{{!modelTypeIs_('video')}}">
            <a href="{{pageUrl}}#{{ytMapping[model.youtubeId]}}">
              <div class="card-header">
                <div class="corner-image"></div>
                <h4><i18n-msg msgid="santatracker">PLACEHOLDER_i18n</i18n-msg></h4>
                <h3><i18n-msg msgid="watch">PLACEHOLDER_i18n</i18n-msg></h3>
              </div>
              <div class="card-{{ytMapping[model.youtubeId]}} card-body"></div>
            </a>
          </div>
        </template>
        <template is="dom-if" bind="{{trackerCard}}">
          <div class="card card-{{trackerCard.type}}">
            <template bind ref="mini-cards-template"></template>
          </div>
        </template>
      </div>

      <div id="tracker-zoom-controls" hidden>
        <paper-fab id="tracker-zoom-controls-zoomin" icon="add" alt="Zoom in" mini on-tap="trackerZoomIn"></paper-fab>
        <paper-fab id="tracker-zoom-controls-zoomout"icon="remove" alt="Zoom out" mini on-tap="trackerZoomOut"></paper-fab>
      </div>

      <div id="trackermap" class="fit"></div>

      <iron-media-query query="max-width:660px" query-matches="{{isPhoneSize}}"></iron-media-query>

      <template is="dom-if" if="{{cityFeedActive}}">
        <div id="city-stats">
          <ul>
            <li hidden$="{{!location.stopover}}">
              <a href="{{pageUrl}}#tracker" on-tap="onCurrentLocationClicked">
                <h4><i18n-msg msgid="tracker_current_stop">PLACEHOLDER_i18n</i18n-msg></h4>
                <div class="ico ico-marker"></div>
                <div class="stat">{{location.stopover.city}}</div>
              </a>
            </li>
            <li>
              <h4><i18n-msg msgid="tracker_next_stop">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="ico ico-reindeer"></div>
              <div class="stat">{{location.next.city}}</div>
            </li>
            <template is="dom-if" if="{{!location.stopover}}">
              <li>
                <h4><i18n-msg msgid="tracker_arriving_in">PLACEHOLDER_i18n</i18n-msg></h4>
                <div class="ico ico-clock"></div>
                <div class="stat">{{arrival_}}</div>
              </li>
            </template>
            <template is="dom-if" if="{{location.stopover}}">
              <li>
                <h4><i18n-msg msgid="tracker_departing_in">PLACEHOLDER_i18n</i18n-msg></h4>
                <div class="ico ico-clock"></div>
                <div class="stat">{{departure_}}</div>
              </li>
            </template>
          </ul>
        </div>
      </template>

      <template is="dom-if" if="{{!cityFeedActive}}">
        <div id="status-bar" class="[[_computeTernary(navOpen, 'slide-up', '')]] [[_computeTernary(location, 'show', '')]]">
          <div id="back-to-village">
            <a id="global-back-to-village" href="{{pageUrl}}#village" class="back">
              <i18n-msg msgid="gotovillage">PLACEHOLDER_i18n</i18n-msg>
            </a>
          </div>

          <template is="dom-if" if="{{userLocation}}">
            <ul>
              <li>
                <h4><i18n-msg msgid="tracker_your_location">PLACEHOLDER_i18n</i18n-msg></h4>
                <div class="ico ico-marker"></div>
                <div class="stat">{{userLocation.name}}</div>
              </li>
              <li>
                <h4><i18n-msg msgid="tracker_distance_from_you">PLACEHOLDER_i18n</i18n-msg></h4>
                <div class="stat-large"> {{formatDistance_(santaDistance)}}</div>
              </li>
              <li >
                <h4><i18n-msg msgid="tracker_gifts_delivered">PLACEHOLDER_i18n</i18n-msg></h4>
                <div class="stat-large">{{formatInt_(location.presentsDelivered)}}</div>
              </li>
              <template is="dom-if" if="{{!location.stopover}}">
                <li>
                  <h4><i18n-msg msgid="tracker_arriving_in">PLACEHOLDER_i18n</i18n-msg></h4>
                  <div class="ico ico-clock"></div>
                  <div class="stat">{{arrival_}}</div>
                </li>
                <li>
                  <h4><i18n-msg msgid="tracker_next_stop">PLACEHOLDER_i18n</i18n-msg></h4>
                  <div class="ico ico-arrow"></div>
                  <div class="stat">{{location.next.city}}</div>
                </li>
              </template>
              <template is="dom-if" if="{{location.stopover}}">
                <li>
                  <h4><i18n-msg msgid="tracker_departing_in">PLACEHOLDER_i18n</i18n-msg></h4>
                  <div class="ico ico-clock"></div>
                  <div class="stat">{{departure_}}</div>
                </li>
                <li>
                  <a href="{{pageUrl}}#tracker" on-tap="onCurrentLocationClicked"><h4><i18n-msg msgid="tracker_current_stop">PLACEHOLDER_i18n</i18n-msg></h4>
                  <div class="ico ico-marker"></div>
                  <div class="stat">{{location.stopover.city}}</div></a>
                </li>
              </template>
            </ul>
          </template>

          <template is="dom-if" if="{{!userLocation}}">
            <ul>
              <template is="dom-if" if="{{location.stopover}}">
                <li>
                  <a href="{{pageUrl}}#tracker" on-tap="onCurrentLocationClicked"><h4><i18n-msg msgid="tracker_current_stop">PLACEHOLDER_i18n</i18n-msg></h4>
                  <div class="ico ico-marker"></div>
                  <div class="stat">{{location.stopover.city}}</div></a>
                </li>
                <li>
                  <h4><i18n-msg msgid="tracker_departing_in">PLACEHOLDER_i18n</i18n-msg></h4>
                  <div class="ico ico-clock"></div>
                  <div class="stat">{{departure_}}</div>
                </li>

              </template>
              <template is="dom-if" if="{{!location.stopover}}">
                <li>
                  <h4><i18n-msg msgid="tracker_next_stop">PLACEHOLDER_i18n</i18n-msg></h4>
                  <div class="ico ico-arrow"></div>
                  <div class="stat">{{location.next.city}}</div>
                </li>
                 <li>
                  <h4><i18n-msg msgid="tracker_arriving_in">PLACEHOLDER_i18n</i18n-msg></h4>
                  <div class="ico ico-clock"></div>
                  <div class="stat">{{arrival_}}</div>
                </li>
              </template>
              <li>
                <h4><i18n-msg msgid="tracker_gifts_delivered">PLACEHOLDER_i18n</i18n-msg></h4>
                <div class="stat-large">{{formatInt_(location.presentsDelivered)}}</div>
              </li>
            </ul>
          </template>
        </div>
      </template>

    </div>
  </div>

</template>
<script>
(function() {
  Polymer({
    is: 'tracker-scene',
    behaviors: [window.SantaSceneBehavior],

    /**
     * Fired when the tracker
     *
     * @event tracker-action
     * @param {object} detail
     *     @param {string} type The type of action that was triggered. Possible
     *         values are 'tracker-toggle' or 'city-toggle'.
     *     @param {boolean} active True if the item in question is being shown.
     */

    /**
     * Fired when city feed is activated.
     *
     * @event analytics-track-event
     * @param {object} detail
     */

    properties: {

      /**
       * Initial Santa's location. Does not get updated.
       */
      initialSantaLocation: {
        type: Object,
        value: null
      },

      /**
       * Initial Santa's distance from user. Does not get updated.
       */
      initialSantaDistance: {
        type: Number,
        value: null
      },

      /**
       * Current Santa's location.
       */
      location: {
        type: Object,
        observer: 'locationChanged'
      },

      /**
       * Santa's destinations. Should be bound into this element.
       */
      destinations: {
        type: Array,
        value: null,
        observer: 'destinationsChanged'
      },

      /**
       * Santa's time of arrival.
       */
      arrival_: {
        type: String,
        value: null
      },

      /**
       * Santa's time of arrival.
       */
      departure_: {
        type: String,
        value: null
      },

      /**
       * User's location.
       * @type {Position}
       */
      userLocation:  {
        type: Object,
        value: null
      },

      /**
       * Is this page a phone size? Bound to `iron-media-query`.
       */
      isPhoneSize: {
        type: Boolean,
        value: false
      },

      /**
       * True if the city feed is open.
       */
      cityFeedActive:  {
        type: Boolean,
        value: false,
        observer: 'cityFeedActiveChanged'
      },

      /**
       * True if the tracker nav is open.
       */
      navOpen: {
        type: Boolean,
        value: false
      },

      /**
       * True if the maps api is ready to use
       */
      mapReady_:  {
        type: Boolean,
        value: false
      },

      /**
       * True if the scene has been displayed and is ready to render
       */
      shown: {
        type: Boolean,
        value: false
      },

      /**
       * True if the city feed was opened from arriving at a city.
       */
      feedWasOpenForCurrentCity: {
        type: Boolean,
        value: false
      },

      /**
       * The currently displayed SantaCard from SantaService.
       */
      trackerCard: {
        type: Object,
        value: null
      },

      /**
       * Mapping of YouTube video ids to URL routes.
       */
      ytMapping: {
        type: Object,
        value: function() {
          return Object.freeze({
            'h83b1lWPuvQ': 'carpool',
            'oCAKV4Ikhec': 'liftoff',
            'sQnKCU_A0Yc': 'jingle',
            'ZJPL56IPTjw': 'satellite',
            '2FtcJJ9vzVQ': 'temptation',
            'IXmDOu-eSx4': 'office',
            '2UGX3bT9u20': 'tired',
            '_WdYujHlmHA': 'com-room',
            'vHMeXs36NTE': 'reload',
            'uEl2WIZOVdQ': 'slacking-off',
          });
        }
      },

    },

    worldView_: null,

    CARD_SHOW_TIME_: 7000, // 7 seconds

    onPreload: function() {
      // TODO(lukem): Audit images and only preload what we need
      var images = [
        'img/arrow-circle.svg',
        'img/arrow.svg',
        'img/clock.svg',
        'img/marker.svg',
        'img/pin.svg',
        'img/santa_n.svg',
        'img/santa_ne.svg',
        'img/santa_e.svg',
        'img/santa_se.svg',
        'img/santa_s.svg',
        'img/santa_sw.svg',
        'img/santa_w.svg',
        'img/santa_nw.svg',
        'img/santa_effects.svg',
        'img/village.svg'
      ];

      for (var i = 1; i <= 9; i++) {
        images.push('img/santa_magic_' + i + '.svg');
      }

      for (var i = 1; i <= 8; i++) {
        images.push('img/santa_presents_' + i + '.svg');
      }

      this.preloadImages(images);
    },

    onCurrentLocationClicked: function(e, detail, sender) {
      e.preventDefault();
      var destId = sender.templateInstance.model.location.stopover.id;
      this.cityFeedActive = true;
      this.$.feed.scrollToDest(destId);
    },

    onTrackerCardClicked: function(e, detail, sender) {
      e.preventDefault();
      this.cityFeedActive = true;
      var destId = sender.templateInstance.model.model.stop.id;
      this.$.feed.scrollToDest(destId);

      var cardType = sender.templateInstance.model.model.type;
      this.fire('analytics-track-event', {category: 'card', action: 'click',
                                          label: 'type: ' + cardType});
    },

    trackSanta: function() {
      if (this.trackingInterval_) return;

      this.updateSanta_();
    },

    trackerZoomIn: function() {
      if (this.worldView_) {
        this.worldView_.zoomIn();
      }
    },

    trackerZoomOut: function() {
      if (this.worldView_) {
        this.worldView_.zoomOut();
      }
    },

    updateSanta_: function() {
      this.santaApp.santaService.getCurrentLocation(function(location) {
        this.location = location;
      }.bind(this));

      // if santaApp doesn't notice, remind it that tracking is finished.
      if (this.santaApp.santaService.now() > this.santaApp.FLIGHT_FINISHED) {
        this.santaApp.fire('tracker-end');
      }

      if (!this.trackingInterval_) {
        this.trackingInterval_ = window.setInterval(this.updateSanta_.bind(this), 250);
      }
    },

    mapsAPIReady: function() {
      this.mapReady_ = true;
      this.setupTracker();
    },

    setupTracker: function() {
      if (!this.mapReady_ || !this.shown || this.worldView_) return;

      this.worldView_ = new WorldView(this, this.componentDir);
      this.worldView_.setupMap();
      this.worldView_.show();

      // Santa API returning destinations is async. Upgrading this element is
      // async. The Maps API being ready is async. If destinations have not
      // been returned by the API at this point, sync santa and get us some!
      if (this.santaApp.destinations && this.santaApp.destinations.length) {
        this.destinations = this.santaApp.destinations;
      } else {
        this.santaApp.santaService.sync(function() {
          this.destinations = this.santaApp.destinations;
        }.bind(this));
      }

      this.$.intro.showTitle();

      google.maps.event.addListener(this.worldView_, 'santa_clicked', function(e) {
        this.cityFeedActive = !this.cityFeedActive;

        if (this.cityFeedActive) {
          if (this.location.stopover) {
            this.$.feed.scrollToDest(this.location.stopover.id);
          } else {
            this.$.feed.scrollToIndex(0); // Scroll to top of feed if he's not at a stop.
          }
        }

        var action = this.cityFeedActive ? 'show' : 'hide';
        this.fire('analytics-track-event', {category: 'cityfeed', action: action,
                                            label: 'from santa'});
      }.bind(this));

      google.maps.event.addListener(this.worldView_, 'routemarker_clicked', function(destId) {
        this.cityFeedActive = true;
        this.$.feed.scrollToDest(destId);

        this.fire('analytics-track-event', {category: 'cityfeed', action: 'show',
                                            label: 'from route marker'});
      }.bind(this));

      google.maps.event.addListener(this.worldView_, 'scenemarker_clicked', function(sceneId) {
        this.loadTrackerScene_(sceneId);
      }.bind(this));

      navigator.geolocation.getCurrentPosition(this.geoLocationSuccess_.bind(this),
        this.geoLocationError_.bind(this), {
          enableHighAccuracy: false,
          timeout: 4000,
          maximumAge: Infinity // We really don't care
        });

      this.santaApp.santaService.addListener('card', this.updateCard_.bind(this));

      this.cityFeedActiveChanged();  // trigger listener for cityFeedActive now that worldView_ exists

      this.trackSanta();
    },

    loadTrackerScene_: function(sceneId) {
      this.santaApp.route = sceneId;
    },

    isPhoneSizeChanged: function() {
      if (this.isPhoneSize) {
        this.trackerCard = null;
      }
    },

    updateCard_: function(card) {
      if (this.cityFeedActive || this.isPhoneSize) {
        this.trackerCard = null;
      } else {
        this.trackerCard = card;
      }
    },

    hideCard_: function() {
      this.$.cards.classList.remove('show');
    },

    trackerCardChanged: function() {
      var visible = this.$.cards.classList.contains('show');

      var t = visible ? 1000 : 0;

      if (this.trackerCard) {
        this.async(function() {
          this.$.cards.classList.add('show');
        }, t);

        this.async(function() {
          this.hideCard_();
        }, t + this.CARD_SHOW_TIME_);
      }
    },

    geoLocationSuccess_: function(position) {
      var latlng = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode({'latLng': latlng}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            var types = results[i].types;
            if (types.indexOf('locality') != -1) {
              this.userLocation = {
                location: {
                  lat: results[i].geometry.location.lat(),
                  lng: results[i].geometry.location.lng()
                },
                name: results[i].formatted_address
              };
              return;
            }
          }
        }
      }.bind(this));

      this.fire('analytics-track-event', {category: 'geolocation', action: 'success'});
    },

    geoLocationError_: function(error) {
      this.userLocation = null;
      this.$.intro.closeIntro();
      this.fire('analytics-track-event', {category: 'geolocation', action: 'error'});
    },

    destinationsChanged: function() {
      if (this.worldView_) {
        this.worldView_.setDestinations(this.destinations || []);
      }
    },

    locationChanged: function() {
      var location = this.location;

      this.arrival_ = this.formatCountdown_(location.next.arrival);

      if (location.stopover) {
        // Make sure the feed doesn't automatically reopen if it was already
        // open for this city.
        if (!this.feedWasOpenForCurrentCity) {
          this.feedWasOpenForCurrentCity = true;

          // Open city feed at the stop location if it's not already open.
          if (!this.cityFeedActive) {
            this.worldView_.followSanta();
            this.cityFeedActive = true;
            this.$.feed.scrollToDest(location.stopover.id);
          }
        }
        this.departure_ = this.formatCountdown_(location.stopover.departure);
      } else {
        this.feedWasOpenForCurrentCity = false; // left the location, reset.
      }

      if (this.userLocation) {
        var distance = Spherical.computeDistanceBetween(
          location.position, this.userLocation.location);

        this.santaDistance = distance;
      }

      if (!this.initialSantaLocation) {
        this.initialSantaLocation = this.location;
      }

      if (!this.initialSantaDistance) {
        this.initialSantaDistance = this.santaDistance;
      }

      if (this.worldView_) {
        this.worldView_.moveSanta(location);
      }
    },

    cityFeedActiveChanged: function() {
      if (!this.worldView_) {
        return;  // ignore, called when worldView_ is created
      }

      this.worldView_.setMode(this.cityFeedActive ? 'feed' : 'track');

      if (this.cityFeedActive) {
        this.trackerCard = null;

        // Wait for circle animation to finish before we fade in stats and city feed.
        this.async(function() {
          this.$.feed.active = true;

          var cityStats = this.$['module-tracker'].querySelector('#city-stats');
          cityStats.style.opacity = 1;
        }, 550);
      } else {
        this.$.feed.active = false;

        var cityStats = this.$['module-tracker'].querySelector('#city-stats');
        if (cityStats) {
          cityStats.style.opacity = 0;
        }
      }

      this.fire('tracker-action', {type: 'city-toggle', active: this.cityFeedActive});
    },

    onShow: function() {
      this.shown = true;
      this.setupTracker();

      if (!this.santaApp.hasTrackerIntroShown) {
        this.santaApp.hasTrackerIntroShown = true;
        this.$.intro.layoutReady();
      } else {
        this.$.intro.destroy();
      }

      // Always start with cityFeed, tracker nav, and tracker card closed.
      this.cityFeedActive = false;
      this.trackerCard = null;
      this.navOpen = false;

      if (this.mode === 'cast') {
        this.openStraightToFeed();
      } else {
        this.sceneParamsChanged();
      }

      this.fire('tracker-action', {type: 'tracker-toggle', active: this.active});
    },

    onHide: function() {
      window.clearInterval(this.trackingInterval_);
      if (this.worldView_) {
        this.worldView_.hide();
      }

      this.shown = false;
      this.mapReady_ = false;

      this.fire('tracker-action', {type: 'tracker-toggle', active: this.active});
    },

    sceneParamsChanged: function() {
      if (this.sceneParams.timestamp) {
        this.openStraightToFeed();
        this.$.feed.scrollToTime(this.sceneParams.timestamp);
      }
    },

    openStraightToFeed: function() {
      this.$.intro.closeIntro();
      this.cityFeedActive = true;
    },

    formatDistance_: function(dist) {
      // TODO: localise? (miles)
      // 0xA0 non-breaking space
      return this.formatInt_(dist / 1000) + '\xA0km';
    },

    formatCountdown_: function(timestamp) {
      if (!this.santaApp || !this.santaApp.santaService || isNaN(timestamp)) {
        return '';
      }

      timestamp -= this.santaApp.santaService.now();

      if (isNaN(timestamp)) {
        return '';
      }
      timestamp /= 1000;

      // TODO: localise?
      var seconds = Math.floor(timestamp) % 60;
      timestamp /= 60;
      var mins = Math.floor(timestamp) % 60;
      timestamp /= 60;
      var hours = Math.floor(timestamp) % 24;
      var parts = [padDigits(hours), padDigits(mins), padDigits(seconds)];
      if (!hours) {
        parts.shift();
      }

      return parts.join(':');
    },

    formatInt_: function(value) {
      return new Number(Math.floor(value)).toLocaleString();
    },

    keyHandler: function(e, detail) {
      switch(detail) {
        case 'esc':
          e.stopPropagation();
          this.cityFeedActive = false;
          break;
      }
    },

    modelTypeIs_: function(type) {
      return type == this.model.type;
    }

  });
})();
</script>
</dom-module>
