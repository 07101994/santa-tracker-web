<link rel="import" href="../base-scene.html">
<link rel="import" href="../../elements/i18n-msg.html">
<link rel="import" href="../../components/google-apis/google-maps-api.html">
<link rel="import" href="../../components/google-map/google-map.html">
<link rel="import" href="tracker-icons.html">

<script src="../shared/js/mapstyles.js"></script>

<!--
Tracker scene.

@element tracker-scene
@extends base-scene
-->
<polymer-element name="tracker-scene" extends="base-scene">
<template>
  <link rel="stylesheet" href="tracker-scene.css" no-shim>

  <div id="module-tracker">

    <div class="scene">

        <google-map id="map" clientId="{{santaApp.config.CLIENT_ID}}" disableDefaultUI
                  zoomable="false" libraries="places,geometry"
                  latitude="{{latitude_}}" longitude="{{longitude_}}" fit></google-map>

        <div class="status-bar">
          <h2>Currently</h2>
          <ul>
            <li>
              <core-icon icon="santa-icons:timer" size="10"></core-icon>
              {{ location_.stopover ? location_.stopover.city : 'In flight' }}
            </li>
          </ul>
          <h2>Next stop</h2>
          <ul>
            <li>
              <core-icon icon="santa-icons:pin" size="10"></core-icon>
              {{location_.next.city}}
            </li>
          </ul>
          <h2>Landing</h2>
          <ul>
            <li>
              <core-icon class="test" icon="santa-icons:reindeer" size="10"></core-icon>
              <!-- TODO: what if already landed? -->
              {{location_.next.arrival | formatDate('HH:mm')}}
            </li>
          </ul>
          <h2>Filter</h2>
          <ul>
            <li>
              <core-icon icon="santa-icons:filter-media" size="10"></core-icon>
              All media
            </li>
            <li>
              <core-icon icon="santa-icons:filter-location" size="30"></core-icon>
              All locations
            </li>
          </ul>
        </div>
      </template>

      <div class="sceneboard">
        <a id="global-back-to-village" href="{{pageUrl}}#village" class="back">
          <i18n-msg msgid="gotovillage">PLACEHOLDER_i18n</i18n-msg>
        </a>
        <div class="sceneboard-back"></div>
      </div>
    </div>
  </div>
</template>
<script>
(function() {

  Polymer({
    componentDir: 'scenes/tracker/',

    /**
     * Latitude of the main map's center. Ususally Santa's location.
     * @type Number
     * @private
     */
    latitude_: null,

    /**
     * Longitude of the main map's center. Ususally Santa's location.
     * @type Number
     * @private
     */
    longitude_: null,
    /**
     * Current Santa's location.
     * @type {SantaState}
     * @private
     */
    location_: null,
    onPreload: function() {
      this.preloadImages([
        'img/smallglobe.svg'
      ]);
    },

    ready: function() {
      this.super();
      this.$.map.styles = mapstyles.styles;
    },

    santaAppChanged: function() {
      this.santaApp.santaService.getCurrentLocation(function(location) {
        this.location_ = location;
        this.latitude_ = location.position.lat;
        this.longitude_ = location.position.lng;
      }.bind(this));
    },

    onShow: function() {
      // TODO: implement

    },
    onHide: function() {
      // TODO: implement
    },
    /**
     * Transforms a supplied input date using a specified format.
     * @see https://github.com/addyosmani/polymer-filters
     * @param  {date} input
     * @param  {string} format
     * @return {date}
     */
    formatDate: function (input, format) {
      var date = new Date(input),
          day = date.getDate(),
          month = date.getMonth() + 1,
          year = date.getFullYear(),
          hours = date.getHours(),
          minutes = date.getMinutes(),
          seconds = date.getSeconds();

      if (!format) {
          format = "MM/dd/yyyy";
      }

      format = format.replace("MM", month.toString().replace(/^(\d)$/, '0$1'));

      if (format.indexOf("yyyy") > -1) {
          format = format.replace("yyyy", year.toString());
      } else if (format.indexOf("yy") > -1) {
          format = format.replace("yy", year.toString().substr(2, 2));
      }

      format = format.replace("dd", day.toString().replace(/^(\d)$/, '0$1'));

      if (format.indexOf("t") > -1) {
          if (hours > 11) {
              format = format.replace("t", "pm");
          } else {
              format = format.replace("t", "am");
          }
      }

      if (format.indexOf("HH") > -1) {
          format = format.replace("HH", hours.toString().replace(/^(\d)$/, '0$1'));
      }

      if (format.indexOf("hh") > -1) {
          if (hours > 12) {
              hours -= 12;
          }

          if (hours === 0) {
              hours = 12;
          }
          format = format.replace("hh", hours.toString().replace(/^(\d)$/, '0$1'));
      }

      if (format.indexOf("mm") > -1) {
          format = format.replace("mm", minutes.toString().replace(/^(\d)$/, '0$1'));
      }

      if (format.indexOf("ss") > -1) {
          format = format.replace("ss", seconds.toString().replace(/^(\d)$/, '0$1'));
      }

      return format;
    }
  });
})();
</script>
</polymer-element>
