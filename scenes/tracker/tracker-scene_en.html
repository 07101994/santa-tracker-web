<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../base-scene.html">
<link rel="import" href="../../elements/i18n-msg.html">
<link rel="import" href="tracker-intro.html">
<link rel="import" href="city-feed/city-feed.html">
<link rel="import" href="../../components/google-apis/google-maps-api.html">

<link rel="import" href="dependencies.html">

<script src="../shared/js/mapstyles.js"></script>

<!--
Tracker scene.

@element tracker-scene
@extends base-scene
-->
<polymer-element name="tracker-scene" extends="base-scene">
<template>
  <link rel="stylesheet" href="tracker-scene.css" no-shim>

  <div id="module-tracker">
    <div class="scene">

      <template if="{{santaApp}}">
        <google-maps-api version="3.exp" clientId="{{santaApp.config.CLIENT_ID}}"
                         libraries="places,geometry" language="{{santaApp.language}}"
                         on-api-load="{{mapsAPIReady}}"></google-maps-api>
      </template>

      <city-feed id="feed" latestDestinations="{{destinations}}" active?="{{feedActive}}"></city-feed>

      <tracker-intro id="intro"
          userLocation="{{userLocation}}"
          santaDistance="{{initialSantaDistance}}"
          santaLocation="{{initialSantaLocation}}"></tracker-intro>

      <div id="trackermap" fit></div>

      <div id="status-bar" hidden>
        <div id="back-to-village">
          <a id="global-back-to-village" href="{{pageUrl}}#village" class="back">
            <i18n-msg msgid="gotovillage">PLACEHOLDER_i18n</i18n-msg>
          </a>
        </div>

        <template if="{{userLocation}}">
          <ul>
            <li>
              <h4><i18n-msg msgid="tracker_your_location">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="ico ico-marker"></div>
              <div class="stat">{{ userLocation.name }}</div>
            </li>
            <li>
              <h4><i18n-msg msgid="tracker_distance_from_you">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="stat-large"> {{ santaDistance | formatDistance_ }}</div>
            </li>
            <li >
              <h4><i18n-msg msgid="tracker_gifts_delivered">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="stat-large">{{ location.presentsDelivered | formatInt_ }}</div>
            </li>
            <template if="{{!location.stopover}}">
              <li>
                <h4><i18n-msg msgid="tracker_arriving_in">PLACEHOLDER_i18n</i18n-msg></h4>
                <div class="ico ico-clock"></div>
                <div class="stat">{{ arrival_ }}</div>
              </li>
            </template>
            <template if="{{location.stopover}}">
              <li>
                <h4><i18n-msg msgid="tracker_departing_in">PLACEHOLDER_i18n</i18n-msg></h4>
                <div class="ico ico-clock"></div>
                <div class="stat">{{ departure_ }}</div>
              </li>
            </template>
            <li>
              <h4><i18n-msg msgid="tracker_next_stop">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="ico ico-arrow"></div>
              <div class="stat">{{ location.next.city }}</div>
            </li>
          </ul>
        </template>

        <template if="{{!userLocation}}">
          <ul>
            <li hidden?="{{location.stopover == null}}">
              <h4><i18n-msg msgid="tracker_current_stop">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="ico ico-marker"></div>
              <div class="stat">{{ location.stopover.city }}</div>
            </li>
            <li>
              <h4><i18n-msg msgid="tracker_next_stop">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="ico ico-arrow"></div>
              <div class="stat">{{ location.next.city }}</div>
            </li>
            <li hidden?="{{location.stopover != null}}">
              <h4><i18n-msg msgid="tracker_arriving_in">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="ico ico-clock"></div>
              <div class="stat">{{ arrival_ }}</div>
            </li>
            <li hidden?="{{location.stopover == null}}">
              <h4><i18n-msg msgid="tracker_departing_in">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="ico ico-clock"></div>
              <div class="stat">{{ departure_ }}</div>
            </li>
            <li>
              <h4><i18n-msg msgid="tracker_gifts_delivered">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="stat-large">{{ location.presentsDelivered | formatInt_ }}</div>
            </li>
          </ul>
        </template>

      </div>

    </div>
  </div>

</template>
<script>
(function() {

  Polymer({
    componentDir: 'scenes/tracker/',

    /**
     * Initial Santa's location. Does not get updated.
     * @type {SantaState}
     * @private
     */
    initialSantaLocation: null,

    /**
     * Initial Santa's distance from user. Does not get updated.
     * @type {SantaState}
     * @private
     */
    initialSantaDistance: null,

    /**
     * Current Santa's location.
     * @type {SantaState}
     * @private
     */
    location: null,

    /**
     * Santas time of arrival.
     * @type {string}
     * @private
     */
    arrival_: null,

    /**
     * Santas time of arrival.
     * @type {string}
     * @private
     */
    departure_: null,

    /**
     * User's location.
     * @type {Position}
     * @private
     */
    userLocation: null,

    worldView_: false,

    /**
     * True if the city feed is open.
     * @type {boolean}
     * @default false
     */
    feedActive: false,

    onPreload: function() {
      // TODO(lukem): Audit images and only preload what we need
      var images = [
        'img/arrow-circle.svg',
        'img/arrow.svg',
        'img/clock.svg',
        'img/marker.svg',
        'img/pin.svg',
        'img/santa_n.svg',
        'img/santa_ne.svg',
        'img/santa_e.svg',
        'img/santa_se.svg',
        'img/santa_s.svg',
        'img/santa_sw.svg',
        'img/santa_w.svg',
        'img/santa_nw.svg',
        'img/santa_effects.svg',
        'img/village.svg'
      ];

      for (var i = 1; i <= 9; i++) {
        images.push('img/santa_magic_' + i + '.svg');
      }

      for (var i = 1; i <= 8; i++) {
        images.push('img/santa_presents_' + i + '.svg');
      }

      this.preloadImages(images);
    },

    created: function() {
      this.location = {};
    },

    ready: function() {
      this.super();
    },

    mapsAPIReady: function() {
      this.setup_();
    },

    trackSanta: function() {
      if (this.trackingInterval_) return;

      this.$['status-bar'].hidden = false;
      this.updateSanta_();
    },

    updateSanta_: function() {
      this.santaApp.santaService.getCurrentLocation(function(location) {
        this.location = location;
      }.bind(this));

      if (!this.trackingInterval_) {
        this.trackingInterval_ = window.setInterval(this.updateSanta_.bind(this), 250);
      }
    },

    setup_: function() {
      this.worldView_ = new WorldView(this, this.componentDir);
      this.worldView_.setupMap();
      this.destinationsChanged();

      this.$.intro.showTitle();

      google.maps.event.addListener(this.worldView_, 'santa_clicked', function(e) {
        this.feedActive = !this.feedActive;
      }.bind(this));

      google.maps.event.addListener(this.worldView_, 'routemarker_clicked', function(destId) {
        this.feedActive = true;
        this.$.feed.scrollToDest(destId);
      }.bind(this));

      // TODO(lukem): this will need to move for the intro animation
      navigator.geolocation.getCurrentPosition(this.geoLocationSuccess_.bind(this),
        this.geoLocationError_.bind(this), {
          enableHighAccuracy: false,
          timeout: 2000,
          maximumAge: Infinity // We really don't care
        });

      this.trackSanta();
    },

    geoLocationSuccess_: function(position) {
      var latlng = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode({'latLng': latlng}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            var types = results[i].types;
            if (types.indexOf('locality') != -1) {
              this.userLocation = {
                location: {
                  lat: results[i].geometry.location.lat(),
                  lng: results[i].geometry.location.lng()
                },
                name: results[i].formatted_address
              };
              return;
            }
          }
        }
      }.bind(this));
    },

    geoLocationError_: function(error) {
      this.userLocation = null;
      this.$.intro.destroy();
    },

    destinationsChanged: function() {
      if (this.worldView_) {
        this.worldView_.setDestinations(this.destinations);
      }
    },

    locationChanged: function() {
      var location = this.location;

      this.arrival_ = this.formatCountdown_(location.next.arrival);

      if (location.stopover) {
        this.departure_ = this.formatCountdown_(location.stopover.departure);
      }

      if (this.userLocation) {
        var distance = Spherical.computeDistanceBetween(
          location.position, this.userLocation.location);

        this.santaDistance = distance;
      }

      if (!this.initialSantaLocation) {
        this.initialSantaLocation = this.location;
      }

      if (!this.initialSantaDistance) {
        this.initialSantaDistance = this.santaDistance;
      }

      if (this.worldView_) {
        this.worldView_.moveSanta(location);
      }
    },

    onShow: function() {

      //TODO(lukem): figure out something nicer to do
      if (this.worldView_) {
        this.worldView_.fitBounds();
      }
    },

    onHide: function() {
      // TODO: implement
    },

    formatInt_: function(i) {
      if (!i) return '';
      return formatInt(i);
    },

    formatDistance_: function(dist) {
      return formatDistance(dist);
    },

    formatCountdown_: function(timestamp) {
      if (!this.santaApp || !this.santaApp.santaService || isNaN(timestamp)) {
        return '';
      }

      timestamp -= this.santaApp.santaService.now();

      return formatCountdown(timestamp);
    }
  });
})();
</script>
</polymer-element>
