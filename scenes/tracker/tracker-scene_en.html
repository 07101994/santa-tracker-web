<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../scene-behavior.html">
<link rel="import" href="../../components/i18n-msg/i18n-msg.html">
<link rel="import" href="tracker-intro.html">
<link rel="import" href="city-feed/city-feed.html">
<link rel="import" href="../../components/google-apis/google-maps-api.html">
<link rel="import" href="../../components/paper-fab/paper-fab.html">
<link rel="import" href="../../components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../elements/santa-icons.html">

<link rel="import" href="dependencies.html">

<script src="../shared/js/mapstyles.js"></script>

<!-- TODO(samthor): Upgrade styling for Polymer 1+ (#1165) -->
<link rel="stylesheet" href="tracker-scene.css" />

<!--
Tracker scene.
-->
<dom-module id="tracker-scene">
<template>
  <style>
    #tracker-zoom-controls-zoomin::shadow iron-icon,
    #tracker-zoom-controls-zoomout::shadow iron-icon {
      -webkit-filter: drop-shadow(0px 2px 0 rgba(0,0,0,0.2));
      filter: drop-shadow(0 2px 0 rgba(0,0,0,0.2));
    }
    .fit {
      @apply(--layout-fit);
    }
  </style>

  <!-- Keyboard handler -->
  <!-- TODO(ebidel): this doesn't work yet -->
  <iron-a11y-keys keys="esc" on-keys-pressed="_keyHandler"></iron-a11y-keys>

  <div id="module-tracker">
    <div class="scene">

      <!-- Conditional required to prevent double loading -->
      <template is="dom-if" if="[[santaApp]]">
        <google-maps-api version="3.exp"
                         client-id="{{santaApp.config.CLIENT_ID}}"
                         language="{{santaApp.language}}"
                         on-api-load="mapsAPIReady"></google-maps-api>
      </template>

      <city-feed id="feed" class="fit" timeline="{{timeline}}" active="{{cityFeedActive}}"
                 user-location="{{userLocation}}"
                 location="{{location}}"
                 santa-distance="{{santaDistance}}"
                 arrival="{{arrival_}}"
                 departure="{{departure_}}"
                 santa-app="{{santaApp}}" video-map="{{ytMapping}}"></city-feed>

      <tracker-intro id="intro"
          user-location="{{userLocation}}"
          santa-distance="{{initialSantaDistance}}"
          santa-location="{{initialSantaLocation}}"></tracker-intro>

      <div id="tracker-zoom-controls" hidden>
        <paper-fab id="tracker-zoom-controls-zoomin" icon="santa:add"
                   alt="Zoom in" mini on-tap="trackerZoomIn"></paper-fab>
        <paper-fab id="tracker-zoom-controls-zoomout" icon="santa:remove"
                   alt="Zoom out" mini on-tap="trackerZoomOut"></paper-fab>
      </div>

      <div id="trackermap" class="fit"></div>

      <iron-media-query query="max-width:660px" query-matches="{{isPhoneSize}}"></iron-media-query>
    </div>
  </div>

</template>
<script>
(function() {
  Polymer({
    is: 'tracker-scene',
    behaviors: [window.SantaSceneBehavior],

    /**
     * Fired when the tracker
     *
     * @event tracker-action
     * @param {object} detail
     *     @param {string} type The type of action that was triggered. Possible
     *         values are 'tracker-toggle' or 'city-toggle'.
     *     @param {boolean} active True if the item in question is being shown.
     */

    /**
     * Fired when city feed is activated.
     *
     * @event analytics-track-event
     * @param {object} detail
     */

    properties: {

      /**
       * Initial Santa's location. Does not get updated.
       */
      initialSantaLocation: {
        type: Object,
        value: null
      },

      /**
       * Initial Santa's distance from user. Does not get updated.
       */
      initialSantaDistance: {
        type: Number,
        value: null
      },

      /**
       * Current Santa's location.
       */
      location: {
        type: Object,
        observer: '_locationChanged'
      },

      /**
       * Santa's destinations as they come in.
       */
      destinations: {
        type: Array,
        value: null,
        observer: '_destinationsChanged'
      },

      /**
       * Full list of timeline feed items.
       */
      timeline: {
        type: Array,
        value: function() { return []; }
      },

      /**
       * Santa's time of arrival.
       */
      arrival_: {
        type: String,
        value: null
      },

      /**
       * Santa's time of arrival.
       */
      departure_: {
        type: String,
        value: null
      },

      /**
       * User's location.
       * @type {Position}
       */
      userLocation:  {
        type: Object,
        value: null
      },

      /**
       * Is this page a phone size? Bound to `iron-media-query`.
       */
      isPhoneSize: {
        type: Boolean,
        value: false
      },

      /**
       * True if the city feed is open.
       */
      cityFeedActive:  {
        type: Boolean,
        value: false
      },

      /**
       * True if the tracker nav is open.
       */
      navOpen: {
        type: Boolean,
        value: false
      },

      /**
       * True if the maps api is ready to use
       */
      mapReady_:  {
        type: Boolean,
        value: false
      },

      /**
       * True if the scene has been displayed and is ready to render
       */
      shown: {
        type: Boolean,
        value: false
      },

      /**
       * True if the city feed was opened from arriving at a city.
       */
      feedWasOpenForCurrentCity: {
        type: Boolean,
        value: false
      },

      /**
       * The currently displayed SantaCard from SantaService.
       */
      trackerCard: {
        type: Object,
        value: null
      },

      /**
       * Mapping of YouTube video ids to URL routes.
       */
      ytMapping: {
        type: Object,
        value: function() {
          return Object.freeze({
            'h83b1lWPuvQ': 'carpool',
            'oCAKV4Ikhec': 'liftoff',
            'sQnKCU_A0Yc': 'jingle',
            'ZJPL56IPTjw': 'satellite',
            '2FtcJJ9vzVQ': 'temptation',
            'IXmDOu-eSx4': 'office',
            '2UGX3bT9u20': 'tired',
            '_WdYujHlmHA': 'com-room',
            'vHMeXs36NTE': 'reload',
            'uEl2WIZOVdQ': 'slacking-off',
          });
        }
      },

    },

    worldView_: null,

    CARD_SHOW_TIME_: 7000, // 7 seconds

    onPreload: function() {
      // TODO(lukem): Audit images and only preload what we need
      var images = [
        'img/arrow-circle.svg',
        'img/arrow.svg',
        'img/clock.svg',
        'img/marker.svg',
        'img/pin.svg',
        'img/santa_n.svg',
        'img/santa_ne.svg',
        'img/santa_e.svg',
        'img/santa_se.svg',
        'img/santa_s.svg',
        'img/santa_sw.svg',
        'img/santa_w.svg',
        'img/santa_nw.svg',
        'img/santa_effects.svg',
        'img/village.svg'
      ];

      for (var i = 1; i <= 9; i++) {
        images.push('img/santa_magic_' + i + '.svg');
      }

      for (var i = 1; i <= 8; i++) {
        images.push('img/santa_presents_' + i + '.svg');
      }

      this.preloadImages(images);
    },

    // TODO: lots to update here for Polymer 1.0.
    onCurrentLocationClicked: function(e, detail) {
      e.preventDefault();
      var destId = sender.templateInstance.model.location.stopover.id;
      this.cityFeedActive = true;
      this.$.feed.scrollToDest(destId);
    },

    // TODO: lots to update here for Polymer 1.0.
    onTrackerCardClicked: function(e, detail, sender) {
      e.preventDefault();
      this.cityFeedActive = true;
      var destId = sender.templateInstance.model.model.stop.id;
      this.$.feed.scrollToDest(destId);

      var cardType = sender.templateInstance.model.model.type;
      this.fire('analytics-track-event', {category: 'card', action: 'click',
                                          label: 'type: ' + cardType});
    },

    trackSanta: function() {
      if (this.trackingInterval_) {
        return;
      }

      this._updateSanta();
    },

    trackerZoomIn: function() {
      if (this.worldView_) {
        this.worldView_.zoomIn();
      }
    },

    trackerZoomOut: function() {
      if (this.worldView_) {
        this.worldView_.zoomOut();
      }
    },

    _updateSanta: function() {
      this.santaApp.santaService.getCurrentLocation(function(location) {
        this.location = location;
      }.bind(this));

      // if santaApp doesn't notice, remind it that tracking is finished.
      if (this.santaApp.santaService.now() > this.santaApp.FLIGHT_FINISHED) {
        this.santaApp.fire('tracker-end');
      }

      if (!this.trackingInterval_) {
        this.trackingInterval_ = window.setInterval(this._updateSanta.bind(this), 250);
      }
    },

    mapsAPIReady: function() {
      this.mapReady_ = true;
      this.setupTracker();
    },

    setupTracker: function() {
      if (!this.mapReady_ || !this.shown || this.worldView_) {
        return;
      }

      this.worldView_ = new WorldView(this, this.componentDir);
      this.worldView_.setupMap();
      this.worldView_.show();

      // TODO: we don't have a removeListener in SantaService. This will add
      // an additional listener every time someone switches back to tracker.
      this.santaApp.santaService.addListener('destinations_changed', function(dests) {
        this.destinations = dests || [];
      }.bind(this));

      this.santaApp.santaService.addListener('timeline_changed', function(timeline) {
        this.timeline = timeline || [];
      }.bind(this));

      // Sync if we need to.
      this.destinations = this.santaApp.santaService.getDestinations();
      this.timeline = this.santaApp.santaService.getTimeline();

      if ((!this.destinations || !this.destinations.length) ||
          (!this.timeline || !this.timeline.length)) {
        this.santaApp.santaService.sync(); // dests set in event listener above.
      }

      this.$.intro.showTitle();
      this.cityFeedActive = true;

      /*google.maps.event.addListener(this.worldView_, 'santa_clicked', function(e) {
        this.cityFeedActive = !this.cityFeedActive;

        if (this.cityFeedActive) {
          if (this.location.stopover) {
            this.$.feed.scrollToDest(this.location.stopover.id);
          } else {
            this.$.feed.scrollToIndex(0); // Scroll to top of feed if he's not at a stop.
          }
        }

        var action = this.cityFeedActive ? 'show' : 'hide';
        this.fire('analytics-track-event', {category: 'cityfeed', action: action,
                                            label: 'from santa'});
      }.bind(this));*/


      google.maps.event.addListener(this.worldView_, 'routemarker_clicked', function(destId) {
        this.cityFeedActive = true;
        this.$.feed.setStopUrl(destId);

        /*this.fire('analytics-track-event', {category: 'cityfeed', action: 'show',
                                            label: 'from route marker'});*/
      }.bind(this));

      google.maps.event.addListener(this.worldView_, 'scenemarker_clicked', function(sceneId) {
        this.loadTrackerScene_(sceneId);
      }.bind(this));

      navigator.geolocation.getCurrentPosition(this.geoLocationSuccess_.bind(this),
        this._geoLocationError.bind(this), {
          enableHighAccuracy: false,
          timeout: 4000,
          maximumAge: Infinity // We really don't care
        });

      this.santaApp.santaService.addListener('card', this.updateCard_.bind(this));

      this.trackSanta();
    },

    loadTrackerScene_: function(sceneId) {
      var newHref = location.href.substr(0,
            location.href.length - location.hash.length) + '#' + sceneId;
      //this.santaApp.route = sceneId;
      window.location = newHref;
    },

    isPhoneSizeChanged: function() {
      if (this.isPhoneSize) {
        this.trackerCard = null;
      }
    },

    updateCard_: function(card) {
      if (this.isPhoneSize) {
        this.trackerCard = null;
      } else {
        this.trackerCard = card;
      }
    },

    hideCard_: function() {
      this.$.cards.classList.remove('show');
    },

    trackerCardChanged: function() {
      var visible = this.$.cards.classList.contains('show');

      var t = visible ? 1000 : 0;

      if (this.trackerCard) {
        this.async(function() {
          this.$.cards.classList.add('show');
        }, t);

        this.async(function() {
          this.hideCard_();
        }, t + this.CARD_SHOW_TIME_);
      }
    },

    geoLocationSuccess_: function(position) {
      var latlng = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode({'latLng': latlng}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            var types = results[i].types;
            if (types.indexOf('locality') != -1) {
              this.userLocation = {
                location: {
                  lat: results[i].geometry.location.lat(),
                  lng: results[i].geometry.location.lng()
                },
                name: results[i].formatted_address
              };
              return;
            }
          }
        }
      }.bind(this));

      this.fire('analytics-track-event', {category: 'geolocation', action: 'success'});
    },

    _geoLocationError: function(error) {
      this.userLocation = null;
      this.$.intro.closeIntro();
      this.fire('analytics-track-event', {category: 'geolocation', action: 'error'});
    },

    _destinationsChanged: function() {
      if (this.worldView_) {
        this.worldView_.setDestinations(this.destinations || []);
      }
    },

    _locationChanged: function() {
      var location = this.location;

      this.arrival_ = this._formatCountdown(location.next.arrival);

      if (location.stopover) {
        this.departure_ = this._formatCountdown(location.stopover.departure);
      }

      if (this.userLocation) {
        var distance = Spherical.computeDistanceBetween(
            location.position, this.userLocation.location);
        this.santaDistance = distance;
      }

      if (!this.initialSantaLocation) {
        this.initialSantaLocation = this.location;
      }

      if (!this.initialSantaDistance) {
        this.initialSantaDistance = this.santaDistance;
      }

      if (this.worldView_) {
        this.worldView_.moveSanta(location);
      }
    },

    onShow: function() {
      this.shown = true;
      this.setupTracker();

      if (!this.santaApp.hasTrackerIntroShown) {
        this.santaApp.hasTrackerIntroShown = true;
        this.$.intro.layoutReady();
      } else {
        this.$.intro.destroy();
      }

      // Always start with cityFeed, tracker nav, and tracker card closed.
      this.trackerCard = null;
      this.navOpen = false;

      this.sceneParamsChanged();

      this.fire('tracker-action', {type: 'tracker-toggle', active: this.active});
    },

    onHide: function() {
      window.clearInterval(this.trackingInterval_);
      if (this.worldView_) {
        this.worldView_.hide();
      }

      this.shown = false;
      this.mapReady_ = false;

      this.fire('tracker-action', {type: 'tracker-toggle', active: this.active});
    },

    sceneParamsChanged: function() {
      if (this.sceneParams && this.sceneParams.stop) {
        this.$.feed.showStop(this.sceneParams.stop);
      } else {
        this.$.feed.showFeed();
      }
    },

    openStraightToFeed: function() {
      this.$.feed.active = true;
      this.$.intro.closeIntro();
    },

    /**
     * Builds a formatted countdown string to the specified timestamp. Isn't localized as it will
     * just be in the form HH:MM:SS or MM:SS.
     */
    _formatCountdown: function(timestamp) {
      if (!this.santaApp || !this.santaApp.santaService || isNaN(timestamp)) {
        return '';
      }

      timestamp -= this.santaApp.santaService.now();

      if (isNaN(timestamp) || timestamp < 0) {
        return ''; // don't report undefined or negative timestamps
      }
      timestamp /= 1000;

      var seconds = Math.floor(timestamp) % 60;
      timestamp /= 60;
      var mins = Math.floor(timestamp) % 60;
      timestamp /= 60;
      var hours = Math.floor(timestamp) % 24;
      var days = Math.floor(timestamp / 24);

      var parts = [padDigits(hours), padDigits(mins), padDigits(seconds)];
      if (!hours) {
        parts.shift();
      }

      var out = parts.join(':');
      if (days > 0) {
        // The Tracker should never be visible with >days to go, but it's useful for testing.
        return days + 'd ' + out;
      }
      return out;
    },

    _keyHandler: function(e, detail) {
      switch(detail) {
        case 'esc':
          e.stopPropagation();
          break;
      }
    },
  });
})();
</script>
</dom-module>
