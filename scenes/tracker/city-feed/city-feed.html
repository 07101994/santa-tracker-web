<link rel="import" href="../../../components/polymer/polymer.html">
<link rel="import" href="../../../components/core-list/core-list.html">
<link rel="import" href="../../../components/core-pages/core-pages.html">
<link rel="import" href="../../../components/core-selector/core-selector.html">
<link rel="import" href="../../../components/core-image/core-image.html">
<link rel="import" href="../../../components/google-streetview-pano/google-streetview-pano.html">

<link rel="import" href="../../../js/utils.html">

<!--
Utility element to use response HTML returned by the Santa Tracker API.

@element html-echo
-->
<polymer-element name="html-echo" attributes="html">
<script>
Polymer({
  htmlChanged: function() {
    if (this.innerHTML) {
      return; // Only set what the API returned (i.e. ignore future updates).
    }
    this.innerHTML = this.html;
  }
});
</script>
</polymer-element>

<!--
City feed view in Tracker

@element city-feed
-->
<polymer-element name="city-feed" attributes="active location latestDestinations santaApp">
<template>
<link rel="stylesheet" href="city-feed.css" no-shim>
<style>
:host {
  display: none;
}
:host([active]) {
  display: block;
}
</style>

<div id="module-city-feed" fit>
  <div class="scene" fit>

    <core-list id="feed" data="{{filteredDestinations}}"
               selectionEnabled="false" height="420" runwayFactor="2">
      <template>

        <div class="card card-{{model.type}}">
          <template if="{{model.type == 'city'}}"><div class="divider"></div></template>
          <div class="card-header">
            <div class="corner-image"></div>
            <template if="{{model.type == 'city'}}">
              <div>
                <h4 class="white">{{model.region}}</h4>
                <h1>{{model.city}}</h1>
              </div>
              <core-selector class="card-icons" selected="{{model.selectedCard}}" on-core-activate="{{onCardSelected}}">
                <img src="img/tracker-and-city-SVGs_feed-city-icon.svg" data-name="photo">
                <img src="img/tracker-and-city-SVGs_feed-city-photo-icon.svg" data-name="photo">
                <template if="{{model.details.streetView}}">
                  <img src="img/tracker-and-city-SVGs_feed-city-sv-icon.svg" data-name="streetview">
                </template>
                <img src="img/tracker-and-city-SVGs_feed-city-wiki-icon.svg" on-tap="{{onWikipedia}}" data-name="wikipedia">
              </core-selector>
              <div class="stats">
                <div layout horizontal>
                  <div>
                    <h4><i18n-msg msgid="tracker_arrival">PLACEHOLDER_i18n</i18n-msg></h4>
                    <div layout horizontal center>
                      <div class="ico ico-clock"></div>
                      <h2 class="stat-large">{{model.arrival | formatCountdown}}</h2>
                    </div>
                  </div>
                  <div>
                    <h4><i18n-msg msgid="tracker_weather">PLACEHOLDER_i18n</i18n-msg></h4>
                    <div layout horizontal center>
                      <div class="ico ico-weatherchanel"></div>
                      <h2 class="stat-large white">{{model.details.weather.tempC}}&deg;C / {{model.details.weather.tempF}}&deg;F</h2>
                    </div>
                  </div>
                </div>
              </div>
            </template>
            <template if="{{model.type != 'city'}}">
              <h4>Santa's Village</h4>
              <h3>Give Santa a trim</h3>
            </template>
          </div>
          <template if="{{model.type == 'city'}}">
            <core-pages class="card-body" selected="{{model.selectedCard}}">
              <div class="photo">
                <core-image sizing="cover" preload fade src="{{model.details.photos[0].url}}"></core-image>
                <div class="attribution"><html-echo html="{{model.details.photos[0].attributionHtml}}"></html-echo></div>
              </div>
              <div class="photo">
                <core-image sizing="cover" preload fade src="{{model.details.photos[1].url}}"></core-image>
                <div class="attribution"><html-echo html="{{model.details.photos[1].attributionHtml}}"></html-echo></div>
              </div>
              <template if="{{model.details.streetView}}">
                <div>
                  <template if="{{model.selectedCard == 2}}">
                    <google-streetview-pano version="3.exp" fit
                        panoid="{{model.details.streetView.id}}"
                        heading="{{model.details.streetView.heading}}"
                        clientId="{{santaApp.config.CLIENT_ID}}"
                        libraries="places,geometry"
                        language="{{santaApp.language}}"
                        disableDefaultUI></google-streetview-pano>
                  </template>
                </div>
              </template>
              <div class="wikipedia">
                <div class="gradientbar"></div>
                <div class="wikipedia__logo"></div>
                <html-echo class="wikipedia__body" html="{{model.details.wikipedia.excerpt}}"></html-echo>
                <div class="attribution">
                  <span class="wiki-cc">Available under
                  <a target="wiki" href="http://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>
                  terms</span> &nbsp;
                  <a target="wiki" href="{{model.details.wikipedia.url}}">{{model.details.wikipedia.url}}</a>
                </div>
              </div>
            </core-pages>
          </template>
          <template if="{{model.type != 'city'}}">
            <div class="card-body">TODO</div>
            <div class="card-footer"></div>
          </template>
        </div>

      </template>
    </core-list>

  </div>
</div>

</template>
<script>
(function() {

/**
 * Fired when a page in the city card is selected.
 *
 * @event analytics-track-event
 * @param {object} detail
 */

/**
 * Lookup table of destination id -> index into destinations array.
 *
 * @type object
 * @default {}
 * @private
 */
var destLookup_ = {};

Polymer({
  componentDir: 'scenes/tracker/',

  publish: {
    /**
     * If `true`, the feed is showing.
     *
     * @attribute active
     * @type bool
     * @default false
     */
    active: {value: false, reflect: true}
  },

  /**
   * New incoming destinations to add.
   *
   * @attribute latestDestinations
   * @type array
   * @default []
   */

  /**
   * Full saved list of destinations as they've come in.
   *
   * @property dests
   * @type array
   * @default []
   */

  /**
   * A `<santa-app>` controller element.
   *
   * @attribute santaApp
   * @type HTMLElement
   * @default null
   */
  santaApp: null,

  created: function() {
    this.location = {};
    this.latestDestinations = [];
    this.dests = [];
  },

  activeChanged: function() {
    // TODO(ericbidelman): shouldn't have to call this with new core-list. Investigate.
    this.$.feed.updateSize();

    if (!this.active) {
      // Want the list to scroll fast and streetview is a hog. Make sure no
      // streetview cards are activated when the list is opened again.
      for (var i = 0, dest; dest = this.dests[i]; ++i) {
        dest.selectedCard = 0;
      }
    }
  },

  latestDestinationsChanged: function() {
    if (!this.latestDestinations || !this.latestDestinations.length) {
      return;
    }

    // TODO(cbro, ebidel): this is going to get simplified. The API will handle
    // the filtering for us.

    for (var i = 0, dest; dest = this.latestDestinations[i]; ++i) {
      // Don't add destination if it already exists.
      if (destLookup_[dest.id]) {
        continue;
      }

      dest.selectedCard = 0; // select initial page on destination card.

      // TODO(crbro,ebidel): remove this when API has the data.
      dest.type = 'city';

      // Latest locations display at top of list. Prepend them to the destinations
      // list in reverse order (so latest is first).
      this.dests.splice(0, 0, dest);
    }

    // Filter destinations to only show those that the red dude has visited.
    var now = this.santaApp.santaService.now();
    var filteredDestinations = this.dests.filter(function(dest) {
      return dest.arrival < now;
    });

    this.filteredDestinations = filteredDestinations;

    destLookup_ = {}; // Re-create destLookup_ because indexes changed.
    for (var i = 0, dest; dest = filteredDestinations[i]; ++i) {
      destLookup_[dest.id] = i;
    }
  },

  /**
   * Scrolls the city feed to the given item in the list.
   *
   * @method scrollToDest
   * @param {string} destId Destination id
   */
  scrollToDest: function(destId) {
    // Wait a rAF so list is rendered.
    this.async(function() {
      this.$.feed.scrollToItem(destLookup_[destId]);
    });
  },

  formatCountdown: function(timestamp) {
    return formatCountdown(timestamp);
  },

  onWikipedia: function(e, detail, sender) {
    var location = sender.templateInstance.model.model;
    location.getDetails(function(detail) {
      location.details.wikipedia = detail.wikipedia;
    });
  },

  onCardSelected: function(e, detail, sender) {
    var destId = sender.templateInstance.model.model.id;
    var type = detail.item.getAttribute('data-name');
    this.fire('analytics-track-event', {category: 'citycard', action: type,
                                        label: destId});
  }
});

})();
</script>
</polymer-element>
