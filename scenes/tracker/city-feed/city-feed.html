<link rel="import" href="../../../components/polymer/polymer.html">
<link rel="import" href="../../../components/core-list/core-list.html">
<link rel="import" href="../../../components/core-pages/core-pages.html">
<link rel="import" href="../../../components/core-selector/core-selector.html">
<link rel="import" href="../../../components/core-image/core-image.html">
<link rel="import" href="../../../components/google-streetview-pano/google-streetview-pano.html">
<link rel="import" href="../../../components/google-youtube/google-youtube.html">

<link rel="import" href="../../../js/utils.html">

<!--
Utility element to use response HTML returned by the Santa Tracker API.

@element html-echo
-->
<polymer-element name="html-echo" attributes="html">
<script>
Polymer({
  htmlChanged: function() {
    if (this.innerHTML) {
      return; // Only set what the API returned (i.e. ignore future updates).
    }
    this.innerHTML = this.html;
  }
});
</script>
</polymer-element>

<!--
City feed view in Tracker

@element city-feed
-->
<polymer-element name="city-feed" attributes="active location timeline santaApp">
<template>
<link rel="stylesheet" href="city-feed.css" no-shim>
<style>
:host {
  display: none;
}
:host([active]) {
  display: block;
}
</style>

<div id="module-city-feed" fit>
  <div class="scene" fit>

    <core-list id="feed" data="{{stream}}" selectionEnabled="false" height="425" runwayFactor="4">
      <template>

        <div class="card card-{{model.type}}">
          <div class="divider"></div>

          <div hidden?="{{model.type != 'city'}}">
            <div class="card-header">
              <div class="corner-image"></div>
              <div>
                <h4 class="white">{{model.stop.region}}</h4>
                <h1>{{model.stop.city}}</h1>
              </div>
              <core-selector class="card-icons" selected="{{model.selectedCard}}" on-core-activate="{{onCardSelected}}">
                <img src="img/tracker-and-city-SVGs_feed-city-icon.svg" data-name="photo">
                <img src="img/tracker-and-city-SVGs_feed-city-photo-icon.svg" data-name="photo">
                <template if="{{model.stop.details.streetView}}">
                  <img src="img/tracker-and-city-SVGs_feed-city-sv-icon.svg" data-name="streetview">
                </template>
                <img src="img/tracker-and-city-SVGs_feed-city-wiki-icon.svg" on-tap="{{onWikipedia}}" data-name="wikipedia">
              </core-selector>
              <div class="stats">
                <div layout horizontal>
                  <div>
                    <h4><i18n-msg msgid="tracker_arrival">PLACEHOLDER_i18n</i18n-msg></h4>
                    <div layout horizontal center>
                      <div class="ico ico-clock"></div>
                      <h2 class="stat-large">{{model.stop.arrival | formatCountdown}}</h2>
                    </div>
                  </div>
                  <div>
                    <h4><i18n-msg msgid="tracker_weather">PLACEHOLDER_i18n</i18n-msg></h4>
                    <div layout horizontal center>
                      <div class="ico ico-weatherchanel"></div>
                      <h2 class="stat-large white">{{model.stop.details.weather.tempC}}&deg;C / {{model.stop.details.weather.tempF}}&deg;F</h2>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <core-pages class="card-body" selected="{{model.selectedCard}}">
              <div class="photo">
                <core-image sizing="cover" preload fade src="{{model.stop.details.photos[0].url}}"></core-image>
                <div class="attribution"><html-echo html="{{model.stop.details.photos[0].attributionHtml}}"></html-echo></div>
              </div>
              <div class="photo">
                <core-image sizing="cover" preload fade src="{{model.stop.details.photos[1].url}}"></core-image>
                <div class="attribution"><html-echo html="{{model.stop.details.photos[1].attributionHtml}}"></html-echo></div>
              </div>
              <template if="{{model.stop.details.streetView}}">
                <div>
                  <template if="{{model.selectedCard == 2}}">
                    <google-streetview-pano version="3.exp" fit
                        panoid="{{model.stop.details.streetView.id}}"
                        heading="{{model.stop.details.streetView.heading}}"
                        clientId="{{santaApp.config.CLIENT_ID}}"
                        libraries="places,geometry"
                        language="{{santaApp.language}}"
                        disableDefaultUI></google-streetview-pano>
                  </template>
                </div>
              </template>
              <div class="wikipedia">
                <div class="gradientbar"></div>
                <div class="wikipedia__logo"></div>
                <html-echo class="wikipedia__body" html="{{model.stop.details.wikipedia.excerpt}}"></html-echo>
                <div class="attribution">
                  <span class="wiki-cc">Available under
                  <a target="wiki" href="http://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>
                  terms</span> &nbsp;
                  <a target="wiki" href="{{model.stop.details.wikipedia.url}}">{{model.stop.details.wikipedia.url}}</a>
                </div>
              </div>
            </core-pages>
          </div>

          <div hidden?="{{model.type != 'facts'}}">
            <div class="card-header">
              <div class="corner-image"></div>
              <h4><i18n-msg msgid="tracker_world_facts">PLACEHOLDER_i18n</i18n-msg></h4>
            </div>
            <div class="card-body">
              <p>{{model.didyouknow}}</p>
            </div>
            <div class="card-footer">
              <p><i18n-msg msgid="trivia_ngb_promo">PLACEHOLDER_i18n</i18n-msg></p>
            </div>
          </div>

          <div hidden?="{{model.type != 'photos'}}" style="height:100%">
            <div class="card-header">
              <div class="corner-image"></div>
            </div>
            <div class="card-body photo">
              <core-image sizing="cover" preload fade src="{{model.imageUrl}}"></core-image>
            </div>
          </div>

          <div hidden?="{{model.type != 'update'}}">
            <div class="card-header">
              <div class="corner-image"></div>
              <h4><i18n-msg msgid="tracker_santa_update">PLACEHOLDER_i18n</i18n-msg></h4>
            </div>
            <div class="card-body">
              <p>{{model.status}}</p>
            </div>
          </div>

          <div hidden?="{{model.type != 'video'}}">
            <div class="card-header">
              <div class="corner-image"></div>
              <h4><i18n-msg msgid="santatracker">PLACEHOLDER_i18n</i18n-msg></h4>
              <h3><i18n-msg msgid="watch">PLACEHOLDER_i18n</i18n-msg></h3>
            </div>
            <div class="card-body">
              <google-youtube videoid="{{model.youtubeId}}" chromeless fit
                  playsupported="false" thumbnail="scenes/tracker/city-feed/img/cardavatars/card-video.png"
                  on-tap="{{onVideoPlay}}"></google-youtube>
            </div>
          </div>

        </div>

      </template>
    </core-list>

  </div>
</div>

</template>
<script>
(function() {

/**
 * Fired when a page in the city card is selected or a video is played.
 *
 * @event analytics-track-event
 * @param {object} detail
 */

/**
 * Lookup table of destination id -> index into timeline array.
 *
 * @type object
 * @default {}
 * @private
 */
var destLookup_ = {};

Polymer({
  componentDir: 'scenes/tracker/',

  publish: {
    /**
     * If `true`, the feed is showing.
     *
     * @attribute active
     * @type bool
     * @default false
     */
    active: {value: false, reflect: true}
  },

  /**
   * Current timeline feed.
   *
   * @attribute timeline
   * @type array
   * @default []
   */

  /**
   * A `<santa-app>` controller element.
   *
   * @attribute santaApp
   * @type HTMLElement
   * @default null
   */
  santaApp: null,

  created: function() {
    this.location = {};
    this.timeline = [];
  },

  activeChanged: function() {
    // TODO(ericbidelman): shouldn't have to call this with new core-list. Investigate.
    this.$.feed.updateSize();

    if (!this.active) {
      // Want the list to scroll fast and streetview is a hog. Make sure no
      // streetview cards are activated when the list is opened again.
      for (var i = 0, item; item = this.stream[i]; ++i) {
        item.selectedCard = 0;
      }
    }
  },

  timelineChanged: function() {
    if (!this.timeline || !this.timeline.length) {
      return;
    }

    destLookup_ = {};

    // TODO(ebidel): decide if we need to make a copy.
    this.stream = this.timeline.slice();

    for (var i = 0, item; item = this.stream[i]; ++i) {
      item.selectedCard = 0; // select initial page on destination card.

      // Specify type of card to render in feed.
      if (item.stop) {
        item.type = 'city';
        destLookup_[item.stop.id] = i; // Cache index for lookup later when scrolling to destination.
      } else if (item.youtubeId) {
        item.type = 'video';
      } else if (item.imageUrl) {
        item.type = 'photos';
      } else if (item.status) {
        item.type = 'update';
      } else if (item.didyouknow) {
        item.type = 'facts';
      }
    }
  },

  /**
   * Scrolls the city feed to the given item in the list.
   *
   * @method scrollToDest
   * @param {string} destId Destination id
   */
  scrollToDest: function(destId) {
    // Wait a rAF so list is rendered.
    this.async(function() {
      this.$.feed.scrollToItem(destLookup_[destId]);
    });
  },

  formatCountdown: function(timestamp) {
    return formatCountdown(timestamp);
  },

  onWikipedia: function(e, detail, sender) {
    var location = sender.templateInstance.model.model.stop;
    location.getDetails(function(detail) {
      location.details.wikipedia = detail.wikipedia;
    });
  },

  onCardSelected: function(e, detail, sender) {
    var destId = sender.templateInstance.model.model.stop.id;
    var type = detail.item.getAttribute('data-name');
    this.fire('analytics-track-event', {category: 'citycard', action: type,
                                        label: destId});
  },

  onVideoPlay: function(e, detail, sender) {
    this.fire('analytics-track-event', {category: 'video', action: 'play',
                                        label: sender.videoid});
  }
});

})();
</script>
</polymer-element>
