<!--
Copyright 2015 Google Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->
<link rel="import" href="../../../components/polymer/polymer.html">
<link rel="import" href="../../../components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../components/iron-list/iron-list.html">
<link rel="import" href="../../../components/iron-pages/iron-pages.html">
<link rel="import" href="../../../components/iron-selector/iron-selector.html">
<link rel="import" href="../../../components/iron-image/iron-image.html">
<link rel="import" href="../../../components/iron-icons/iron-icons.html">
<link rel="import" href="../../../components/google-streetview-pano/google-streetview-pano.html">
<link rel="import" href="../../../components/iron-media-query/iron-media-query.html">

<!--
Utility element to use response HTML returned by the Santa Tracker API.
-->
<dom-module id="html-echo">
<script>
Polymer({
  is: 'html-echo',

  properties: {
    html: {
      type: String,
      value: null,
      observer: '_htmlChanged'
    }
  },

  _htmlChanged: function() {
    if (this.html) {
      Polymer.dom(this).innerHTML = this.html;
    }
  }
});
</script>
</dom-module>

<!-- TODO(samthor): Upgrade styling for Polymer 1+ (#1165) -->
<link rel="stylesheet" href="city-feed.css">

<!--
City feed view in Tracker
-->
<dom-module id="city-feed">
<template>
<style>
  :host {
    display: none;
  }
  :host([active]) {
    display: block;
  }

  .divider {
    @apply(--layout-horizontal);
    @apply(--layout-end);
  }

  .horizontal {
    @apply(--layout-horizontal);
  }

  .centered {
    @apply(--layout-center);
  }

  .start-justified {
    @apply(--layout-start-justified);
  }

  .justified {
    @apply(--layout-justified);
  }

  .fit {
    @apply(--layout-fit);
  }

  .flex {
    @apply(--layout-flex);
  }
</style>

<div id="module-city-feed" class="fit">
  <div class="scene fit">

    <div id="city-view" class="fit">
      <template is="dom-if" if="{{_isActiveStop(activeStop)}}">
      <div id="city-details">
        <a href="#">Back to tracker</a>
        <div class="details">
          <h4>{{activeStop.stop.region}}</h4>
          <h1>{{activeStop.stop.city}}</h1>
        </div>
        <div class="stats">
          <div class="horizontal">
            <div>
              <h4><i18n-msg msgid="tracker_arrival">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="horizontal centered">
                <div class="ico ico-clock"></div>
                <h2 class="stat-large">{{formatTime(activeStop.stop.arrival)}}</h2>
              </div>
            </div>
            <div>
              <h4><i18n-msg msgid="tracker_weather">PLACEHOLDER_i18n</i18n-msg></h4>
              <div class="horizontal centered">
                <div class="ico ico-weatherchanel"></div>
                <h2 class="stat-large white">
                  <span>{{activeStop.stop.details.weather.tempC}}</span>&deg;C /
                  <span>{{activeStop.stop.details.weather.tempF}}</span>&deg;F
                </h2>
              </div>
            </div>
          </div>
        </div>
        <div class="wikipedia">
          <p><html-echo class="wikipedia__body" html="{{activeStop.stop.details.wikipedia.excerpt}}"></html-echo></p>

          <div class="attribution">
            <span class="wiki-cc">Available under
            <a href$="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>
            terms</span>
            <a href$="{{activeStop.stop.details.wikipedia.url}}">{{activeStop.stop.details.wikipedia.url}}</a>
          </div>
        </div>
      </div>
      <div id="city-photos">
        <div class="city-photo" style$="background-image:url({{cityPhotoLowRes}})">
          <div class="city-photo-hires" style$="background-image:url({{cityPhotoHiRes}})"></div>
        </div>

        <iron-selector id="photoselector" selected="1"
              on-iron-activate="_onPhotoSelected">
          <template is="dom-repeat" items="{{activeStop.stop.details.photos}}" as="photo">
            <img src="{{photo.url}}">
          </template>
        </iron-selector>
      </div>
      </template>
    </div>

    <iron-list id="feed" items="[[stream]]" as="item" on-scroll="onScroll">
      <template>
        <div class$="{{_computeCardLayout(isMobileSize)}}" data-index$="[[index]]">
          <div class$="card {{_computeCardClasses(item)}}">
            <div hidden$="{{!itemIsType(item, 'santa-info')}}">
              <div class="santa-info-row">
                <div class="santa-info-distance">
                  <div class="fancy-bg"></div>
                  <div class="fancy-content">
                    <h4><i18n-msg msgid="tracker_distance_from_you">PLACEHOLDER_i18n</i18n-msg></h4>
                    <h2>{{_computeSantaDistance(santaDistance)}}</h2>
                    {{_computeUserLocation(userLocation)}}
                  </div>
                </div>
                <div class="divider"></div>
                <div>
                  <h4><i18n-msg msgid="tracker_gifts_delivered">PLACEHOLDER_i18n</i18n-msg></h4>
                  <h2>{{_computePresentsDelivered(location)}}</h2>
                </div>
              </div>
              <div class="santa-info-row">
                <div hidden$="{{_computeIsSantaFlying(location)}}">
                  <h4><i18n-msg msgid="tracker_next_stop">PLACEHOLDER_i18n</i18n-msg></h4>
                  <h3><i class="ico ico-arrow-yellow"></i> {{_computeNextStop(location)}}</h3>
                </div>
                <div hidden$="{{!_computeIsSantaFlying(location)}}">
                  <h4><i18n-msg msgid="tracker_current_stop">PLACEHOLDER_i18n</i18n-msg></h4>
                  <h3><i class="ico ico-arrow-yellow"></i> {{_computeCurrentStop(location)}}</h3>
                </div>
                <div class="divider"></div>
                <div hidden$="{{_computeIsSantaFlying(location)}}">
                  <h4><i18n-msg msgid="tracker_arriving_in">PLACEHOLDER_i18n</i18n-msg></h4>
                  <h3><i class="ico ico-arrow-yellow"></i>{{_computeArrival(arrival)}}</h3>
                </div>
                <div hidden$="{{!_computeIsSantaFlying(location)}}">
                  <h4><i18n-msg msgid="tracker_departing_in">PLACEHOLDER_i18n</i18n-msg></h4>
                  <h3><i class="ico ico-arrow-yellow"></i>{{_computeDeparture(departure)}}</h3>
                </div>
              </div>
                <!--
                <h4><i18n-msg msgid="tracker_your_location">PLACEHOLDER_i18n</i18n-msg></h4>
                  -->
            </div>

            <div hidden$="{{!itemIsType(item, 'city')}}">
              <div class="card-city-bg" style$="background-image:url({{_getPhotoUrl(item.stop.details.photos, 0)}});"></div>
              <div class="card-header">
                <div class="card-city-attribution">
                  <html-echo html="{{_getPhotoAttribution(item.stop.details.photos, 0)}}"></html-echo>
                </div>

                <div>
                  <h4>{{item.stop.region}}</h4>
                  <h1>{{item.stop.city}}</h1>
                </div>
                <div class="stats">
                  <div class="horizontal">
                    <div>
                      <h4><i18n-msg msgid="tracker_arrival">PLACEHOLDER_i18n</i18n-msg></h4>
                      <div class="horizontal centered">
                        <div class="ico ico-clock"></div>
                        <h2 class="stat-large">{{formatTime(item.stop.arrival)}}</h2>
                      </div>
                    </div>
                    <div>
                      <h4><i18n-msg msgid="tracker_weather">PLACEHOLDER_i18n</i18n-msg></h4>
                      <div class="horizontal centered">
                        <div class="ico ico-weatherchanel"></div>
                        <h2 class="stat-large white">
                          <span>{{item.stop.details.weather.tempC}}</span>&deg;C /
                          <span>{{item.stop.details.weather.tempF}}</span>&deg;F
                        </h2>
                      </div>
                    </div>
                  </div>
                </div>
                <paper-fab icon="add" class="card-fab" on-tap="_showStop" data-stop$="{{item.stop.id}}"></paper-fab>
              </div>
            </div>

             <!-- mini cards -->
              <div hidden$="{{!itemIsType(item, 'facts')}}">
                <div class="card-header">
                  <div class="corner-image"></div>
                  <h4><i18n-msg msgid="tracker_world_facts">PLACEHOLDER_i18n</i18n-msg></h4>
                </div>
                <div class="divider">{{formatTime(item.timestamp)}}</div>

                <div class="card-body">
                  <p>{{item.didyouknow}}</p>
                </div>
                <div class="card-footer">
                  <p><i18n-msg msgid="trivia_ngb_promo">PLACEHOLDER_i18n</i18n-msg></p>
                </div>
              </div>

              <div hidden$="{{!itemIsType(item, 'photos')}}" style="height: 100%">
                <div class="card-header">
                  <div class="corner-image"></div>
                </div>
                <div class="card-body">
                  <iron-image sizing="cover" preload prevent-load="{{!item.imageUrl}}"
                              fade src="{{item.imageUrl}}"></iron-image>
                </div>
              </div>

              <div hidden$="{{!itemIsType(item, 'scene')}}" style="height: 100%">
                <a href$="{{pageUrl}}#{{item.game}}">
                  <div class="card-header">
                    <div class="corner-image"></div>
                  </div>
                  <div class="card-body"></div>
                </a>
              </div>

              <div hidden$="{{!itemIsType(item, 'update')}}">
                <div class="card-header">
                  <div class="corner-image"></div>
                  <h4><i18n-msg msgid="tracker_santa_update">PLACEHOLDER_i18n</i18n-msg></h4>
                </div>
                <div class="card-body">
                  <p>{{item.status}}</p>
                </div>
              </div>

              <div hidden$="{{!itemIsType(item, 'video')}}">
                <a href$="{{pageUrl}}#{{_computeVideoName(item.youtubeId)}}">
                  <div class="card-header">
                    <div class="corner-image"></div>
                    <h4><i18n-msg msgid="santatracker">PLACEHOLDER_i18n</i18n-msg></h4>
                    <h3><i18n-msg msgid="watch">PLACEHOLDER_i18n</i18n-msg></h3>
                  </div>
                  <div class$="card-body card-{{_computeVideoName(item.youtubeId)}}"></div>
                </a>
              </div>
              <!-- mini cards -->

          </div>
        </div>

      </template>
    </iron-list>

  </div>
</div>

</template>
<script>
(function() {

/**
 * Fired when a page in the city card is selected or a video is played.
 *
 * @event analytics-track-event
 * @param {object} detail
 */

/**
 * Lookup table of destination id -> index into timeline array.
 *
 * @type object
 * @default {}
 * @private
 */
var destLookup_ = {};

var CARD_CENTERED_THRESHOLD = 100; // Top/bottom margin of a stream card to declare it as centered on screen.

Polymer({
  is: 'city-feed',

  properties: {

    /**
     * If `true`, the feed is showing.
     */
    active: {
      type: Boolean,
      value: false,
      reflectToAttribute: true,
      observer: '_activeChanged'
    },

    /**
     * Current timeline feed.
     */
    timeline: {
      type: Array,
      value: function() { return []; },
      observer: '_timelineChanged'
    },

    activeStop: {
      type: Object,
      value: null,
      observer: '_activeStopChanged'
    },

    /**
     * Current Santa's location.
     */
    location: {
      type: Object,
    },

    /**
     * Santa's time of arrival.
     */
    arrival: {
      type: String,
      value: null
    },

    /**
     * Santa's distance.
     */
    santaDistance: {
      type: Number,
      value: 0
    },

    /**
     * Santa's time of arrival.
     */
    departure: {
      type: String,
      value: null
    },

    /**
     * User's location.
     * @type {Position}
     */
    userLocation:  {
      type: Object,
      value: null
    },

    /**
     * The timeline feed with additional data and adjusted to support mini cards.
     */
    stream: {
      type: Array,
      value: function() {
        return [];
      }
    },

    /**
     * A `<santa-app>` controller element.
     * TODO(samthor): Like for scenes, find this from parent elements
     */
    santaApp: {
      type: Object,
      value: null
    },

    /**
     * Mapping of YouTube video ids to URL routes.
     */
    videoMap: {
      type: Object,
      value: null
    },

    /**
     * The timestamp of the card which is currently visible in the center of
     * the stream.
     */
    _cardInView: {
      type: Number,
      value: null
    },
  },

  /**
   * A basename for links within Santa Tracker. The hash is removed for nicer
   * display URLs in the status bar.
   * @property pageUrl
   * @type string
   * @default
   */
  get pageUrl() {
    return location.href.substr(0, location.href.length - location.hash.length);
  },

  /**
   * The last scroll operation that was attempted.
   */
  pendingScroll_: null,

  cityPhotoLowRes: '',
  cityPhotoHiRes: '',

  /**
   * True if the list has done its metrics setup and is ready to be shown.
   */
  setupDone_: false,

  /**
   * True if a scroll update has been queued, due to the user scrolling the stream.
   */
  updateQueued_: false,

  _formatDistance: function(dist) {
    // TODO: localise? (miles)
    // 0xA0 non-breaking space
    return this._formatInt(dist / 1000) + '\xA0km';
  },

  _formatInt: function(value) {
    return new Number(Math.floor(value)).toLocaleString();
  },

  _getPhotoAttribution: function(photos, index) {
    return photos[index].attributionHtml;
  },

  _getPhotoUrl: function(photos, index) {
    return photos[index].url;
  },

  created: function() {
    this.pendingScroll_ = {};
  },

  _computeUserLocation: function(userLocation) {
    if (userLocation) {
      return userLocation.name;
    }
  },

  _computeArrival: function(arrival) {
    return arrival;
  },

  _computeDeparture: function(departure) {
    return departure;
  },

  _computeSantaDistance: function(santaDistance) {
    return this._formatDistance(santaDistance);
  },

  _computePresentsDelivered: function(location) {
    if (location) {
      return this._formatInt(location.presentsDelivered);
    }
    return '...';
  },

  _computeIsSantaFlying: function(location) {
    return !!location.stopover;
  },

  _computeNextStop: function(location) {
    if (location.next) {
      return location.next.city;
    }
    return '';
  },

  _computeCurrentStop: function(location) {
    if (location.stopover) {
      return location.stopover.city;
    }
    return '';
  },

  _activeChanged: function() {
    if (this.active) {
      // TODO(ericbidelman): shouldn't have to call this with new iron-list. Investigate.
      //this.$.feed.updateSize();
      this.$.feed.notifyResize();

      this.setupDone_ = true;

      if (this.pendingScroll_.func) {
        this.async(function() {
          this.pendingScroll_.func.call(this, this.pendingScroll_.arg);
          this.pendingScroll_ = {};
        });
      }
    } else {
      this._cardInView = null;

      // Remove any deep link URL params when stream is hidden.
      var newHref = location.href.substr(0,
                    location.href.length - location.hash.length) + '#tracker';
      window.history.replaceState(null, '', newHref);

      // Want the list to scroll fast and streetview is a hog. Make sure no
      // streetview cards are activated when the list is opened again.
      if (this.stream) {
        for (var i = 0, item; item = this.stream[i]; ++i) {
          item.selectedCard = 0;
        }
      }
    }
  },

  _showStop: function(e) {
    var fab;
    var t = e.target;
    while (t.nodeName != 'PAPER-FAB') {
      t = t.parentNode;
    }

    var stopId = t.dataset.stop;
    var activeStopIndex = destLookup_[stopId];
    var activeStop = this.stream[activeStopIndex + 1];

    activeStop.stop.getDetails(function(details) {
      activeStop.stop.details = details;
      this.activeStop = activeStop;
      console.log(this.activeStop);
    }.bind(this));
  },

  _activeStopChanged: function() {
    if (this.activeStop) {
      this.$['module-city-feed'].classList.add('stop-active');
    } else {
      this.$['module-city-feed'].classList.remove('stop-active');
    }
  },

  _isActiveStop: function(activeStop) {
    return activeStop == null ? false: true;
  },

  _timelineChanged: function() {
    if (!this.timeline || !this.timeline.length) {
      return;
    }

    // Make a copy so 2-way bindings don't alter original timeline data.
    var stream = this.timeline.slice();

    // Add additional metadata needed by the template.
    for (var i = 0, item; item = stream[i]; ++i) {
      item.selectedCard = 0; // select initial page on destination card.
    }

    var adjustedStream = [];
    destLookup_ = {};

    // iron-list uses a single template to render a linear list of items. To
    // support side-by-side mini cards, we pair mini cards together by storing
    // a reference to the next mini card when it is followed by a subsequent
    // mini card. The reference to the next mini card is used in the iron-list
    // template to determine if an additional card should be rendered in the
    // same row. The template is wrapped in a flexbox container (<div
    // class="layout horizontal start justified">) which handles the layout.
    for (var i = 0, item; item = stream[i]; ++i) {
      if (item.type == 'city') {
        // Cache index of stop to be able to scroll to destination.
        destLookup_[item.stop.id] = i;
      }
    }

    stream.unshift({
      type: 'santa-info',
      timestamp: 0
    });

    this.stream = stream;

    if (this.active && this._cardInView) {
      this.scrollToTime(this._cardInView);
    }
  },

  /**
   * Scrolls the stream to the given destination card. If the index doesn't exist,
   * the stream scrolls to the top.
   *
   * @method scrollToDest
   * @param {string} destId Destination id
   */
  scrollToDest: function(destId) {
    var idx = destLookup_[destId] || 0;
    this.scrollToIndex(idx);

    if (this.setupDone_ && this.stream.length) {
      // Add deep link to opened destination.
      var newHref = location.href.substr(0,
                    location.href.length - location.hash.length) +
                    '#tracker';
      if (this.stream[idx].timestamp) {
        newHref += '?timestamp=' + this.stream[idx].timestamp;
      }
      window.history.replaceState(null, '', newHref);
    }
  },

  /**
   * Scrolls the stream to the item at index.
   *
   * @method scrollToIndex
   * @param {number} idx Index of item to scroll to.
   */
  scrollToIndex: function(idx) {
    if (this.setupDone_) {
      this.$.feed.scrollToIndex(idx);
    } else {
      this.pendingScroll_ = {func: this.scrollToIndex, arg: idx};
    }
  },

  /**
   * Scrolls the stream item.
   *
   * @method scrollToTime
   * @param {number} idx Index of item to scroll to.
   */
  scrollToTime: function(timestamp) {
    var timestamp = parseInt(timestamp);
    for (var i = 0, item; item = this.stream[i]; ++i) {
      if (item.timestamp === timestamp) {
        this.scrollToIndex(i);
        break;
      }
    }
  },

  formatTime: function(timestamp) {
    if (isNaN(timestamp)) {
      return '';
    }

    var dateStamp = new Date(timestamp);

    var seconds = dateStamp.getSeconds();
    var mins = dateStamp.getMinutes();
    var hours = dateStamp.getHours();
    var parts = [padDigits(hours), padDigits(mins), padDigits(seconds)];

    return parts.join(':');
  },

  _onWikipedia: function(e, detail) {
    //var location = sender.templateInstance.model.model.stop;
    var location = e.model.item.stop;

    // Don't make details API request if wikipedia article has already been fetched.
    if (location.details.wikipedia) {
      return;
    }

    location.getDetails(function(detail) {
      location.details.wikipedia = detail.wikipedia;
    });
  },

  _onPhotoSelected: function(e, detail, sender) {
    //var destId = e.model.item.stop.id;
    /*var type = detail.item.getAttribute('data-name');
    this.fire('analytics-track-event', {
      category: 'citycard',
      action: type,
      label: destId
    });*/
    this.cityPhotoLowRes = detail.item.src;

    this.cityPhotoHiRes = detail.item.src.replace('mw2.google.com/mw-panoramio/photos/medium/',
        'static.panoramio.com.storage.googleapis.com/photos/original/');
  },

  // Determines the most central visible card in the stream's viewport for deep linking.
  updateCardInView: function() {
    this.updateQueued_ = false;

    var listHeight = this.$.feed.offsetHeight;
    var listChildren = this.$.feed.$$('#items').children;

    for (var i = 0, el; el = listChildren[i]; ++i) {
      var elBounds = el.getBoundingClientRect();
      if (0 < elBounds.top && elBounds.top < listHeight) {
        var yMiddleOfElement = elBounds.top + (elBounds.height / 2);
        var yUpper = (listHeight / 2) + CARD_CENTERED_THRESHOLD;
        var yLower = (listHeight / 2) - CARD_CENTERED_THRESHOLD;

        // If card is on center of screen, add deep link to URL.
        if (yLower < yMiddleOfElement && yMiddleOfElement < yUpper) {
          var idx = Number(el.getAttribute('data-index'));
          var timestamp = this.$.feed.items[idx].timestamp;

          this._cardInView = timestamp;

          var newHref = location.href.substr(0,
            location.href.length - location.hash.length) + '#tracker';
          if (timestamp) {
            newHref += '?timestamp=' + timestamp;
          }

          window.history.replaceState(null, '', newHref);

          break;
        }
      }
    }
  },

  onScroll: function(e, detail) {
    // Debounce scrolling.
    if (!this.updateQueued_) {
      this.async(function() {
        this.updateCardInView();
      });
    }

    this.updateQueued_ = true;
  },

  itemIsType: function(item, type) {
    return type == item.type;
  },

  _computeCardClasses: function(item, opt_isNextCard) {
    // TODO(ebidel): unclear why item can every be undefined.
    if (!item) {
      return '';
    }

    var isNextCard = opt_isNextCard || false;

    var str = 'card-' + item.type;
    if (item.game) {
      str += ' card-' + item.game;
    }
    if (!isNextCard && item.type === 'city') {
      str += ' flex';
    }
    return str;
  },

  _computeNextCardClasses: function(item) {
    return this._computeCardClasses(item, true);
  },

  _computeVideoName: function(youtubeId) {
    return this.videoMap[youtubeId];
  },

  _isSelectedCard: function(card, index) {
    return card === index;
  },

  _computeCardLayout: function(isMobile) {
    return !isMobile ? 'layout horizontal justified' : '';
  }

});

})();
</script>
</dom-module>
