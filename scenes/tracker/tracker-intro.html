<link rel="import" href="../../elements/i18n-msg.html">
<link rel="import" href="../../components/google-map/google-map.html">
<link rel="import" href="bubble-overlay.html">

<script src="../../js/utils.js"></script>
<script src="../shared/js/mapstyles.js"></script>

<!--
Intro for the tracker scene.

@element tracker-intro
-->
<polymer-element name="tracker-intro" attributes="userLocation santaLocation santaDistance">
<template>
  <style>
  /* Outside of tracker-intro.scss because it requires shimming. */
  :host {
    width: 100%;
    height: 100%;
    display: block;
    position: relative;
    transition: transform 0.3s ease;
    z-index: 1;
  }
  </style>
  <link rel="stylesheet" href="tracker-intro.css" no-shim>

  <div id="tracker-intro-module">
    <bubble-overlay opacity="1" color="#13AB27">
      <canvas-bubble id="userBubble" x="{{winCenterX_}}" y="{{winCenterY_}}"></canvas-bubble>
      <canvas-bubble id="santaBubble" x="{{santaBubbleCenterX_}}" y="{{winCenterY_}}"></canvas-bubble>
    </bubble-overlay>

    <div class="top" id="top">
      <p class="welcome">
        <i18n-msg msgid="tracker_intro_welcome">PLACEHOLDER_i18n</i18n-msg></a>
      </p>
      <p class="title">
        <i18n-msg msgid="santatracker">PLACEHOLDER_i18n</i18n-msg>
      </p>
    </div>

    <div class="pin-wrapper" id="pinWrapper">
      <img class="pin" id="pin" src="img/pin.svg">
    </div>

    <div id="santaSleigh" class="santa-sleigh sw"></div>

    <div id="userMap">
      <div id="userMapInner"></div>
    </div>

    <div id="santaMap">
      <div id="santaMapInner"></div>
    </div>

    <div class="bottom-wrapper">
      <div class="user-location" id="userLocation">
        <p class="info">
          <i18n-msg msgid="tracker_intro_user_location">PLACEHOLDER_i18n</i18n-msg>
          <br>
          <em>{{userLocation.name}}</em>
        </p>
      </div>

      <div class="santa-distance" id="santaDistance">
        <p>Santa is {{santaDistance | formatDistance_}} away</p>
      </div>
    </div>

    <div class="skip">
      <a on-click="{{skip}}"><i18n-msg msgid="tracker_intro_skip_intro">PLACEHOLDER_i18n</i18n-msg></a>
    </div>
  </div>

</template>
<script>
(function() {

  var BUBBLE_RADIUS_BIG = 100;
  var BUBBLE_RADIUS_SMALL = 60;
  var BUBBLE_CENTER_OFFSET = 200;

  Polymer({
    /**
     * Name and coords of the user's location.
     *
     * @property userLocation
     * @type number
     * @default 0
     */
    userLocation: null,

    /**
     * Name and coords of the Santa's location.
     *
     * @property latitude
     * @type number
     * @default 0
     */
    santaLocation: null,

    /**
     * window center point.
     *
     * @private
     * @type number
     * @default 0
     */
    winCenterX_: 0,

    /**
     * window center point.
     *
     * @private
     * @type number
     * @default 0
     */
    winCenterY_: 0,

    /**
     * Santa's bubble center point.
     *
     * @private
     * @type number
     * @default 0
     */
    santaBubbleCenterX_: 0,

    created: function() {
      this.winCenterX_ = window.innerWidth / 2;
      this.winCenterY_ = window.innerHeight / 2;
      this.santaBubbleCenterX_ = this.winCenterX_ + BUBBLE_CENTER_OFFSET;
    },

    domReady: function() {
      this.$.pinWrapper.style.left = this.winCenterX_ - 100 + 'px'; // 100 = pin width
      this.$.pinWrapper.style.top = this.winCenterY_ - 50 + 'px';  // 50 = pin height
      this.$.santaSleigh.style.left = this.santaBubbleCenterX_ + 'px';
      this.$.santaSleigh.style.top = this.winCenterY_ + 20 + 'px';
      this.$.userMap.style.left = this.winCenterX_ - 150 + 'px';  /* center point - 0.5 * width */
      this.$.userMap.style.top = this.winCenterY_ - 150 + 'px';  /* center point - 0.5 * width */
      this.$.santaMap.style.left = this.santaBubbleCenterX_ - 180/2 + 'px';  /* center point - 0.5 * width */
      this.$.santaMap.style.top = this.winCenterY_ - 180/2 + 'px';  /* center point - 0.5 * width */
    },

    clipMap_: function(el, bubble) {
      var rect = el.getBoundingClientRect();
      el.style.clip = 'rect(0px ' + (bubble.x +
        bubble.radius - rect.left)/bubble.scale + 'px auto ' +
      (bubble.x - bubble.radius - rect.left)/bubble.scale + 'px)';
    },

    translateMap_: function(el, bubble) {
      var stepX = bubble.x - bubble.originX;
      var stepY = bubble.y - bubble.originY;
      var scale = bubble.scale;

      if (stepX || stepY || bubble.scale!==1) {
        var transform = 'matrix(' + bubble.scale + ', 0, 0, ' + bubble.scale +
          ', '+ stepX + ', '+ stepY +')';
        el.style.webkitTransform = transform;
        el.style.transform = transform;

        var wrapper = this.$.pin.parentNode;
        wrapper.style.webkitTransform = transform;
        wrapper.style.transform = transform;
      }
    },

    formatDistance_: function(dist) {
      return formatDistance(dist);
    },

    bindMapToBubble_: function(el, bubble) {
      // Compensate for a left and top overflow if present.
      var rect = el.getBoundingClientRect();
      var transformOrigin = (bubble.bubble.originX - rect.left) + 'px ' +
                            (bubble.bubble.originY - rect.top) + 'px';
      el.style.transformOrigin = transformOrigin;
      el.style.webkitTransformOrigin = transformOrigin;

      bubble.addEventListener('resize', function(e) {
        this.clipMap_(el, e.target.bubble);
      }.bind(this));
      bubble.addEventListener('translate', function(e) {
        this.translateMap_(el, e.target.bubble);
      }.bind(this));
    },

    santaLocationChanged: function() {
      this.santaMap_ = new google.maps.Map(this.$.santaMapInner, {
        center: new google.maps.LatLng(
            this.santaLocation.position.lat,
            this.santaLocation.position.lng),
        zoom: 7,
        disableDefaultUI: true,
        scrollwheel: false,
        draggable: false,
        disableDoubleClickZoom: true,
        backgroundColor: '#fff',
        styles: mapstyles.styles
      });

    },

    userLocationChanged: function() {
      this.map_ = new google.maps.Map(this.$.userMapInner, {
        center: new google.maps.LatLng(
            this.userLocation.location.lat,
            this.userLocation.location.lng),
        zoom: 8,
        disableDefaultUI: true,
        scrollwheel: false,
        draggable: false,
        disableDoubleClickZoom: true,
        backgroundColor: '#fff',
        styles: mapstyles.styles
      });

      this.bindMapToBubble_(this.$.userMap, this.$.userBubble);

      google.maps.event.addListener(
        this.map_, 'idle', function(){
          this.showUserLocationMap();
        }.bind(this));
    },

    /**
     * Plays intro title animation sequence.
     *
     * @method showTitle
     */
    showTitle: function() {
      this.async(function() {
        this.$.top.classList.add('final');
      }, null, 300);
    },

    /**
     * Plays user's location animation sequence.
     *
     * @method showUserLocationMap
     */
    showUserLocationMap: function() {
      var bubble = this.$.userBubble;
      var pin = this.$.pin;
      var userLocationEl = this.$.userLocation;

      this.$.top.classList.add('final'); // 300ms
      this.async(function() {
        bubble.open(140, function(e) {
          bubble.open(100, function() {
            userLocationEl.classList.add('final');
            pin.style.transform = 'rotate(0deg)';
            this.async(function() {
              this.showSantaLocation();

            }, null, 1500);
          }.bind(this));
        }.bind(this));
      }, null, 300);
    },

    /**
     * Plays user's location animation sequence.
     *
     * @method showUserLocationMap
     */
    showSantaLocation: function() {
      var bubble = this.$.userBubble;
      var santaBubble = this.$.santaBubble;
      bubble.move(this.winCenterX_ - BUBBLE_CENTER_OFFSET,
          this.winCenterY_, BUBBLE_RADIUS_SMALL, function() {
        santaBubble.open(BUBBLE_RADIUS_SMALL);
      });
      this.$.userLocation.classList.remove('final');
      this.$.santaDistance.classList.add('final');
    },

    /**
     * Hides the intro from view.
     *
     * @method skip
     */
    skip: function() {
      this.style.transform = 'translateY(-' + 2 * this.winCenterY_ + 'px)';
    },

    /**
     * Removes this element entirely from DOM.
     *
     * @method destroy
     */
    destroy: function() {
      this.parentNode.removeChild(this);
    }
  });
})();
</script>
</polymer-element>
