<link rel="import" href="smatch-storage.html">
<link rel="import" href="smatch-unlockable.html">
<link rel="import" href="smatch-common.html">
<dom-module id="smatch-secret">
  <template>
    <style>
      :host {
        position: absolute;
        overflow: hidden;
        width: 500px;
        height: 500px;
      }

      :host(.unlocked) {
        display: none;
        pointer-events: none;
      }

      #unlockable {
        position: relative;
        top: 90px;
        transition: transform 0.3s, opacity 0.3s;
        transform: scale(1);
        opacity: 1;
      }

      #unlockable.disappear {
        opacity: 0;
        transform: scale(1.2);
      }
    </style>
    <smatch-storage id="storage"
        unlocks="{{_unlocks}}">
    </smatch-storage>
    <smatch-unlockable
        id="unlockable"
        character-id="[[characterId]]"
        on-unlockable-selected="_onUnlockableSelected"
        active
        unlocked>
    </smatch-unlockable>
  </template>
  <script>
    (function() {
      const awaitTransition = window.scenes.smatch.awaitTransition;

      Polymer({
        is: 'smatch-secret',

        properties: {
          characterId: {
            type: String
          },

          unlocked: {
            type: Boolean,
            readOnly: true,
            computed: '_computeUnlocked(_unlocks.*, characterId)',
            observer: '_unlockedChanged'
          },

          _unlocks: {
            type: Object
          }
        },

        _computeUnlocked: function() {
          return this._unlocks && this._unlocks[this.characterId] === true;
        },

        _unlockedChanged: function() {
          if (this.unlocked) {
            this.classList.add('unlocked');
          } else {
            this.classList.remove('unlocked');
          }
        },

        _onUnlockableSelected: function() {
          if (this.unlocked || !this.characterId) {
            return;
          }

          this.$.unlockable.selected = true;
          this.$.unlockable.classList.add('disappear');

          awaitTransition(this.$.unlockable).then(function() {
            this.set('_unlocks.' + this.characterId, true);
          }.bind(this));
        }
      });
    })();
  </script>
</dom-module>
