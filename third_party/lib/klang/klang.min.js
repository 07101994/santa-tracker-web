!function(t,e){t.Klang=t.Klang||e(),"function"==typeof define&&define.amd?define(function(){return t.Klang}):"object"==typeof exports&&(module.exports=t.Klang)}(window,function(){if(-1!=navigator.userAgent.indexOf("MSIE")){var t,e=navigator.userAgent,i=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");null!=i.exec(e)&&(t=parseInt(RegExp.$1)),9>t&&(Object.oldDefineProperty=Object.defineProperty,Object.defineProperty=function(){})}!function(){"use strict";function t(t){t&&(t.setTargetValueAtTime||(t.setTargetValueAtTime=t.setTargetAtTime))}var e=window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,i=function(){var t,e=navigator.userAgent,i=e.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(i[1])?(t=/\brv[ :]+(\d+)/g.exec(e)||[],{name:"IE",version:t[1]||"unknown"}):"Chrome"===i[1]&&(t=e.match(/\bOPR\/(\d+)/),null!==t)?{name:"Opera",version:t[1]}:(i=i[2]?[i[1],i[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(t=e.match(/version\/(\d+)/i))&&i.splice(1,1,t[1]),{name:i[0],version:i[1]})}();if(e){var n=e.prototype,s=new e;n.hasOwnProperty("createGain")||(n.createGain=n.createGainNode),n.hasOwnProperty("internal_createBiquadFilter")||(n.internal_createBiquadFilter=n.createBiquadFilter,n.createBiquadFilter=function(){var e=this.internal_createBiquadFilter();t(e.frequency),t(e.detune),t(e.Q),t(e.gain);for(var i=["LOWPASS","HIGHPASS","BANDPASS","LOWSHELF","HIGHSHELF","PEAKING","NOTCH","ALLPASS"],n=0;n<i.length;++n){var s=i[n],o=s.toLowerCase();!e.hasOwnProperty(s)||Object.isFrozen&&Object.isFrozen(e)||(e[s]=o)}return e}),n.hasOwnProperty("createDelay")||(n.createDelay=n.createDelayNode);var o=function(t,e){return void 0===t&&void 0!==e},r=s.createBufferSource().constructor.prototype;if(o(r.start,r.noteOn)||o(r.stop,r.noteOff)){var a=n.createBufferSource;n.createBufferSource=function(){var t=a.call(this);return t.start=t.start||t.noteOn,t.stop=t.stop||t.noteOff,t}}if("function"==typeof s.createOscillator){var u=s.createOscillator().constructor.prototype;if(o(u.start,u.noteOn)||o(u.stop,u.noteOff)){var c=n.createOscillator;n.createOscillator=function(){var t=c.call(this);return t.start=t.start||function(){t.noteOn&&(arguments.length>1?t.noteGrainOn.apply(t,arguments):t.noteOn.apply(t,arguments))},t.stop=t.stop||t.noteOff,t}}}void 0===n.createGain&&void 0!==n.createGainNode&&(n.createGain=n.createGainNode),void 0===n.createDelay&&void 0!==n.createDelayNode&&(n.createDelay=n.createDelayNode),void 0===n.createScriptProcessor&&void 0!==n.createJavaScriptNode&&(n.createScriptProcessor=n.createJavaScriptNode);var h=window.AudioParam=window.AudioParam||window.webkitAudioParam;if(h){var l=window.AudioParam.prototype;l.setTargetAtTime=l.setTargetAtTime||l.setTargetValueAtTime}else e.prototype.internal_createGain||(e.prototype.internal_createGain=e.prototype.createGain,e.prototype.createGain=function(){var e=this.internal_createGain();return t(e.gain),e});if("Chrome"==i.name&&42==i.version){var p=window.AudioBufferSourceNode.prototype;p.internal_start||(p.internal_start=p.start,p.start=function(t,e,i){p.internal_start.call(this,t)})}}}();var n,s=this.__extends||function(t,e){function i(){this.constructor=t}i.prototype=e.prototype,t.prototype=new i};return function(t){function e(t){G=G||{},G[t]=arguments}function i(e){for(var i=[],n=0;n<arguments.length-1;n++)i[n]=arguments[n+1];if(R.isInited)try{if("webaudio"===t.version){if(!t.context)return;R.instance.triggerEvent(e,i)}else"audiotag"===t.version&&t.audioTagHandler&&t.audioTagHandler.triggerEvent(e,i)}catch(s){t.err("Klang exception: unable to trigger event: '"+e+"': "+s.name+": "+s.message)}}function n(e){var i=R.instance.findInstance(t.getEvents()[e]);return i?i.destination():null}function o(){if(G){for(var e in G)G.hasOwnProperty(e)&&t.triggerEvent.apply(t,G[e]);G=null}}function r(e,i,n,s,r){if(t.initOptions=r=r||{},t.isMobile=U.checkMobile(),t.isIOS=U.checkIOS(),t.useMonoBuffers=t.isIOS,"object"==typeof e&&e.settings&&e.settings.force_logging&&(t.loggingEnabled=!0),t.klangInited)return void t.warn("Klang already initialized");t.klangInited=!0,t.readyState=t.READY_STATE_NOT_INITIATED;var a="webaudio"===r.forceMode||!r.forceMode&&void 0!==window.AudioContext;"audiotag"===r.forceMode||!r.forceMode&&!window.AudioContext;if(!a){t.version="audiotag";try{if("string"==typeof e&&-1===e.indexOf(".json")&&e.indexOf(".js")>1){var u=window.KLANGCONFIG;U.loadScriptFile(e,function(){var s=window.KLANG_CONFIG;window.KLANG_CONFIG=u,t.audioTagHandler=new q(s,function(e){t.readyState=t.READY_STATE_LOADED,i&&i(e),o()},n,e)},function(){})}else t.audioTagHandler=new q(e,function(e){t.readyState=t.READY_STATE_LOADED,i&&i(e),o()},n,e)}catch(c){return t.err("Klang exception: unable to initialize audio tag fallback"),t.version="failed audiotag",i(!1),!1}return!0}t.context||(t.context=new AudioContext);try{if(t.version="webaudio",R.isInited()&&t.warn("Klang already initialized"),"string"==typeof e&&-1===e.indexOf(".json")&&e.indexOf(".js")>1){var u=window.KLANG_CONFIG;U.loadScriptFile(e,function(){var s=window.KLANG_CONFIG;window.KLANG_CONFIG=u,R.instance.loadJSON(s,function(e){t.readyState=t.READY_STATE_LOADED,i&&i(e),o()},n,e)},function(){})}else R.instance.loadJSON(e,function(e){t.readyState=t.READY_STATE_LOADED,i&&i(e),o()},n,e);return!0}catch(c){return t.err("Klang exception: unable to parse config file: '"+e+"': "+c.name+": "+c.message),t.version="failed web audio",i(!1),!1}}function a(){if("webaudio"==t.version)try{R.instance.initIOS()}catch(e){t.err("Klang exception: unable to init iOS: "+e.name+": "+e.message)}else"audiotag"==t.version&&t.isMobile&&t.audioTagHandler.initIOS()}function u(){var e,i=[];if("webaudio"===t.version)e=B.FileHandler.instance;else{if("audiotag"!==t.version)return[];e=t.audioTagHandler}i=e.getLoadGroups();var n=i.indexOf("auto");return-1!==n&&i.splice(n,1),i}function c(){return R.instance}function h(){return B.FileHandler.instance}function l(){return U}function p(){return B}function _(e,i){return"webaudio"!==t.version?(t.err("Schedule only availible in WebAudio version"),this):("number"==typeof e&&"function"==typeof i?R.instance.scheduler.at(e,i):t.err(".schedule requires arg0 - time in seconds and arg1 - a callback function"),this)}function f(t,e){if(!B[t])throw new Error("No such object");return new B[t](e)}function d(t,e){R.debugSettings[t]=e}function g(e,i,n,s){try{t.logc("Klang: Loading: '"+e+"'",U.LOG_LOAD_COLOR),"webaudio"==t.version?R.instance.loadSoundFiles(e,i,n,s):"audiotag"==t.version?t.audioTagHandler.loadSoundFiles(e,i,n,s):(n&&n(1),i&&i(!1))}catch(o){t.err("Klang exception: unable to load file group: '"+e+"': "+o.name+": "+o.message)}}function y(e){try{t.logc("Klang: Freeing: '"+e+"'",U.LOG_LOAD_COLOR),"webaudio"==t.version?R.instance.freeSoundFiles(e):"audiotag"==t.version}catch(i){t.err("Klang exception: unable to free file group: '"+e+"': "+i.name+": "+i.message)}}function m(){return B.FileHandler.instance.progress}function v(){"webaudio"==t.version?R.isInited()&&R.instance.stopAll():"audiotag"==t.version&&t.audioTagHandler.stopAll()}function b(e,i){if("webaudio"==t.version){if(R.isInited()){if(0===e.indexOf(".")){var n=e.substring(1),s=[],o=t.getCoreInstance()._objectTable;for(var r in o)if(o.hasOwnProperty(r)){var a=o[r];a._type===n&&s.push(a)}return s}var u=R.instance.getSymbolId(e);return R.instance.findInstance(u)}}else"audiotag"==t.version}function T(){for(var e=[],i=0;i<arguments.length-0;i++)e[i]=arguments[i+0];t.loggingEnabled&&("Chrome"==t.browser?console.log("%c["+E()+"] "+e.join(),"color:"+U.LOG_TIME_COLOR):console.log.apply(console,e))}function S(e,i){t.loggingEnabled&&("Chrome"==t.browser?(i||(i="gray"),console.log("%c["+E()+"] "+e,"color:"+i)):console.log(e))}function O(){for(var e=[],i=0;i<arguments.length-0;i++)e[i]=arguments[i+0];t.loggingEnabled&&("Chrome"==t.browser?console.warn("%c["+t.getTimeString()+"] "+e.join(),"color:"+U.LOG_WARN_COLOR):console.warn.apply(console,e))}function P(){for(var e=[],i=0;i<arguments.length-0;i++)e[i]=arguments[i+0];t.loggingEnabled&&("Chrome"==t.browser?console.warn("%c["+t.getTimeString()+"] "+e.join(),"color:"+U.LOG_ERROR_COLOR):console.warn.apply(console,e))}function A(t,e){for(var i=t.toString();i.length<e;)i="0"+i;return i}function w(t){return A(t.getUTCMinutes(),2)+":"+A(t.getUTCSeconds(),2)+"."+A(t.getUTCMilliseconds(),3)}function E(e){void 0==e&&(e=t.context.currentTime);var i=Math.round(1e3*e),n=Math.floor(i/1e3%60),s=Math.floor(i/6e4%60),o=Math.floor(i/36e5%24);return A(o,2)+":"+A(s,2)+":"+A(n,2)+"."+A(i%1e3,3)}function k(){return"flash"===t.version?null:"audiotag"==t.version?t.audioTagHandler._events:R.instance._eventTable}function F(t){R.instance.setCallbacks(t)}function x(e){var n=0,s=setInterval(function(){for(var o=t.context.currentTime,r=e[n];r.time<o;){if(i(r.name,r.args),n++,n==e.length){clearInterval(s);break}r=e[n]}},10)}function C(e,i){t.klangInited=!1,"webaudio"==t.version?R.isInited()&&(R.instance.stopAll(),R.deinit()):"audiotag"==t.version&&t.audioTagHandler.stopAll(),t.version="n/a"}!function(t){function e(){var t=window.document.createElement("audio");if(!t.canPlayType)return!1;var e=[];return t.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")&&e.push(".ogg"),t.canPlayType("audio/aac").replace(/no/,"")&&e.push(".m4a"),t.canPlayType("audio/mpeg;").replace(/no/,"")&&e.push(".mp3"),e}function i(t){s=s||e();for(var i=0;i<s.length;i++)if(s[i]===t)return!0;return!1}function n(){var t,e=navigator.userAgent,i=e.match(/(edge(?=\/))\/?\s*(\d+)/i)||[];return 0==i.length&&(i=e.match(/(edge|opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[]),/trident/i.test(i[1])?(t=/\brv[ :]+(\d+)/g.exec(e)||[],{name:"IE",version:t[1]||"unknown"}):"Chrome"===i[1]&&(t=e.match(/\bOPR\/(\d+)/),null!==t)?{name:"Opera",version:t[1]}:(i=i[2]?[i[1],i[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(t=e.match(/version\/(\d+)/i))&&i.splice(1,1,t[1]),{name:i[0],version:i[1]})}var s;t.canPlayAudioSuffix=i,t.browser=n()}(t.detector||(t.detector={}));t.detector;!function(e){function i(t){var e=document.createElement("a");e.href=t;var i=document.createElement("a");i.href=location.href;var n=""!=e.hostname&&(e.port!=i.port||e.protocol!=i.protocol||e.hostname!=i.hostname);return n}function n(e,i,n,s){var o;if(e.type=e.type||"GET","MSIE"==t.detector.browser.name&&t.detector.browser.version<10)o=new window.XDomainRequest,o.onload=function(){setTimeout(function(){i&&i(o.responseText)},10)},o.onprogress=n||function(){},o.onerror=s||function(){},o.open(e.type,e.url,!0);else{if(!window.XMLHttpRequest)throw"Error - browser does not support XDomain/XMLHttp Requests";o=new XMLHttpRequest,o.open(e.type,e.url,!0),o.onreadystatechange=function(){try{if(4==o.readyState&&200==o.status){if(i){var t=o.responseText;i(t)}}else 0!=o.status&&200!=o.status&&s&&s({status:o.status})}catch(e){throw e}}}o&&o.send(null)}e.isCrossDomain=i,e.request=n}(t.network||(t.network={}));var I=t.network;t.audioTagHandler;var V=function(){function t(e,i){this._url=e,this.data=i,this._onCanPlayThrough=this._onCanPlayThrough.bind(this),this._waitForReadyState=this._waitForReadyState.bind(this),this.state=t.STATE_NOT_LOADED}return t.STATE_NOT_LOADED=0,t.STATE_LOADING=1,t.STATE_LOADED=2,t.prototype._onCanPlayThrough=function(){this.audioElement.removeEventListener("canplaythrough",this._onCanPlayThrough,!1),this._waitForReadyState(function(){this.ready=!0,this.state=this.state=t.STATE_LOADED,this._readyCallback&&this._readyCallback(),this.audioElement.pause()}.bind(this))},t.prototype._waitForReadyState=function(t){var e=this;!function i(){e.audioElement.readyState?t&&t():setTimeout(i,100)}()},t.prototype.load=function(e){if(this.state===t.STATE_NOT_LOADED){this.state=t.STATE_LOADING;var i=this.audioElement=new Audio;i.src=this._url,i.addEventListener("canplaythrough",this._onCanPlayThrough,!1),i.volume=0,i.play()}this._readyCallback=e},t.prototype.clone=function(){var e=new t(this._url,this.data);return e.state=this.state,e.audioElement=new Audio,e.ready=!!this.ready,e.audioElement.src=this._url,e.audioElement.volume=0,e.audioElement.play(),e},t}();t.ATAudioFile=V;var D=function(){function e(t,i){this._xLoopTimer=0,this.state=e.STATE_STOPPED,this._data=t,this._currentFile=i,this._retrig=void 0===t.retrig?!0:t.retrig,this._loopStart=t.loop_start||0,this._loopEnd=t.loop_end||0,this._destination_name=t.destination_name,this._currentFile&&(this._priority=this._currentFile.data.audio_tag,this._loop=!!this._data.loop,this._gain=new N(t.volume,this),this.beforeEnding=this.beforeEnding.bind(this))}return e.STATE_PLAYING=3,e.STATE_STOPPING=3,e.STATE_STOPPED=4,e.prototype.beforeEnding=function(){if(this._playing&&this._loop){var t=this._currentFile;this._currentFile=t===this._files[0]?this._files[1]:this._files[0],this._currentFile.currentTime=0,this._currentFile.audioElement.currentTime=0,this.update(),this._currentFile.audioElement.play(),clearTimeout(this._xLoopTimer),this._xLoopTimer=setTimeout(this.beforeEnding,1e3*(this._currentFile.audioElement.duration-this._loopStart-(this._loopEnd?this._currentFile.audioElement.duration-this._loopEnd:0)))}},e.prototype.play=function(t,i,n,s,o){if(t=t||0,!this._currentFile.ready)return this;if(this._playing&&!this._retrig&&this.state!==e.STATE_STOPPING)return this;if(t>0){var r=this;this._playTimeout=setTimeout(function(){r.doPlay(i,n,s,o)},1e3*t)}else this.doPlay(i,n,s,o)},e.prototype.doPlay=function(t,i,n,s){return t=t||0,this.state!=e.STATE_STOPPING||this._retrig?(n||this.update(),this._currentFile.audioElement.currentTime=0,this._currentFile.audioElement.play(),this._playing=!0,this._loop&&(this._files||(this._files=[this._currentFile,this._currentFile.clone()]),clearTimeout(this._xLoopTimer),this._xLoopTimer=setTimeout(this.beforeEnding,1e3*(this._currentFile.audioElement.duration-t-this._loopStart-(this._loopEnd?this._currentFile.audioElement.duration-this._loopEnd:0)))),this.state=e.STATE_PLAYING,this):(this.getOutput().fadeVolume(this.getOutput().getVolume(),.5),void(this.state=e.STATE_PLAYING))},e.prototype.fadeInAndPlay=function(t,e,i,n){if(i=i||0,i>0){var s=this;this._playTimeout=setTimeout(function(){s.doFadeInAndPlay(s.getOutput().getVolume(),e)},1e3*i)}else this.doFadeInAndPlay(this.getOutput().getVolume(),e);return this},e.prototype.doFadeInAndPlay=function(t,i){return this._gain.setVolume(this.state==e.STATE_PLAYING?this._gain.getVolume():0),this.play(0,0,!0,!0),this._gain.fadeVolume(1,i),this},e.prototype.stop=function(t){return this._playTimeout&&clearTimeout(this._playTimeout),this.state=e.STATE_STOPPED,this._currentFile.audioElement.pause(),this._playing=!1,clearTimeout(this._xLoopTimer),this},e.prototype.fadeOutAndStop=function(t,i){if(this.state==e.STATE_PLAYING){this._playTimeout&&clearTimeout(this._playTimeout);var n=this;return this._gain.fadeVolume(0,t,function(){n.state==e.STATE_STOPPING&&n.stop()}),this.state=e.STATE_STOPPING,this}},e.prototype.setVolume=function(e){return e=void 0===e?this.getOutput().getVolume():e*this.getOutput().getVolume(),e=Math.max(0,Math.min(1,e*t.audioTagHandler.getGlobalVolume()*t.audioTagHandler.getFocusBlurVolume())),this._currentFile.audioElement&&isFinite(e)&&(this._currentFile.audioElement.volume=e),this},e.prototype.update=function(){this.setVolume(this._destination.calcVolume())},e.prototype.connect=function(t){this._destination=t,t.addConnected(this),this.update()},e.prototype.getOutput=function(){return this._gain},Object.defineProperty(e.prototype,"position",{get:function(){return this.playing?this._currentFile.audioElement.currentTime:0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"playing",{get:function(){return this._playing},enumerable:!0,configurable:!0}),e}();t.ATAudioSource=D;var M=function(){function t(t,e){this._data=t,this._content=[];for(var i in this._data.content){var n=e.getObject(this._data.content[i]);n&&this._content.push(n)}}return t.prototype.play=function(t,e,i){var n="number"==typeof e?e:U.random(this._content.length-1,0);return this._content[n]&&this._content[n].play(t),this},t.prototype.stop=function(){for(var t in this._content)this._content[t]&&this._content[t].stop();return this},Object.defineProperty(t.prototype,"content",{get:function(){return this._content},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"playing",{get:function(){var t=!1;for(var e in this._content)this._content[e]._playing&&(t=!0);return t},enumerable:!0,configurable:!0}),t.prototype.update=function(){},t.prototype.connect=function(t){},t}();t.ATAudioGroup=M;var N=function(){function t(t,e){this._currentVolume=this._volume=void 0!=t?t:1,this._currentVolume=Math.max(0,Math.min(this._currentVolume,1)),this._owner=e}return t.prototype.getVolume=function(){return this._volume},t.prototype.setVolume=function(t){return t=Math.max(0,Math.min(1,t)),this._currentVolume=t,this._owner&&this._owner.setVolume&&this._owner.setVolume(this._currentVolume),this},t.prototype.fadeVolume=function(t,e,i){this._fadeTimer&&clearInterval(this._fadeTimer);var n=this;return this._fadeSteps=Math.round(1e3*e)/10,this._volumeStep=(this._currentVolume-t)/this._fadeSteps,this._fadeTimer=setInterval(function(){n.setVolume(n._currentVolume-n._volumeStep),n._fadeSteps--,n._fadeSteps<=0&&(clearInterval(n._fadeTimer),i&&i())},10),this},t.prototype.resetVolume=function(t){var e=t?this._currentVolume:this._volume;return clearInterval(this._fadeTimer),this.setVolume(e),this},t}();t.ATGainNode=N;var L=function(){function t(t,e,i){this._isMaster=!1,this._connected=[],this._isMaster=i,this._data=t,this._name=e,this._output=new N(void 0!=t.output_vol?t.output_vol:1,this),this._volume=void 0!=t.output_vol?t.output_vol:1,this._destination_name=t.destination_name}return t.prototype.getVolume=function(){return this._isMaster?this._volume:this._volume},t.prototype.calcVolume=function(t){return"undefined"==typeof t&&(t=1),t*=this._volume,this._destination?this._destination.calcVolume(t):t},t.prototype.setVolume=function(t){this._volume=t;for(var e=0;e<this._connected.length;e++)this._connected[e].update()},t.prototype.update=function(){for(var t=0;t<this._connected.length;t++)this._connected[t].update()},t.prototype.getOutput=function(){return this._output},t.prototype.addConnected=function(t){this._connected.push(t)},t.prototype.connect=function(t){this._destination=t,t.addConnected(this)},t}();t.ATBus=L;var j=function(){function e(t,e,i){this._data=t,this._name=e,this._vars=i,"copy"===this._data.at_action&&(this._data.at_action=this._data.action)}return e.prototype.start=function(e){try{"function"==typeof this._data.at_action?this._data.at_action(U,this._vars,e):new Function("Util","me","args",this._data.at_action)(U,this._vars,e)}catch(i){t.err("Klang: error in process '"+this._name+"': "+i.name+": "+i.message)}},e}();t.ATProcess=j;var q=function(){function e(e,i,n,s){if(this._loadedFiles=0,t.audioTagHandler=this,this._audioFiles={},this._limitSounds=t.isMobile||"Opera"==t.detector.browser.name,"string"==typeof e){var o=this;I.request({url:e},function(e){try{o.init(JSON.parse(e),i,n,s)}catch(r){t.version="n/a",i&&i(!1)}},null,function(e){t.err(e)})}else"object"==typeof e?this.init(e,i,n,s):t.err("Klang exception: unrecognized config type: "+typeof e)}return e.prototype.init=function(e,i,n,s){function o(){r.isHidden()?r._blurFadeOut&&r.setFocusBlurVolume(0):r.setFocusBlurVolume(1)}var r=this;this._globalVolume=1,this._focusBlurVolume=1,this._readyCallback=i,this._progressCallback=n,this._events=e.events;var a,u=parseInt(e.settings.relative_path),c=e.settings.file_path||"";u&&-1!=s.lastIndexOf("/")?(a=s.substring(0,s.lastIndexOf("/")),"/"!==a.charAt(a.length-1)&&(a+="/"),a+=c):a=c;var h=".mp3";("Firefox"==t.detector.browser.name||"Chrome"==t.detector.browser.name)&&(h=".ogg");for(var l in e.files){var p=e.files[l],_=p.audio_tag;!_||this._limitSounds&&1!=_||(this._audioFiles[p.id]=new V(a+p.url+h,p))}this._masterBus=e.masterBus,this._busses={};for(var f in e.busses)this._busses[f]=new L(e.busses[f],f,f==this._masterBus);this._audio={};for(var d in e.audio)if(e.audio.hasOwnProperty(d)){var g=e.audio[d];if("AudioSource"==g.type){if(this._audioFiles[g.file_id]){this._audioFiles[g.file_id];this._audio[d]=new D(g,this._audioFiles[g.file_id])}}else"AudioGroup"==g.type&&(this._audio[d]=new M(g,this))}for(var y in this._busses)y!=this._masterBus&&this._busses[y].connect(this._busses[this._busses[y]._destination_name]);for(var m in this._audio)"AudioSource"==this._audio[m]._data.type&&this._audio[m].connect(this._busses[this._audio[m]._destination_name]);this._processes={};for(var l in e.processes){var v=e.processes[l];if(v.at_action){var b={};for(var T in v.vars){var S=v.vars[T];b[S]=this._audio[S]||this._busses[S]}this._processes[l]=new j(v,l,b)}}if(this.loadSoundFiles(["auto","autotag"],i,n),-1!=e.settings.blur_fade_time){this._blurFadeOut=!0;var r=(e.settings.blur_fade_time||.5,this),O=this.getHiddenProp();if(O){var P="visibilitychange";document.addEventListener(P,o)}}},e.prototype.fadeBusVolume=function(t,e,i){var n=this._busses[t._name];n.getOutput().fadeVolume(e,i)},e.prototype.isHidden=function(){var t=this.getHiddenProp();return t?document[t]:!1},e.prototype.getHiddenProp=function(){var t=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var e=0;e<t.length;e++)if(t[e]+"Hidden"in document)return t[e]+"Hidden";return null},e.prototype.initIOS=function(){if(t.isIOS||t.isMobile)for(var e in this._audioFiles)this._audioFiles[e].load()},e.prototype.loadSoundFiles=function(t,e,i,n){e&&(this._readyCallback=e),i&&(this._progressCallback=i),"string"==typeof t&&(t=[t]),this._loadedFiles=0,this._numFiles=0;var s=this;for(var o in this._audioFiles)if(this._audioFiles.hasOwnProperty(o)){var r=this._audioFiles[o],a=r.data.load_group;(void 0==t||-1!=t.indexOf(a))&&r.state===V.STATE_NOT_LOADED&&(this._numFiles++,r.load(function(){s.loadProgress()}))}0==this._numFiles&&this._readyCallback&&this._readyCallback(!0)},e.prototype.getLoadGroups=function(){var t,e=this._audioFiles||[],i={},n=[];for(t in e){var s=e[t];i[s.data.load_group]=s.data.load_group}for(t in i)n.push(t);return n},e.prototype.loadProgress=function(){if(this._loadedFiles++,this._progressCallback&&this._progressCallback(this._loadedFiles/this._numFiles*100),this._readyCallback&&this._loadedFiles==this._numFiles){var t=this;setTimeout(function(){t._readyCallback(!0)},200)}},e.prototype.triggerEvent=function(e,i){for(var n="",s=0;s<i.length;s++)n+=i[s]+", ";if("sound_position"!=e){var o="";i&&(o=i[0])}if(this._events)try{var r=this._events[e];if("string"==typeof r){var a=this._processes[r];a&&a.start(i)}else if(r)for(var u=0,c=r.length;c>u;u++){var h=r[u],a=this._processes[h];a&&a.start(i)}}catch(l){t.err("Klang: error when triggering event '"+e+"': "+l.name+": "+l.message)}},e.prototype.getFocusBlurVolume=function(){return this._focusBlurVolume},e.prototype.setFocusBlurVolume=function(t){t=Math.max(0,Math.min(t,1)),this._focusBlurVolume=t;for(var e in this._audio){var i=this._audio[e];if(i&&i.setVolume&&i.getOutput()){var n=i.getOutput();n&&i.update()}}},e.prototype.getGlobalVolume=function(){return this._globalVolume},e.prototype.setGlobalVolume=function(t){t=Math.max(0,Math.min(t,1)),this._globalVolume=t;for(var e in this._audio){var i=this._audio[e];if(i&&i.setVolume&&i.getOutput){var n=i.getOutput();n&&i.setVolume(n.getVolume())}}},e.prototype.fadeGlobalVolume=function(t,e){t=Math.max(0,Math.min(t,1)),this._globalFadeTimer&&clearInterval(this._globalFadeTimer);var i=this,n=Math.round(1e3*e)/10,s=(this._globalVolume-t)/n;this._globalFadeTimer=setInterval(function(){i._globalVolume=i._globalVolume-s,n--;for(var t in i._audio){var e=i._audio[t];e&&e.setVolume&&e.getOutput&&e.setVolume()}0>=n&&clearInterval(i._globalFadeTimer)},10)},e.prototype.getLimitSounds=function(){return this._limitSounds},e.prototype.stopAll=function(t){for(var e in this._audio)(void 0==t||this._audio[e]._priority==t)&&this._audio[e].stop();return this.stopPeriodic(),this},e.prototype.getObject=function(t){return this._audioFiles[t]||this._audio[t]},e.prototype.playPeriodic=function(t,e,i){clearTimeout(this._periodicTimer);var n=this;this._periodicTimer=setTimeout(function(){t.play(),n.playPeriodic(t,e,i)},U.random(1e3*e,1e3*i))},e.prototype.stopPeriodic=function(){clearTimeout(this._periodicTimer)},e}();t.AudioTagHandler=q,t.versionNumber=1,t.context,t.version,t.progressCallback,t.readyCallback,t.browser,t.os,t.isMobile,t.isIOS,t.fallback,t.loggingEnabled=!1,t.useMonoBuffers=!1,t.Panner,t.safari=!1,t.initOptions;var R=function(){function e(){this._initComplete=!1,this._blurFadeOut=!1,this._masterBusId=null,this._preLoadInitStack=[],this._postLoadInitStack=[],this._connectStack=[],this._superMasterOutput=t.context?t.context.createGain():null,t.Panner=B.Panner,this._eventHistory=[],this.scheduler=new B.Scheduler,U.getParameterByName("klang_log")&&(t.loggingEnabled=!0)}return e.debugSettings={},e.inst=null,e.isInited=function(){return null==e.inst?!1:e.inst._initComplete},Object.defineProperty(e.prototype,"initComplete",{get:function(){return this._initComplete},enumerable:!0,configurable:!0}),Object.defineProperty(e,"instance",{get:function(){return null==e.inst&&(e.inst=new e),e.inst},enumerable:!0,configurable:!0}),e.prototype.setCallbacks=function(t){this._callbacks=t},Object.defineProperty(e,"callbacks",{get:function(){return e.instance._callbacks},enumerable:!0,configurable:!0}),e.deinit=function(){e.inst=null},e.prototype.stopAll=function(){window.KlangVisual&&KlangVisual.stop();for(var t in this._objectTable)if(this._objectTable[t].stop)try{this._objectTable[t].stop()}catch(e){}},e.prototype.loadJSON=function(i,n,s,o){if(this._readyCallback=n,this._progressCallback=s||function(){},"object"==typeof i){t.log("Loading config (editor)");var r=this.createConfigNode(i);e.settings=r.settings,e.instance.initContent(r,null,o),window.KlangVisual&&KlangVisual.init(i)}else{if("string"!=typeof i)throw"Klang exception: unrecognized options: '"+i+"'";t.log("Loading config (client)");var a=new XMLHttpRequest;a.open("GET",i,!0);var u=this;a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var t=a.responseText,n=u.parseConfigJSON(t);e.settings=n.settings,e.instance.initContent(n,null,i),window.KlangVisual&&KlangVisual.init(JSON.parse(t))}else{if(404==a.status)throw"Klang exception: config file not found: '"+i+"'";if(200!=a.status)throw"Klang exception: unable to load config file: '"+i+"'"}},a.send(null)}},e.prototype.parseConfigJSON=function(e){if("string"==typeof e)return JSON.parse(e,function(e,i){return i&&"object"==typeof i&&"string"==typeof i.type?B[i.type]?new B[i.type](i,e):(t.warn("Core: Type not found: "+i.type),null):i});for(var i in Object.keys(e)){var n=e[i];return B[n.type]?new B[n.type](n,i):(t.warn("Core: Type not found: "+n.type),null)}},e.prototype.createConfigNode=function(e){if("object"==typeof e)for(var i in e){var n=e[i];"object"==typeof n&&"string"==typeof n.type?(B[n.type]||t.warn("Core: Type not found: "+n.type),e[i]=this.createConfigNode(n),e[i]=new B[n.type](n,i)):e[i]=this.createConfigNode(n)}return e},e.prototype.createObject=function(e,i,n){if(n||(n={}),!B[i.type])return void t.warn("Core: Type not found: "+i.type);!n.excludeFromTable&&this._objectTable[e]&&t.warn("Core: Duplicate object: "+e);var s=new B[i.type](i,e);if(n.excludeFromTable||(this._objectTable[e]=s),!n.noInit&&s.init&&s.init(),!n.noConnect&&s.destinationName&&s.connect)if("$OUT"==s.destinationName)s.connect(this._superMasterOutput);else{var o=this.findInstance(s.destinationName);o||t.warn("Core: Destination not found: "+s.destinationName),"Bus"!=o._type&&t.warn("Core: Destination is not a bus: "+s.destinationName),s.connect(o.input)}return s},e.prototype.updateObject=function(t,e){var i="string"==typeof t?this._objectTable[t]:t;if("SimpleProcess"==i._type&&"AdvancedProcess"==e.type){var n=new B.AdvancedProcess(e,t);n.init(),this._objectTable[t]=n}else if("AdvancedProcess"==i._type&&"SimpleProcess"==e.type){var s=new B.SimpleProcess(e,t);s.init(),this._objectTable[t]=s}else i.setData&&i.setData(e)},e.prototype.createEvent=function(e,i){this._eventTable[e]&&t.warn("Core: Duplicate event: "+e),this._eventTable[e]=i},e.prototype.initContent=function(i,n,s){function o(){h.isHidden()?h._blurFadeOut&&U.curveParamLin(h._superMasterOutput.gain,0,c):U.curveParamLin(h._superMasterOutput.gain,1,c)}var r,a=i.settings.relative_path,u=i.settings.file_path||"";a&&-1!=s.lastIndexOf("/")?(r=s.substring(0,s.lastIndexOf("/")),"/"!==r.charAt(r.length-1)&&(r+="/"),r+=u):r=u,t.log("Initializing core");t.context.currentTime;if(-1!=i.settings.blur_fade_time){this._blurFadeOut=!0;var c=i.settings.blur_fade_time||.5;0>c&&-1!=c&&t.warn("Core: Invalid blur_fade_time value. Must be -1 or >= 0.");var h=this,l=this.getHiddenProp();if(l){var p="visibilitychange";document.addEventListener(p,o)}}B.FileHandler.instance.fileInfo=(void 0!=n&&null!==n?n:i.files)||[],this._eventTable=i.events||{},this._objectTable={};for(var _ in i.audio)this._objectTable[_]=i.audio[_];for(var _ in i.busses)this._objectTable[_]=i.busses[_];for(var _ in i.sequencers)this._objectTable[_]=i.sequencers[_];for(var _ in i.processes)this._objectTable[_]=i.processes[_];for(var _ in i.synths)this._objectTable[_]=i.synths[_];for(var _ in i.lfos)this._objectTable[_]=i.lfos[_];for(var _ in i.automations)this._objectTable[_]=i.automations[_];this.setVars(i.vars),this._masterBusId=i.masterBus,this._exportedSymbols=i.exportedSymbols||{},this._logIgnore=i.debug.log_ignore||i.log_ignore||{},B.Panner.setListenerData(i.settings.listener),U.createCurves(i.curves),this._loadStartTimestamp=(new Date).getTime(),i.debug&&(t.debugData.ignoredEvents=i.debug.ignored_events||t.debugData.ignoredEvents,t.debugData.logToConsole=i.debug.log_to_console||t.debugData.logToConsole),t.log("Pre load initialization started");for(var f=0,d=this._preLoadInitStack.length;d>f;f++){var g=this._preLoadInitStack[f];g.init&&g.init()}t.log("Pre load initialization finished"),t.log("Connecting nodes"),this._superMasterOutput.connect(t.context.destination);for(var f=0,d=this._connectStack.length;d>f;f++){var g=this._connectStack[f];switch(g.destinationName){case"$OUT":g.connect(this._superMasterOutput);break;case"$PARENT":break;default:var y=this.findInstance(g.destinationName);y||t.warn("Core: Destination not found: "+g.destinationName),"Bus"!=y._type&&t.warn("Core: Destination is not a bus: "+g.destinationName),g.connect(y.input)}}t.log("Nodes connected"),this._preLoadInitStack=null,this._connectStack=null,this._timeHandler=new B.TimeHandler,this._initComplete=!0,t.log("Core initialized"),B.FileHandler.instance.baseURL=r,!t.initOptions||t.initOptions&&!t.initOptions.noAutoLoad?B.FileHandler.instance.loadFiles("auto",e.soundsLoaded,this._progressCallback):setTimeout(e.soundsLoaded,4)},e.prototype.isHidden=function(){var t=this.getHiddenProp();return t?document[t]:!1},e.prototype.getHiddenProp=function(){var t=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var e=0;e<t.length;e++)if(t[e]+"Hidden"in document)return t[e]+"Hidden";return null},e.prototype.setVars=function(t){if(t){for(var e in t)if("string"==typeof t[e]&&t[e].indexOf("me.")>-1)t[e]=this.findInstance(t[e].split("me.")[1]);else if("object"==typeof t[e]){var i=t[e];for(var n in i)i.hasOwnProperty(n)&&"string"==typeof i[n]&&i[n].indexOf("me.")>-1&&(i[n]=this.findInstance(i[n].split("me.")[1]))}U.vars=t}},e.prototype.loadSoundFiles=function(t,e,i,n){i&&(this._progressCallback=i);var s=this;B.FileHandler.instance.loadFiles(t,function(t,i){for(var n=0;n<i.length;n++){var o=i[n].id;for(var r in s._objectTable)if(s._objectTable.hasOwnProperty(r)){var a=s._objectTable[r];"AudioSource"===a._type&&a._fileId===o&&a.init()}}e&&e(!0)},this._progressCallback,n)},e.prototype.freeSoundFiles=function(t){B.FileHandler.instance.freeSoundFiles(t);for(var e in this._objectTable){var i=this._objectTable[e];if("AudioSource"==i._type){var n=B.FileHandler.instance.getFileInfo(i._fileId);
n&&n.load_group==t&&i.freeBuffer()}}},e.soundsLoaded=function(){t.log("Post load initialization started");for(var i=e.instance,n=0,s=i._postLoadInitStack.length;s>n;n++)i._postLoadInitStack[n].init();t.log("Post load initialization finished"),i._postLoadInitStack=null,i._readyCallback&&i._readyCallback(!0)},e.prototype.pushToPreLoadInitStack=function(t){return this._preLoadInitStack?(this._preLoadInitStack.push(t),!0):!1},e.prototype.pushToPostLoadInitStack=function(t){return this._postLoadInitStack?(this._postLoadInitStack.push(t),!0):!1},e.prototype.pushToConnectStack=function(t){return this._connectStack?(this._connectStack.push(t),!0):!1},e.prototype.findInstance=function(e){var i=this._objectTable[e];return i||t.warn("Core: Unknown reference: '"+e+"'"),i},e.prototype.triggerEvent=function(e){for(var i=[],n=0;n<arguments.length-1;n++)i[n]=arguments[n+1];if(U.lastEvent=e,!t.debugData.ignoredEvents[e]){this._eventTable[e]?t.debugData.logToConsole&&!this._logIgnore[e]&&t.logc("Klang Core: Incoming sound event: '"+e+"', "+i,U.LOG_EVENT_COLOR):t.debugData.logToConsole&&!this._logIgnore[e]&&t.logc("Klang Core: Incoming sound event: '"+e+"', "+i,U.LOG_UNIMPLEMENTED_EVENT_COLOR);var s=this._eventTable[e];if("string"==typeof s)this._objectTable[s]||t.warn("Core: Unknown process: '"+s+"'"),"SimpleProcess"!=this._objectTable[s]._type&&"AdvancedProcess"!=this._objectTable[s]._type&&t.warn("Core: Object is not a process: '"+s+"'"),this._objectTable[s].start(i[0]);else if(s instanceof Array)for(var o=0,r=s.length;r>o;o++)this._objectTable[s[o]]||t.warn("Core: Unknown process: '"+s[o]+"'"),"SimpleProcess"!=this._objectTable[s[o]]._type&&"AdvancedProcess"!=this._objectTable[s[o]]._type&&t.warn("Core: Object is not a process: '"+s+"'"),this._objectTable[s[o]].start(i[0])}},e.prototype.getSymbolId=function(t){return this._exportedSymbols[t]},e.prototype.initIOS=function(){var e=t.context.createBufferSource();e.start(0)},Object.defineProperty(e.prototype,"timeHandler",{get:function(){return this._timeHandler},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"output",{get:function(){return this._superMasterOutput},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blurFadeOut",{get:function(){return this._blurFadeOut},set:function(t){this._blurFadeOut=t},enumerable:!0,configurable:!0}),e}();t.READY_STATE_NOT_INITIATED=0,t.READY_STATE_INITIATED=1,t.READY_STATE_LOADED=2,t.klangInited=!1,t.readyState=t.READY_STATE_NOT_INITIATED;var G;t.pushToEventQue=e,t.triggerEvent=i,t.getDestinationForEvent=n,t.init=r,t.initIOS=a,t.getLoadGroups=u,t.getCoreInstance=c,t.getFileHandlerInstance=h,t.getUtil=l,t.getModel=p,t.schedule=_,t.createObject=f,t.setDebugFlag=d,t.load=g,t.free=y,t.getLoadProgress=m,t.stopAll=v,t.$=b,t.log=T,t.logc=S,t.warn=O,t.err=P,t.zeropad=A,t.getTimeStamp=w,t.getTimeString=E,t.getEvents=k,t.debugData={ignoredEvents:{},logToConsole:!0},t.visualWindow,t.setCallbacks=F,t.schedulePredefinedEvents=x,t.deinit=C;var B;!function(e){function i(t,e,i,n,s){"undefined"==typeof s&&(s="equalpower");var o,r;if("linear"==s)o=function(t){return 1-t},r=function(t){return t};else{if("equalpower"!=s)return;o=function(t){return Math.pow(1-t,.5)},r=function(t){return Math.pow(t,.5)}}i=Math.min(i,t.length),n=Math.min(n,e);for(var a=0;a<t.numberOfChannels;a++){for(var u=t.getChannelData(a),c=i-1,h=e-1,l=n-1;l>=0;l--){var p=(l+1)/(n+1);u[c]=u[c]*o(p)+u[h]*r(p),c--,h--}for(var _=i,f=e;_<t.length;)u[_++]=u[f++]}}function n(t){switch(t){case g.PrePlaying:return"PrePlaying";case g.Playing:return"Playing";case g.PreStopping:return"PreStopping";case g.PostStop:return"PostStop";case g.Stopped:return"Stopped"}}function o(e,i){(0>i||i>3)&&t.warn("Synth: Invalid noise algorithm: "+i);var n=e||65536,s=t.context.createBuffer(1,n,t.context.sampleRate),o=s.getChannelData(0);i||(i=0);for(var r=0;n>r;r++)switch(i){case 0:o[r]=2*Math.random()-1;break;case 1:o[r]=Math.random();break;case 2:o[r]=Math.random()-1;break;case 3:o[r]=r/n}return s}var r=function(){function t(){}return t.prototype.on=function(t,e,i){this._events=this._events||{};var n=this._events[t]||(this._events[t]=[]);return n.push({callback:e,ctxArg:i,context:i||this}),this},t.prototype.off=function(t,e,i){var n,s,o,r;if(!this._events||!this._events[t])return this;t||e||i||(this._events={});var a=this._events[t];if(a){if(r=[],e&&i)for(n=0,s=a.length;s>n;n++)o=a[n],e!==o.callback&&i!==o.ctxArg&&r.push(a[n]);else if(e)for(n=0,s=a.length;s>n;n++)o=a[n],e!==o.callback&&r.push(a[n]);else if(i)for(n=0,s=a.length;s>n;n++)o=a[n],i!==o.ctxArg&&r.push(a[n]);this._events[t]=r}return this._events[t].length||delete this._events[t],this},t.prototype.trigger=function(t){for(var e=[],i=0;i<arguments.length-1;i++)e[i]=arguments[i+1];if(!this._events||!this._events[t])return this;var n,s,o;for(o=this._events[t],e=[].splice.call(arguments,1),n=o.length-1;n>=0;n--)s=o[n],s.callback.apply(s.context,e);return this},t}();e.EventEmitter=r;var a=function(){function e(){this.memUsage=0,this._decoding=!1,this._files={},this._bufferQue=[],this._groups={},this._lastSentPercent=-1}return e.inst=null,Object.defineProperty(e,"instance",{get:function(){return null==e.inst&&(e.inst=new e),e.inst},enumerable:!0,configurable:!0}),e.prototype.sendProgressCallback=function(t){var e=this._groups[t];if(e.progressCallback&&!e.loadInterrupted){var i=0;e.progress.readyAudioFiles>=e.progress.totalAudioFiles&&(i=Math.floor((e.progress.loadedBytes+e.progress.bufferedFiles)/(e.progress.totalBytes+e.progress.totalFiles)*(100-(e.progress.totalFiles-e.progress.convertedFiles)))),this._lastSentPercent!==i&&e.progressCallback(i),this._lastSentPercent=i}},e.prototype.updateProgress=function(t,e){var i=t.load_group;if(!t.sizeReceived){t.sizeReceived=!0;var n=1;e.lengthComputable&&(n=e.total,t.loadedBytes=0),t.totalBytes=n,this._groups[i].progress.totalBytes+=n,this._groups[i].progress.readyAudioFiles++}if(void 0!=t.loadedBytes){var s=e.loaded-t.loadedBytes;t.loadedBytes=e.loaded,this._groups[i].progress.loadedBytes+=s,this.sendProgressCallback(i)}},e.prototype.decodeBufferQue=function(){var e=this;if(this._bufferQue.length){var i=this._bufferQue.pop(),n=i.data,s=i.info,o=i.callback;this._decoding=!0,t.context.decodeAudioData(n,function(n){var r=e._groups[s.load_group];if(e._decoding=!1,t.useMonoBuffers){for(var a=n.length,u=t.context.createBuffer(1,a,t.context.sampleRate),c=n.getChannelData(0),h=u.getChannelData(0),l=0;a>l;l++)h[l]=c[l];n=u}e.memUsage+=n.length*n.numberOfChannels*Float32Array.BYTES_PER_ELEMENT;e.memUsage;e.addFile(s,n),r.progress.convertedFiles++,i.data=null,e._bufferQue.length?e.decodeBufferQue():o&&o()},function(e){t.log("Klang warning: unable to load file '"+(this._baseURL||"")+s.url+"'")})}},e.prototype.loadAudioBuffer=function(e,i){var n=this,s=new XMLHttpRequest,o=".mp3";("Firefox"===t.detector.browser.name||"Chrome"===t.detector.browser.name)&&(o=".ogg");var r=(e.external?"":this._baseURL)+e.url+o;s.open("GET",r,!0),s.responseType="arraybuffer",s.sizeReceived=!1,s.load_group=e.load_group,s.onprogress=function(t){n.updateProgress(s,t)},s.onload=function(t){var o=n._groups[e.load_group];if(n._bufferQue.push({data:s.response,load_group:o,info:e,callback:i}),s.loadedBytes){var r=s.totalBytes-s.loadedBytes;o.progress.loadedBytes+=r}else o.progress.loadedBytes+=1;n.updateProgress(s,t),n.decodeBufferQue(),s.response=null,s=null},s.onreadystatechange=function(){4==s.readyState&&200==s.status||200!=s.status&&(n._groups[e.load_group].loadInterrupted=!0,n._groups[e.load_group].loadFailedCallback&&n._groups[e.load_group].loadFailedCallback())},s.send(),this._groups[e.load_group].progress.totalAudioFiles++},e.prototype.loadMidiFile=function(t,e){var i=this;loadRemote(this._baseURL+t.url,function(t,e){i.updateProgress(t,e)},function(n){i.addFile(t,readMidiFile(n)),e&&e()})},e.prototype.loadMidiString=function(t){var e=this,i=new XMLHttpRequest;i.open("GET",this._baseURL+t.url),i.onprogress=function(t){e.updateProgress(i,t)},i.onreadystatechange=function(){4==this.readyState&&200==this.status&&e.addFile(t,readMidiString(i.response))},i.send()},e.prototype.loadFiles=function(t,e,i,n){"string"==typeof t&&(t=[t]);for(var s=t.length,o=function(){s--,0===s&&e&&e.apply(this,arguments)},r={},a=function(t){if(i){r[this.name]=t;var e=0,n=0;for(var s in r)r.hasOwnProperty(s)&&(e++,n+=r[s]);n/=e,i(n)}},u=function(){o()},c=0,h=t.length;h>c;c++)r[t[c]]=0,this._groups[t[c]]={},this._groups[t[c]]._loadedFiles=[],this._groups[t[c]].filesLoadedCallback=o,this._groups[t[c]].progressCallback=a.bind(this._groups[t[c]]),this._groups[t[c]].loadFailedCallback=u,this._groups[t[c]].loadInterrupted=!1,this._groups[t[c]].name=t[c],this._groups[t[c]].progress={totalBytes:0,loadedBytes:0,totalFiles:0,totalAudioFiles:0,readyAudioFiles:0,bufferedFiles:0,convertedFiles:0};for(var c=0,h=this._fileInfo.length;h>c;c++){var l=this._fileInfo[c],p=t.indexOf(l.load_group);if(-1!=p&&!this._files[l.id]&&!l.only_audio_tag){switch(l.file_type){case"audio":this.loadAudioBuffer(l);break;case"midi":this.loadMidiFile(l);break;case"midistring":this.loadMidiString(l)}this._groups[t[p]].progress.totalFiles++}}for(var c=0,h=t.length;h>c;c++)0==this._groups[t[c]].progress.totalFiles&&this._groups[t[c]].filesLoadedCallback&&!this._groups[t[c]]._loadInterrupted&&this._groups[t[c]].filesLoadedCallback(!0,this._groups[t[c]]._loadedFiles)},e.prototype.prepareFile=function(t){this._fileInfo.push(t)},e.prototype.prepareFiles=function(t){var e,i;for(e=0,i=t.length;i>e;e++)this.prepareFile(t[e])},e.prototype.addFile=function(t,e){this._files[t.id]=e,this._groups[t.load_group].progress.bufferedFiles++,this._groups[t.load_group]._loadedFiles=this._groups[t.load_group]._loadedFiles||[],this._groups[t.load_group]._loadedFiles.push(t),this.sendProgressCallback(t.load_group),this._groups[t.load_group].progress.bufferedFiles!=this._groups[t.load_group].progress.totalFiles||this._groups[t.load_group].loadInterrupted||this._groups[t.load_group].filesLoadedCallback&&this._groups[t.load_group].filesLoadedCallback(!0,this._groups[t.load_group]._loadedFiles||[])},e.prototype.freeSoundFiles=function(t){"string"==typeof t&&(t=[t]);for(var e=0,i=this._fileInfo.length;i>e;e++){var n=this._fileInfo[e];-1!=t.indexOf(n.load_group)&&(this._files[n.id]=null)}},e.prototype.getLoadGroups=function(){var t,e=this._fileInfo||[],i={},n=[];for(t=0;t<e.length;t++){var s=e[t];i[s.load_group]=s.load_group}for(t in i)n.push(t);return n},e.prototype.getFile=function(t){return this._files[t]||null},e.prototype.getFilesForLoadgroup=function(t){for(var e=[],i=0,n=this._fileInfo.length;n>i;i++)this._fileInfo[i].load_group==t&&e.push(this._fileInfo[i]);return e},e.prototype.getFileInfo=function(t){for(var e=0,i=this._fileInfo.length;i>e;e++)if(this._fileInfo[e].id==t)return this._fileInfo[e]},Object.defineProperty(e.prototype,"progress",{get:function(){return this._groups},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"baseURL",{set:function(t){this._baseURL=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fileInfo",{set:function(t){this._fileInfo=t},enumerable:!0,configurable:!0}),e}();e.FileHandler=a;var u=function(){function e(e,i){this.data=e,this._name=i,this._type=e.type,this._output=t.context.createGain(),this._volume=void 0!=e.volume?e.volume:1,this._output.gain.value=this._volume,e.destination_name&&(this.destinationName=e.destination_name,R.instance.initComplete||R.instance.pushToConnectStack(this))}return e.prototype.connect=function(e){return t.warn("Audio: Invocation of abstract method: Audio.connect in",this),this},e.prototype.disconnect=function(){return t.warn("Audio: Invocation of abstract method: Audio.disconnect in",this),this},e.prototype.play=function(e,i){return t.warn("Audio: Invocation of abstract method: Audio.play in",this),this},e.prototype.stop=function(e){return t.warn("Audio: Invocation of abstract method: Audio.stop in",this),this},e.prototype.pause=function(){return t.warn("Audio: Invocation of abstract method: Audio.pause in",this),this},e.prototype.unpause=function(){return t.warn("Audio: Invocation of abstract method: Audio.unpause in",this),this},e.prototype.curvePlaybackRate=function(e,i){return t.warn("Audio: Invocation of abstract method: Audio.curvePlaybackRate in",this),this},e.prototype.fadeInAndPlay=function(t,e){return console.warn("Audio: Invocation of abstract method: Audio.fadeInAndPlay in",this),this},e.prototype.fadeOutAndStop=function(t,e){return console.warn("Audio: Invocation of abstract method: Audio.fadeOutAndStop in",this),this},e.prototype.deschedule=function(){return console.warn("Audio: Invocation of abstract method: Audio.deschedule in",this),this},Object.defineProperty(e.prototype,"playbackRate",{set:function(e){return t.warn("Audio: Invocation of abstract property: Audio.playbackRate in",this),this},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"playing",{get:function(){return t.warn("Audio: Invocation of abstract property: Audio.playing in",this),!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"duration",{get:function(){return t.warn("Audio: Invocation of abstract property: Audio.duration in",this),0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"playbackState",{get:function(){return t.warn("Audio: Invocation of abstract property: Audio.playbackState in",this),0},enumerable:!0,configurable:!0}),e.prototype.setData=function(t){this._volume=void 0==t.volume?1:t.volume,this._output.gain.value=this._volume,this.destinationName!=t.destination_name&&(this.destinationName=t.destination_name,this.disconnect(),this.connect(R.instance.findInstance(this.destinationName).input))},e.prototype.clone=function(){var t=new this.constructor(this.data,this._name);return t.connect(R.instance.findInstance(this.destinationName).input),t},e}();e.Audio=u;var c=function(n){function o(t,e){if(n.call(this,t,e),this._sources=[],this._startTime=0,this._loopStartTime=0,this._scheduleAhead=.2,this._stopping=!1,this._fading=!1,this._paused=!1,this._pauseTime=-1,this._pauseStartTime=-1,this.editorName=t.editorName,this._fileId=t.file_id,this._playbackRate=t.playback_rate||1,this._endTime=0,this._loop=void 0!=t.loop?t.loop:!1,this._loopStart=t.loop_start,this._loopEnd=t.loop_end,this._offset=t.offset||0,this._duration=t.duration||0,this._reverse=t.reverse,this._retrig=void 0!=t.retrig?t.retrig:!0,this._lockPlaybackrate=void 0!=t.lock_playback_rate?t.lock_playback_rate:!1,this._volumeStartRange=t.volume_start_range,this._volumeEndRange=t.volume_end_range,this._pitchStartRange=t.pitch_start_range,this._pitchEndRange=t.pitch_end_range,t.panner&&(this._panner=t.panner),t.granular){this._granular={bufferDuration:0,speed:t.granular.speed||.3333,pitch:t.granular.pitch||0,pitchRandomization:t.granular.pitch_randomization||0,timeRandomization:t.granular.time_randomization||0,realTime:0,grainTime:0,grainDuration:t.granular.grain_duration||.09,grainSpacing:t.granular.grain_spacing||.045,grainWindow:null};var i=16384;this._granular.grainWindow=new Float32Array(i);for(var s=0;i>s;++s)this._granular.grainWindow[s]=Math.sin(Math.PI*s/i)}R.instance.pushToPostLoadInitStack(this)||this.init()}return s(o,n),o.prototype.init=function(){if(this._fileId&&("string"==typeof this._fileId?this._buffer=a.instance.getFile(this._fileId):this._fileId.sampleRate&&(this._buffer=this._fileId)),this._buffer){if(this._duration||(this._duration=this._buffer.duration),this._granular&&(this._granular.bufferDuration=this._buffer.duration-.05),this._reverse){for(var e=t.context.createBuffer(this._buffer.numberOfChannels,this._buffer.length,t.context.sampleRate),n=0;n<this._buffer.numberOfChannels;n++)for(var s=this._buffer.getChannelData(n),o=e.getChannelData(n),r=s.length,u=r-1;u>=0;u--)o[r-u]=s[u];this._buffer=e}if(this.data.xfade){for(var c=t.context.createBuffer(this._buffer.numberOfChannels,this._buffer.length,t.context.sampleRate),n=0;n<this._buffer.numberOfChannels;n++)for(var s=this._buffer.getChannelData(n),h=c.getChannelData(n),r=s.length,u=r-1;u>=0;u--)h[u]=s[u];this._buffer=c;var l=t.context.sampleRate,p=this.data.xfade===!0?11025:this.data.xfade*l,_=void 0==this._loopStart?p:Math.round(this._loopStart*l),f=void 0==this._loopEnd?this._buffer.length:Math.round(this._loopEnd*l);i(this._buffer,_,f,p)}}},o.prototype.setLoopRegion=function(t,e){this._loopStart=t||this._loopStart,this._loopEnd=e||this._loopEnd;for(var i=0,n=this._sources.length;n>i;i++){var s=this._sources[i];s.loopStart=this._loopStart,s.loopEnd=this._loopEnd}return this},o.prototype.connect=function(t,e){return(!this._destination||e)&&(this._destination=t,this._panner?(this._output.connect(this._panner.input),this._panner.output.connect(t)):this._output.connect(t)),this},o.prototype.disconnect=function(){return this._output.disconnect(),this._destination=null,this._panner&&this._panner.output.disconnect(),this},o.prototype.scheduleGrain=function(){if(this._buffer){var e=this._granular,i=t.context.createBufferSource();i.buffer=this._buffer;var n=Math.random(),s=Math.random(),o=Math.random(),r=Math.random();Math.random();n=2*(n-.5),s=2*(s-.5),o=2*(o-.5),r=2*(r-.5);var a=t.context.createGain();i.connect(a),a.connect(this._output);var u=this._granular.pitch+n*e.pitchRandomization,c=Math.pow(2,u/1200);i.playbackRate.value=c;var h=s*e.timeRandomization;i.start(e.realTime,e.grainTime+h,e.grainDuration);var l=e.grainDuration/c;a.gain.value=0,a.gain.setValueCurveAtTime(e.grainWindow,e.realTime,l);e.grainTime;e.realTime+=e.grainSpacing,e.grainTime+=e.speed*e.grainSpacing,e.grainTime>e.bufferDuration&&(e.grainTime=0,this._loop||this.stop()),e.grainTime<0&&(e.grainTime+=e.bufferDuration,this._loop||this.stop())}},o.prototype.granularSchedule=function(e){for(;this._granular.realTime<e+.1;)this.scheduleGrain();var i=this;this._granular.scheduleId=setTimeout(function(){i.granularSchedule(t.context.currentTime)},20)},o.prototype.play=function(e,i,n,s){if("undefined"==typeof e&&(e=0),"undefined"==typeof i&&(i=0),"undefined"==typeof s&&(s=!1),this.removeUnusedSources(),n||(n=this._loop?9999999999:this._duration),!this._buffer&&(this.init(),!this._buffer))return void t.warn("AudioSource: Buffer not found!",this._name);if(e=e||0,this._granular)this.granularSchedule(e);else{if(0!=e&&e+.01<=t.context.currentTime)return t.warn("AudioSource: Returned, playTime < currentTime",this._name),this;if(0==e&&(e=t.context.currentTime),this.output.gain.cancelScheduledValues(e),void 0!=this._volumeStartRange?this.output.gain.setValueAtTime(this._volume*(Math.random()*(this._volumeEndRange-this._volumeStartRange)+this._volumeStartRange),e):this.output.gain.setValueAtTime(this._volume,e),this.paused||(this._pauseStartTime=e),s||(this._pauseTime=0),this._startTime=e,this._loopStartTime=e+this.duration,this._paused=!1,this._stopping&&!this._retrig)return this.output.gain.cancelScheduledValues(e),this.output.gain.setValueAtTime(this.output.gain.value,e),this.output.gain.linearRampToValueAtTime(this._volume,e+.25),clearTimeout(this._stoppingId),void(this._stopping=!1);if(!this._fading,this._fading=!1,this._retrig||this.loop)if(this.loop&&!this._retrig){if(-1==this._endTime||e<this._endTime)return}else{if(this.loop&&this._retrig&&this.playing&&!this._stopping)return;if(this._stopping)this._stopping=!1;else if(Math.round(1e3*this._endTime)/1e3==Math.round(1e3*(e+this._buffer.duration))/1e3)return t.warn("AudioSource: Returned, Doubletrig",this._name),this}else if(e<this._endTime)return;this._endTime=this.loop?-1:e+this._buffer.duration;var o=this.createBufferSource();o.buffer=this._buffer,this._loop&&(o.loop=!0,o.loopStart=this._loopStart?this._loopStart:0,o.loopEnd=this._loopEnd?this._loopEnd:this._buffer.duration),this._destination||t.warn("AudioSource: no destination node"),"object"!=typeof this._destination&&t.warn("AudioSource: destination is not an object",this._name),o.connect(this._output),i>this._duration&&(i%=this._duration),this._startOffset=this._offset+i,void 0!=this._pitchStartRange&&(o.playbackRate.value=this._playbackRate*(Math.random()*(this._pitchEndRange-this._pitchStartRange)+this._pitchStartRange)),o.startTime=e,this._loop?o.start(e,this._startOffset):o.start(e,this._startOffset,n||o.buffer.duration),R.callbacks&&R.callbacks.scheduleAudioSource&&R.callbacks.scheduleAudioSource({audio:this,startTime:e})}return this},o.prototype.getNumberOfSamples=function(){return this._buffer.length},o.prototype.stop=function(t){if("undefined"==typeof t&&(t=0),this._granular)clearTimeout(this._granular.scheduleId);else{this._stopping&&(this._stopping=!1,clearTimeout(this._stoppingId));var e=this._sources.length;if(e>0)if(t=t||U.now(),this._loop&&(this._loopPlaying=!1),this._endTime=t,this._retrig)this._sources[this._sources.length-1].stop(t),this._sources.splice(this._sources.length-1,1);else{for(var i=0;e>i;i++){var n=this._sources[i];n.stop(t),this._endTime=U.now()}this._sources=[]}else this._loopPlaying=!1}return this},o.prototype.deschedule=function(){for(var e=0;e<this._sources.length;e++){var i=this._sources[e];i.startTime>t.context.currentTime&&(i.stop(0),this._sources[e].disconnect(),i.disconnect(),this._sources.splice(e,1),e--)}return this},o.prototype.pause=function(){if(this._endTime>U.now()){this._paused=!0;var t=U.now()-this._startTime;this._pauseTime+=t,this.stop()}return this},o.prototype.unpause=function(){if(this.paused){var t=this._offset;this._offset+=this._pauseTime,this.play(0,0,null,!0),this._offset=t,this._paused=!1}return this},o.prototype.createBufferSource=function(){var e=t.context.createBufferSource();return e.playbackRate.value=this._playbackRate,this._sources.push(e),e},o.prototype.fadeInAndPlay=function(e,i,n,s){"undefined"==typeof n&&(n=0),"undefined"==typeof s&&(s=this._duration);var o=t.context.currentTime;return i||(i=o),this.loop&&!this._retrig&&(-1==this._endTime||i<this._endTime)&&!this._stopping||this.loop&&this._retrig&&this.playing&&!this._stopping?void 0:(this.output.gain.cancelScheduledValues(i),this._stopping?(clearTimeout(this._stoppingId),this.output.gain.setValueAtTime(this.output.gain.value,i)):(this._fading=!0,this.play(i==o?0:i,n,s),this.output.gain.setValueAtTime(0,i)),this._stopping=!1,this.output.gain.linearRampToValueAtTime(this._volume,i+e),this)},o.prototype.fadeOutAndStop=function(e,i){if(this.playing){void 0==i&&(i=t.context.currentTime),this._stopping&&clearTimeout(this._stoppingId),this.output.gain.cancelScheduledValues(i),this.output.gain.setValueAtTime(this.output.gain.value||this._volume,i),this.output.gain.linearRampToValueAtTime(0,i+e);var n=this;return this._stoppingId=setTimeout(function(){n._stopping&&(n._stopping=!1,n.loop&&(n._loopPlaying=!1),n.stop(i+e))},(e+(i-U.now())-n._scheduleAhead)/.001),this._stopping=!0,this}},o.prototype.removeUnusedSources=function(){for(var e=0;e<this._sources.length;e++){var i=this._sources[e];(!i.buffer||!this.loop&&i.startTime+i.buffer.duration<t.context.currentTime)&&(this._sources[e].disconnect(),this._sources.splice(e,1),e--)}},o.prototype.curvePlaybackRate=function(t,e,i){if(!this._lockPlaybackrate){var n=i?i:U.now(),s=this.playbackRateNode;return s&&(s.cancelScheduledValues(n),s.setValueAtTime(0==s.value?U.EXP_MIN_VALUE:s.value,n),s.exponentialRampToValueAtTime(t,n+e)),this._playbackRate=t,this}},Object.defineProperty(o.prototype,"lastSource",{get:function(){var t=this._sources.length;return 0==t?null:this._sources[t-1]},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"offset",{get:function(){return this._offset},set:function(t){"string"==typeof t&&-1!==t.indexOf("%")&&(t=this._duration*parseFloat(t)),this._offset=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"position",{get:function(){if(!this.playing||!this._duration)return 0;var t=this._duration;(this._loopStart||this._loopEnd)&&(t=(this._loopEnd||t)-(this._loopStart||0));var e=U.now()-this._startTime,i=U.now()+this._startOffset-this._loopStartTime;return this._startOffset+e>this._duration?(this._loopStart||0)+i%t:this._startOffset+e},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"duration",{get:function(){return this._duration},set:function(t){this._duration=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"paused",{get:function(){return this._paused},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"playbackRate",{get:function(){return this._playbackRate},set:function(t){if(!this._lockPlaybackrate){var e=this.playbackRateNode;e&&e.cancelScheduledValues(U.now()),this._playbackRate=t;for(var i=0,n=this._sources.length;n>i;i++)this._sources[i].playbackRate.value=this._playbackRate}},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"nextPlaybackRate",{set:function(t){this._lockPlaybackrate||(this._playbackRate=t)},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"playbackRateNode",{get:function(){var t=this.lastSource;return t&&t.playbackRate},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"buffer",{get:function(){return this._buffer||(this._buffer=a.instance.getFile(this._fileId)),this._buffer},set:function(t){this._buffer=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"playing",{get:function(){return-1==this._endTime||this._endTime>U.now()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"playbackState",{get:function(){var t=this.lastSource;return t?t.playbackState:0},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"output",{get:function(){return this._panner?this._panner.output:this._output},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"panner",{get:function(){return this._panner},enumerable:!0,configurable:!0}),o.prototype.freeBuffer=function(){this._buffer=null;for(var t=0,e=this._sources.length;e>t;t++){try{this._sources[t].stop(0)}catch(i){}this._sources[t].disconnect(),this._sources[t]=null}this._sources=[]},o.prototype.setData=function(t){n.prototype.setData.call(this,t);var i=!1;this._volumeStartRange=t.volume_start_range,this._volumeEndRange=t.volume_end_range,this._pitchEndRange=t.pitch_end_range,this._pitchStartRange=t.pitch_start_range,void 0!=t.file_id&&this._fileId!=t.file_id&&(this._fileId=t.file_id,i=!0),this._playbackRate=void 0==t.playback_rate?1:t.playback_rate,this.playbackRateNode&&(this.playbackRateNode.value=this._playbackRate),this._loop=void 0==t.loop?!1:t.loop,this.lastSource&&(this.lastSource.loop=this._loop),this._loop||(this._loopPlaying=!1),this._loopStart=void 0==t.loop_start?0:t.loop_start,this.lastSource&&(this.lastSource.loopStart=this._loopStart),this._loopEnd=void 0==t.loop_end?0:t.loop_end,this.lastSource&&(this.lastSource.loopEnd=this._loopEnd);var s=void 0==t.offset?0:t.offset;this._offset!=s&&(this._offset=s,i=!0);var o=void 0==t.duration?0:t.duration;if(this._duration!=o&&(this._duration=o,i=!0),this._retrig=void 0==t.retrig?!0:t.retrig,void 0==t.reverse&&(t.reverse=!1),this._reverse!=t.reverse&&(this._reverse=t.reverse,i=!0),void 0==t.xfade&&(t.xfade=!1),this.data.xfade!=t.xfade&&(i=!0),this.data=t,i&&this.init(),t.granular)if(this._granular)void 0!=t.granular.speed&&(this._granular.speed=t.granular.speed),void 0!=t.granular.pitch&&(this._granular.pitch=t.granular.pitch),void 0!=t.granular.pitch_randomization&&(this._granular.pitchRandomization=t.granular.pitch_randomization),void 0!=t.granular.time_randomization&&(this._granular.timeRandomization=t.granular.time_randomization),void 0!=t.granular.grain_duration&&(this._granular.grainDuration=t.granular.grain_duration),void 0!=t.granular.grain_spacing&&(this._granular.grainSpacing=t.granular.grain_spacing);else{this._granular={bufferDuration:this._buffer.duration-.05,speed:t.granular.speed||.3333,pitch:t.granular.pitch||0,pitchRandomization:t.granular.pitch_randomization||0,timeRandomization:t.granular.time_randomization||0,realTime:0,grainTime:0,grainDuration:t.granular.grain_duration||.09,grainSpacing:t.granular.grain_spacing||.045,grainWindow:null};for(var r=16384,a=new Float32Array(r),u=0;r>u;++u)a[u]=Math.sin(Math.PI*u/r);this._granular.grainWindow=a}else this._granular&&(clearTimeout(this._granular.scheduleId),this._granular=null);if(t.panner)if(this._panner)this._panner.setData(t.panner);else{var c=this._destination;this.disconnect(),this._panner=new e.Panner(t.panner),this.connect(c)}else if(!t.panner&&this._panner){var c=this._destination;this.disconnect(),this._panner=null,this.connect(c)}},o}(u);e.AudioSource=c,e.crossfade=i;var h={CONCURRENT:0,STEP:1,RANDOM:2,SHUFFLE:3,BACKWARDS:4},l={NONE:0,ONE:1,INFINITE:2},p=function(){function e(t,e){this._adder=0,this._currentId=0,this._paused=!1,this.data=t,this.editorName=t.editorName,this._name=e,this._type=t.type,this._groupType=void 0!=t.group_type?t.group_type:h.STEP,this._retrig=void 0!=t.retrig?t.retrig:!0,this._queue=void 0!=t.queue?t.queue:l.NONE,this._content=t.content||[],R.instance.pushToPreLoadInitStack(this)}return e.prototype.init=function(){for(var t=[],e=0,i=this._content.length;i>e;e++)t.push(R.instance.findInstance(this._content[e]));this._content=t},e.prototype.play=function(e,i,n){if(this._content.length){var s=this.latestPlayed?this.latestPlayed.playing:!1;if(!n&&!this._retrig&&s)return this._queue!=l.NONE&&(this._queue==l.ONE&&this._latestStartTime>t.context.currentTime?(this.latestPlayed.stop(),this.play(this._latestStartTime,i,!0)):this.play(this._latestStartTime+this.latestPlayed.duration,i,!0)),this;if(this._paused=!1,void 0!=i){var o;"number"==typeof i?o=i:"string"==typeof i?o=this.getIdFromString(i):i._name&&(o=this.getIdFromString(i._name)),this._content[o].play(e),this._latestPlayed=this._content[o]}else{if(this._groupType==h.CONCURRENT)for(var r=0,a=this._content.length;a>r;r++)this._content[r].play(e);else this._currentId=this.getIdToPlay(),this._content[this._currentId].play(e);this._groupType===h.CONCURRENT?this._latestPlayed=this._content[0]:this._latestPlayed=this._content[this._currentId]}return this._latestStartTime=e||t.context.currentTime,this}},e.prototype.getIdToPlay=function(){var t;if(this._groupType==h.STEP)t=this._adder<0?this._content.length-1+this._adder%this._content.length:this._adder%this._content.length,this._adder++;else if(this._groupType==h.RANDOM){var e=Math.floor(Math.random()*(this._content.length-1));this._content.length>1&&e==this._adder&&(e=(e+1)%this._content.length),t=this._adder=e}else this._groupType==h.SHUFFLE?(this._adder%this._content.length==0&&U.shuffle(this._content),t=this._adder%this._content.length,this._adder++):this._groupType==h.BACKWARDS&&(t=this._adder<0?this._content.length-1+this._adder%this._content.length:this._adder%this._content.length,this._adder--);return t},e.prototype.stop=function(t){return this._content[this._currentId].stop(t),this},e.prototype.stopAll=function(t){for(var e=0,i=this._content.length;i>e;e++)this._content[e].stop(t);return this},e.prototype.pause=function(){return this._paused=!0,this._latestPlayed&&this._latestPlayed.pause(),this},e.prototype.unpause=function(){return this._paused=!1,this._latestPlayed&&this._latestPlayed.unpause(),this},e.prototype.fadeInAndPlay=function(t,e){var i=this.latestPlayed?this.latestPlayed.playing:!1;if(this._retrig||!i)return this._currentId=this.getIdToPlay(),this._latestPlayed=this._content[this._currentId],this._content[this._currentId].fadeInAndPlay(t,e),this},e.prototype.fadeOutAndStop=function(e,i){return void 0==i&&(i=t.context.currentTime),this._latestPlayed&&this._latestPlayed.fadeOutAndStop(e,i),this},e.prototype.curvePlaybackRate=function(t,e,i){for(var n=(i?i:U.now(),0),s=this._content.length;s>n;n++)this._content[n].curvePlaybackRate(t,e,i);return this},e.prototype.deschedule=function(){for(var t=0,e=this._content.length;e>t;t++)this._content[t].deschedule();
return this},e.prototype.getIdFromString=function(t){for(var e=0,i=this._content.length;i>e;e++)if(this._content[e]._name==t)return e},Object.defineProperty(e.prototype,"playbackRate",{set:function(t){for(var e=0,i=this._content.length;i>e;e++)this._content[e].playbackRate=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"groupType",{get:function(){return this._groupType},set:function(t){this._groupType=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"content",{get:function(){return this._content},set:function(t){this._content=t,this.init()},enumerable:!0,configurable:!0}),e.prototype.addContent=function(t){this._content.push(t)},e.prototype.removeContent=function(t){for(var e=0;e<this._content.length;e++)this._content[e]._name===t&&this._content.splice(e,1)},Object.defineProperty(e.prototype,"playing",{get:function(){return this._latestPlayed?this._latestPlayed.playing:!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"duration",{get:function(){return this._latestPlayed?this._latestPlayed.duration:this._content[0].duration},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"playbackState",{get:function(){return this._content[this._currentId].playbackState},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"latestPlayed",{get:function(){return this._latestPlayed},enumerable:!0,configurable:!0}),e.prototype.setData=function(t){this._groupType=void 0==t.group_type?h.STEP:t.group_type,this._retrig=void 0==t.retrig?!0:t.retrig,this._queue=void 0==t.queue?l.NONE:t.queue,t.content&&(this._content=t.content,this.init())},e}();e.AudioGroup=p;var _=function(){function e(t){this._startValue=t.start_value||0,this._points=t.points||[]}return e.prototype.automate=function(e,i){i=i||t.context.currentTime,e.cancelScheduledValues(i),e.setValueAtTime(this._startValue,i);for(var n=0,s=0,o=this._points.length;o>s;s++){var r=this._points[s];switch(r.curve){case"lin":e.linearRampToValueAtTime(r.value,i+r.time);break;case"exp":e.exponentialRampToValueAtTime(r.value,i+r.time);break;default:if(!U.CUSTOM_CURVES[r.curve]){t.warn("Automation: Invalid curve type: "+r.curve);break}e.setValueCurveAtTime(U.CUSTOM_CURVES[r.curve],i+n,r.time-n)}n=r.time}},e}();e.Automation=_;var f=function(){function e(e,i){this._name=i,this._type=e.type,this._input=t.context.createGain(),this._output=t.context.createGain(),this._effects=e.effects||[];for(var n=0,s=this._effects.length;s>n;n++)e.effects[n].active===!1&&this._effects[n].setActive(!1);this._input.gain.value=void 0!==e.input_vol?e.input_vol:1,this._output.gain.value=void 0!==e.output_vol?e.output_vol:1,e.destination_name&&(this.destinationName=e.destination_name,R.instance.pushToConnectStack(this)),R.instance.pushToPreLoadInitStack(this)}return e.prototype.init=function(){for(var t=this._input,e=0,i=this._effects.length;i>e;e++)t.disconnect(),t.connect(this._effects[e].input),t=this._effects[e];t.connect(this._output)},e.prototype.connect=function(t){return this._output.connect(t),this},e.prototype.disconnect=function(){return this._output.disconnect(),this},e.prototype.insertEffect=function(t,e){var i=R.instance.createObject(void 0,t,{excludeFromTable:!0});return void 0==e?this._effects.push(i):this._effects.splice(e,0,i),this.init(),this},e.prototype.moveEffect=function(t,e){for(var i=0,n=this._effects.length;n>i;i++)this._effects[i].disconnect();var s=this._effects[t];return this._effects.splice(t,1),this._effects.splice(e,0,s),this.init(),this},Object.defineProperty(e.prototype,"input",{get:function(){return this._input},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"effects",{get:function(){return this._effects},enumerable:!0,configurable:!0}),e.prototype.setData=function(t){if(this._input.gain.value=void 0==t.input_vol?1:t.input_vol,this._output.gain.value=void 0==t.output_vol?1:t.output_vol,t.effects.length<this.effects.length){this.input.disconnect();for(var e=!1,i=0;i<this._effects.length;i++)this._effects[i].disconnect(),e||(void 0==t.effects[i]?(this._effects.splice(i,1),e=!0):this._effects[i]._type!=t.effects[i].type&&(this._effects.splice(i,1),i--,e=!0));this.init()}else if(t.effects.length>this.effects.length)this.insertEffect(t.effects[t.effects.length-1]);else for(var i=0,n=this._effects.length;n>i;i++)this._effects[i].setData(t.effects[i]);this.destinationName!=t.destination_name&&(this.destinationName=t.destination_name,this.disconnect(),"$OUT"==this.destinationName?this.connect(R.instance._superMasterOutput):this.connect(R.instance.findInstance(this.destinationName).input))},e}();e.Bus=f;var d=function(e){function i(t,i){if(e.call(this,t,i),this._startStep=0,this._totalStep=0,this._currentStep=0,this._syncStep=0,this._stepCount=0,this._fadeTime=0,this._transpose=0,this._scales={diatonic:[0,-1,0,-1,0,0,-1,0,-1,0,-1,0],dorian:[0,1,0,0,-1,0,1,0,1,0,0,-1],phrygian:[0,0,-1,0,-1,0,1,0,0,-1,0,-1],lydian:[0,1,0,1,0,1,0,0,1,0,1,0],mixolydian:[0,1,0,1,0,0,-1,0,-1,0,0,-1],aeolian:[0,-1,0,0,-1,0,-1,0,0,-1,0,-1],locrian:[0,0,-1,0,-1,0,0,-1,0,-1,0,-1],harmonicMinor:[0,1,0,0,-1,0,1,0,0,-1,1,0],melodicMinor:[0,1,0,0,-1,0,1,0,-1,0,1,0],majorPentatonic:[0,1,0,1,0,-1,1,0,1,0,-1,1],minorPentatonic:[0,-1,1,0,-1,0,1,0,-1,1,0,-1],doubleHarmonic:[0,0,-1,1,0,0,1,0,0,-1,1,0],halfDim:[0,1,0,0,-1,0,0,-1,0,-1,0,-1],chromatic:[0,0,0,0,0,0,0,0,0,0,0,0],custom:[0,0,0,0,0,0,0,0,0,0,0,0]},this._state=g.Stopped,this._beatSubscription=t.beat_subscription||.25,this._midiFileId=t.file_id,this._midiTrackIx=t.midi_track||0,this._sequencerName=t.sequencer,this._synthName=t.synth,this._loop=void 0!=t.loop?t.loop:!0,this._length=t.length||0,this._nextClip=0,this._startStep=t.start_step||0,this._root=t.root||0,this._transpose=this._orgTranspose=t.transpose||0,this._scale=this._orgScale=t.scale,this._rootNote=t.root_note||36,this._activeUpbeat=-1,t.upbeats){this._upbeats=[],this._upbeatLoopOffset=0;for(var n=0,s=t.upbeats.length;s>n;n++)this._upbeats.push({length:t.upbeats[n].length,step:t.upbeats[n].step,targetStep:t.upbeats[n].target_step,playInLoop:t.upbeats[n].play_in_loop})}R.instance.pushToPostLoadInitStack(this)}return s(i,e),i.prototype.init=function(){this._sequencer=R.instance.findInstance(this._sequencerName),this._sequencer.registerPattern(this),"progression"===this._synthName?(this._synth="progression",this._progression=!0,this._currentChord=[]):this._synth=R.instance.findInstance(this._synthName),this._midiFile=a.instance.getFile(this._midiFileId),this._midiFile&&this.setupFile()},i.prototype.setupFile=function(){this._midiTrack=this._midiFile.tracks[this._midiTrackIx],void 0==this._midiTrack&&t.warn("MidiPattern: midi track out of bounds: "+this._midiTrackIx),this.recalculateBPM(this._sequencer.bpm);var e=this._midiFile.header.ticksPerBeat,i=0;this._clips=[];for(var n=0,s=this._midiTrack.length;s>n;n++){var o=this._midiTrack[n];i+=o.deltaTime;var r=i/e%this._sequencer.resolution,a=i/e-r;this._clips.push({event:o,step:a,offset:i%(e*this._sequencer.resolution)})}return this},i.prototype.connect=function(t){return this._output.connect(t),this},i.prototype.disconnect=function(){return this._output.disconnect(),this},i.prototype.changeState=function(t){t!=this._state&&(R.callbacks&&R.callbacks.changePatternState&&R.callbacks.changePatternState({pattern:this,lastState:this._state,newState:t,step:this._sequencer.currentStep}),this._state=t)},i.prototype.prePlaySchedule=function(e,i,n){if(!this._midiFile){if(this._midiFile=a.instance.getFile(this._midiFileId),!this._midiFile)return void t.warn("MidiPattern: midifile not found: "+this._name);this.setupFile()}if(n=n||!1,this._state==g.Playing){if(!n)return this;this._syncStep=i,this.stop(e,!0)}if(this._syncStep=i%this._length,this._currentStep=this._startStep,this.findNextClip(this._currentStep),e>0){if(this._stepCount=e,this._currentStep+=this._syncStep,this._syncStep=0,this._totalStep=0,this.changeState(g.PrePlaying),this._upbeats){this._activeUpbeat=-1;for(var s=0,o=this._upbeats.length;o>s;s++){var r=this._upbeats[s];r.length<=e&&(-1==this._activeUpbeat||this._upbeats[this._activeUpbeat].length<r.length)&&(this._activeUpbeat=s)}-1!=this._activeUpbeat&&this._upbeats[this._activeUpbeat].playInLoop&&(this._upbeatLoopOffset=this._upbeats[this._activeUpbeat].length)}this.findNextClip(-1==this._activeUpbeat?this._currentStep:this._upbeats[this._activeUpbeat].step)}else this.changeState(g.Playing);return this},i.prototype.play=function(e){if(!this._midiFile){if(this._midiFile=a.instance.getFile(this._midiFileId),!this._midiFile)return void t.warn("MidiPattern: midifile not found: "+this._name);this.setupFile()}if(this._state==g.Playing)return this;if(e&&0!=e){var i=this._output.gain.value;this._output.gain.setValueAtTime(0,0),this._output.gain.setValueAtTime(i,e)}return this._currentStep=this._sequencer.currentStep%this._length+this._startStep,this.changeState(g.Playing),this.findNextClip(this._currentStep),this._sequencer.started||this._sequencer.start(),this},i.prototype.restart=function(){return this._currentStep=this._startStep,this._nextClip=0,this},i.prototype.stop=function(t,e){return this._synth.deschedule&&this._sequencer._scheduleAheadTime>.5&&this._synth.deschedule(),void 0==t||this._state==g.Stopped?(this.changeState(g.Stopped),this):(void 0==e&&(e=!0),e?(this._stepCount=this._sequencer.getStepsToNext(this._sequencer.beatLength*t),this.changeState(g.PreStopping)):(this.changeState(g.Stopped),"progression"!==this._synth&&this._synth._loopedSamples&&this._synth.stop(t)),this)},i.prototype.pause=function(){return this},i.prototype.unpause=function(){return this},i.prototype.sendMidiEvents=function(e,i,n){for(var s=this._nextClip;this._clips[this._nextClip].step==e;){var o=this._clips[this._nextClip];if(this._progression){if("noteOn"===o.event.subtype)this._currentChord.push(o.event.noteNumber);else if("noteOff"===o.event.subtype){var r=this._currentChord.indexOf(o.event.noteNumber);r>-1&&this._currentChord.splice(r,1)}}else{var a=0;if(o.event.noteNumber){if(this._scale){var u=o.event.noteNumber,c=u%12-this._root;0>c&&(c+=12),a=this._scales[this._scale][c]}0!=this._transpose&&(a+=this._transpose)}n&&"noteOn"===o.event.subtype||this._synth.handleMidiEvent(o.event,i+o.offset*this._secPerTick,a)}if(this._nextClip++,this._nextClip==this._clips.length&&(this._nextClip=0),this._nextClip===s){t.log("MidiPattern",this._name,"got stuck, check if you're playing the correct midi track.");break}}if(this._progression&&this._currentChord.length){this._currentChord.sort(function(t,e){return t-e});var h=this._currentChord[0],l=h%12,a=0;l!=this._root&&(a=h-this._rootNote);for(var p=[0,0,0,0,0,0,0,0,0,0,0,0],_=[],f=0;f<this._currentChord.length;f++){var d=this._currentChord[f]%12-l;0>d&&(d+=12),_.push(d)}_.sort(function(t,e){return t-e});for(var g=0;g<p.length;g++){var y=this.getClosestValues(_,g);void 0!==y&&(p[g]=y-g)}this._sequencer.customScale=p,this._sequencer.transpose=a,this._rootNote=h}},i.prototype.getClosestValues=function(t,e){for(var i=-1,n=t.length;n-i>1;){var s=Math.round((i+n)/2);t[s]<=e?i=s:n=s}var o;return t[i]==e&&(o=n=i),o=Math.abs(e-n)>Math.abs(e-i)?i:Math.abs(e-n)<Math.abs(e-i)?n:i,t[o]},i.prototype.findNextClip=function(t){for(var e=0,i=this._clips.length;i>e;e++)if(this._clips[e].step>=t)return this._nextClip=e,e},i.prototype.playStep=function(t,e){var i=!0;this._currentStep>=this._length+this._startStep&&(this.sendMidiEvents(this._length,e,!0),this._currentStep=this._startStep,this.findNextClip(this._currentStep),this._loop||(this.changeState(g.Stopped),i=!1)),i&&this.sendMidiEvents(this._currentStep,e,!1),this._totalStep+=this._beatSubscription,this._currentStep+=this._beatSubscription},i.prototype.update=function(t,e){if(this._state!=g.Stopped&&t%this._beatSubscription==0)switch(this._upbeats&&-1!=this._activeUpbeat&&this._upbeats[this._activeUpbeat].playInLoop&&this._state==g.Playing&&this._currentStep>=this._length+this._startStep-this._upbeatLoopOffset&&(this._upbeatLoopOffset>0&&(this._stepCount=this._upbeatLoopOffset,this.changeState(g.PrePlaying)),this.sendMidiEvents(this._currentStep,e,!0),this._currentStep=this._startStep,this.findNextClip(this._upbeats[this._activeUpbeat].step)),this._state){case g.PrePlaying:if(-1!=this._activeUpbeat){var i=this._upbeats[this._activeUpbeat],n=i.length-this._stepCount;n>=0&&this.sendMidiEvents(i.step+n,e,!1)}this._stepCount-=this._beatSubscription,this._stepCount<=0&&(-1!=this._activeUpbeat&&i.targetStep&&(this._currentStep=i.targetStep),this.findNextClip(this._currentStep),this.changeState(g.Playing));break;case g.Playing:this.playStep(t,e);break;case g.PreStopping:this._stepCount-=this._beatSubscription,this._stepCount<=0?this.stop(e,!1):this.playStep(t,e);break;case g.PostStop:}return this},i.prototype.recalculateBPM=function(t){var e=this._midiFile.header.ticksPerBeat,i=6e7/t,n=i/1e6;this._secPerTick=n/e},i.prototype.getNextBar=function(t){var e=Math.ceil(this._currentStep/t);return this._currentStep>this._length-t&&(e=0),e},i.prototype.fadeInAndPlay=function(t,e){return this.play(e),this.output.gain.value=0,U.curveParamLin(this.output.gain,1,t,e),this},i.prototype.fadeOutAndStop=function(e,i){return void 0==i&&(i=t.context.currentTime),this.output.gain.cancelScheduledValues(i),U.curveParamLin(this.output.gain,0,e,i),U.setParam(this.output.gain,this._volume,i+e),this.stop(i+e),this},i.prototype.deschedule=function(t){if(void 0==t&&(t=this._length),this._synth.deschedule&&this._synth.deschedule(),this._state!=g.Stopped){if(t%=this._length,this._currentStep=this._currentStep-t,this._currentStep<this._startStep){var e=this._startStep-this._currentStep;this._currentStep=this._startStep+this._length-e}for(var i=0,n=this._clips.length;n>i;i++)if(this._clips[i].step>=this._currentStep){this._nextClip=i;break}}return this},i.prototype.resetTranspose=function(){this._transpose=this._orgTranspose},Object.defineProperty(i.prototype,"length",{get:function(){return this._length},set:function(t){this._length=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"startStep",{set:function(t){this._startStep=t,this._currentStep=this._sequencer.currentStep%this._length+this._startStep;for(var e=0,i=this._clips.length;i>e;e++)if(this._clips[e].step>=this._currentStep){this._nextClip=e;break}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scale",{set:function(t){this._progression||("reset"===t?this._scale=this._orgScale:this._scale=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"customScale",{set:function(t){this._progression||(this._scales.custom=t,this._scale="custom")},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"transpose",{get:function(){return this._transpose},set:function(t){this._transpose=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"loop",{get:function(){return this._loop},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"playing",{get:function(){var t=!1;return(1===this._state||1===this._state)&&(t=!0),t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"duration",{get:function(){return this._length*this._sequencer.getNoteTime(1)},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){e.prototype.setData.call(this,t);var i=!1;if(this._beatSubscription=void 0==t.beat_subscription?.25:t.beat_subscription,this._midiFile!=t.file_id&&(this._midiFile=t.file_id),this._midiTrackIx!=t.midi_track&&(this._midiTrackIx=t.midi_track),void 0!=t.sequener&&this._sequencerName!=t.sequencer&&(this._sequencerName=t.sequencer,i=!0),void 0!=t.synth&&this._synthName!=t.synth&&(this._synthName=t.synth,i=!0),this._loop=void 0==t.loop?!1:t.loop,this._length=void 0==t.length?0:t.length,this._root=void 0==t.root?0:t.root,this._orgTranspose=void 0==t.transpose?0:t.transpose,this._transpose=this._orgTranspose,this._orgScale=void 0==t.scale?0:t.scale,this._scale=this._orgScale,this._rootNote=void 0==t.root_note?36:t.root_note,this._activeUpbeat=-1,t.upbeats){this._upbeats=[],this._upbeatLoopOffset=0;for(var n=0,s=t.upbeats.length;s>n;n++)this._upbeats.push({length:t.upbeats[n].length,step:t.upbeats[n].step,targetStep:t.upbeats[n].target_step,playInLoop:t.upbeats[n].play_in_loop});i=!0}i&&(this._sequencer.unregisterPattern(this),this.init())},i}(u);e.MidiPattern=d,function(t){t._map=[],t._map[0]="PrePlaying",t.PrePlaying=0,t._map[1]="Playing",t.Playing=1,t._map[2]="PreStopping",t.PreStopping=2,t._map[3]="PostStop",t.PostStop=3,t._map[4]="Stopped",t.Stopped=4}(e.PatternState||(e.PatternState={}));var g=e.PatternState;e.getPatternStateString=n;var y=function(e){function i(t,i){e.call(this,t,i),this._startStep=0,this._totalStep=0,this._currentStep=0,this._syncStep=0,this._stepCount=0,this._fadeTime=0,this._length=2,this._loop=!0,this._tail=!1,this._forceFade=!1,this._activeUpbeat=-1,this._startOffset=0,this._state=g.Stopped,this._beatSubscription=t.beat_subscription||.25,this._length=t.length||0,this._startStep=t.start_step||0,this._loop=void 0!=t.loop?t.loop:!0,this._tail=void 0!=t.tail?t.tail:!1,this._clips=[],this._upbeats=[],this._sequencerName=t.sequencer,this._initData={dummyClips:t.content,dummyUpbeats:t.upbeats},R.instance.pushToPreLoadInitStack(this)}return s(i,e),i.prototype.init=function(){if(this._initData.dummyClips)for(var t=0,e=this._initData.dummyClips.length;e>t;t++){var i=this._initData.dummyClips[t];i.audio?(this._clips.push({audio:R.instance.findInstance(i.audio),process:null,args:null,step:i.step}),this._clips[this._clips.length-1].audio._parentType=this._type):this._clips.push({audio:null,process:R.instance.findInstance(i.process),args:i.args,step:i.step})}if(this._initData.dummyUpbeats){for(var t=0,n=this._initData.dummyUpbeats.length;n>t;t++){for(var s=this._initData.dummyUpbeats[t],o=[],r=0,a=s.content.length;a>r;r++){var u=s.content[r];u.audio?(o.push({audio:R.instance.findInstance(u.audio),process:null,args:null,step:u.step}),this._clips[this._clips.length-1].audio._parentType=this._type):o.push({audio:null,process:R.instance.findInstance(u.process),args:u.args,step:u.step})}s.clips=o,this._upbeats.push({length:s.length,clips:o})}this._upbeats.sort(function(t,e){return e.length-t.length})}this._sequencer=R.instance.findInstance(this._sequencerName),this._sequencer.registerPattern(this),this._initData=null},i.prototype.connect=function(t){for(var e=0,i=this._clips.length;i>e;e++){var n=this._clips[e].audio;!n||n.destinationName&&"$OUT"!=R.instance.findInstance(n.destinationName).destinationName||(n.disconnect(),n.connect(this._output))}return this._output.connect(t),this},i.prototype.disconnect=function(){return this._output.disconnect(),this},i.prototype.changeState=function(t){t!=this._state&&(R.callbacks&&R.callbacks.changePatternState&&R.callbacks.changePatternState({pattern:this,lastState:this._state,newState:t,step:this._sequencer.currentStep}),this._state=t)},i.prototype.prePlaySchedule=function(e,i,n,s,o,r){n=n||!1;var a=t.context.currentTime;if(this._state==g.PreStopping||this._state==g.PostStop)return this._output.gain.cancelScheduledValues(a),this._output.gain.setValueAtTime(this._output.gain.value,a),this._output.gain.linearRampToValueAtTime(this._volume,a+.5),this.changeState(g.Playing),clearTimeout(this._stoppingId),this;if(this._output.gain.value!=this._volume||g.Stopped){var u;u=this._state===g.Stopped&&s?0:this._output.gain.value,this._output.gain.cancelScheduledValues(a),this._output.gain.setValueAtTime(u,a),this._output.gain.linearRampToValueAtTime(this._volume,a+o)}else if(s){var c=this._sequencer.getBeatTime(e);this._output.gain.cancelScheduledValues(c),this._output.gain.setValueAtTime(0,c),this._output.gain.linearRampToValueAtTime(this._volume,c+o)}if(this._state==g.Playing||this._state==g.PrePlaying){if(!n)return this;this._syncStep=i,this.stop(e,!0,0)}if(void 0!=r&&(this._startOffset=r),this._syncStep=i%this._length+this._startStep,e>0||n){this._stepCount=e,this._currentStep=this._startStep,this._totalStep=0,this._activeUpbeat=-1;for(var h=0,l=this._upbeats.length;l>h;h++){var p=this._upbeats[h];p.length<=e&&(-1==this._activeUpbeat||this._upbeats[this._activeUpbeat].length<p.length)&&(this._activeUpbeat=h)}this.changeState(g.PrePlaying)}else this.changeState(g.Playing);return this},i.prototype.play=function(t){return this._state==g.Playing||this._state==g.PrePlaying?this:((this._state==g.PreStopping||this._state==g.PostStop)&&clearTimeout(this._stoppingId),this._currentStep=this._sequencer.currentStep%this._length+this._startStep,this.changeState(g.Playing),this._sequencer.started||this._sequencer.start(),this)},i.prototype.stop=function(e,i,n,s){if(this._state==g.Stopped)return this;if(this._state===g.PrePlaying)return void this.changeState(g.Stopped);if(void 0==e)return this.changeState(g.Stopped),this._currentStep=0,this;if(void 0==i&&(i=!0),i)this._stepCount=this._sequencer.getStepsToNext(this._sequencer.beatLength*e)||0,this._fadeTime=n,this.changeState(g.PreStopping),s>0&&(this._stepCount+=s);else if(n){var o=n/this._sequencer.getNoteTime(1);this._stepCount=Math.ceil(o),this.changeState(g.Stopped);for(var r=(t.context.currentTime,0);r<this._clips.length;r++)this._clips[r].audio&&this._clips[r].audio.fadeOutAndStop(n,e)}else{this.changeState(g.Stopped),this._currentStep=0;for(var r=0;r<this._clips.length;r++)this._clips[r].audio&&this._clips[r].audio.stop(e+this._sequencer.getNoteTime(this._sequencer.resolution))}return this},i.prototype.pause=function(){for(var t=0,e=this._clips.length;e>t;t++)this._clips[t].audio&&this._clips[t].audio.pause();return this},i.prototype.unpause=function(){for(var t=0,e=this._clips.length;e>t;t++)this._clips[t].audio&&this._clips[t].audio.unpause();return this},i.prototype.playStep=function(t,e){this._currentStep>=this._length+this._startStep&&(this._loop?this._currentStep=this._startStep:this._loop||this.changeState(g.Stopped));for(var i=0,n=this._clips.length;n>i;i++)if(this._clips[i].step==this._currentStep){var s=this._clips[i];s.audio?s.audio.play(e,this._startOffset):s.process.start(s.args)}this._totalStep+=this._beatSubscription,this._currentStep+=this._beatSubscription},i.prototype.update=function(t,e){if(this._state!=g.Stopped&&t%this._beatSubscription==0)switch(this._state){case g.PrePlaying:if(-1!=this._activeUpbeat)for(var i=this._upbeats[this._activeUpbeat],n=0,s=i.clips.length;s>n;n++){var o=i.clips[n];o.step==i.length-this._stepCount&&(o.audio?o.audio.play(e):o.process.start(o.args))}this._stepCount-=this._beatSubscription,this._stepCount<=0&&(this._currentStep=this._startStep+this._syncStep%this._length,this._syncStep=0,this.changeState(g.Playing));break;case g.Playing:this.playStep(t,e);break;case g.PreStopping:this._stepCount-=this._beatSubscription,this._stepCount<=0?!this._tail||this._forceFade?this.stop(e,!1,this._fadeTime):(this.changeState(g.Stopped),this._currentStep=0):this.playStep(t,e);break;case g.PostStop:this.playStep(t,e),this._stepCount-=this._beatSubscription,this._stepCount<=0&&(this._forceFade=!1,this.changeState(g.Stopped),this._currentStep=0)}return this},i.prototype.deschedule=function(t){if(void 0==t&&(t=this._length),this._state!=g.Stopped){t%=this._length;for(var e=0,i=this._clips.length;i>e;e++){var n=this._clips[e];n.audio&&n.audio.deschedule()}if(clearTimeout(this._stoppingId),this._output.gain.cancelScheduledValues(U.now()),this._currentStep=this._currentStep-t,this._currentStep<this._startStep){var s=this._startStep-this._currentStep;this._currentStep=this._startStep+this._length-s}}return this},i.prototype.fadeInAndPlay=function(t,e){return this},i.prototype.fadeOutAndStop=function(t,e){return e=e||U.now(),this.stop(e,!1,t),this},i.prototype.curvePlaybackRate=function(t,e){for(var i=0,n=this._clips.length;n>i;i++)this._clips[i].audio.curvePlaybackRate(t,e);return this},i.prototype.getNextBar=function(t){var e=Math.ceil(this._currentStep/t);return this._currentStep>this._length-t&&(e=0),e},Object.defineProperty(i.prototype,"forceFade",{set:function(t){this._forceFade=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"playbackRate",{set:function(t){for(var e=0,i=this._clips.length;i>e;e++)this._clips[e].audio.playbackRate=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"length",{get:function(){return this._length},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"loop",{get:function(){return this._loop},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"playing",{get:function(){var t=!1;return(1===this._state||1===this._state)&&(t=!0),t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"duration",{get:function(){return this._length*this._sequencer.getNoteTime(1)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"playbackState",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"currentStep",{get:function(){return this._currentStep},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){e.prototype.setData.call(this,t);var i=!1;this._beatSubscription=void 0!=t.beat_subscription?t.beat_subscription:.25,this._length=void 0!=t.length?t.length:0,this._startStep=void 0!=t.start_step?t.start_step:0,this._loop=void 0==t.loop?!0:t.loop,this._tail=void 0==t.tail?!1:t.tail,void 0!=t.sequencer&&this._sequencerName!=t.sequencer&&(this._sequencerName=t.sequencer,i=!0),this._initData={dummyClips:null,dummyUpbeats:null},t.content&&(this._initData.dummyClips=t.content,this._clips=[],i=!0),t.upbeats&&(this._initData.dummyUpbeats=t.upbeats,this._upbeats=[],i=!0),i&&(this._sequencer.unregisterPattern(this),this.init())},i}(u);e.Pattern=y;var m=function(){function e(e){this.active=!0,this._type=e.type,this._input=void 0!=t.context.createGain?t.context.createGain():t.context.createGainNode(),this._output=void 0!=t.context.createGain?t.context.createGain():t.context.createGainNode(),e.active===!1&&(this.active=!1)}return e.prototype.connect=function(t){return this._output.connect(t),this},e.prototype.disconnect=function(){return this._output.disconnect(),this},e.prototype.setActive=function(e){return t.warn("Effect: Invocation of abstract method: Effect.setActive in",this),this},Object.defineProperty(e.prototype,"input",{get:function(){return this._input},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0}),e}();e.Effect=m;var v=function(e){function i(i){e.call(this,i),this._wet=t.context.createGain(),this._wet.gain.value=i.wet,this._input.connect(this._wet),this._input.connect(this._output),this.destinationName=i.destination_name,R.instance.pushToPreLoadInitStack(this)}return s(i,e),i.prototype.init=function(){var t=R.instance.findInstance(this.destinationName);t&&this._wet.connect(t.input)},i.prototype.setActive=function(t){return this._input.disconnect(),t?(this._input.connect(this._wet),this._input.connect(this._output)):this._input.connect(this._output),this},Object.defineProperty(i.prototype,"wet",{get:function(){return this._wet.gain},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){void 0!=t.wet&&(this.wet.value=t.wet),t.destination_name!=this.destinationName&&(this.destinationName=t.destination_name,this._wet.disconnect(),this.init())},i}(m);e.EffectSend=v;var b=function(e){function i(i){if(e.call(this,i),this._filters=[],"Firefox"==t.detector.browser.name)return void this._input.connect(this._output);if(0==i.bands.length)t.warn("Equalizer: No bands specified"),this._input.connect(this.output);else{for(var n=0,s=i.bands.length;s>n;n++){var o=i.bands[n],r=t.context.createBiquadFilter();o.filter_type&&(r.type=U.safeFilterType(o.filter_type)),o.frequency&&(r.frequency.value=o.frequency),o.gain&&(r.gain.value=o.gain),o.Q&&(r.Q.value=o.Q),0==n?this._input.connect(r):this._filters[n-1].connect(r),this._filters.push(r)}this._filters[this._filters.length-1].connect(this._output)}}return s(i,e),i.prototype.addFilter=function(e,i,n,s){var o=t.context.createBiquadFilter();o.type=e,o.frequency.value=i,o.gain.value=s,o.Q.value=n,0==this._filters.length?(this._input.disconnect(),this._input.connect(o)):(this._filters[this._filters.length-1].disconnect(),this._filters[this._filters.length-1].connect(o)),o.connect(this.output),this._filters.push(o)},i.prototype.removeFilter=function(t){this._filters[t].disconnect(),0==t&&this._filters.length>1?(this._input.disconnect(),this._input.connect(this._filters[1])):0==t?(this._input.disconnect(),this._input.connect(this._output)):t==this._filters.length-1?(this._filters[t-1].disconnect(),this._filters[t-1].connect(this._output)):(this._filters[t-1].disconnect(),this._filters[t-1].connect(this._filters[t+1])),this._filters.splice(t,1)},i.prototype.setActive=function(t){return this._input.disconnect(),t?0==this._filters.length?this._input.connect(this._output):this._input.connect(this._filters[0]):this._input.connect(this._output),this},Object.defineProperty(i.prototype,"filters",{get:function(){return this._filters},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){for(var e=0,i=this._filters.length;i>e;e++){var n=t.bands[e],s=this._filters[e];if(s&&n){s.frequency.value=n.frequency,s.Q.value=n.Q,s.gain.value=n.gain;var o=U.safeFilterType(n.filter_type);s.type!=o&&(s.type=o)}}},i}(m);e.Equalizer=b;var T=function(e){function i(i){e.call(this,i),this._filter=t.context.createBiquadFilter(),this._filter.type=U.safeFilterType(i.filter_type),this._input.connect(this._filter),this._filter.connect(this._output),this._filter.frequency.value=void 0!=i.frequency?i.frequency:1e3,this._filter.Q.value=void 0!=i.Q?i.Q:1,this._filter.gain.value=void 0!=i.gain?i.gain:0}return s(i,e),i.prototype.setActive=function(t){return this._input.disconnect(),t?this._input.connect(this._filter):this._input.connect(this._output),this},Object.defineProperty(i.prototype,"frequency",{get:function(){return this._filter.frequency},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"Q",{get:function(){return this._filter.Q},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"gain",{get:function(){return this._filter.gain},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){void 0==t.filter_type&&(t.filter_type="lowpass"),this._filter.type!=t.filter_type&&(this._filter.type=U.safeFilterType(t.filter_type)),this._filter.frequency.value=void 0==t.frequency?1e3:t.frequency,this._filter.Q.value=void 0==t.Q?1:t.Q,this._filter.gain.value=void 0==t.gain?0:t.gain},i}(m);e.BiquadFilter=T;var S=function(e){function i(i){e.call(this,i),this._pro=t.context.createScriptProcessor(i.buffer_size||4096,2,2);var n=this;this._pro.onaudioprocess=function(t){for(var e=t.inputBuffer,i=t.outputBuffer,s=e.getChannelData(0),o=e.getChannelData(1),r=i.getChannelData(0),a=i.getChannelData(1),u=Math.pow(.5,n._bits),c=e.length,h=0,l=0,p=0,_=0;c>_;++_)(h+=n._reduction)>=1&&(h--,l=u*Math.floor(s[_]/u),p=u*Math.floor(o[_]/u)),r[_]=l,a[_]=p},this._bits=i.bits||4,this._reduction=i.reduction||.2,this._input.connect(this._pro),this._pro.connect(this._output)}return s(i,e),i.prototype.setActive=function(t){return this._input.disconnect(),t?(this._input.connect(this._pro),this._input.connect(this._output)):this._input.connect(this._output),this},Object.defineProperty(i.prototype,"bits",{get:function(){return this._bits},set:function(t){this._bits=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"reduction",{get:function(){return this._reduction},set:function(t){this._reduction=t},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){this._bits=void 0!=t.bits?t.bits:4,this._reduction=void 0!=t.reduction?t.reduction:.2},i}(m);e.Bitcrusher=S;
var O=function(e){function i(i){return e.call(this,i),this._bypass=i.bypass,t.isMobile?void this._input.connect(this._output):(this._dynamicsCompressor=t.context.createDynamicsCompressor(),this._makeUpGain=t.context.createGain(),this._input.connect(this._dynamicsCompressor),this._dynamicsCompressor.connect(this._makeUpGain),this._makeUpGain.connect(this._output),this._bypass&&(this._input.connect(this._output),this._makeUpGain.gain.value=0),this._dynamicsCompressor.threshold.value=i.threshold||this._dynamicsCompressor.threshold.value,this._dynamicsCompressor.knee.value=i.knee||this._dynamicsCompressor.knee.value,this._dynamicsCompressor.ratio.value=i.ratio||this._dynamicsCompressor.ratio.value,this._dynamicsCompressor.attack.value=i.attack||this._dynamicsCompressor.attack.value,this._dynamicsCompressor.release.value=i.release||this._dynamicsCompressor.release.value,void(this._makeUpGain.gain.value=i.make_up_gain||this._makeUpGain.gain.value))}return s(i,e),i.prototype.setActive=function(t){return this._input.disconnect(),t?(this._input.connect(this._dynamicsCompressor),this._bypass&&this._input.connect(this._output)):this._input.connect(this._output),this},Object.defineProperty(i.prototype,"threshold",{get:function(){return this._dynamicsCompressor.threshold},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"knee",{get:function(){return this._dynamicsCompressor.knee},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"ratio",{get:function(){return this._dynamicsCompressor.ratio},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"attack",{get:function(){return this._dynamicsCompressor.attack},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"release",{get:function(){return this._dynamicsCompressor.release},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"reduction",{get:function(){return this._dynamicsCompressor.reduction},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"makeUpGain",{get:function(){return this._makeUpGain.gain},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){void 0!=t.threshold&&(this.threshold.value=t.threshold),void 0!=t.knee&&(this.knee.value=t.knee),void 0!=t.ratio&&(this.ratio.value=t.ratio),void 0!=t.attack&&(this.attack.value=t.attack),void 0!=t.release&&(this.release.value=t.release),void 0!=t.make_up_gain&&(this.makeUpGain.value=t.make_up_gain)},i}(m);e.Compressor=O;var P=function(e){function i(i){return e.call(this,i),t.isMobile?void this._input.connect(this._output):(this._soundName=i.sound,this._convolver=t.context.createConvolver(),this._wetGain=t.context.createGain(),this._dryGain=t.context.createGain(),this._wetGain.gain.value=1,this._dryGain.gain.value=0,this._wetGain.connect(this._convolver),this._dryGain.connect(this._output),this._input.connect(this._wetGain),this._input.connect(this._dryGain),this._convolver.connect(this._output),void R.instance.pushToPostLoadInitStack(this))}return s(i,e),i.prototype.dryWet=function(t){t=Math.max(0,Math.min(1,t)),this._wetGain.gain.value=t,this._dryGain.gain.value=1-t},i.prototype.setActive=function(t){return this._input.disconnect(),t?this._input.connect(this._convolver):this._input.connect(this._output),this},i.prototype.init=function(){var t=R.instance.findInstance(this._soundName);this._convolver.buffer=t.buffer},i.prototype.setData=function(t){t.sound&&t.sound!=this._soundName&&(this._soundName=t.sound,this.init())},i}(m);e.Convolver=P;var A=function(e){function i(t){e.call(this,t),this._sync=t.sync}return s(i,e),i.prototype.init=function(){if(this._sync){var t=R.instance.findInstance(this._sync);this.updateSync(t.bpm),t.registerBPMSync(this)}},i.prototype.setSync=function(t,e){return t?(this._sync=t,this._syncResolution=e||1,this.init()):(this._sync=null,this._syncResolution=null),this},i.prototype.setSyncRate=function(t){return this._sync&&(this._syncResolution=t,this.updateSync(R.instance.findInstance(this._sync).bpm)),this},i.prototype.updateSync=function(e){return t.warn("DelayBase: Invocation of abstract method: DelayBase.updateSync in",this),this},Object.defineProperty(i.prototype,"sync",{get:function(){return this._sync},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"syncResolution",{get:function(){return this._syncResolution},set:function(t){this._syncResolution=t},enumerable:!0,configurable:!0}),i}(m);e.DelayBase=A;var w=function(e){function i(i){e.call(this,i),this._feedback=t.context.createGain(),this._delay=t.context.createDelay(),i.filter?(this._filter=t.context.createBiquadFilter(),this._input.connect(this._filter),this._filter.connect(this._delay),this._filter.type=U.safeFilterType(i.filter.filter_type),this._filter.frequency.value=i.filter.frequency||1e3,this._filter.Q.value=i.filter.Q||4,this._filter.gain.value=i.filter.gain||1):this._input.connect(this._delay),this._delay.connect(this._feedback),this._delay.connect(this._output),this._feedback.connect(this._delay),this.sync?(R.instance.pushToPreLoadInitStack(this),this.syncResolution=i.delay_time||1):this._delay.delayTime.value=i.delay_time||.125,this._feedback.gain.value=i.feedback||.3,this._output.gain.value=i.output_vol||i.wet||1}return s(i,e),i.prototype.setActive=function(t){return this._input.disconnect(),t?this._input.connect(this._delay):this._input.connect(this._output),this},i.prototype.updateSync=function(t){return this._delay.delayTime.value=60/t*this.syncResolution,this},Object.defineProperty(i.prototype,"delayTime",{get:function(){return this._delay.delayTime},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"feedback",{get:function(){return this._feedback.gain},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"filter",{get:function(){return this._filter},enumerable:!0,configurable:!0}),i.prototype.setData=function(e){e.feedback&&(this._feedback.gain.value=e.feedback),e.sync?this.setSync(e.sync,e.delay_time):e.delay_time&&(this._delay.delayTime.value=e.delay_time),e.filter?(this._filter||(this.input.disconnect(),this._filter=t.context.createBiquadFilter(),this.input.connect(this._filter),this._filter.connect(this._delay)),void 0!=e.filter.filter_type&&(this._filter.type=U.safeFilterType(e.filter.filter_type)),void 0!=e.filter.frequency&&(this._filter.frequency.value=e.filter.frequency),void 0!=e.filter.Q&&(this._filter.Q.value=e.filter.Q),void 0!=e.filter.gain&&(this._filter.gain.value=e.filter.gain)):this._filter&&(this.input.disconnect(),this._filter.disconnect(),this.input.connect(this._delay),this._filter=null)},i}(A);e.Delay=w;var E=function(e){function i(i){return e.call(this,i),"Firefox"==t.detector.browser.name?void this._input.connect(this._output):(this._splitter=t.context.createChannelSplitter(2),this._merger=t.context.createChannelMerger(2),this._mono=t.context.createGain(),this._leftDelay=t.context.createDelay(),this._rightDelay=t.context.createDelay(),this._feedback=t.context.createGain(),i.filter?(this._filter=t.context.createBiquadFilter(),this._mono.connect(this._filter),this._filter.connect(this._leftDelay),this._feedback.connect(this._filter),this._filter.type=U.safeFilterType(i.filter.filter_type),this._filter.frequency.value=i.filter.frequency||1e3,this._filter.Q.value=i.filter.Q||4,this._filter.gain.value=i.filter.gain||1):(this._mono.connect(this._leftDelay),this._feedback.connect(this._leftDelay)),this._input.connect(this._splitter),this._splitter.connect(this._mono,0,0),this._splitter.connect(this._mono,1,0),this._leftDelay.connect(this._rightDelay),this._rightDelay.connect(this._feedback),this._leftDelay.connect(this._merger,0,0),this._rightDelay.connect(this._merger,0,1),this._merger.connect(this._output),this.sync?(R.instance.pushToPreLoadInitStack(this),this.syncResolution=i.delay_time||1):(this._leftDelay.delayTime.value=i.delay_time||.125,this._rightDelay.delayTime.value=this._leftDelay.delayTime.value),this._feedback.gain.value=i.feedback||.3,void(this._output.gain.value=i.output_vol||i.wet||1))}return s(i,e),i.prototype.setActive=function(t){return this._input.disconnect(),t?this._input.connect(this._splitter):this._input.connect(this._output),this},i.prototype.updateSync=function(t){return this._leftDelay.delayTime.value=60/t*this.syncResolution,this._rightDelay.delayTime.value=this._leftDelay.delayTime.value,this},Object.defineProperty(i.prototype,"delay_time",{set:function(t){this._leftDelay.delayTime.value=t,this._rightDelay.delayTime.value=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"feedback",{get:function(){return this._feedback.gain},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"filter",{get:function(){return this._filter},enumerable:!0,configurable:!0}),i.prototype.setData=function(e){e.feedback&&(this._feedback.gain.value=e.feedback),e.sync?this.setSync(e.sync,e.delay_time):e.delay_time&&(this._leftDelay.delayTime.value=e.delay_time,this._rightDelay.delayTime.value=e.delay_time),e.filter?(this._filter||(this._mono.disconnect(),this._feedback.disconnect(),this._filter=t.context.createBiquadFilter(),this._mono.connect(this._filter),this._filter.connect(this._leftDelay),this._feedback.connect(this._filter)),void 0!=e.filter.filter_type&&(this._filter.type=U.safeFilterType(e.filter.filter_type)),void 0!=e.filter.frequency&&(this._filter.frequency.value=e.filter.frequency),void 0!=e.filter.Q&&(this._filter.Q.value=e.filter.Q),void 0!=e.filter.gain&&(this._filter.gain.value=e.filter.gain)):this._filter&&(this._mono.disconnect(),this._feedback.disconnect(),this._filter.disconnect(),this._mono.connect(this._leftDelay),this._feedback.connect(this._leftDelay),this._filter=null)},i}(A);e.PingPongDelay=E;var k=function(e){function i(i){e.call(this,i),this.sync&&(i.left.sync=this.sync,i.right.sync=this.sync),this._splitter=t.context.createChannelSplitter(2),this._merger=t.context.createChannelMerger(2),this._leftDelay=new w(i.left||{}),this._rightDelay=new w(i.right||{}),this._input.connect(this._splitter),this._splitter.connect(this._leftDelay.input,0,0),this._splitter.connect(this._rightDelay.input,0,0),this._splitter.connect(this._rightDelay.input,1,0),this._leftDelay.output.connect(this._merger,0,0),this._rightDelay.output.connect(this._merger,0,1),this._merger.connect(this._output)}return s(i,e),i.prototype.setActive=function(t){return this._input.disconnect(),t?this._input.connect(this._splitter):this._input.connect(this._output),this},i.prototype.updateSync=function(t){return this._leftDelay.updateSync(t),this._rightDelay.updateSync(t),this},Object.defineProperty(i.prototype,"leftDelay",{get:function(){return this._leftDelay},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rightDelay",{get:function(){return this._rightDelay},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){this._leftDelay.setData(t.left),this._rightDelay.setData(t.right)},i}(A);e.StereoDelay=k;var F=function(e){function i(i){e.call(this,i),this._compressor=t.context.createDynamicsCompressor(),this._preGain=t.context.createGain(),this._postGain=t.context.createGain(),this._input.connect(this._preGain),this._preGain.connect(this._compressor),this._compressor.connect(this._postGain),this._postGain.connect(this._output),this._compressor.threshold.value=i.threshold||0,this._compressor.knee.value=0,this._compressor.ratio.value=100,this._compressor.attack.value=0,this._compressor.release.value=0,this._preGain.gain.value=void 0==i.pre_gain?1:i.pre_gain,this._postGain.gain.value=void 0==i.post_gain?1:i.post_gain}return s(i,e),i.prototype.setActive=function(t){return this._input.disconnect(),t?this._input.connect(this._preGain):this._input.connect(this._output),this},Object.defineProperty(i.prototype,"threshold",{get:function(){return this._compressor.threshold},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"preGain",{get:function(){return this._preGain.gain},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"postGain",{get:function(){return this._postGain.gain},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"reduction",{get:function(){return this._compressor.reduction},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){void 0!=t.threshold&&(this._compressor.threshold.value=t.threshold),void 0!=t.pre_gain&&(this._preGain.gain.value=t.pre_gain),void 0!=t.post_gain&&(this._postGain.gain.value=t.post_gain)},i}(m);e.Limiter=F;var x=function(e){function i(n){e.call(this,n),this._name=n.name,this._panner=t.context.createPanner(),this._input.connect(this._panner),this._panner.connect(this._output),void 0!=n.panning_model&&(this._panner.panningModel=n.panning_model),void 0!=n.distance_model&&(this._panner.distanceModel=n.distance_model),void 0!=n.ref_distance&&(this._panner.refDistance=n.ref_distance),void 0!=n.max_distance&&(this._panner.maxDistance=n.max_distance),void 0!=n.rolloff_factor&&(this._panner.rolloffFactor=n.rolloff_factor),void 0!=n.cone_inner_angle&&(this._panner.coneInnerAngle=n.cone_inner_angle),void 0!=n.cone_outer_angle&&(this._panner.coneOuterAngle=n.cone_outer_angle),void 0!=n.cone_outer_gain&&(this._panner.coneOuterGain=n.cone_outer_gain),void 0!=n.position&&this._panner.setPosition(n.position[0],n.position[1],n.position[2]),void 0!=n.orientation&&this._panner.setOrientation(n.position[0],n.position[1],n.position[2]),i.panners[this._name]=this}return s(i,e),i.panners={},i._scale=1,i.prototype.setActive=function(t){return this._input.disconnect(),t?this._input.connect(this._panner):this._input.connect(this._output),this},i.prototype.setPosition=function(t,e,n){this._panner.setPosition(t*i.scale,e*i.scale,n*i.scale)},i.prototype.setOrientation=function(t,e,i){this._panner.setOrientation(t,e,i)},i.prototype.setVelocity=function(e,i,n){t.warn("setVelocity is removed from Klang and the WebAudio API")},i.prototype.setData=function(t){this._panner.setPosition(t.position[0],t.position[1],t.position[2]),this._panner.setOrientation(t.position[0],t.position[1],t.position[2]),void 0!=t.panning_model&&(this._panner.panningModel=t.panning_model),void 0!=t.distance_model&&(this._panner.distanceModel=t.distance_model),void 0!=t.ref_distance&&(this._panner.refDistance=t.ref_distance),void 0!=t.max_distance&&(this._panner.maxDistance=t.max_distance),void 0!=t.rolloff_factor&&(this._panner.rolloffFactor=t.rolloff_factor),void 0!=t.cone_inner_angle&&(this._panner.coneInnerAngle=t.cone_inner_angle),void 0!=t.cone_outer_angle&&(this._panner.coneOuterAngle=t.cone_outer_angle),void 0!=t.cone_outer_gain&&(this._panner.coneOuterGain=t.cone_outer_gain)},Object.defineProperty(i,"listener",{get:function(){return t.context.listener},enumerable:!0,configurable:!0}),i.setListenerPosition=function(e,n,s){t.context.listener.setPosition(e*i.scale,n*i.scale,s*i.scale)},i.setListenerOrientation=function(e,i,n,s,o,r){t.context.listener.setOrientation(e,i,n,s,o,r)},i.setListenerVelocity=function(e,i,n){t.warn("setListenerVelocity is removed from Klang and the WebAudio API")},i.setDopplerFactor=function(e){t.warn("setDopplerFactor is removed from Klang and the WebAudio API")},i.setSpeedOfSound=function(e){t.context.listener.speed=e},i.setListenerData=function(t){t&&(i.scale=t.scale,i.setListenerPosition(t.position[0],t.position[1],t.position[2]),i.setListenerOrientation(t.orientation[0],t.orientation[1],t.orientation[2],t.orientation_up[0],t.orientation_up[1],t.orientation_up[2]),i.setSpeedOfSound(t.speed_of_sound))},i.get=function(t){return i.panners[t]},Object.defineProperty(i,"scale",{get:function(){return i._scale},set:function(t){i._scale=t},enumerable:!0,configurable:!0}),i}(m);e.Panner=x;var C=function(e){function i(i){e.call(this,i),this._source=i.source,this._gain=t.context.createGain(),this._processor=t.context.createScriptProcessor(i.buffer_size||0);var n=this;this._processor.onaudioprocess=function(){var t=n._source.reduction.value;n._gain.gain.value=0==t?1:Math.pow(10,t/20)},this._input.connect(this._gain),this._input.connect(this._processor),this._processor.connect(t.context.destination),this._gain.connect(this._output),R.instance.pushToPreLoadInitStack(this)}return s(i,e),i.prototype.init=function(){this._source&&this._source.bus&&void 0!=this._source.index||t.warn("Sidechain: No source specified");var e=R.instance.findInstance(this._source.bus);this._source=e._effects[this._source.index]},i.prototype.setActive=function(t){return this._input.disconnect(),t?(this._input.connect(this._gain),this._input.connect(this._processor)):this._input.connect(this._output),this},i}(m);e.Sidechain=C;var I=function(e){function i(i){e.call(this,i),this._splitter=t.context.createChannelSplitter(2),this._merger=t.context.createChannelMerger(2),this._left=t.context.createGain(),this._right=t.context.createGain(),this._input.connect(this._splitter),this._splitter.connect(this._left,0,0),this._splitter.connect(this._right,1,0),this._left.connect(this._merger,0,0),this._right.connect(this._merger,0,1),this._merger.connect(this._output),this.pan=i.pan}return s(i,e),i.prototype.setActive=function(t){return this._input.disconnect(),t?this._input.connect(this._splitter):this._input.connect(this._output),this},i.prototype.getGainValue=function(t){return(t+1)/2},i.prototype.setPanTo=function(t,e){var i=this.getGainValue(t);return this._left.gain.setValueAtTime(1-i,e||0),this._right.gain.setValueAtTime(i,e||0),this},i.prototype.linPanTo=function(e,i,n){n=n||t.context.currentTime;var s=this.getGainValue(e);return this._left.gain.setValueAtTime(this._left.gain.value,n),this._left.gain.linearRampToValueAtTime(1-s,t.context.currentTime+i),this._right.gain.setValueAtTime(this._right.gain.value,n),this._right.gain.linearRampToValueAtTime(s,t.context.currentTime+i),this},i.prototype.expPanTo=function(e,i,n){n=n||t.context.currentTime;var s=this.getGainValue(e);return this._left.gain.setValueAtTime(0==this._left.gain.value?U.EXP_MIN_VALUE:this._left.gain.value,n),this._left.gain.exponentialRampToValueAtTime(1-s,t.context.currentTime+i),this._right.gain.setValueAtTime(0==this._right.gain.value?U.EXP_MIN_VALUE:this._right.gain.value,n),this._right.gain.exponentialRampToValueAtTime(s,t.context.currentTime+i),this},Object.defineProperty(i.prototype,"pan",{get:function(){return this._right.gain.value},set:function(t){var e=this.getGainValue(t);this._left.gain.value=1-e,this._right.gain.value=e},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){void 0!=t.pan&&(this.pan=t.pan)},i}(m);e.StereoPanner=I;var V=function(e){function i(i,n){e.call(this,i),i.sync&&(this._sync=i.sync,this._rate=i.rate||.25),this._oscillator=t.context.createOscillator(),this._amplitude=t.context.createGain(),this._input.connect(this._output),this._oscillator.connect(this._amplitude),this._amplitude.connect(this._output.gain),this._oscillator.frequency.value=i.frequency||10,this._oscillator.type=i.wave||0,this._amplitude.gain.value=i.amplitude||1,this._oscillator.start(n),R.instance.pushToPreLoadInitStack(this)}return s(i,e),i.prototype.init=function(){if(this._sync){var t=R.instance.findInstance(this._sync);this.updateSync(t.bpm),t.registerBPMSync(this)}},i.prototype.setActive=function(t){return t?this._amplitude.connect(this._output.gain):this._amplitude.disconnect(),this},i.prototype.updateSync=function(t){return this._oscillator.frequency.value=t/60/this._rate,this},Object.defineProperty(i.prototype,"frequency",{get:function(){return this._oscillator.frequency},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"amplitude",{get:function(){return this._amplitude.gain},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){void 0!=t.amplitude&&(this.amplitude.value=t.amplitude),void 0!=t.wave&&(this._oscillator.type=t.wave),t.sync?(this._sync=t.sync,this._rate=t.rate||.25,this.init()):void 0!=t.frequency&&(this.frequency.value=t.frequency)},i}(m);e.Tremolo=V;var D=function(e){function i(i){e.call(this,i),this._samples=8192,this._distortionType=i.distortion_type||0,this._amount=i.amount||.7,this._samples=8192,this._waveshaper=t.context.createWaveShaper(),this._inputDrive=t.context.createGain(),this._outputDrive=t.context.createGain(),this._input.connect(this._inputDrive),this._inputDrive.connect(this._waveshaper),this._waveshaper.connect(this._outputDrive),this._outputDrive.connect(this._output),this._ws_table=new Float32Array(this._samples),this.createWSCurve(this._distortionType,this._amount),this._inputDrive.gain.value=i.drive||.5,this._outputDrive.gain.value=i.outputGain||.5}return s(i,e),i.prototype.createWSCurve=function(t,e){switch(t){case 0:var i,n,e=Math.min(e,.9999),s=2*e/(1-e);for(i=0;i<this._samples;i++)n=2*i/this._samples-1,this._ws_table[i]=(1+s)*n/(1+s*Math.abs(n));break;case 1:var i,n,o;for(i=0;i<this._samples;i++)n=2*i/this._samples-1,o=(.5*Math.pow(n+1.4,2)-1)*o>=0?5.8:1.2,this._ws_table[i]=this.tanh(o);break;case 2:var i,n,o,r=1-e;for(i=0;i<this._samples;i++)n=2*i/this._samples-1,o=0>n?-Math.pow(Math.abs(n),r+.04):Math.pow(n,r),this._ws_table[i]=this.tanh(2*o);break;case 3:var i,n,o,a,r=1-e>.99?.99:1-e;for(i=0;i<this._samples;i++)n=2*i/this._samples-1,a=Math.abs(n),r>a?o=a:a>r?o=r+(a-r)/(1+Math.pow((a-r)/(1-r),2)):a>1&&(o=a),this._ws_table[i]=this.sign(n)*o*(1/((r+1)/2));break;case 4:var i,n;for(i=0;i<this._samples;i++)n=2*i/this._samples-1,-.08905>n?this._ws_table[i]=-3/4*(1-Math.pow(1-(Math.abs(n)-.032857),12)+1/3*(Math.abs(n)-.032847))+.01:n>=-.08905&&.320018>n?this._ws_table[i]=-6.153*(n*n)+3.9375*n:this._ws_table[i]=.630035;break;case 5:var i,n,r=2+Math.round(14*e),u=Math.round(Math.pow(2,r-1));for(i=0;i<this._samples;i++)n=2*i/this._samples-1,this._ws_table[i]=Math.round(n*u)/u}this._waveshaper.curve=this._ws_table},i.prototype.tanh=function(t){return(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))},i.prototype.sign=function(t){return 0===t?1:Math.abs(t)/t},i.prototype.setActive=function(t){return this._input.disconnect(),t?this._input.connect(this._inputDrive):this._input.connect(this._output),this},Object.defineProperty(i.prototype,"amount",{get:function(){return this._amount},set:function(t){this._amount=t,this.createWSCurve(this._distortionType,this._amount)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"distortionType",{get:function(){return this._distortionType},set:function(t){this._distortionType=t,this.createWSCurve(this._distortionType,this._amount)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"drive",{get:function(){return this._inputDrive.gain},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"outputGain",{get:function(){return this._outputDrive.gain},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){void 0!=t.amount&&(this.amount=t.amount),void 0!=t.distortion_type&&(this.distortionType=t.distortion_type),void 0!=t.drive&&(this._inputDrive.gain.value=t.drive),void 0!=t.outputGain&&(this._outputDrive.gain.value=t.outputGain)},i}(m);e.Distortion=D;var M=function(){function e(e,i){i=i||0,this._targets=e.targets,this._sync=e.sync,this._rate=e.rate||1,this._phaseVal=e.phase||0,this._oscillator=t.context.createOscillator(),this._oscillator.type=e.wave||"sine",this._oscillator.frequency.value=this._rate,this._amplitude=t.context.createGain(),this._amplitude.gain.value=e.amplitude||1,this._phase=t.context.createDelay(),this._phase.delayTime.value=this._phaseVal*(1/this._oscillator.frequency.value),this._oscillator.connect(this._phase),this._phase.connect(this._amplitude),this._oscillator.start(i),R.instance.pushToPreLoadInitStack(this)}return e.prototype.init=function(){if(this._sync){var e=R.instance.findInstance(this._sync);this.updateSync(e.bpm),e.registerBPMSync(this)}for(var i=0,n=this._targets.length;n>i;i++){var s=this._targets[i],o=R.instance.findInstance(s.bus),r=o.effects[s.effect];r||t.warn("LFO: Effect index out of bounds: "+s.effect),r[s.param]||t.warn("LFO: Parameter not recognized: "+s.param),this._amplitude.connect(r[s.param])}},e.prototype.updateSync=function(t){return this._oscillator.frequency.value=t/60/this._rate,this._phase.delayTime.value=this._phaseVal*(1/this._oscillator.frequency.value),this},e.prototype.setData=function(t){this._oscillator.type=t.wave,this._oscillator.frequency.value=t.rate,this._phase.delayTime.value=t.phase*(1/this._oscillator.frequency.value),this._amplitude.gain.value=t.amplitude||1,t.targets&&(this._targets=t.targets,this.init()),this._sync!=t.sync&&(this._sync=t.sync,this.init())},e}();e.LFO=M;var N=function(){function e(e,i){this._arpCounter=0,this._arpNoteLength=.5,this._arpPattern=[],this._arpPatternStep=0,this._name=i,this._type=e.type,this._output=t.context.createGain(),this._output.gain.value=e.volume||1,e.destination_name&&(this.destinationName=e.destination_name,R.instance.initComplete||R.instance.pushToConnectStack(this)),e.arp?(this._arpMode=e.arp.arp_mode||"off",this._octaves=e.arp.octaves||1,this._sync=e.arp.sync,this._arpPattern=e.arp.arp_pattern||[]):this._arpMode="off",this._activeVoices=[],this._arpVoices=[],this._beatSubscription=e.beat_subscription||.25,this.data=e}return e.prototype.connect=function(t){return this._output.connect(t),this},e.prototype.disconnect=function(){return this._output.disconnect(),this},e.prototype.handleMidiEvent=function(e,i,n,s){return t.warn("Synth: Invocation of abstract method: Synth.handleMidiEvent in",this),this},e.prototype.stop=function(){t.warn("Synth: Invocation of abstract method: Synth.stop in",this)},e.prototype.handleArpModes=function(t){if(this._arpVoices=[],this._octaves>1){for(var e=[],i=0;i<this._octaves-1;i++)for(var n=0;n<this._activeVoices.length;n++){var s=this._activeVoices[n].midiEvent,o=s.noteNumber,r={type:"channel",subtype:s.subtype,noteNumber:o+=12*(i+1),velocity:s.velocity,deltaTime:s.deltaTime};e.push({midiEvent:r,transpose:this._activeVoices[n].transpose})}this._arpVoices=this._activeVoices.concat(e)}else this._arpVoices=this._activeVoices;if("up"===this._arpMode)this._arpVoices=this._arpVoices.sort(this.sortVoices);else if("down"===this._arpMode)this._arpVoices=this._arpVoices.sort(this.sortVoices),this._arpVoices.reverse();else if("up-down"===this._arpMode){var a=this._arpVoices.slice(0);a.sort(this.sortVoices);var u=this._arpVoices.slice(0);u.sort(this.sortVoices),u.reverse(),this._arpVoices=a.concat(u),this._arpVoices.length>1&&(this._arpVoices.splice(this._arpVoices.length/2,1),this._arpVoices.pop())}else"random"===this._arpMode&&(this._arpVoices=U.shuffle(this._arpVoices))},e.prototype.sortVoices=function(t,e){return t.midiEvent.noteNumber<e.midiEvent.noteNumber?-1:t.midiEvent.noteNumber>e.midiEvent.noteNumber?1:0},e.prototype.arpActive=function(t){if(t){if(this._sync){var e=R.instance.findInstance(this._sync);e.registerSynth(this),e._started||e.start()}}else if(this._arpMode="off",this._sync){var e=R.instance.findInstance(this._sync);e.unregisterSynth(this)}},e.prototype.update=function(t,e){if(t%this._beatSubscription==0){if(this._arpPatternStep=4*t%this._arpPattern.length,0===this._arpVoices.length)return;if(this._arpPattern.length&&!this._arpPattern[4*t%this._arpPattern.length])return;if(this._arpCounter++,this._arpCounter=this._arpCounter%this._arpVoices.length,this._arpCounter<this._arpVoices.length){var i=this._fixedVelocities?this._fixedVelocities[this._arpCounter]:this._arpVoices[this._arpCounter].midiEvent.velocity;this._arpVoices[this._arpCounter].midiEvent.velocity=i,this.handleMidiEvent(this._arpVoices[this._arpCounter].midiEvent,e,this._arpVoices[this._arpCounter].transpose,!0);var n={type:"channel",subtype:"noteOff",noteNumber:this._arpVoices[this._arpCounter].midiEvent.noteNumber,velocity:this._arpVoices[this._arpCounter].midiEvent.velocity,deltaTime:this._arpVoices[this._arpCounter].midiEvent.deltaTime};this.handleMidiEvent(n,e+this._arpNoteLength,this._arpVoices[this._arpCounter].transpose,!0)}}},e.prototype.deschedule=function(){return t.warn("Synth: Invocation of abstract method: Synth.deschedule in",this),this},Object.defineProperty(e.prototype,"arpCounter",{get:function(){return this._arpCounter},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"arpLength",{get:function(){return this._arpVoices.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"arpPattern",{get:function(){return this._arpPattern},set:function(t){this._arpPattern=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"arpPatternStep",{get:function(){return this._arpPatternStep},enumerable:!0,configurable:!0}),e.prototype.setData=function(t){if(void 0!=t.volume&&(this.output.gain.value=t.volume),this.destinationName!=t.destination_name&&(this.destinationName=t.destination_name,this.disconnect(),this.connect(R.instance.findInstance(this.destinationName).input)),t.arp){if(this._sync=t.arp.sync,this._octaves=t.arp.octaves,this._arpPattern=t.arp.arp_pattern,"off"==this._arpMode){var e=R.instance.findInstance(this._sync);e.registerSynth(this),e._started||e.start()}this._arpMode=t.arp.arp_mode}else if(this._arpMode="off",this._sync){var e=R.instance.findInstance(this._sync);e.unregisterSynth(this)}this.data=t},e}();e.Synth=N,e.generateNoiseBuffer=o;var L=function(){function e(e,i,n,s,o){this.filterStartFreq=-1,this._filterEnabled=!0,this.voiceType=i,this.active=!1,this.activatedNote=-1,this._enabled=!0,this._detune=e.detune||0,this._wave=e.wave||"sine",this._frames=e.frames,this._algorithm=e.algorithm,o&&(this._noiseBuffer=o),this.gain=t.context.createGain(),n||(n={frequency:22050,Q:1,filter_type:"lowpass"},this.filterEnabled=!1),this._filterData=n}return e.prototype.noteOn=function(e,i,n,s,o,r,a){if(this.enabled){if("custom"!==this._wave?(this.source=t.context.createOscillator(),this.source.type=this._wave,this.source.detune.value=this._detune):"custom"==this._wave&&(this.source=t.context.createBufferSource(),this.source.buffer=this._noiseBuffer,this.source.loop=!0),this._envelope=t.context.createGain(),this._filterData?(this.filter=t.context.createBiquadFilter(),this.filter.type=U.safeFilterType(this._filterData.filter_type),this.filter.frequency.value=void 0==this._filterData.frequency?U.NYQUIST_FREQUENCY:this._filterData.frequency,this.filter.detune&&(this.filter.detune.value=this._filterData.detune||0),this.filter.Q.value=this._filterData.Q||this.filter.Q,this.filter.gain.value=this._filterData.gain||this.filter.gain,this.filterTargetFreq=this.filter.frequency.value,this.source.connect(this.filter),this.filter.connect(this._envelope),this._envelope.connect(this.gain)):(this.source.connect(this._envelope),this._envelope.connect(this.gain)),1==this.voiceType&&this.filterAmplitudeGainNode.connect(this.filter.frequency),n<U.now()&&(n=U.now()),this.active=!0,this.activatedNote=e,"custom"!==this._wave){var u=U.midiNoteToFrequency(e+a);if(r){var c=-1;r.contour>0?c=u*(1-r.contour):r.contour<0&&(c=(U.NYQUIST_FREQUENCY-u)*-r.contour+u),this.source.frequency.cancelScheduledValues(n),-1!=c?(this.source.frequency.setValueAtTime(c,n),t.safari?this.source.frequency.setTargetValueAtTime(u,n,r.decay||1e-4):this.source.frequency.setTargetAtTime(u,n,r.decay||1e-4)):this.source.frequency.setValueAtTime(u,n)}else this.source.frequency.setValueAtTime(u,n)}o&&(this.filterStartFreq=-1,o.contour<0?this.filterStartFreq=this.filterTargetFreq*(1+o.contour)+1:o.contour>0&&(this.filterStartFreq=(U.NYQUIST_FREQUENCY-this.filterTargetFreq)*o.contour+this.filterTargetFreq),-1!=this.filterStartFreq&&(this.filter.frequency.cancelScheduledValues(n),this.filter.frequency.setValueAtTime(this.filterStartFreq,n),this.filter.frequency.exponentialRampToValueAtTime(this.filterTargetFreq,n+o.attack),t.safari?this.filter.frequency.setTargetValueAtTime(this.filterTargetFreq*o.sustain,n+o.attack,o.decay||1e-4):this.filter.frequency.setTargetAtTime(this.filterTargetFreq*o.sustain,n+o.attack,o.decay||1e-4)));var h;h="linear"===s.volumeCurve?i/128:"exponential"===s.volumeCurve?Math.abs(1-Math.exp(i/128)):1,s?(this._envelope.gain.setValueAtTime(0,n),
this._envelope.gain.linearRampToValueAtTime(h,n+s.attack),t.safari?this._envelope.gain.setTargetValueAtTime(h*s.sustain,n+s.attack,s.decay||1e-4):this._envelope.gain.setTargetAtTime(h*s.sustain,n+s.attack,s.decay||1e-4)):this._envelope.gain.setValueAtTime(h,n),this.source.startTime=n,t.safari?this.source.noteOn(n):this.source.start(n)}},e.prototype.noteOff=function(e,i,n,s){if(this.enabled){if(i<U.now()&&(i=U.now()),this.active=!1,s&&-1!=this.filterStartFreq){var o=this.filter.frequency.value;this.filter.frequency.cancelScheduledValues(i),this.filter.frequency.setValueAtTime(o,i),t.safari?this.filter.frequency.setTargetValueAtTime(this.filterStartFreq,i,s.release):this.filter.frequency.setTargetAtTime(this.filterStartFreq,i,s.release)}n?(this._envelope.gain.cancelScheduledValues(i),i!=U.now()?this._envelope.gain.setValueAtTime(n.sustain,i):this._envelope.gain.setValueAtTime(this._envelope.gain.value,i),t.safari?this._envelope.gain.setTargetValueAtTime(0,i,n.release):this._envelope.gain.setTargetAtTime(0,i,n.release)):this._envelope.gain.setValueAtTime(0,i),this.source.offTime=i,t.safari?this.source.noteOff(i+5*n.release):this.source.stop(i+5*n.release)}},e.prototype.stop=function(){this.filter.frequency.cancelScheduledValues(0),this._envelope.gain.cancelScheduledValues(0),this._envelope.gain.setValueAtTime(0,0),t.safari?this.source.noteOff(0):this.source.stop(0),this.source.disconnect(),this.filter&&this.filter.disconnect(),this._envelope&&this._envelope.disconnect()},e.prototype.stopSoft=function(e,i,n){this.active=!1,this._envelope.gain.cancelScheduledValues(e),t.safari?this._envelope.gain.setTargetValueAtTime(0,e,i.release):this._envelope.gain.setTargetAtTime(0,e,i.release);var s=e+5*i.release;t.safari?this.source.noteOff(s):this.source.stop(s);var o=this;setTimeout(function(){o.source.disconnect(),o.filter&&o.filter.disconnect(),o._envelope&&o._envelope.disconnect()},1e3*(s-U.now()))},Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(t){this._enabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"filterEnabled",{get:function(){return this._filterEnabled},set:function(t){this._filterEnabled=t,this.source&&(t?(this.source.disconnect(),this.source.connect(this.filter),this.filter.connect(this._envelope)):(this.source.disconnect(),this.filter.disconnect(),this.source.connect(this._envelope)))},enumerable:!0,configurable:!0}),e}(),j=function(){function e(e,i,n,s){this._enabled=!0,this.nextVoice=0,this.octave=e.octave||0,this.output=t.context.createGain(),this.output.gain.value=void 0==e.volume?1:e.volume,this._data=e,this._poly=i,this._filterData=n,this.voices=[],this._noiseBuffer=o(this._data._frames,this._data._algorithm)}return e.prototype.noteOn=function(t,e,i,n,s,o,r){if(this.enabled){this.voices.length==this._poly&&(this.voices[0].noteOff(t,i,n,s),this.voices.splice(0,1)),t+=12*this.octave;var a;a="custom"==this._data.wave?new L(this._data,0,this._filterData,i,this._noiseBuffer):new L(this._data,0,this._filterData,i,null),a.gain.connect(this.output),a.noteOn(t,e,i,n,s,o,r),this.lfoPitchGainNode&&"custom"!=this._data.wave&&this.lfoPitchGainNode.connect(a.source.frequency),this.filterAmplitude&&a.filter&&this.filterAmplitude.connect(a.filter.frequency),this.voices.push(a)}},e.prototype.noteOff=function(t,e,i,n){if(this.enabled){t+=12*this.octave;for(var s=0;s<this.voices.length;s++)if(this.voices[s].active&&this.voices[s].activatedNote==t){this.voices[s].noteOff(t,e,i,n),this.voices.splice(s,1);break}}},e.prototype.stopSoft=function(t,e,i){for(var n=0;n<this.voices.length;n++)this.voices[n].stopSoft(t,e,i);this.voices=[]},e.prototype.stop=function(){for(var t=0,e=this.voices.length;e>t;t++)this.voices[t].stop();this.voices=[]},e.prototype.deschedule=function(){for(var e=0,i=this.voices.length;i>e;e++)if(this.voices[e]){var n=this.voices[e].source;(1==n.playbackState||n.startTime>t.context.currentTime)&&(this.voices[e].stop(),this.voices.splice(e,1),e--)}},e.prototype.setDetune=function(t,e){if(this._data){this._data.detune=t;for(var i=0,n=this.voices.length;n>i;i++)this.voices[i].source.detune.setValueAtTime(t,e)}},Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(t){this._enabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"detune",{get:function(){return this._detune},enumerable:!0,configurable:!0}),e}(),q=function(){function e(e,i){this.osc=t.context.createOscillator(),this.phaseDelay=t.context.createDelay(),this.osc.type=e.wave||"sine",this.osc.frequency.value=e.rate||1,this.phase=e.phase||0,this.phaseDelay.delayTime.value=this.phase*(1/this.osc.frequency.value),this.sync=e.sync,this.syncResolution=e.rate,this.osc.connect(this.phaseDelay),this.oscVolumeAmplitude=t.context.createGain(),this.oscVolumeAmplitude.gain.value=e.osc_volume_amount,this.phaseDelay.connect(this.oscVolumeAmplitude),this.pitchAmplitude=t.context.createGain(),this.pitchAmplitude.gain.value=e.pitch_amount,this.phaseDelay.connect(this.pitchAmplitude),this.filterAmplitude=t.context.createGain(),this.filterAmplitude.gain.value=e.filter_amount,this.phaseDelay.connect(this.filterAmplitude),t.safari?this.osc.noteOn(i):this.osc.start(i)}return e.prototype.updateSync=function(t){return this.osc.frequency.value=t/60/this.syncResolution,this.phaseDelay.delayTime.value=this.phase*(1/this.osc.frequency.value),this},e}(),G=function(e){function i(i,n){e.call(this,i,n),this.bendRange=400;var s=t.context.currentTime+U.OSC_START_DELAY;this._gainEG=i.gain_eg,this._filterEG=i.filter_eg,this._pitchEG=i.pitch_eg;var o=0;i.oscillators[0]||(i.oscillators.push({wave:"sine",detune:0,volume:1,octave:0}),o++),i.oscillators[1]||(i.oscillators.push({wave:"sine",detune:0,volume:1,octave:0}),o++),this._oscs=[],this._poly=i.poly;for(var r=0,a=i.oscillators.length;a>r;r++){var u=new j(i.oscillators[r],i.poly,i.filter,s);u.output.connect(this.output),this._oscs.push(u)}if(1==o?this._oscs[1].enabled=!1:2==o&&(this._oscs[0].enabled=!1,this._oscs[1].enabled=!1),i.LFO||(i.LFO={wave:"sine",rate:1,phase:0,osc_volume_amount:0,noise_volume_amount:0,pitch_amount:0,filter_amount:0}),i.LFO){this._LFO=new q(i.LFO,s);for(var r=0,a=this._oscs.length;a>r;r++){var c=this._oscs[r];this._LFO.oscVolumeAmplitude&&this._LFO.oscVolumeAmplitude.connect(c.output.gain),this._LFO.pitchAmplitude&&(c.lfoPitchGainNode=this._LFO.pitchAmplitude),this._LFO.filterAmplitude&&(c.filterAmplitude=this._LFO.filterAmplitude)}this._LFO.sync&&R.instance.pushToPreLoadInitStack(this)}this._sync&&R.instance.pushToPreLoadInitStack(this)}return s(i,e),i.prototype.init=function(){if(this._LFO&&this._LFO.sync){var t=R.instance.findInstance(this._LFO.sync);this._LFO.updateSync(t.bpm),t.registerBPMSync(this._LFO)}if(this._sync){var t=R.instance.findInstance(this._sync);t.registerSynth(this),t.started||t.start()}},i.prototype.handleMidiEvent=function(e,i,n,s){if(i=i||t.context.currentTime,s=s||!1,n=n||0,"channel"==e.type)if("noteOn"==e.subtype){if("off"!=this._arpMode&&!s)return this._activeVoices.push({midiEvent:e,transpose:n}),void this.handleArpModes(e);for(var o=0,r=this._oscs.length;r>o;o++)this._oscs[o].noteOn(e.noteNumber,e.velocity,i,this._gainEG,this._filterEG,this._pitchEG,n)}else if("noteOff"==e.subtype){if("off"!=this._arpMode&&!s){for(var a=0;a<this._activeVoices.length;a++)e.noteNumber===this._activeVoices[a].midiEvent.noteNumber&&this._activeVoices.splice(a,1);return void this.handleArpModes(e)}for(var o=0,r=this._oscs.length;r>o;o++)this._oscs[o].noteOff(e.noteNumber,i,this._gainEG,this._filterEG)}else if("pitchBend"==e.subtype){var u;void 0!=e.value?u=e.value:void 0!=e.velocity&&(u=e.velocity);for(var c=(u-8192)/16384*this.bendRange,a=0;a<this._oscs.length;a++)this._oscs[a].setDetune(c,i)}return this},i.prototype.glideTo=function(t,e,i,n){var s=U.now();e=e||s,void 0==i&&(i=.5),n=n||0;for(var o=0,r=this._oscs.length;r>o;o++)for(var a=this._oscs[o],u=Math.min(t.length,a.voices.length),c=0;u>c;c++){var h=a.voices[c],l=U.midiNoteToFrequency(t[c]+n+12*a.octave);h.source.frequency&&(h.source.frequency.cancelScheduledValues(s),h.source.frequency.setValueAtTime(h.source.frequency.value,e),h.source.frequency.linearRampToValueAtTime(l,e+i))}return this},i.prototype.stop=function(t){t=t||U.now();for(var e=0,i=this._oscs.length;i>e;e++)this._oscs[e].stopSoft(t,this._gainEG,this._filterEG);this._activeVoices.length&&(this._activeVoices=[]),this._arpVoices=[]},i.prototype.deschedule=function(){for(var t=0,e=this._oscs.length;e>t;t++)this._oscs[t].deschedule();return this},Object.defineProperty(i.prototype,"filterFrequency",{set:function(t){for(var e=0,i=this._oscs.length;i>e;e++){var n=this._oscs[e];n._filterData.frequency=t;for(var s=0,o=n.voices.length;o>s;s++){var r=n.voices[s];r.filterTargetFreq=t,this._filterEG&&0!=this._filterEG.contour||(r.filter.frequency.value=t)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"filterQ",{set:function(t){for(var e=0,i=this._oscs.length;i>e;e++){var n=this._oscs[e];n._filterData.Q=t;for(var s=0,o=n.voices.length;o>s;s++){var r=n.voices[s];r.filterTargetFreq=t,this._filterEG&&0!=this._filterEG.contour||(r.filter.Q.value=t)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"filterType",{set:function(t){for(var e=0,i=this._oscs.length;i>e;e++){var n=this._oscs[e];n._filterData.filter_type=t;for(var s=0,o=n.voices.length;o>s;s++){var r=n.voices[s];r.filter.type=t}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"osc1Wave",{set:function(t){var e=this._oscs[0];e._data.wave=t;for(var i=0,n=e.voices.length;n>i;i++){var s=e.voices[i];s.source.type&&"4"!==t&&(s.source.type=t)}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"osc1Vol",{set:function(t){var e=this._oscs[0];e.output.gain.value=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"osc1Detune",{set:function(t){var e=this._oscs[0];e._detune=t;for(var i=0,n=e.voices.length;n>i;i++){var s=e.voices[i];s.source.detune&&(s.source.detune.value=t)}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"osc1Octave",{set:function(t){var e=this._oscs[0];e.octave=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"osc2Wave",{set:function(t){if(!(this._oscs.length<2)){var e=this._oscs[1];e._data.wave=t;for(var i=0,n=e.voices.length;n>i;i++){var s=e.voices[i];s.source.type&&"4"!==t&&(s.source.type=t)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"osc2Vol",{set:function(t){if(!(this._oscs.length<2)){var e=this._oscs[1];e.output.gain.value=t}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"osc2Detune",{set:function(t){if(!(this._oscs.length<2)){var e=this._oscs[1];e._detune=t;for(var i=0,n=e.voices.length;n>i;i++){var s=e.voices[i];s.source.detune&&(s.source.detune.value=t)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"osc2Octave",{set:function(t){if(!(this._oscs.length<2)){var e=this._oscs[1];e.octave=t}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pitchDecay",{set:function(t){this._pitchEG&&(this._pitchEG.decay=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pitchContour",{set:function(t){this._pitchEG&&(this._pitchEG.contour=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lfoWave",{set:function(t){this._LFO&&(this._LFO.osc.type=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lfoRate",{set:function(t){this._LFO&&(this._LFO.osc.frequency.value=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lfoPhase",{set:function(t){this._LFO&&(this._LFO.phase=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lfoOscVol",{set:function(t){this._LFO&&(this._LFO.oscVolumeAmplitude.gain.value=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lfoPitch",{set:function(t){this._LFO&&(this._LFO.pitchAmplitude.gain.value=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lfoFilter",{set:function(t){this._LFO&&(this._LFO.filterAmplitude.gain.value=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"arpMode",{set:function(t){this._arpMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"arpOctaves",{set:function(t){this._octaves=t},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){e.prototype.setData.call(this,t),this._poly=t.poly,this._gainEG=t.gain_eg?t.gain_eg:void 0,this._filterEG=t.filter_eg?t.filter_eg:void 0,this._pitchEG=t.pitch_eg?t.pitch_eg:void 0,this._oscs[0].enabled=t.oscillators[0]?!0:!1,this._oscs[1].enabled=t.oscillators[1]?!0:!1;for(var i=0,n=this._oscs.length;n>i;i++){var s=this._oscs[i];s._data=t.oscillators[i],s._filterData=t.filter,s._poly=this._poly;for(var o=0,r=s.voices.length;r>o;o++){var a=s.voices[o];t.filter?(a.filterEnabled||(a.filterEnabled=!0),this._filterEG&&0!=this._filterEG.contour||(a.filter.frequency.value=t.filter.frequency),a.filter.Q.value=t.filter.Q,a.filterTargetFreq=t.filter.frequency,a.filter.type=t.filter.filter_type):a.filterEnabled&&(a.filterEnabled=!1),t.oscillators&&t.oscillators[i]&&0==a.voiceType&&(a.source.type&&4!==t.oscillators[0].wave&&(a.source.type=t.oscillators[i].wave),a.source.detune&&(a.source.detune.value=t.oscillators[i].detune))}t.oscillators[i]&&(s.output.gain.value=t.oscillators[i].volume,s.octave=t.oscillators[i].octave)}t.LFO?(this._LFO.osc.type=t.LFO.wave,this._LFO.osc.frequency.value=t.LFO.rate,this._LFO.phase=t.LFO.phase,this._LFO.phaseDelay.delayTime.value=t.LFO.phase*(1/this._LFO.osc.frequency.value),this._LFO.oscVolumeAmplitude.gain.value=t.LFO.osc_volume_amount,this._LFO.pitchAmplitude.gain.value=t.LFO.pitch_amount,this._LFO.filterAmplitude.gain.value=t.LFO.filter_amount):(this._LFO.oscVolumeAmplitude.gain.value=0,this._LFO.pitchAmplitude.gain.value=0,this._LFO.filterAmplitude.gain.value=0)},i}(N);e.Symple=G;var B=function(i){function n(t,e){i.call(this,t,e),this._content=[],this._playingVoices=[],this._allVoices=[],this._hasNoteOffSamples=!1,this._hasSustainOnSamples=!1,this._hasSustainOffSamples=!1,this._pitchBendRange=.25,this._pedalOnTime=-1,this._sustained=[],this._maxNotes=20,this._stopFactor=5,this._content=t.content,this._volumeCurve=t.volume_curve||"none",this._gainEG=t.eg_gain||{attack:0,decay:0,sustain:1,release:.005},this._currentPitch=1,R.instance.pushToPreLoadInitStack(this)}return s(n,i),n.prototype.init=function(){this._envelope=t.context.createGain();for(var e=0,i=this._content.length;i>e;e++){"noteOff"===this._content[e].value&&(this._hasNoteOffSamples=!0),"sustainOn"===this._content[e].value&&(this._hasSustainOnSamples=!0),"sustainOff"===this._content[e].value&&(this._hasSustainOffSamples=!0);for(var n=0;n<this._content[e].samples.length;n++)this._content[e].samples[n].source=R.instance.findInstance(this._content[e].samples[n].source),this._content[e].samples[n].source||t.warn("SamplePlayer: audio source not found"),this._content[e].samples[n].source._parentType="SamplePlayer",this._content[e].samples[n].source.loop&&(this._loopedSamples=!0)}if(this._sync){var s=R.instance.findInstance(this._sync);s.registerSynth(this),!s.started}},n.prototype.handleMidiEvent=function(t,e,i,n){if(e=e||U.now(),n=n||!1,i=i||0,"channel"==t.type)if("noteOn"==t.subtype){if("off"!=this._arpMode&&!n)return this._activeVoices.push({midiEvent:t,transpose:i}),void this.handleArpModes(t);this.noteOn(e,t.noteNumber,i,t.velocity,t.subtype),this._callback&&this._callback(t,e)}else if("noteOff"==t.subtype){if("off"!=this._arpMode&&!n){for(var s=0;s<this._activeVoices.length;s++)t.noteNumber===this._activeVoices[s].midiEvent.noteNumber&&this._activeVoices.splice(s,1);return void this.handleArpModes(t)}this.noteOff(e,t.noteNumber,t.velocity,t.subtype),this._callback&&this._callback(t,e)}else if("pitchBend"==t.subtype){var o=t.value;this._currentPitch=1+(o-64)/127;for(var s=0;s<this._playingVoices.length;s++)this._playingVoices[s].source.playbackRateNode.setValueAtTime(this._currentPitch,e)}else if("controller"==t.subtype){var r=t.controllerType||t.noteNumber,a=void 0==t.value?t.velocity:t.value;switch(r){case 1:break;case 64:64>a?(this.pedalRelease(e),e>this._pedalOnTime&&(this._pedalOnTime=-1),this._hasSustainOffSamples&&this.noteOn(e,0,0,127,"sustainOff")):a>64&&(this._pedalOnTime=e,this._hasSustainOnSamples&&this.noteOn(e,0,0,127,"sustainOn"))}}return this},n.prototype.noteOn=function(t,i,n,s,o,r){for(var a=0;a<this._allVoices.length;a++){var u=this._allVoices[a];(0==u.source._sources.length||3==u.source.lastSource.playbackState)&&(this._allVoices.splice(a,1),a--)}var c=this.getNote(i+n,s,o),h=U.midiNoteToFrequency(i+n),l=U.midiNoteToFrequency(c.root),p=h/l;-1===c.root&&(p=1);var _=new e.AudioSource(c.source.data,i.toString());if("noteOn"===o){var f={source:_,time:t,velocity:s,note:i,transpose:n};this._playingVoices.push(f),this._allVoices.push(f)}this.destinationName?_.connect(R.instance.findInstance(this.destinationName).input):_.connect(R.instance.findInstance(_.destinationName).input),t=t<U.now()?U.now():t;var d=0;r?d=r*s/128:"linear"===this._volumeCurve?d=s/128:"exponential"===this._volumeCurve?d=Math.abs(1-Math.exp(s/128)):"none"===this._volumeCurve&&(d=1),d*=_.output.gain.value,_.output.gain.cancelScheduledValues(t),_.nextPlaybackRate=p*this._currentPitch,_.play(t),_.output.gain.setValueAtTime(0,t),_.output.gain.linearRampToValueAtTime(d,t+this._gainEG.attack),_.output.gain.setTargetAtTime?_.output.gain.setTargetAtTime(d*this._gainEG.sustain,t+this._gainEG.attack,this._gainEG.decay||1e-4):_.output.gain.setTargetValueAtTime&&_.output.gain.setTargetValueAtTime(d*this._gainEG.sustain,t+this._gainEG.attack,this._gainEG.decay||1e-4)},n.prototype.adsr=function(t,e,i,n){var s=this._gainEG;return 0===arguments.length?{attack:s.attack,decay:s.decay,sustain:s.sustain,release:s.release}:(s.attack=void 0===arguments[0]?s.attack:arguments[0],s.decay=void 0===arguments[1]?s.decay:arguments[1],s.sustain=void 0===arguments[2]?s.sustain:arguments[2],s.release=void 0===arguments[3]?s.release:arguments[3],this)},n.prototype.noteOff=function(e,i,n,s){for(var o=(this.getNote(i,n,"noteOn"),0);o<this._playingVoices.length;o++)if(!i||i.toString()===this._playingVoices[o].source._name)if(e>this._pedalOnTime&&this._pedalOnTime>0)this._sustained.length>this._maxNotes&&(this._sustained[0].source.stop(e+this._gainEG.release*this._stopFactor),this._sustained.splice(0,1)),this._sustained.push(this._playingVoices[o]),this._playingVoices.splice(o,1);else{e<U.now()&&(e=U.now());var r=this._playingVoices[o].source.output.gain.value;if(this._playingVoices[o].source.output.gain.cancelScheduledValues(e),e!=U.now()||"Firefox"==t.detector.browser.name?this._playingVoices[o].source.output.gain.setValueAtTime(this._gainEG.sustain,e):this._playingVoices[o].source.output.gain.setValueAtTime(r,e),this._playingVoices[o].source.stop(e+this._gainEG.release*this._stopFactor),this._playingVoices[o].source.output.gain.setTargetAtTime(0,e,this._gainEG.release),this._hasNoteOffSamples){var a=U.now()-this._playingVoices[o].time,u=Math.min(Math.exp(-a)/3,1);this.noteOn(e,i,this._playingVoices[o].transpose,this._playingVoices[o].velocity,s,u)}this._playingVoices.splice(o,1)}},n.prototype.stop=function(t){var t=t||U.now();this.pedalRelease(t);for(var e=0;e<this._playingVoices.length;e++){t<U.now()&&(t=U.now());var i=this._playingVoices[e].source.output.gain.value;this._playingVoices[e].source.output.gain.cancelScheduledValues(t),this._playingVoices[e].source.output.gain.setValueAtTime(i,t),this._playingVoices[e].source.stop(t+this._gainEG.release*this._stopFactor),this._playingVoices[e].source.output.gain.setTargetAtTime(0,t,this._gainEG.release)}return this._playingVoices=[],this._arpVoices=[],this},n.prototype.deschedule=function(){for(var t=0;t<this._allVoices.length;t++)this._allVoices[t].source.deschedule();return this},n.prototype.pedalRelease=function(e){for(var i=0;i<this._sustained.length;i++)if(e<U.now()&&(e=U.now()),"Firefox"!=t.detector.browser.name){if(this._sustained[i].source.output.gain.setTargetAtTime(0,e,this._gainEG.release),this._hasNoteOffSamples){var n=U.now()-this._sustained[i].time,s=Math.min(Math.exp(-n)/3,1);this.noteOn(e,this._sustained[i].note,this._sustained[i].transpose,this._sustained[i].velocity,"noteOff",s)}}else this._sustained[i].source.output.gain.linearRampToValueAtTime(0,e+.3),this._sustained[i].source.stop(e+this._gainEG.release*this._stopFactor);this._sustained=[]},n.prototype.getNote=function(t,e,i){var n=0;for(this._content[n].value||"noteOn";e>this._content[n].highVelocity||i!==this._content[n].value;)n++;for(var s=n,o=0;t<this._content[s].samples[o].startRange||t>this._content[s].samples[o].endRange;)o++;return this._content[s].samples[o]},Object.defineProperty(n.prototype,"content",{get:function(){return this._content},set:function(t){this._content=t,this.init()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"callbackFunction",{set:function(t){this._callback=t},enumerable:!0,configurable:!0}),n.prototype.setData=function(t){i.prototype.setData.call(this,t),t.eg_gain&&(this._gainEG=t.eg_gain),t.content&&(this._content=t.content,this.init()),t.volumeCurve&&(this._volumeCurve=t.volumeCurve)},n}(N);e.SamplePlayer=B,function(t){t._map=[],t._map[0]="Restart",t.Restart=0,t._map[1]="Playing",t.Playing=1,t._map[2]="All",t.All=2,t._map[3]="Continue",t.Continue=3}(e.SyncType||(e.SyncType={}));var H=e.SyncType,Q=function(e){function i(t,i){e.call(this),this._scheduler=null,this._started=!1,this._bpm=120,this._barLength=4,this._beatLength=1,this._resolution=.25,this._currentStep=0,this._paused=!1,this._maxSwing=.08,this._swingFactor=0,this._lastBeat=-1,this._name=i,this._type=t.type,this._bpm=t.bpm||120,this._barLength=t.bar_length||4,this._beatLength=t.beat_length||1,this._registeredPatterns=[],this._registeredSynths=[],this._syncHandler=new z,this._syncedObjects=[],this._swingFactor=t.swing_factor||0,R.instance.pushToPreLoadInitStack(this)}return s(i,e),i.prototype.init=function(){this._lookahead=R.settings.sequencer_lookahead||50,this._scheduleAheadTime=R.settings.sequencer_schedule_ahead||.2,t.isIOS&&(this._scheduleAheadTime=R.settings.sequencer_schedule_ahead_ios||5),this._resolution=R.settings.sequencer_resolution||.25},i.prototype.startScheduler=function(){if(!this._paused&&0!==t.context.currentTime)for(this._lastScheduleLoopTime=t.context.currentTime;this._scheduleTime<t.context.currentTime+this._scheduleAheadTime;){for(var e=0,i=this._registeredPatterns.length;i>e;e++)this._registeredPatterns[e].update(this._currentStep,this._scheduleTime);for(var n=0,i=this._registeredSynths.length;i>n;n++)this._registeredSynths[n].update(this._currentStep,this._scheduleTime);var s=this.currentStep,o=Math.floor(s);o!==this._lastBeat&&this.trigger("beforeNextBeat",o,this.getBeatTime(0)-this._scheduleTime,this._scheduleTime),this._lastBeat=o,this.trigger("progress",this._currentStep,this.getBeatTime(0)-this._scheduleTime,this._scheduleTime),this._currentStep+=this._resolution,this._syncHandler.update(this._resolution),this._swingFactor>0?4*this._currentStep%2?this._scheduleTime+=(.25+this._maxSwing*this._swingFactor)*(60/this._bpm):this._scheduleTime+=(.25-this._maxSwing*this._swingFactor)*(60/this._bpm):this._scheduleTime+=60/this._bpm*this._resolution}var r=this;this._scheduler=setTimeout(function(){r.startScheduler()},r._lookahead)},i.prototype.start=function(){return this._started=!0,this._scheduleTime=t.context.currentTime,this._scheduleAheadTime<=.2&&(this._scheduleTime+=.3),clearTimeout(this._scheduler),this.startScheduler(),R.callbacks&&R.callbacks.startSequencer&&R.callbacks.startSequencer({name:this._name}),this.trigger("start"),this},i.prototype.pause=function(){this._paused=!0,this._pauseOffset=this._scheduleTime-U.now();for(var t=0,e=this._registeredPatterns.length;e>t;t++)this._registeredPatterns[t].pause();return this.trigger("pause"),this},i.prototype.unpause=function(){this._paused=!1,this._scheduleTime=U.now()+this._pauseOffset;for(var t=0,e=this._registeredPatterns.length;e>t;t++)this._registeredPatterns[t].unpause();return this},i.prototype.reschedule=function(){clearTimeout(this._scheduler);var e=this._scheduleTime-t.context.currentTime,i=this.getNoteTime(this._resolution),n=e>this._scheduleAheadTime?e-this._scheduleAheadTime:e-(this._scheduleAheadTime-i),s=(e-e%i)/i/(this._beatLength/this._resolution),o=this._scheduleAheadTime/i/(this._beatLength/this._resolution);this._scheduleTime=t.context.currentTime+n,o>s&&(this._scheduleTime-=i),this._currentStep-=o,(isNaN(this._currentStep)||this._currentStep<0)&&(this._currentStep=0);for(var r=0,a=this._registeredPatterns.length;a>r;r++)this._registeredPatterns[r].deschedule(o);return this.startScheduler(),this},i.prototype.stop=function(){return this._started=!1,clearTimeout(this._scheduler),this._scheduler=null,this._started=!1,R.callbacks&&R.callbacks.stopSequencer&&R.callbacks.stopSequencer({name:this._name}),this},i.prototype.stopAll=function(t){for(var e=[],i=0;i<arguments.length-1;i++)e[i]=arguments[i+1];for(var n=void 0!=t.beat?t.beat:4,s=void 0===t.fadeTime?0:t.fadeTime,o=t.forceFade||!1,r=t.wait||0,a=0,u=this._registeredPatterns.length;u>a;a++)-1==e.indexOf(this._registeredPatterns[a])&&(this._registeredPatterns[a].forceFade=o,this._registeredPatterns[a].stop(n,!0,s,r));return this},i.prototype.restart=function(){return this._currentStep=0,this},i.prototype.registerPattern=function(t){return this._registeredPatterns.push(t),this},i.prototype.unregisterPattern=function(t){var e=this._registeredPatterns.indexOf(t);return this._registeredPatterns.splice(e,1),this},i.prototype.registerSynth=function(t){return-1==this._registeredSynths.indexOf(t)&&this._registeredSynths.push(t),this},i.prototype.unregisterSynth=function(t){var e=this._registeredPatterns.indexOf(t);return this._registeredSynths.splice(e,1),this},i.prototype.sync=function(t,e,i){return this.syncInSteps(t,this.getStepsToNext(this.beatLength*e),i)},i.prototype.syncInSteps=function(t,e,i){this._started||this.start();var n=this.getNoteTime(e)+this._scheduleTime;return i?i.length&&i.push(n):i=[n],this._syncHandler.addSyncCountdown(new K(e,t,i)),this},i.prototype.syncPattern=function(e){for(var i=[],n=0;n<arguments.length-1;n++)i[n]=arguments[n+1];var s,o,r=e.beat||0,a=e.fadeIn||!1,u=e.duration||1,c=void 0==e.absolute?!1:e.absolute,h=void 0!=e.syncType?e.syncType:3,l=e.offset,p=e.wait||0;this._started||(this._currentStep=0,this.start(),s=r=0,o=!0);var _,f=!1;if(h===H.Restart)_=0,f=!0;else if(h===H.Playing){for(var d=0,g=-1,y=0,m=i.length;m>y;y++)1===i[y].state&&i[y].length>d&&(d=i[y].length,g=y);var v=0;g>-1&&(v=i[g].getNextBar(r)),_=v*r,v>0&&p>0&&(_+=p)}else if(h===H.All){for(var d=0,g=-1,y=0,m=this._registeredPatterns.length;m>y;y++)(1===this._registeredPatterns[y].state||2===this._registeredPatterns[y].state)&&this._registeredPatterns[y].length>d&&(d=this._registeredPatterns[y].length,g=y);var b=0;g>-1&&(b=this._currentStep+this.getStepsToNext(r)),_=b}else h===H.Continue&&(_=0,f=o?!0:!1);0!=c?s="number"==typeof c?this.getStepsToNext(this.beatLength*c)+this.beatLength*r:this.beatLength*r:r>0?s=this.getStepsToNext(this.beatLength*r):0==r&&(s=0),p>0&&(s+=p);for(var y=0,m=i.length;m>y;y++)void 0!=l&&(l=this.getNoteTime(l)),i[y].prePlaySchedule(s,_,f,a,u,l);if(o){var T=this._scheduleTime-t.context.currentTime,S=this.getNoteTime(this._resolution),O=T>this._scheduleAheadTime?T-this._scheduleAheadTime:T-(this._scheduleAheadTime-S);this._scheduleTime=t.context.currentTime+O,f?this._currentStep=i[0]._currentStep-this._resolution:this._currentStep=i[0]._currentStep,o=!1}else this._scheduleAheadTime>.5&&this.reschedule();return this},i.prototype.registerBPMSync=function(t){return-1==this._syncedObjects.indexOf(t)&&this._syncedObjects.push(t),this},i.prototype.unregisterBPMSync=function(t){var e=this._syncedObjects.indexOf(t);return-1!=e&&this._syncedObjects.splice(e,1),this},i.prototype.getStepsToNext=function(t){return 0==t?0:t-this._currentStep%t},i.prototype.getNoteTime=function(t){return void 0==t&&(t=1),60/this._bpm*t},i.prototype.getBeatTime=function(t){return this.getNoteTime(this.getStepsToNext(t))+this._scheduleTime},Object.defineProperty(i.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"paused",{get:function(){return this._paused},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"bpm",{get:function(){return this._bpm},set:function(t){this._bpm=t;for(var e=0,i=this._registeredPatterns.length;i>e;e++)"MidiPattern"==this._registeredPatterns[e]._type&&this._registeredPatterns[e].recalculateBPM(this._bpm);for(var e=0,i=this._syncedObjects.length;i>e;e++)this._syncedObjects[e].updateSync(this._bpm)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scale",{set:function(t){for(var e=0,i=this._registeredPatterns.length;i>e;e++)"MidiPattern"==this._registeredPatterns[e]._type&&(this._registeredPatterns[e].scale=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"customScale",{set:function(t){for(var e=0,i=this._registeredPatterns.length;i>e;e++)"MidiPattern"==this._registeredPatterns[e]._type&&(this._registeredPatterns[e].customScale=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"transpose",{set:function(t){for(var e=0,i=this._registeredPatterns.length;i>e;e++)"MidiPattern"==this._registeredPatterns[e]._type&&(0===t?this._registeredPatterns[e].resetTranspose():this._registeredPatterns[e].transpose+=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"resolution",{get:function(){return this._resolution},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"barLength",{get:function(){return this._barLength},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"beatLength",{get:function(){return this._beatLength},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"currentStep",{get:function(){return this._currentStep},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"swingFactor",{set:function(t){this._swingFactor=t},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){this._bpm=t.bpm||120,this._barLength=t.measure_length||4,this._beatLength=t.beat_length||1,this._swingFactor=t.swing_factor||0},i}(r);e.Sequencer=Q;var K=function(){function t(t,e,i){this._currentStep=0,this._targetStep=t,this._process=e,this._args=i}return t.prototype.advance=function(t){this._currentStep+=t},t.prototype.performAction=function(){"string"==typeof this._process?new Function("Core","Model","Util","args",this._process)(R,e,U,this._args):this._process.start(this._args)},Object.defineProperty(t.prototype,"finished",{get:function(){return this._currentStep>=this._targetStep},enumerable:!0,configurable:!0}),t}();e.SyncCountdown=K;var z=function(){function t(){this._timers=[]}return t.prototype.addSyncCountdown=function(t){this._timers.push(t)},t.prototype.update=function(t){for(var e=0;e<this._timers.length;e++){var i=this._timers[e];i.advance(t),i.finished&&(i.performAction(),this._timers.splice(e,1),e--)}},t}();e.SyncHandler=z;var W=function(){function e(){this._callbacks=[]}return e.inst=null,Object.defineProperty(e,"instance",{get:function(){return null==e.inst&&(e.inst=new e),e.inst},enumerable:!0,configurable:!0}),e.prototype.startScheduler=function(){if(this._callbacks.length>0){for(var e=t.context.currentTime,i=e-this._lastTime,n=0;n<this._callbacks.length;n++){var s=this._callbacks[n];s.timePassed+=i,s.timePassed>=s.targetTime&&(s.obj[s.func](),this._callbacks.splice(n,1),n--)}this._lastTime=e;var o=this;this._scheduler=setTimeout(function(){o.startScheduler()},R.settings.timehandler_lookahead)}else this.stop()},e.prototype.start=function(){this._started=!0,this._lastTime=t.context.currentTime,clearTimeout(this._scheduler),this.startScheduler()},e.prototype.stop=function(){this._started=!1,clearTimeout(this._scheduler),
this._scheduler=null},e.prototype.registerMethodCallback=function(t,e,i){return this._callbacks.push({obj:t,func:e,timePassed:0,targetTime:i}),this._started||this.start(),this},e.prototype.removeMethodCallback=function(t,e){for(var i=0,n=this._callbacks.length;n>i;i++){var s=this._callbacks[i];if(s.obj==t&&s.func==e)return void this._callbacks.splice(i,1)}return this},e}();e.TimeHandler=W;var Y=function(){function e(){this._updateTime=100,this._lookAHead=2*this._updateTime,this._callbacks=[]}return e.prototype.scheduleClose=function(e){var i=e.targetTime-t.context.currentTime;setTimeout(function(){e.func.apply(e.ctx)},1e3*i)},e.prototype.runScheduler=function(){if(this._callbacks.length>0){for(var e=t.context.currentTime,i=0;i<this._callbacks.length;i++){var n=this._callbacks[i];e+this._lookAHead>=n.targetTime&&(this.scheduleClose(n),this._callbacks.splice(i,1),i--)}this._lastTime=e;var s=this;this._scheduler=setTimeout(function(){s.runScheduler()},s._updateTime)}else this.stop()},e.prototype.start=function(){this._started=!0,this._lastTime=t.context.currentTime,clearTimeout(this._scheduler),this.runScheduler()},e.prototype.stop=function(){this._started=!1,clearTimeout(this._scheduler),this._scheduler=null},e.prototype.delay=function(e,i,n){return this.at(t.context.currentTime+e,i,n)},e.prototype.at=function(e,i,n){return e<t.context.currentTime?this:(this._callbacks.push({ctx:n||this,func:i,targetTime:e}),this._started||this.start(),this)},e.prototype.cancel=function(t){for(var e=0;e<this._callbacks.length;e++)if(this._callbacks[e].func&&this._callbacks[e].func===t){this._callbacks.splice(e,1);break}return this},e}();e.Scheduler=Y;var X=function(){function i(t){this._vars=t.vars,R.instance.pushToPreLoadInitStack(this)}return i.prototype.init=function(){for(var t=0,e=this._vars.length;e>t;t++){var i=this._vars[t];this._destination=this._actionData[i]=R.instance.findInstance(i)}this._vars=null},i.prototype.start=function(e){t.warn("Process: Invocation of abstract method")},i.prototype.destination=function(){return this._destination},i.prototype.execute=function(t,i,n){return"function"!=typeof t?((!this._func||n)&&(this._func=new Function("Core","Model","Util","me","args","vars",t)),this._func(R,e,U,this._actionData,i,U.vars)):void t(R,e,U,this._actionData,i,U.vars)},i}();e.Process=X;var J=function(e){function i(t,i){e.call(this,t),this._name=i,this._type=t.type,this._action=t.action,this._actionData={}}return s(i,e),i.prototype.start=function(e){try{this.execute(this._action,e)}catch(i){t.err("Klang: error in process '"+this._name+"': "+i.name+": "+i.message)}},i.prototype.setData=function(t){this._action=t.action,this._vars=t.vars,this.init(),this._func=new Function("Core","Model","Util","me","args","vars",this._action)},i}(X);e.SimpleProcess=J;var $=function(e){function i(i,n){if(e.call(this,i),this._nextStartTime=0,this._waitOffset=0,this.SCHEDULE_AHEAD_TIME=.2,this._lastTime=0,this._name=n,this._type=i.type,this._preAction=i.pre_action||null,this._actions=i.actions,this._currentAction=0,this._started=!1,this._loop=void 0!=i.loop?i.loop:!1,this._loopTime=i.loopTime||-1,this._actionData={process:this},this._loop){for(var s=!1,o=0,r=this._actions.length;r>o;o++)if("wait"==this._actions[o].operation){s=!0;break}s||t.warn("Process: Infinite loop found in process '"+this._name+"'")}}return s(i,e),i.prototype.start=function(e){if(!t.isIOS)try{if(this._args=e,this._currentAction=0,this._execTime=0,this._startTime=t.context.currentTime,this._nextStartTime=this._startTime,this._preAction)if("exec"==this._preAction.operation)this.execute(this._preAction.script,this._args);else if("wait"==this._preAction.operation)return this._execTime=this.execute(this._preAction.script,this._args),this._waitOffset+=this._execTime,void(this._execTime>=this.SCHEDULE_AHEAD_TIME?W.instance.registerMethodCallback(this,"cont",this._execTime-this.SCHEDULE_AHEAD_TIME/2):this.cont());this._started=!0,this.cont()}catch(i){t.err("Klang: error in process '"+this._name+"': "+i.name+": "+i.message)}},i.prototype.cont=function(){this._actionData.execTime=this._nextStartTime+this._waitOffset;for(var t=this._actions.length;this._currentAction<t;this._currentAction++){if(!this._started)return;var e=this._actions[this._currentAction];if("exec"==e.operation)this.execute(e.script,this._args,!0),this._execTime=0;else if("wait"==e.operation)return this._execTime=this.execute(e.script,this._args,!0),this._waitOffset+=this._execTime,this._execTime>=this.SCHEDULE_AHEAD_TIME?W.instance.registerMethodCallback(this,"cont",this._execTime-this.SCHEDULE_AHEAD_TIME/2):this._waitOffset>this.SCHEDULE_AHEAD_TIME?this.scheduleLoop(this._waitOffset):(this._currentAction++,this.cont()),void this._currentAction++}this._loop&&(this._loopTime>0?this.scheduleLoop(this._loopTime):(this._waitOffset=0,this._currentAction=0,this.cont()))},i.prototype.scheduleLoop=function(e){if(this._started){this._nextStartTime+=e;var i=this._nextStartTime-t.context.currentTime,n=this;setTimeout(function(){n._waitOffset=0,n._currentAction=0,n.cont()},1e3*(i-this.SCHEDULE_AHEAD_TIME/2))}},i.prototype.stop=function(){this._started=!1,W.instance.removeMethodCallback(this,"cont")},Object.defineProperty(i.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),i.prototype.setData=function(t){this._actions=t.actions,this._vars=t.vars,this.init()},i}(X);e.AdvancedProcess=$}(B||(B={}));var U;!function(e){function i(e,i,n){e.setValueAtTime(i,n||t.context.currentTime)}function n(e,i,n){e.setValueAtTime(e.value+i,n||t.context.currentTime)}function s(e,i,n,s,o){s=s||t.context.currentTime;var r=e.value;void 0!=o&&"Firefox"==t.detector.browser.name&&(r=o),e.setValueAtTime(r,s),e.linearRampToValueAtTime(i,t.context.currentTime+n)}function o(i,n,s,o,r){o=o||t.context.currentTime;var a=i.value;void 0!=r&&"Firefox"==t.detector.browser.name&&(a=r),i.setValueAtTime(0==a?e.EXP_MIN_VALUE:a,o),i.exponentialRampToValueAtTime(n,t.context.currentTime+s)}function r(i,n,s,o){o=o||t.context.currentTime,i.setValueCurveAtTime(e.CUSTOM_CURVES[n],o,s)}function a(i){for(var n in i){var s=i[n];if(s instanceof Array)for(var o=new Float32Array(s.length),r=0,a=s.length;a>r;r++)o[r]=s[r];else{s.curve_type||t.warn("Modulation: Curve type not specified"),s.resolution||(s.resolution=1024),s.amplitude||(s.amplitude=1),s.amplitude_offset||(s.amplitude_offset=0),s.phase_offset||(s.phase_offset=0),s.length||(s.length=1);var o=new Float32Array(s.resolution);if("sine"==s.curve_type)for(var u=s.phase_offset*Math.PI*2,c=s.length*Math.PI*2,r=0,a=o.length;a>r;r++)o[r]=s.amplitude_offset+Math.sin(u+r/a*c)*s.amplitude;else if("saw"==s.curve_type)for(var r=0,a=o.length;a>r;r++)o[r]=s.amplitude_offset+(a-r)/a*s.amplitude;else if("inverse-saw"==s.curve_type)for(var r=0,a=o.length;a>r;r++)o[r]=s.amplitude_offset+r/a*s.amplitude;else t.warn("Modulation: Unrecognized curve type");e.CUSTOM_CURVES[n]=o}}}function u(t,e){return Math.floor(e+(1+t-e)*Math.random())}function c(t,e){return e+(t-e)*Math.random()}function h(t,e,i){var n=document.createElement("script");n.async=!0,n.onload=function(){e&&e(),n.onload=null},n.onerror=function(t){i&&i(t),n.onerror=null},n.src=t,document.getElementsByTagName("head")[0].appendChild(n)}function l(t,e,i){return"undefined"==typeof i&&(i=3),t-(t-e)/i}function p(){return"webaudio"==t.version?t.context.currentTime:0}function _(t){return 440*Math.pow(2,(t-69)/12)}function f(t){return 69+12*Math.log(t/440)/Math.log(2)}function d(t){return void 0==t?"lowpass":t}function g(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function y(){return/(iPad|iPhone|iPod)/g.test(navigator.userAgent)}function m(t){R.instance.blurFadeOut=t}function v(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),i=e.exec(location.search);return null==i?"":decodeURIComponent(i[1].replace(/\+/g," "))}function b(t,i,n,s,o){var n=n||120,o=o||2,t=t,i=i;if(!i)return e.now();if(t===i)return e.now();if(Array.isArray(t)){for(var r,a=0;a<t.length;a++)if(t[a].playing){r=t[a];break}t=r}if(!t)return i.play(e.now(),0,!1),e.now();var u=60/n,c=n/60,h=t?t.position:0;h=h||0;var l=h*c,s=s||4,p=s-l%s;.5>p&&(p+=s);var _=p*u;t.playing||(_=0);var f=e.now()+_;return i.play(f,0,!1),t&&t.fadeOutAndStop(o,f),f}function T(t,e,i,n){var e=e||120,t=t,n=n||0;if(Array.isArray(t)){for(var s,o=0;o<t.length;o++)if(t[o].playing){s=t[o];break}t=s}if(t){var r=60/e,a=e/60,u=t.position;u=u||0,t._loopStart>0&&(u<t._loopStart?u=0:u-=t._loopStart);var c=u*a,i=i||4,h=i-c%i;h+=n;var l=h*r;return t.playing||(l=0),l}}function S(){for(var t=[],e=0;e<arguments.length-0;e++)t[e]=arguments[e+0];for(var i=[{beat:0,fadeOut:2}],n=t.length-1;n>=0;n--){var s=R.instance.findInstance(t[n]);"Pattern"==s.type&&i.push(t[n])}var o=R.instance._objectTable;for(var r in R.instance._objectTable){var a=o[r];"AudioSource"==a._type&&-1==t.indexOf(r)?a.loop&&a.playing&&a.fadeOutAndStop(1):"Sequencer"==a._type?a.stopAll.apply(a,i):"AdvancedProcess"==a._type&&a.started&&-1==t.indexOf(r)&&a.stop()}}function O(t){for(var e,i,n=t.length;n--;)i=Math.random()*n|0,e=t[n],t[n]=t[i],t[i]=e;return t}function P(t){if(0==t)return 0;var e=20,i=2e4;0==e&&(e=.01);var n=t,s=e,o=i,r=Math.log(s),a=Math.log(o),u=(a-r)/(o-s);return Math.exp(r+u*(n-s))}function A(t){for(var e="";e.length<t;)e+="0";return(e+(Math.random()*Math.pow(36,t)<<0).toString(36)).slice(-t)}if(e.setParam=i,e.adjustParam=n,e.curveParamLin=s,e.curveParamExp=o,e.curveParam=r,e.CUSTOM_CURVES={},e.createCurves=a,-1!=navigator.userAgent.indexOf("MSIE")){var w,E=navigator.userAgent,k=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");null!=k.exec(E)&&(w=parseInt(RegExp.$1)),9>w&&(Object.defineProperty=Object.oldDefineProperty,delete Object.oldDefineProperty)}e.ROOT12=1.059463094359295,e.NYQUIST_FREQUENCY=22050,e.PITCH_SHIFT_FFT=2048,e.EXP_MIN_VALUE=1e-4,e.OSC_START_DELAY=.005,e.LOG_TIME_COLOR="#999999",e.LOG_EVENT_COLOR="#54CBDD",e.LOG_UNIMPLEMENTED_EVENT_COLOR="#E075A9",e.LOG_LOAD_COLOR="#333333",e.LOG_WARN_COLOR="DarkOrange",e.LOG_ERROR_COLOR="Red",e.lastEvent=void 0,e.vars={},e.random=u,e.randomFloat=c,e.loadScriptFile=h,e.ease=l,e.now=p,e.midiNoteToFrequency=_,e.frequencyToMidiNote=f,e.safeFilterType=d,e.checkMobile=g,e.checkIOS=y,e.setBlurFadeOut=m,e.getParameterByName=v,e.transition=b,e.getTimeToBeat=T,e.stopPlayingExcept=S,e.shuffle=O,e.logFreq=P,e.generateIdString=A,e.MidiHandler={midiAccess:null,midiIn:null,midiOut:null,inputs:[],outputs:[],init:function(t){this.MIDIUtils.initUtils();var e=this;window.navigator.requestMIDIAccess().then(function(i){e.onMIDIStarted(i),t&&t()},this.onMIDISystemError)},onMIDISystemError:function(t){console.log("Error encountered:",t)},onMIDIStarted:function(t){e.MidiHandler.midiAccess=t;var i=t.inputs;i.forEach(function(t){e.MidiHandler.inputs.push(t)});var n=t.outputs;return n.forEach(function(t){e.MidiHandler.outputs.push(t)}),e.MidiHandler.inputs.length?(e.MidiHandler.midiIn=e.MidiHandler.inputs[0],e.MidiHandler.midiIn.onmidimessage=e.MidiHandler.midiMessageReceived,e.MidiHandler.midiOut=e.MidiHandler.outputs[0],void 0):void console.error("No midi inputs found")},midiMessageReceived:function(t){var i=t.data[0],n=t.data[0]>>4,s=15&t.data[0],o=t.data[1],r=t.data[2];e.MidiHandler.handleMidiData(i,n,s,o,r)},handleMidiData:function(t,e,i,n,s){},changeMidi:function(t){this.midiOut=this.outputs[t],this.midiIn=this.inputs[t]},MIDIUtils:{noteMap:{},noteNumberMap:[],notes:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],initUtils:function(t){for(var e=0;127>e;e++){var i=e,n=this.notes[i%12],s=(i/12|0)-1;1===n.length&&(n+="-"),n+=s,this.noteMap[n]=e,this.noteNumberMap[e]=n}},getBaseLog:function(t,e){return Math.log(t)/Math.log(e)},noteNameToNoteNumber:function(t){return this.noteMap[t]},noteNumberToFrequency:function(t){return 440*Math.pow(2,(t-69)/12)},noteNumberToName:function(t){return this.noteNumberMap[t]},frequencyToNoteNumber:function(t){return Math.round(12*this.getBaseLog(t/440,2)+69)}},play:function(t,e,i){"undefined"==typeof i&&(i=100),this.midiOut.send([144,t,i]),console.log("On"),this.midiOut.send([128,t,0],window.performance.now()+e)},panic:function(){for(var t=1;128>t;++t)this.midiOut.send([128,t,0])}}}(U||(U={}))}(n||(n={})),n});